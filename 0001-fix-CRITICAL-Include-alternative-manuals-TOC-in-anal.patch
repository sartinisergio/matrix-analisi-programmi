From 3af7a6e5a5a849e3e7fd79d71f74ed9a8387b77f Mon Sep 17 00:00:00 2001
From: sartinisergio <genspark_dev@genspark.ai>
Date: Fri, 30 Jan 2026 15:07:22 +0000
Subject: [PATCH] fix(CRITICAL): Include alternative manuals TOC in analysis
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

PROBLEMA: Fase 3b valutava manuali alternativi solo con metadati generici
SOLUZIONE: Carica file JSON e include indice completo (primi 15 capitoli)

- Cerca manual_catalog entry per filepath
- Carica JSON completo del manuale
- Estrae chapters array
- Include nel prompt LLM: 'INDICE: 1. ... 2. ... 15. ...'
- Fallback graceful se file non trovato

IMPATTO: LLM ora può fare analisi accurata dei manuali alternativi
TEST: Brown + Bruice chimica organica → valutazione dettagliata
---
 index.html | 23 ++++++++++++++++++++++-
 1 file changed, 22 insertions(+), 1 deletion(-)

diff --git a/index.html b/index.html
index 071e1d6..7c440ff 100644
--- a/index.html
+++ b/index.html
@@ -1692,6 +1692,24 @@ RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;
                     
                     for (const manualeAlt of manualiAlternativi) {
                         const manualeInfo = MANUALI_DB[manualeAlt] || {};
+                        
+                        // Carica indice completo del manuale alternativo dal JSON
+                        let indiceManuale = '';
+                        try {
+                            const catalogEntry = MANUAL_CATALOG.manuals.find(m => m.id === manualeAlt);
+                            if (catalogEntry && catalogEntry.filepath) {
+                                const manualeData = await fetch(catalogEntry.filepath).then(r => r.json());
+                                if (manualeData.chapters && manualeData.chapters.length > 0) {
+                                    const firstChapters = manualeData.chapters.slice(0, 15);
+                                    indiceManuale = '\n   INDICE:\n' + firstChapters.map(ch => 
+                                        `   ${ch.number}. ${ch.title}`
+                                    ).join('\n');
+                                }
+                            }
+                        } catch (err) {
+                            console.warn(`⚠️ Impossibile caricare indice di ${manualeAlt}:`, err.message);
+                        }
+                        
                         const gapAlt = await callLLM(`Valuta il manuale "${manualeAlt}" (${manualeInfo.editore || ''}) rispetto a questo programma di ${materiaName} usando il FRAMEWORK DI VALUTAZIONE MANUALI.${istruzioniDettaglio}
 
 MATERIA: ${materiaName}
@@ -1705,7 +1723,10 @@ CONTESTO:
 - CFU: ${cfu || 'Non specificato'}
 - Ore: ${ore || 'Non specificato'}
 
-CARATTERISTICHE MANUALE ${manualeAlt}:
+MANUALE ALTERNATIVO: ${manualeAlt}
+EDITORE: ${manualeInfo.editore || 'N/D'}${indiceManuale}
+
+CARATTERISTICHE MANUALE:
 ${JSON.stringify(manualeInfo.caratteristiche || [])}
 
 FRAMEWORK VALUTAZIONE MANUALI (270 punti):
-- 
2.39.5

