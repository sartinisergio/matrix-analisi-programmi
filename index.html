
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIX v1.0 - Multi-Analysis Teaching Resource Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4F46E5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Catalog Tab Styles */
        .catalog-tab-btn.active {
            border-bottom-color: #4F46E5;
            color: #4F46E5;
        }
        .catalog-tab-content {
            display: block;
        }
        .catalog-tab-content.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                        <div class="flex items-center space-x-2">
                            <h1 class="text-2xl font-bold text-gray-900">MATRIX</h1>
                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">v1.0</span>
                            <span id="apiKeyBadge" class="hidden px-2 py-1 text-xs font-medium rounded-full"></span>
                        </div>
                        <p id="headerSubtitle" class="text-sm text-gray-500">Multi-Analysis Teaching Resource Intelligence X-platform</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showView('upload')" id="btnUpload" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Nuova Analisi
                    </button>
                    <button onclick="showView('storico')" id="btnStorico" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Storico
                    </button>
                    <button onclick="showView('settings')" id="btnSettings" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center space-x-1">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>Impostazioni</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Banner Miglioramento -->
    <div class="max-w-7xl mx-auto px-4 pt-4 sm:px-6 lg:px-8">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-green-900">‚úÖ Versione v5.7 - Bilanciamento Criteri Valutazione</h3>
                <p class="text-sm text-green-800 mt-1">Questa versione <strong>bilancia i criteri di valutazione</strong> nell'analisi Avanzata: oltre alla completezza, considera anche <strong>adeguatezza al programma</strong>, <strong>rapporto qualit√†/prezzo</strong> e <strong>accessibilit√†</strong>. Hart (manuale sintetico ed economico) ha ora pi√π possibilit√† di essere raccomandato per programmi brevi o budget limitati!</p>
            </div>
        </div>
    </div>

    <!-- Banner Informativo Differenze Base/Avanzata -->
    <div class="max-w-7xl mx-auto px-4 pt-4 sm:px-6 lg:px-8">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-blue-900">üí° Differenze tra Analisi Base e Avanzata</h3>
                <p class="text-sm text-blue-800 mt-1">
                    Analisi Base e Avanzata dello stesso programma possono raccomandare manuali Zanichelli <strong>diversi</strong>. Questo non √® un errore, ma riflette due approcci complementari:
                </p>
                <ul class="text-sm text-blue-800 mt-2 space-y-1 ml-4">
                    <li><strong>‚ö° Analisi Base:</strong> Fornisce una valutazione <strong>rapida e focalizzata</strong> sui contenuti del programma. Privilegia manuali con buon equilibrio tra chiarezza, accessibilit√† e copertura essenziale degli argomenti. Ideale per una prima valutazione veloce.</li>
                    <li><strong>üî¨ Analisi Avanzata:</strong> Include <strong>insights strategici approfonditi</strong> per il promotore: profilo del docente, opportunit√† commerciali, analisi dell'impatto dell'adozione, strategie di colloquio e gestione obiezioni. Privilegia l'allineamento con il profilo pedagogico e gli obiettivi specifici del corso.</li>
                </ul>
                <p class="text-sm text-blue-800 mt-2">
                    <strong>Entrambe le raccomandazioni sono valide:</strong> usa l'Analisi Base per screening iniziali, l'Analisi Avanzata quando prepari un colloquio con il docente o hai bisogno di argomentazioni commerciali dettagliate.
                </p>
            </div>
        </div>
    </div>

    <!-- Banner Benvenuto (solo per nuovi utenti) -->
    <div id="welcomeBanner" class="hidden max-w-7xl mx-auto px-4 pt-6 sm:px-6 lg:px-8">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-blue-900">Benvenuto! Configurazione necessaria</h3>
                <p class="text-sm text-blue-800 mt-1">Prima di iniziare, devi configurare la tua chiave API OpenAI. Clicca su <strong>Impostazioni</strong> per procedere.</p>
                <button onclick="showView('settings'); document.getElementById('welcomeBanner').classList.add('hidden');" class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700">
                    Vai alle Impostazioni ‚Üí
                </button>
            </div>
            <button onclick="document.getElementById('welcomeBanner').classList.add('hidden')" class="text-blue-400 hover:text-blue-600">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Sezione FAQ -->
    <div class="max-w-7xl mx-auto px-4 pt-4 sm:px-6 lg:px-8">
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <button onclick="toggleFAQ()" class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition">
                <div class="flex items-center space-x-2">
                    <svg class="h-5 w-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="text-sm font-medium text-gray-900">‚ùì Perch√© analisi Base e Avanzata dello stesso programma raccomandano manuali Zanichelli diversi?</h3>
                </div>
                <svg id="faqChevron" class="h-5 w-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="faqContent" class="hidden px-4 pb-4 text-sm text-gray-700 space-y-4">
                <p class="font-medium text-gray-900">
                    Questo comportamento √® <strong>intenzionale</strong> e riflette due filosofie di raccomandazione complementari:
                </p>
                
                <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
                    <h4 class="font-semibold text-blue-900 mb-2">‚ö° ANALISI BASE - Approccio "Rapido-Essenziale"</h4>
                    <ul class="space-y-1 ml-4 list-disc text-blue-800">
                        <li><strong>Velocit√†:</strong> 3-5 minuti per l'analisi completa</li>
                        <li><strong>Focus:</strong> Valutazione del programma (270 punti) + Gap analysis del manuale adottato + Raccomandazioni Zanichelli</li>
                        <li><strong>Output:</strong> Punteggi, copertura argomenti, compatibilit√† manuali</li>
                        <li><strong>Ideale per:</strong> Screening iniziale di pi√π programmi, valutazione rapida della situazione, confronto tra corsi diversi</li>
                    </ul>
                </div>
                
                <div class="bg-purple-50 border-l-4 border-purple-400 p-3">
                    <h4 class="font-semibold text-purple-900 mb-2">üî¨ ANALISI AVANZATA - Approccio "Strategico-Commerciale"</h4>
                    <ul class="space-y-1 ml-4 list-disc text-purple-800">
                        <li><strong>Velocit√†:</strong> 6-9 minuti per l'analisi completa</li>
                        <li><strong>Focus:</strong> Tutto ci√≤ che offre l'Analisi Base + 4 sezioni aggiuntive con insights per il promotore</li>
                        <li><strong>Output:</strong> Profilo docente, leve motivazionali, opportunit√† commerciali, impatto adozione, strategia colloquio, obiezioni e risposte</li>
                        <li><strong>Ideale per:</strong> Preparazione colloqui con docenti, sviluppo argomentazioni commerciali, gestione obiezioni, pianificazione strategia di adozione</li>
                    </ul>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                    <h4 class="font-semibold text-yellow-900 mb-2">üéØ QUALE USARE?</h4>
                    <p class="text-yellow-800 mb-2">Dipende dal contesto e dall'obiettivo della tua analisi:</p>
                    <ul class="space-y-1 ml-4 list-disc text-yellow-800">
                        <li><strong>Screening iniziale di pi√π programmi</strong> ‚Üí Usa Analisi Base per velocit√†</li>
                        <li><strong>Preparazione colloquio con docente specifico</strong> ‚Üí Usa Analisi Avanzata per insights strategici</li>
                        <li><strong>Hai bisogno di argomentazioni commerciali</strong> ‚Üí Usa Analisi Avanzata per obiezioni e risposte</li>
                        <li><strong>Confronto rapido tra manuali</strong> ‚Üí Usa Analisi Base per copertura essenziale</li>
                        <li><strong>In dubbio</strong> ‚Üí Inizia con Base, poi richiedi Avanzata se serve approfondire</li>
                    </ul>
                    <p class="text-yellow-800 mt-2 text-sm italic">
                        Nota: Le raccomandazioni possono differire perch√© l'Analisi Avanzata valuta anche il <strong>profilo pedagogico del docente</strong> e l'<strong>allineamento strategico</strong>, non solo la copertura argomenti.
                    </p>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded p-3">
                    <p class="text-gray-700">
                        <strong>üìå RICORDA:</strong> Le raccomandazioni Base e Avanzata sono entrambe valide e basate su criteri diversi. Se i punteggi di compatibilit√† sono simili (es. 85/100 vs 84/100), la scelta finale dipender√† pi√π dal <strong>contesto del colloquio</strong> e dal <strong>profilo del docente</strong> che da una superiorit√† oggettiva del manuale.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        
        <!-- Settings View -->
        <div id="viewSettings" class="hidden">
            <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Configurazione AI Provider</h2>
                
                <div class="space-y-6">
                    <!-- Provider Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Provider AI</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="selectProvider('openai')" id="btnProviderOpenAI" class="px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100">
                                OpenAI
                            </button>
                            <button onclick="selectProvider('perplexity')" id="btnProviderPerplexity" class="px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50">
                                Perplexity
                            </button>
                        </div>
                    </div>

                    <!-- OpenAI Configuration -->
                    <div id="configOpenAI" class="space-y-4">
                        <div class="border-t pt-4">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Configurazione OpenAI</h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chiave API OpenAI</label>
                                    <input type="password" id="apiKeyOpenAI" placeholder="sk-proj-xxxxxxxxxxxxx" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">La chiave viene salvata solo nel tuo browser. <a href="https://platform.openai.com/api-keys" target="_blank" class="text-indigo-600 hover:underline">Ottieni chiave</a></p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Modello OpenAI</label>
                                    <select id="modelOpenAI" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="gpt-4.1-mini">gpt-4.1-mini (Economico, veloce)</option>
                                        <option value="gpt-4o">gpt-4o (Bilanciato)</option>
                                        <option value="gpt-4-turbo">gpt-4-turbo (Potente)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Perplexity Configuration -->
                    <div id="configPerplexity" class="space-y-4 hidden">
                        <div class="border-t pt-4">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Configurazione Perplexity</h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chiave API Perplexity</label>
                                    <input type="password" id="apiKeyPerplexity" placeholder="pplx-xxxxxxxxxxxxx" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">La chiave viene salvata solo nel tuo browser. <a href="https://www.perplexity.ai/settings/api" target="_blank" class="text-indigo-600 hover:underline">Ottieni chiave</a></p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Modello Perplexity</label>
                                    <select id="modelPerplexity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="llama-3.1-sonar-large-128k-online">Sonar (Economico, veloce)</option>
                                        <option value="llama-3.1-sonar-huge-128k-online">Sonar Pro (Potente, costoso)</option>
                                        <option value="llama-3.1-sonar-large-128k-reasoning">Sonar Reasoning (Con ragionamento)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Sonar √® raccomandato per il miglior rapporto qualit√†/prezzo</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <button onclick="saveConfiguration()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                        Salva Configurazione
                    </button>
                    
                    <!-- Status Message -->
                    <div id="configStatus" class="hidden p-3 rounded-lg"></div>
                </div>
            </div>
        </div>

        
        <!-- Upload View -->
        <div id="viewUpload" class="hidden">
            
            <!-- Tab Navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-8 max-w-4xl mx-auto" aria-label="Tabs">
                    <button id="tabAnalisi" onclick="switchTab('analisi')" class="tab-button border-b-2 border-indigo-500 py-4 px-1 text-indigo-600 font-medium text-sm whitespace-nowrap">
                        üìä Analisi Programma
                    </button>
                    <button id="tabValutazione" onclick="switchTab('valutazione')" class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                        üìö Valutazione Manuali
                    </button>
                    <button id="tabCataloghi" onclick="switchTab('cataloghi')" class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                        ‚öôÔ∏è Gestione Dati
                    </button>
                </nav>
            </div>
            
            <!-- Tab Content: Analisi Programma (DEFAULT - contains all existing content) -->
            <div id="tabContentAnalisi" class="tab-content">
                <div class="max-w-4xl mx-auto space-y-6">
                    
                    <!-- Step 0: Selezione Materia e Framework -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">üéØ Selezione Materia e Framework</h2>
                    <p class="text-sm text-gray-600 mb-6">Seleziona la materia e il framework specifico per l'analisi</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Dropdown 1: Materia -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Materia *</label>
                            <select id="materiaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">üìö Seleziona materia...</option>
                                <!-- Popolato dinamicamente da matrix_config.json -->
                            </select>
                        </div>
                        
                        <!-- Dropdown 2: Framework (appare solo dopo selezione materia) -->
                        <div id="frameworkContainer" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Framework Specifico *</label>
                            <select id="frameworkSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona framework...</option>
                                <!-- Popolato dinamicamente in base alla materia -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Info framework caricato -->
                    <div id="frameworkInfo" class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200" style="display: none;">
                        <p class="text-sm text-blue-800">
                            ‚úÖ <strong>Framework caricato:</strong> <span id="frameworkName" class="font-medium"></span>
                        </p>
                    </div>
                </div>
                
                <!-- Step 1: Informazioni Contesto -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">1. Informazioni sul Contesto</h2>
                    <p class="text-sm text-gray-600 mb-6">Fornisci informazioni sul contesto didattico e il manuale adottato</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contesto Didattico *</label>
                            <select id="contestoSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona contesto...</option>
                                <option value="L-2">L-2: Biotecnologie</option>
                                <option value="L-13">L-13: Scienze biologiche</option>
                                <option value="L-25">L-25: Agraria</option>
                                <option value="L-29">L-29: Scienze farmaceutiche</option>
                                <option value="L-32">L-32: Scienze naturali/ambientali</option>
                                <option value="L-38">L-38: Scienze zootecniche</option>
                                <option value="L-8/9">L-8/9: Ingegneria</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manuale Principale *</label>
                            <select id="manualeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona manuale principale...</option>
                                <optgroup label="Manuali Zanichelli">
                                    <option value="McMurryBiologico">McMurry - Chimica Organica: Un approccio biologico (Zanichelli)</option>
                                    <option value="Hart">Hart - Chimica Organica (Zanichelli)</option>
                                    <option value="McMurryFondamenti">McMurry - Fondamenti di Chimica Organica (Zanichelli)</option>
                                </optgroup>
                                <optgroup label="Altri Editori">
                                    <option value="Botta">Botta (EdiErmes)</option>
                                    <option value="Brown">Brown (Edises)</option>
                                    <option value="Bruice">Bruice (Edises)</option>
                                    <option value="GorzynskiSmith">Gorzynski Smith (McGraw-Hill)</option>
                                    <option value="Wade">Wade (Piccin)</option>
                                </optgroup>
                                <option value="Altro">Altro manuale (specificare sotto)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Il manuale principale sar√† analizzato in dettaglio</p>
                        </div>
                        
                        <!-- Campo testo per "Altro manuale" -->
                        <div id="altroManualeField" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Specifica il manuale adottato</label>
                            <input type="text" id="altroManualeNome" placeholder="Es: Solomons, Vollhardt, Klein..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">L'analisi si concentrer√† sulle raccomandazioni Zanichelli basate sul programma</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manuali Alternativi (opzionale)</label>
                            <p class="text-xs text-gray-500 mb-2">Seleziona eventuali manuali alternativi per un confronto rapido</p>
                            <div class="space-y-2 bg-gray-50 p-3 rounded-lg border border-gray-200 max-h-80 overflow-y-auto">
                                <!-- Manuali Zanichelli -->
                                <div class="border-b border-gray-300 pb-2 mb-2">
                                    <p class="text-xs font-semibold text-gray-600 mb-2 sticky top-0 bg-gray-50 py-1">Zanichelli</p>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altMcMurryBiologico" value="McMurryBiologico" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">McMurry - Approccio Biologico</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altHart" value="Hart" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">Hart - Chimica Organica</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altMcMurryFondamenti" value="McMurryFondamenti" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">McMurry - Fondamenti</span>
                                    </label>
                                </div>
                                <!-- Altri Editori -->
                                <div>
                                    <p class="text-xs font-semibold text-gray-600 mb-2 sticky top-0 bg-gray-50 py-1">Altri Editori</p>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altBotta" value="Botta" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">Botta (EdiErmes)</span>
                                    </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altBrown" value="Brown" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Brown (Edises)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altBruice" value="Bruice" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Bruice (Edises)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altGorzynski" value="GorzynskiSmith" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Gorzynski Smith (McGraw-Hill)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altWade" value="Wade" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Wade (Piccin)</span>
                                </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altAltro" value="Altro" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">Altro/Non specificato</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo di Analisi *</label>
                            <p class="text-xs text-gray-500 mb-3">Scegli il livello di dettaglio dell'analisi</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-start space-x-3 p-4 border-2 border-indigo-600 bg-indigo-50 rounded-lg cursor-pointer hover:bg-indigo-100 transition">
                                    <input type="radio" name="tipoAnalisi" value="base" checked class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-indigo-900">‚ö° Base</p>
                                        <p class="text-xs text-indigo-700 mt-1">Analisi veloce ed essenziale. Ideale per una prima valutazione rapida del programma.</p>
                                    </div>
                                </label>
                                <label class="flex items-start space-x-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition">
                                    <input type="radio" name="tipoAnalisi" value="avanzata" class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-gray-900">üî¨ Avanzata</p>
                                        <p class="text-xs text-gray-700 mt-1">Analisi dettagliata e approfondita con argomentazioni commerciali complete.</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CFU (Crediti)</label>
                            <input type="number" id="cfuInput" placeholder="es. 9" min="1" max="20"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ore Totali</label>
                            <input type="number" id="oreInput" placeholder="es. 72" min="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Carica Programma -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">2. Carica Programma Universitario</h2>
                    <p class="text-sm text-gray-600 mb-6">Carica un file PDF o incolla il testo del programma</p>
                    
                    <div class="space-y-6">
                        <!-- Upload File -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Carica File (PDF o TXT)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" accept=".pdf,.txt" class="hidden" onchange="handleFileSelect(event)">
                                <svg class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p id="fileNameDisplay" class="text-sm text-gray-600">Clicca per selezionare un file</p>
                                <p class="text-xs text-gray-500 mt-2">PDF o TXT (max 16 MB)</p>
                            </div>
                        </div>

                        <!-- Oppure -->
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                            <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">oppure</span></div>
                        </div>

                        <!-- Textarea -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Incolla il Testo</label>
                            <textarea id="testoInput" placeholder="Incolla qui il testo del programma universitario..." 
                                      class="w-full h-64 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
                        </div>

                        <!-- Error -->
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3">
                            <svg class="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p id="errorText" class="text-sm text-red-800"></p>
                        </div>

                        <!-- Button -->
                        <button onclick="avviaAnalisi()" id="btnAnalizza" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-lg font-medium flex items-center justify-center">
                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Avvia Analisi Completa
                        </button>
                        <div id="loadingMessage" class="hidden text-center space-y-2">
                            <div class="spinner mx-auto"></div>
                            <p class="text-sm text-gray-600" id="loadingText">Analisi in corso...</p>
                            <p class="text-xs text-gray-500">Questo pu√≤ richiedere 30-60 secondi</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- END Tab Content: Analisi Programma -->
            
            <!-- Tab Content: Valutazione Manuali -->
            <div id="tabContentValutazione" class="tab-content hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-6">üìö Valutazione Assoluta Manuali</h2>
                        
                        <!-- Form Valutazione -->
                        <div class="space-y-6">
                            
                            <!-- STEP 1: Macroarea -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 1: Seleziona Macroarea
                                </label>
                                <select id="evalAbsMacroarea" onchange="evalAbs_onMacroareaChange()" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona macroarea...</option>
                                </select>
                            </div>
                            
                            <!-- STEP 2: Materia Specifica (nascosto se non necessario) -->
                            <div id="evalAbsMateriaContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 2: Seleziona Materia Specifica
                                </label>
                                <select id="evalAbsMateria" onchange="evalAbs_onMateriaChange()" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona materia...</option>
                                </select>
                            </div>
                            
                            <!-- STEP 3: Manuale -->
                            <div id="evalAbsManualeContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 3: Seleziona Manuale
                                </label>
                                <select id="evalAbsManuale" onchange="evalAbs_onManualeChange()" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona manuale...</option>
                                </select>
                            </div>
                            
                            <!-- STEP 4: Framework -->
                            <div id="evalAbsFrameworkContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 4: Framework di Riferimento
                                    <span class="text-xs text-gray-500 ml-2">(auto-selezionato, puoi modificare)</span>
                                </label>
                                <select id="evalAbsFramework" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona framework...</option>
                                </select>
                            </div>
                            
                            <!-- Bottone Avvia -->
                            <div id="evalAbsButtonContainer" class="hidden pt-4">
                                <button onclick="evalAbs_startEvaluation()" 
                                    class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-lg">
                                    üöÄ Avvia Valutazione
                                </button>
                            </div>
                            
                        </div>
                        
                        <!-- Loading State -->
                        <div id="evalAbsLoading" class="hidden mt-8">
                            <div class="flex flex-col items-center justify-center py-12">
                                <div class="spinner mb-4"></div>
                                <p class="text-gray-600 font-medium">‚è≥ Valutazione in corso...</p>
                                <p class="text-sm text-gray-500 mt-2">Analisi del manuale con AI (pu√≤ richiedere 1-2 minuti)</p>
                            </div>
                        </div>
                        
                        <!-- Report Result -->
                        <div id="evalAbsResult" class="hidden mt-8">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b">
                                <h3 class="text-lg font-bold">üìä Report Valutazione</h3>
                                <div class="flex gap-2">
                                    <button onclick="evalAbs_saveReport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                        üíæ Salva
                                    </button>
                                    <button onclick="evalAbs_downloadHTML()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                        üì• Scarica HTML
                                    </button>
                                    <button onclick="evalAbs_closeReport()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                                        ‚Üê Torna
                                    </button>
                                </div>
                            </div>
                            <div id="evalAbsReportContent" class="prose max-w-none bg-gray-50 p-6 rounded-lg border">
                                <!-- Report HTML will be inserted here -->
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Lista Valutazioni Salvate -->
                    <div id="evalAbsSavedList" class="bg-white rounded-xl shadow-lg p-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold">üìã Valutazioni Salvate</h3>
                            <div class="flex gap-2">
                                <button onclick="evalAbs_exportAll()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-sm">
                                    üì§ Esporta Tutte
                                </button>
                                <button onclick="evalAbs_importJSON()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-sm">
                                    üì• Importa
                                </button>
                            </div>
                        </div>
                        <div id="evalAbsSavedListContent" class="space-y-3">
                            <p class="text-sm text-gray-500 text-center py-8">Nessuna valutazione salvata</p>
                        </div>
                    </div>
                    
                </div>
            </div>
            <!-- END Tab Content: Valutazione Manuali -->
            
            <!-- Tab Content: Gestione Dati -->
            <div id="tabContentCataloghi" class="tab-content hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-6">‚öôÔ∏è Gestione Dati</h2>
                        
                        <!-- Sub-tabs: Manuali / Framework -->
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="switchCatalogTab('manuali')" id="btnTabManuali" class="catalog-tab-btn active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600">
                                    üìö Manuali
                                </button>
                                <button onclick="switchCatalogTab('framework')" id="btnTabFramework" class="catalog-tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                    üìã Framework
                                </button>
                            </nav>
                        </div>
                        
                        <!-- MANUALI TAB -->
                        <div id="catalogTabManuali" class="catalog-tab-content">
                            
                            <!-- Header con filtri e azioni -->
                            <div class="mb-6">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                    <div class="flex-1">
                                        <input type="text" id="searchManuali" placeholder="üîç Cerca per titolo, autore, editore..." 
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            onkeyup="filterManuali()">
                                    </div>
                                    <button onclick="openAddManualeModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium whitespace-nowrap">
                                        ‚ûï Nuovo Manuale
                                    </button>
                                </div>
                                
                                <!-- Filtri -->
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <select id="filterMacroarea" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üóÇÔ∏è Tutte le macroaree</option>
                                        <option value="Biologia">Biologia</option>
                                        <option value="Chimica">Chimica</option>
                                        <option value="Fisica">Fisica</option>
                                        <option value="Matematica">Matematica</option>
                                        <option value="Economia">Economia</option>
                                        <option value="Istologia">Istologia</option>
                                    </select>
                                    
                                    <select id="filterMateria" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üìö Tutte le materie</option>
                                        <!-- Popolato dinamicamente in base ai manuali caricati -->
                                    </select>
                                    
                                    <select id="filterEditore" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üè¢ Tutti gli editori</option>
                                        <option value="Zanichelli">Zanichelli</option>
                                        <option value="Edises">Edises</option>
                                        <option value="McGraw-Hill">McGraw-Hill</option>
                                        <option value="Pearson">Pearson</option>
                                        <option value="Piccin">Piccin</option>
                                        <option value="CEA">CEA</option>
                                    </select>
                                    
                                    <select id="filterTipo" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üè∑Ô∏è Tutti i tipi</option>
                                        <option value="zanichelli">Zanichelli</option>
                                        <option value="competitor">Competitor</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Tabella manuali -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-20">ID</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-28">Titolo</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-20">Autore</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Edit.</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Macro</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-24">Materia</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-10">Cap</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Tipo</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-14">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manualiTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Popolato dinamicamente da JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Footer con stats -->
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <div class="text-sm text-gray-600">
                                    <span id="manualiCount">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                        <!-- END MANUALI TAB -->
                        
                        <!-- FRAMEWORK TAB -->
                        <div id="catalogTabFramework" class="catalog-tab-content hidden">
                            
                            <!-- Header con filtri e azioni -->
                            <div class="mb-6">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                    <div class="flex-1">
                                        <input type="text" id="searchFramework" placeholder="üîç Cerca per nome, materia..." 
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            onkeyup="filterFramework()">
                                    </div>
                                    <button onclick="openAddFrameworkModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium whitespace-nowrap">
                                        ‚ûï Nuovo Framework
                                    </button>
                                </div>
                                
                                <!-- Filtri -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <select id="filterFrameworkMateria" onchange="filterFramework()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üìö Tutte le materie</option>
                                        <option value="Matematica">Matematica</option>
                                        <option value="Fisica">Fisica</option>
                                        <option value="Chimica">Chimica</option>
                                        <option value="Biologia">Biologia</option>
                                        <option value="Economia">Economia</option>
                                        <option value="Medicina e Chirurgia">Medicina e Chirurgia</option>
                                        <option value="Istologia">Istologia</option>
                                    </select>
                                    
                                    <select id="filterFrameworkTipo" onchange="filterFramework()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üè∑Ô∏è Tutti i tipi</option>
                                        <option value="originale">Originale</option>
                                        <option value="modificato">Modificato</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Tabella framework -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-24">ID</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-32">Nome</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-20">Materia</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-12">Moduli</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-12">Profili</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Tipo</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-14">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="frameworkTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Popolato dinamicamente da JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Footer con stats -->
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <div class="text-sm text-gray-600">
                                    <span id="frameworkCount">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                        <!-- END FRAMEWORK TAB -->
                        
                    </div>
                </div>
            </div>
            <!-- END Tab Content: Gestione Dati -->
            
        </div>

        <!-- Risultati View -->
        <div id="viewRisultati" class="hidden">
            <!-- Contenuto dinamico generato da JavaScript -->
        </div>

        <!-- Storico View -->
        <div id="viewStorico" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Storico Analisi</h2>
                <div id="storicoContent" class="space-y-3">
                    <!-- Contenuto dinamico -->
                </div>
            </div>
        </div>

        <!-- View Colloquio (Fase C) -->


    </main>

    <script>
        // Configurazione PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Database manuali (da report forniti)
        const MANUALI_DB = {
            'Botta': {
                editore: 'EdiErmes',
                caratteristiche: ['Approccio italiano', 'Focus biomolecole', 'Esempi biologici'],
                punti_forza: ['Linguaggio accessibile', 'Applicazioni biologiche', 'Esercizi graduati'],
                target: ['L-13', 'L-2']
            },
            'Brown': {
                editore: 'Edises',
                caratteristiche: ['Approccio problem-solving', 'Molti esercizi', 'Visione moderna'],
                punti_forza: ['Chiarezza espositiva', 'Ricchezza esercizi', 'Aggiornato'],
                target: ['L-13', 'L-29', 'L-32']
            },
            'Bruice': {
                editore: 'Edises',
                caratteristiche: ['Approccio biologico', 'Meccanismi dettagliati', 'Applicazioni mediche'],
                punti_forza: ['Profondit√† meccanismi', 'Collegamenti biologia', 'Casi clinici'],
                target: ['L-29', 'L-13']
            },
            'GorzynskiSmith': {
                editore: 'McGraw-Hill',
                caratteristiche: ['Approccio visuale', 'Molte illustrazioni', 'Sintesi organica'],
                punti_forza: ['Chiarezza visiva', 'Sintesi organica', 'Meccanismi'],
                target: ['L-13', 'L-29']
            },
            'Wade': {
                editore: 'Piccin',
                caratteristiche: ['Approccio sistematico', 'Meccanismi dettagliati', 'Esercizi'],
                punti_forza: ['Sistematicit√†', 'Rigore', 'Completezza'],
                target: ['L-13', 'L-29']
            },
            'McMurryBiologico': {
                editore: 'Zanichelli',
                caratteristiche: ['Orientamento biologico', 'Collegamenti biochimica', 'Biomolecole approfondite'],
                punti_forza: ['Integrazione biologica continua', 'Preparazione ottimale per Biochimica', 'Meccanismi dettagliati'],
                target: ['L-13', 'L-2', 'L-29']
            },
            'Hart': {
                editore: 'Zanichelli',
                caratteristiche: ['Sintesi e chiarezza', 'Biomolecole presenti', 'Esercizi graduati'],
                punti_forza: ['Concisione', 'Linguaggio accessibile', 'Buona copertura argomenti base'],
                target: ['L-13', 'L-25', 'L-32']
            },
            'McMurryFondamenti': {
                editore: 'Zanichelli',
                caratteristiche: ['Versione compatta', 'Meccanismi approfonditi', 'Stereochimica dettagliata'],
                punti_forza: ['Rigore scientifico', 'Concisione', 'Linguaggio preciso'],
                target: ['L-27', 'Ingegneria']
            }
        };

        // Database indici manuali Zanichelli (per Fase C - Post-it)
        const INDICI_MANUALI = {"versione":"2.0","data_aggiornamento":"2025-11-09","manuali":[{"id":"hart","nome":"Hart - Fondamenti di chimica organica","editore":"Zanichelli","pagine_totali":520,"capitoli":[{"numero":1,"titolo":"Il legame chimico e l'isomeria","pagina_inizio":1},{"numero":2,"titolo":"Gli alcani e i cicloalcani","pagina_inizio":37},{"numero":3,"titolo":"Gli alcheni e gli alchini","pagina_inizio":68},{"numero":4,"titolo":"I composti aromatici","pagina_inizio":113},{"numero":5,"titolo":"La stereoisomeria","pagina_inizio":140},{"numero":6,"titolo":"Composti organici alogenati","pagina_inizio":170},{"numero":7,"titolo":"Gli alcoli, i fenoli e i tioli","pagina_inizio":193},{"numero":8,"titolo":"Gli eteri e gli epossidi","pagina_inizio":220},{"numero":9,"titolo":"Le aldeidi e i chetoni","pagina_inizio":238},{"numero":10,"titolo":"Acidi carbossilici e derivati","pagina_inizio":272},{"numero":11,"titolo":"Le ammine e altri composti azotati","pagina_inizio":309},{"numero":12,"titolo":"La spettroscopia","pagina_inizio":333},{"numero":13,"titolo":"I composti eterociclici","pagina_inizio":360},{"numero":14,"titolo":"I polimeri sintetici","pagina_inizio":379},{"numero":15,"titolo":"I lipidi e i detergenti","pagina_inizio":405},{"numero":16,"titolo":"I carboidrati","pagina_inizio":426},{"numero":17,"titolo":"Amminoacidi, peptidi e proteine","pagina_inizio":455},{"numero":18,"titolo":"I nucleotidi e gli acidi nucleici","pagina_inizio":486}]},{"id":"mcmurry_fondamenti","nome":"McMurry - Fondamenti di chimica organica","editore":"Zanichelli","pagine_totali":896,"capitoli":[{"numero":1,"titolo":"Struttura e legame chimico; acidi e basi","pagina_inizio":1},{"numero":2,"titolo":"I composti organici: gli alcani","pagina_inizio":31},{"numero":3,"titolo":"Gli alcheni e gli alchini: le reazioni organiche","pagina_inizio":66},{"numero":4,"titolo":"Le reazioni degli alcheni e degli alchini","pagina_inizio":94},{"numero":5,"titolo":"I composti aromatici","pagina_inizio":131},{"numero":6,"titolo":"La stereochimica dei centri tetraedrici","pagina_inizio":161},{"numero":7,"titolo":"Gli organoalogenuri: sostituzioni nucleofile ed eliminazioni","pagina_inizio":190},{"numero":8,"titolo":"Alcoli, fenoli, eteri e loro analoghi solforati","pagina_inizio":221},{"numero":9,"titolo":"Aldeidi e chetoni: le reazioni di addizione nucleofila","pagina_inizio":255},{"numero":10,"titolo":"Gli acidi carbossilici e i loro derivati: reazioni di sostituzione nucleofila acilica","pagina_inizio":281},{"numero":11,"titolo":"Le reazioni di sostituzione in alfa al carbonile e le reazioni di condensazione","pagina_inizio":321},{"numero":12,"titolo":"Le ammine","pagina_inizio":348},{"numero":13,"titolo":"La determinazione della struttura","pagina_inizio":373},{"numero":14,"titolo":"Le biomolecole: i carboidrati","pagina_inizio":404},{"numero":15,"titolo":"Le biomolecole: amminoacidi, peptidi e proteine","pagina_inizio":432},{"numero":16,"titolo":"Le biomolecole: i lipidi e gli acidi nucleici","pagina_inizio":462},{"numero":17,"titolo":"La chimica organica dei percorsi metabolici","pagina_inizio":490}]},{"id":"mcmurry_biologico","nome":"McMurry - Chimica organica: un approccio biologico","editore":"Zanichelli","pagine_totali":1152,"capitoli":[{"numero":1,"titolo":"La struttura e il legame","pagina_inizio":1},{"numero":2,"titolo":"I legami covalenti polari; gli acidi e le basi","pagina_inizio":27},{"numero":3,"titolo":"I composti organici: gli alcani e la loro stereochimica","pagina_inizio":57},{"numero":4,"titolo":"I composti organici: i cicloalcani e la loro stereochimica","pagina_inizio":85},{"numero":5,"titolo":"Una panoramica sulle reazioni organiche","pagina_inizio":109},{"numero":6,"titolo":"Gli alcheni e gli alchini","pagina_inizio":140},{"numero":7,"titolo":"Le reazioni degli alcheni e degli alchini","pagina_inizio":170},{"numero":8,"titolo":"I composti aromatici","pagina_inizio":205},{"numero":9,"titolo":"La stereochimica","pagina_inizio":247},{"numero":10,"titolo":"Gli alogenuri alchilici: le sostituzioni nucleofile e le eliminazioni","pagina_inizio":281},{"numero":11,"titolo":"La determinazione della struttura: spettrometria di massa, spettroscopia infrarossa e ultravioletta","pagina_inizio":323},{"numero":12,"titolo":"La determinazione della struttura: la spettroscopia di risonanza magnetica nucleare","pagina_inizio":355},{"numero":13,"titolo":"Gli alcoli, i fenoli e i tioli; gli eteri e i solfuri","pagina_inizio":390},{"numero":14,"titolo":"Le aldeidi e i chetoni: le reazioni di addizione nucleofila","pagina_inizio":436},{"numero":15,"titolo":"Gli acidi carbossilici e i nitrili","pagina_inizio":470},{"numero":16,"titolo":"I derivati degli acidi carbossilici: le reazioni di sostituzione nucleofila acilica","pagina_inizio":494},{"numero":17,"titolo":"Le reazioni dei composti carbonilici in posizione alfa","pagina_inizio":525},{"numero":18,"titolo":"Le ammine e gli eterocicli","pagina_inizio":557},{"numero":19,"titolo":"Le biomolecole: i carboidrati","pagina_inizio":595},{"numero":20,"titolo":"Le biomolecole: gli amminoacidi, i peptidi e le proteine","pagina_inizio":636},{"numero":21,"titolo":"Le biomolecole: gli enzimi e la vitamina","pagina_inizio":676},{"numero":22,"titolo":"Le biomolecole: i lipidi","pagina_inizio":710},{"numero":23,"titolo":"Le biomolecole: gli acidi nucleici","pagina_inizio":747},{"numero":24,"titolo":"La chimica organica dei percorsi metabolici","pagina_inizio":779}]}]};

        // Variabili globali
        let currentProgramma = null;
        let fileContent = null;
        let postItGenerati = [];
        
        // Variabili MATRIX
        let MATRIX_CONFIG = null;
        let FRAMEWORK_CATALOG = null;
        let MANUAL_CATALOG = null;
        let CURRENT_FRAMEWORK = null;

        // Funzioni MATRIX - Caricamento configurazione
        async function loadMATRIXConfig() {
            try {
                console.log('üîÑ Inizio caricamento MATRIX Config...');
                
                const [config, frameworks, manuals] = await Promise.all([
                    fetch('matrix_config.json').then(r => {
                        console.log('üì• Caricato matrix_config.json');
                        return r.json();
                    }),
                    fetch('framework_catalog.json').then(r => {
                        console.log('üì• Caricato framework_catalog.json');
                        return r.json();
                    }),
                    fetch('manual_catalog.json').then(r => {
                        console.log('üì• Caricato manual_catalog.json');
                        return r.json();
                    })
                ]);
                
                console.log('üì¶ Config ricevuto:', config);
                console.log('üì¶ Frameworks ricevuto:', frameworks);
                console.log('üì¶ Manuals ricevuto:', manuals);
                
                MATRIX_CONFIG = config;
                FRAMEWORK_CATALOG = frameworks;
                MANUAL_CATALOG = manuals;
                
                console.log('‚úÖ Variabili globali assegnate');
                console.log('üîç window.FRAMEWORK_CATALOG dopo assegnazione:', window.FRAMEWORK_CATALOG);
                
                console.log('‚úÖ MATRIX Config caricato:', {
                    subjects: MATRIX_CONFIG?.supported_subjects?.length || 0,
                    frameworks: FRAMEWORK_CATALOG?.total_frameworks || 0,
                    manuals: MANUAL_CATALOG?.total_manuals || 0
                });
                console.log('üìã FRAMEWORK_CATALOG:', FRAMEWORK_CATALOG);
                
                populateMateriaDropdown();
            } catch (error) {
                console.error('‚ùå Errore caricamento MATRIX Config:', error);
                console.error('‚ùå Stack trace:', error.stack);
                alert('Errore caricamento configurazione MATRIX. Ricarica la pagina.');
            }
        }

        // Popola dropdown materie
        function populateMateriaDropdown() {
            const select = document.getElementById('materiaSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">üìö Seleziona materia...</option>';
            
            MATRIX_CONFIG.supported_subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.icon} ${subject.name}`;
                select.appendChild(option);
            });
        }

        // Popola dropdown framework in base alla materia selezionata
        function populateFrameworkDropdown(subject) {
            const select = document.getElementById('frameworkSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona framework...</option>';
            
            subject.frameworks.forEach(frameworkId => {
                const framework = FRAMEWORK_CATALOG.frameworks.find(f => f.id === frameworkId);
                if (framework) {
                    const option = document.createElement('option');
                    option.value = framework.filepath;
                    option.textContent = framework.name;
                    option.dataset.subject = framework.subject;
                    select.appendChild(option);
                }
            });
        }

        // Carica framework JSON e popola form
        async function loadFramework(frameworkPath, frameworkName) {
            try {
                const framework = await fetch(frameworkPath).then(r => r.json());
                CURRENT_FRAMEWORK = framework;
                window.lastFrameworkPath = frameworkPath; // Salva per uso in avviaAnalisi()
                
                console.log('‚úÖ Framework caricato:', frameworkPath);
                
                // Popola contesti dal framework
                populateContestoSelect(framework.content.program_profiles);
                
                // Ottieni il subject dal framework per filtrare i manuali
                const frameworkObj = FRAMEWORK_CATALOG.frameworks.find(f => f.filepath === frameworkPath);
                const frameworkSubject = frameworkObj ? frameworkObj.subject : frameworkName;
                
                console.log('üîç Filtro manuali per subject:', frameworkSubject);
                
                // Popola manuali (principali e alternativi) filtrati per subject
                populateManualeSelect(frameworkSubject);
                populateManualiAlternativi(frameworkSubject);
                
                // Mostra conferma
                const displayName = frameworkPath.split('/').pop().replace('.json', '');
                document.getElementById('frameworkInfo').style.display = 'block';
                document.getElementById('frameworkName').textContent = displayName;
                
                // Aggiorna subtitle header
                const headerSubtitle = document.getElementById('headerSubtitle');
                if (headerSubtitle && frameworkObj) {
                    headerSubtitle.textContent = `${frameworkObj.name} - Analisi Multi-Editore`;
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento framework:', error);
                alert('Errore caricamento framework. Riprova.');
            }
        }

        // Popola dropdown contesti dal framework
        function populateContestoSelect(profiles) {
            const select = document.getElementById('contestoSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona contesto...</option>';
            
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.name;
                option.textContent = profile.name;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ Caricati ${profiles.length} contesti`);
        }

        // Popola dropdown manuali filtrati per subject
        function populateManualeSelect(frameworkSubject) {
            const select = document.getElementById('manualeSelect');
            if (!select || !MANUAL_CATALOG) return;
            
            // Filtra manuali per subject
            const manualsForSubject = Object.values(MANUAL_CATALOG.manuals).filter(m => 
                m.subject === frameworkSubject
            );
            
            // Separa Zanichelli e Competitor
            const zanichelli = manualsForSubject.filter(m => m.type === 'zanichelli');
            const competitor = manualsForSubject.filter(m => m.type === 'competitor');
            
            select.innerHTML = '<option value="">Seleziona manuale principale...</option>';
            
            // Optgroup Zanichelli
            if (zanichelli.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìó Manuali Zanichelli';
                zanichelli.forEach(manual => {
                    const option = document.createElement('option');
                    option.value = manual.id;
                    // Mostra: Autore - Titolo (Editore)
                    option.textContent = manual.author 
                        ? `${manual.author} - ${manual.title}` 
                        : `${manual.title} (${manual.publisher})`;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Optgroup Altri Editori
            if (competitor.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìï Altri Editori';
                competitor.forEach(manual => {
                    const option = document.createElement('option');
                    option.value = manual.id;
                    // Mostra: Autore - Titolo (Editore)
                    option.textContent = manual.author 
                        ? `${manual.author} - ${manual.title} (${manual.publisher})` 
                        : `${manual.title} (${manual.publisher})`;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Opzione "Altro"
            const optionAltro = document.createElement('option');
            optionAltro.value = 'Altro';
            optionAltro.textContent = 'Altro manuale (specificare sotto)';
            select.appendChild(optionAltro);
            
            console.log(`‚úÖ Caricati ${manualsForSubject.length} manuali (${zanichelli.length} Zanichelli, ${competitor.length} Competitor)`);
        }

        // Popola checkbox manuali alternativi filtrati per subject
        function populateManualiAlternativi(frameworkSubject) {
            // Trova i container dei manuali alternativi
            const zanichellContainer = document.querySelector('.space-y-2.bg-gray-50 > div:first-child');
            const competitorContainer = document.querySelector('.space-y-2.bg-gray-50 > div:nth-child(2)');
            
            if (!zanichellContainer || !competitorContainer || !MANUAL_CATALOG) return;
            
            // Filtra manuali per subject
            const manualsForSubject = Object.values(MANUAL_CATALOG.manuals).filter(m => 
                m.subject === frameworkSubject
            );
            
            // Separa Zanichelli e Competitor
            const zanichelli = manualsForSubject.filter(m => m.type === 'zanichelli');
            const competitor = manualsForSubject.filter(m => m.type === 'competitor');
            
            // Popola Zanichelli
            const zanichellHTML = zanichelli.map(manual => `
                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                    <input type="checkbox" id="alt${manual.id}" value="${manual.id}" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="text-sm text-gray-700">${manual.author ? `${manual.author} - ${manual.title}` : manual.title}</span>
                </label>
            `).join('');
            
            // Popola Competitor
            const competitorHTML = competitor.map(manual => `
                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                    <input type="checkbox" id="alt${manual.id}" value="${manual.id}" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="text-sm text-gray-700">${manual.author ? `${manual.author} - ${manual.title} (${manual.publisher})` : `${manual.title} (${manual.publisher})`}</span>
                </label>
            `).join('');
            
            // Aggiorna i container (mantiene il titolo "Zanichelli" / "Altri Editori")
            const zanichellTitle = zanichellContainer.querySelector('.text-xs.font-semibold');
            if (zanichellTitle) {
                zanichellContainer.innerHTML = '';
                zanichellContainer.appendChild(zanichellTitle);
                zanichellContainer.insertAdjacentHTML('beforeend', zanichellHTML);
            }
            
            const competitorTitle = competitorContainer.querySelector('.text-xs.font-semibold');
            if (competitorTitle) {
                competitorContainer.innerHTML = '';
                competitorContainer.appendChild(competitorTitle);
                competitorContainer.insertAdjacentHTML('beforeend', competitorHTML);
            }
            
            console.log(`‚úÖ Popolati ${zanichelli.length} manuali alternativi Zanichelli, ${competitor.length} Competitor`);
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async function() {
            // Carica configurazione MATRIX e ASPETTA che finisca
            await loadMATRIXConfig();
            
            // Event listener cambio materia
            const materiaSelect = document.getElementById('materiaSelect');
            if (materiaSelect) {
                materiaSelect.addEventListener('change', function() {
                    const materiaId = this.value;
                    const frameworkContainer = document.getElementById('frameworkContainer');
                    const frameworkInfo = document.getElementById('frameworkInfo');
                    
                    if (!materiaId) {
                        frameworkContainer.style.display = 'none';
                        frameworkInfo.style.display = 'none';
                        return;
                    }
                    
                    const subject = MATRIX_CONFIG.supported_subjects.find(s => s.id === materiaId);
                    if (subject) {
                        populateFrameworkDropdown(subject);
                        frameworkContainer.style.display = 'block';
                        frameworkInfo.style.display = 'none';
                    }
                });
            }
            
            // Event listener cambio framework
            const frameworkSelect = document.getElementById('frameworkSelect');
            if (frameworkSelect) {
                frameworkSelect.addEventListener('change', function() {
                    const frameworkPath = this.value;
                    if (!frameworkPath) return;
                    
                    const selectedOption = this.options[this.selectedIndex];
                    const frameworkName = selectedOption.textContent; // Nome completo del framework
                    
                    loadFramework(frameworkPath, frameworkName);
                });
            }
            checkApiKey();
            showView('upload');
            
            // Listener per mostrare/nascondere campo "Altro manuale"
            const manualeSelect = document.getElementById('manualeSelect');
            const altroManualeField = document.getElementById('altroManualeField');
            
            if (manualeSelect && altroManualeField) {
                manualeSelect.addEventListener('change', function() {
                    if (this.value === 'Altro') {
                        altroManualeField.style.display = 'block';
                    } else {
                        altroManualeField.style.display = 'none';
                    }
                });
            }
        });

        // Gestione Configurazione
        function checkApiKey() {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const apiKeyOpenAI = localStorage.getItem('openai_api_key');
            const apiKeyPerplexity = localStorage.getItem('perplexity_api_key');
            const badge = document.getElementById('apiKeyBadge');
            
            // Per OpenAI: permetti uso anche senza chiave (user√† quella di default su Netlify)
            // Per Perplexity: richiedi sempre la chiave
            const hasKey = (provider === 'openai') || (provider === 'perplexity' && apiKeyPerplexity);
            
            if (hasKey) {
                const providerName = provider === 'openai' ? 'OpenAI' : 'Perplexity';
                const isUsingDefault = provider === 'openai' && !apiKeyOpenAI;
                if (isUsingDefault) {
                    badge.textContent = `‚úì ${providerName} (Test)`;
                    badge.className = 'px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full';
                } else {
                    badge.textContent = `‚úì ${providerName}`;
                    badge.className = 'px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full';
                }
                badge.classList.remove('hidden');
            } else {
                document.getElementById('welcomeBanner')?.classList.remove('hidden');
                badge.textContent = '‚ö† API Non Configurata';
                badge.className = 'px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full';
                badge.classList.remove('hidden');
            }
        }

        // Selezione Provider
        function selectProvider(provider) {
            localStorage.setItem('ai_provider', provider);
            
            // Aggiorna UI bottoni
            const btnOpenAI = document.getElementById('btnProviderOpenAI');
            const btnPerplexity = document.getElementById('btnProviderPerplexity');
            const configOpenAI = document.getElementById('configOpenAI');
            const configPerplexity = document.getElementById('configPerplexity');
            
            if (provider === 'openai') {
                btnOpenAI.className = 'px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100';
                btnPerplexity.className = 'px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50';
                configOpenAI.classList.remove('hidden');
                configPerplexity.classList.add('hidden');
            } else {
                btnPerplexity.className = 'px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100';
                btnOpenAI.className = 'px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50';
                configPerplexity.classList.remove('hidden');
                configOpenAI.classList.add('hidden');
            }
        }

        function saveConfiguration() {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const status = document.getElementById('configStatus');
            
            if (provider === 'openai') {
                const apiKey = document.getElementById('apiKeyOpenAI').value.trim();
                const model = document.getElementById('modelOpenAI').value;
                
                if (!apiKey) {
                    showConfigStatus('Inserisci una chiave API OpenAI valida', 'error');
                    return;
                }
                
                if (!apiKey.startsWith('sk-')) {
                    showConfigStatus('La chiave API OpenAI deve iniziare con "sk-"', 'error');
                    return;
                }
                
                localStorage.setItem('openai_api_key', apiKey);
                localStorage.setItem('openai_model', model);
                showConfigStatus('Configurazione OpenAI salvata con successo!', 'success');
            } else {
                const apiKey = document.getElementById('apiKeyPerplexity').value.trim();
                const model = document.getElementById('modelPerplexity').value;
                
                if (!apiKey) {
                    showConfigStatus('Inserisci una chiave API Perplexity valida', 'error');
                    return;
                }
                
                if (!apiKey.startsWith('pplx-')) {
                    showConfigStatus('La chiave API Perplexity deve iniziare con "pplx-"', 'error');
                    return;
                }
                
                localStorage.setItem('perplexity_api_key', apiKey);
                localStorage.setItem('perplexity_model', model);
                showConfigStatus('Configurazione Perplexity salvata con successo!', 'success');
            }
            
            checkApiKey();
            
            setTimeout(() => {
                showView('upload');
            }, 1500);
        }

        function showConfigStatus(message, type) {
            const status = document.getElementById('configStatus');
            status.textContent = message;
            status.className = `p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            status.classList.remove('hidden');
        }
        
        // Carica configurazione salvata all'apertura settings
        function loadSavedConfiguration() {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const openaiKey = localStorage.getItem('openai_api_key') || '';
            const openaiModel = localStorage.getItem('openai_model') || 'gpt-4.1-mini';
            const perplexityKey = localStorage.getItem('perplexity_api_key') || '';
            const perplexityModel = localStorage.getItem('perplexity_model') || 'llama-3.1-sonar-large-128k-online';
            
            // Imposta provider
            selectProvider(provider);
            
            // Carica valori
            if (document.getElementById('apiKeyOpenAI')) {
                document.getElementById('apiKeyOpenAI').value = openaiKey;
                document.getElementById('modelOpenAI').value = openaiModel;
                document.getElementById('apiKeyPerplexity').value = perplexityKey;
                document.getElementById('modelPerplexity').value = perplexityModel;
            }
        }

        // Gestione tipo analisi (cambio stile radio buttons)
        document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('input[name="tipoAnalisi"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Rimuovi stile selezionato da tutti
                    document.querySelectorAll('input[name="tipoAnalisi"]').forEach(r => {
                        const label = r.closest('label');
                        label.classList.remove('border-indigo-600', 'bg-indigo-50');
                        label.classList.add('border-gray-300');
                    });
                    // Aggiungi stile selezionato
                    if (this.checked) {
                        const label = this.closest('label');
                        label.classList.remove('border-gray-300');
                        label.classList.add('border-indigo-600', 'bg-indigo-50');
                    }
                });
            });
        });

        // Gestione views
        function showView(viewName) {
            const views = ['viewSettings', 'viewUpload', 'viewRisultati', 'viewStorico'];
            const buttons = ['btnSettings', 'btnUpload', 'btnStorico'];
            
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            
            buttons.forEach(btn => {
                const button = document.getElementById(btn);
                if (button) {
                    button.classList.remove('bg-indigo-600', 'text-white');
                    button.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                }
            });
            
            document.getElementById('view' + viewName.charAt(0).toUpperCase() + viewName.slice(1)).classList.remove('hidden');
            
            if (viewName === 'storico') {
                loadStorico();
            } else if (viewName === 'settings') {
                loadSavedConfiguration();
            }
            
            const activeBtn = document.getElementById('btn' + viewName.charAt(0).toUpperCase() + viewName.slice(1));
            if (activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                activeBtn.classList.add('bg-indigo-600', 'text-white');
            }
        }
        
        // Tab switching function (for tabs inside viewUpload)
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('border-indigo-500', 'text-indigo-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            const selectedContent = document.getElementById('tabContent' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }
            
            // Activate selected tab button
            const selectedButton = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedButton) {
                selectedButton.classList.remove('border-transparent', 'text-gray-500');
                selectedButton.classList.add('border-indigo-500', 'text-indigo-600');
            }
            
            // Se √® il tab Cataloghi, carica i manuali
            if (tabName === 'cataloghi') {
                loadManualiList();
            }
            
            // Se √® il tab Valutazione, inizializza
            if (tabName === 'valutazione') {
                evalAbs_initTab();
            }
        }
        
        // ============================================
        // GESTIONE CATALOGHI - SUB TABS
        // ============================================
        
        function switchCatalogTab(tabName) {
            // Hide all catalog tab contents
            const catalogTabs = document.querySelectorAll('.catalog-tab-content');
            catalogTabs.forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all catalog tab buttons
            const catalogButtons = document.querySelectorAll('.catalog-tab-btn');
            catalogButtons.forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600', 'active');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected catalog tab
            const selectedTab = document.getElementById('catalogTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            }
            
            // Activate selected button
            const selectedBtn = document.getElementById('btnTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedBtn) {
                selectedBtn.classList.remove('border-transparent', 'text-gray-500');
                selectedBtn.classList.add('border-indigo-500', 'text-indigo-600', 'active');
            }
            
            // Load data for the selected tab
            if (tabName === 'manuali') {
                loadManualiList();
            } else if (tabName === 'framework') {
                loadFrameworkList();
            }
        }
        
        // ============================================
        // CRUD MANUALI - VARIABILI GLOBALI
        // ============================================
        
        let currentManualeData = null; // JSON caricato dall'utente
        let editingManualeId = null; // ID del manuale in modifica (null = nuovo)
        
        // Helper function: converte MANUAL_CATALOG.manuals (array) in oggetto {id: manual}
        function getManualsAsObject() {
            if (!MANUAL_CATALOG || !MANUAL_CATALOG.manuals) {
                console.error('‚ùå MANUAL_CATALOG non disponibile');
                return {};
            }
            
            const manuals = {};
            MANUAL_CATALOG.manuals.forEach(manual => {
                if (manual.id) {
                    manuals[manual.id] = manual;
                }
            });
            return manuals;
        }
        
        // Mapping subject legacy ‚Üí macroarea/materia
        const SUBJECT_TO_MACROAREA_MATERIA = {
            'Chimica Generale': { macroarea: 'Chimica', materia: 'Chimica Generale' },
            'Chimica Organica': { macroarea: 'Chimica', materia: 'Chimica Organica' },
            'Chimica': { macroarea: 'Chimica', materia: 'Chimica Generale' },
            'Fisica': { macroarea: 'Fisica', materia: 'Fisica Generale' },
            'Matematica': { macroarea: 'Matematica', materia: 'Matematica Generale' },
            'Economia': { macroarea: 'Economia', materia: 'Economia Politica' },
            'Biologia': { macroarea: 'Biologia', materia: 'Biologia Generale' },
            'Istologia': { macroarea: 'Istologia', materia: 'Istologia ed Embriologia' }
        };
        
        // ============================================
        // CRUD MANUALI - REGISTRY MATERIE
        // ============================================
        
        function getMaterieRegistry() {
            return JSON.parse(localStorage.getItem('materie_registry') || '{}');
        }
        
        function saveMaterieRegistry(registry) {
            localStorage.setItem('materie_registry', JSON.stringify(registry));
        }
        
        function addMateriaToRegistry(macroarea, materia) {
            const registry = getMaterieRegistry();
            if (!registry[macroarea]) {
                registry[macroarea] = [];
            }
            if (!registry[macroarea].includes(materia)) {
                registry[macroarea].push(materia);
                registry[macroarea].sort();
                saveMaterieRegistry(registry);
            }
        }
        
        function getMaterieForMacroarea(macroarea) {
            const registry = getMaterieRegistry();
            return registry[macroarea] || [];
        }
        
        function mapSubjectToMacroareaMateria(subject) {
            // Prima controlla mapping predefinito
            if (SUBJECT_TO_MACROAREA_MATERIA[subject]) {
                return SUBJECT_TO_MACROAREA_MATERIA[subject];
            }
            
            // Prova a dedurre da registry
            const registry = getMaterieRegistry();
            for (const [macroarea, materie] of Object.entries(registry)) {
                if (materie.includes(subject)) {
                    return { macroarea, materia: subject };
                }
            }
            
            // Fallback: usa subject come entrambi
            return { macroarea: subject, materia: subject };
        }
        
        function updateMaterieAutocomplete() {
            const macroarea = document.getElementById('manualeMacroarea').value;
            const datalist = document.getElementById('materieDatalist');
            
            if (!datalist) return;
            
            const materie = getMaterieForMacroarea(macroarea);
            datalist.innerHTML = materie.map(m => `<option value="${m}">`).join('');
        }
        
        function filterMaterieDatalist() {
            // Placeholder per futuri miglioramenti (filtro dinamico)
        }
        
        // ============================================
        // CRUD MANUALI - CARICAMENTO LISTA
        // ============================================
        
        async function loadManualiList() {
            console.log('üìö Caricamento lista manuali...');
            
            try {
                // Carica manuali originali dal catalog
                if (!MANUAL_CATALOG || !MANUAL_CATALOG.manuals) {
                    console.error('‚ùå MANUAL_CATALOG non caricato o vuoto');
                    alert('Errore: il catalogo manuali non √® stato caricato. Ricarica la pagina.');
                    return;
                }
                
                // CONVERTI ARRAY IN OGGETTO (manuals √® un array!)
                const originalManuals = {};
                MANUAL_CATALOG.manuals.forEach(manual => {
                    if (manual.id) {
                        originalManuals[manual.id] = manual;
                    }
                });
                
                console.log(`üì¶ Manuali originali caricati: ${Object.keys(originalManuals).length}`);
                
                // Carica manuali custom da localStorage
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                console.log(`üÜï Manuali custom: ${Object.keys(customManuals).length}`);
                
                // Carica modifiche da localStorage
                const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                console.log(`‚úèÔ∏è Manuali modificati: ${Object.keys(modifiedManuals).length}`);
                
                // Merge: modifiche sovrascrivono originali, custom si aggiungono
                const allManuals = {
                    ...originalManuals,
                    ...modifiedManuals,
                    ...customManuals
                };
                
                console.log(`‚úÖ Totale manuali caricati: ${Object.keys(allManuals).length}`);
                
                // Popola registry materie da manuali esistenti
                populateRegistryFromManuals(allManuals);
                
                // Popola la tabella
                displayManualiTable(allManuals, customManuals, modifiedManuals);
                
            } catch (error) {
                console.error('‚ùå Errore caricamento manuali:', error);
                alert('Errore nel caricamento dei manuali: ' + error.message);
            }
        }
        
        function populateRegistryFromManuals(manuals) {
            console.log('üîÑ Popolamento registry materie da manuali esistenti...');
            
            let processedCount = 0;
            Object.values(manuals).forEach(manuale => {
                try {
                    // Se ha gi√† macroarea/materia, aggiungili
                    if (manuale.macroarea && manuale.materia) {
                        addMateriaToRegistry(manuale.macroarea, manuale.materia);
                        processedCount++;
                    } 
                    // Altrimenti mappa da subject legacy
                    else if (manuale.subject) {
                        const mapped = mapSubjectToMacroareaMateria(manuale.subject);
                        addMateriaToRegistry(mapped.macroarea, mapped.materia);
                        processedCount++;
                    }
                } catch (error) {
                    console.error('‚ùå Errore popolamento registry per', manuale.id, error);
                }
            });
            
            const registry = getMaterieRegistry();
            console.log(`‚úÖ Registry popolato con ${processedCount} manuali processati:`, registry);
            console.log(`üìä Materie per macroarea:`, Object.keys(registry).map(m => `${m} (${registry[m].length})`).join(', '));
        }
        
        function displayManualiTable(allManuals, customManuals, modifiedManuals) {
            console.log('üìä Rendering tabella manuali...');
            
            const tbody = document.getElementById('manualiTableBody');
            if (!tbody) {
                console.error('‚ùå Elemento manualiTableBody non trovato!');
                return;
            }
            
            // Reset filtri su "Tutte" di default
            const filterMacroarea = document.getElementById('filterMacroarea');
            const filterMateria = document.getElementById('filterMateria');
            const filterEditore = document.getElementById('filterEditore');
            const filterTipo = document.getElementById('filterTipo');
            const searchInput = document.getElementById('searchManuali');
            
            if (filterMacroarea) filterMacroarea.value = '';
            if (filterMateria) filterMateria.value = '';
            if (filterEditore) filterEditore.value = '';
            if (filterTipo) filterTipo.value = '';
            if (searchInput) searchInput.value = '';
            
            console.log('üîÑ Filtri resettati su "Tutte"');
            
            tbody.innerHTML = '';
            
            const manualiArray = Object.values(allManuals);
            console.log(`üìã Manuali da visualizzare: ${manualiArray.length}`);
            
            // Raccogli tutte le materie uniche per il filtro
            const materieSet = new Set();
            
            // Sort per macroarea, materia e titolo
            manualiArray.sort((a, b) => {
                try {
                    // Gestisci legacy: se esiste subject ma non macroarea, mappa
                    if (!a.macroarea && a.subject) {
                        const mapped = mapSubjectToMacroareaMateria(a.subject);
                        a.macroarea = mapped.macroarea;
                        a.materia = mapped.materia;
                        console.log(`üîÑ Mapped ${a.id}: ${a.subject} ‚Üí ${a.macroarea} / ${a.materia}`);
                    }
                    if (!b.macroarea && b.subject) {
                        const mapped = mapSubjectToMacroareaMateria(b.subject);
                        b.macroarea = mapped.macroarea;
                        b.materia = mapped.materia;
                        console.log(`üîÑ Mapped ${b.id}: ${b.subject} ‚Üí ${b.macroarea} / ${b.materia}`);
                    }
                    
                    const macroareaA = a.macroarea || '';
                    const macroareaB = b.macroarea || '';
                    const materiaA = a.materia || '';
                    const materiaB = b.materia || '';
                    const titleA = a.title || '';
                    const titleB = b.title || '';
                    
                    if (macroareaA !== macroareaB) return macroareaA.localeCompare(macroareaB);
                    if (materiaA !== materiaB) return materiaA.localeCompare(materiaB);
                    return titleA.localeCompare(titleB);
                } catch (error) {
                    console.error('‚ùå Errore nel sort:', error, 'A:', a.id, 'B:', b.id);
                    return 0; // Fallback: mantieni ordine originale
                }
            });
            
            console.log(`üìã Dopo sort: ${manualiArray.length} manuali`);
            console.log(`üìù Primi 3 manuali:`, manualiArray.slice(0, 3).map(m => ({ id: m.id, macroarea: m.macroarea, materia: m.materia })));
            
            manualiArray.forEach(manuale => {
                try {
                    // Gestisci legacy mapping
                    if (!manuale.macroarea && manuale.subject) {
                        const mapped = mapSubjectToMacroareaMateria(manuale.subject);
                        manuale.macroarea = mapped.macroarea;
                        manuale.materia = mapped.materia;
                    }
                    
                    // Aggiungi materia al set per filtro
                    if (manuale.materia) materieSet.add(manuale.materia);
                    
                    const isCustom = customManuals[manuale.id];
                    const isModified = modifiedManuals[manuale.id];
                    
                    const badge = isCustom ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">üîµ Custom</span>' :
                                  isModified ? '<span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded">üü° Modificato</span>' :
                                  '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">üü¢ Originale</span>';
                    
                    const tipoBadge = manuale.type === 'zanichelli' ? 
                        '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Zanichelli</span>' :
                        '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">Competitor</span>';
                    
                    const row = document.createElement('tr');
                    row.className = 'manuale-row hover:bg-gray-50';
                    row.dataset.id = manuale.id || '';
                    row.dataset.macroarea = manuale.macroarea || '';
                    row.dataset.materia = manuale.materia || '';
                    row.dataset.publisher = manuale.publisher || '';
                    row.dataset.type = manuale.type || '';
                    row.dataset.title = manuale.title || '';
                    row.dataset.author = manuale.author || '';
                    
                    row.innerHTML = `
                        <td class="px-1 py-1 text-xs text-gray-500 w-20 break-words">${manuale.id || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs w-28">
                            <div class="font-medium text-gray-900 break-words">${manuale.title || '‚Äî'}</div>
                            <div class="text-xs text-gray-500">${badge}</div>
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-20 break-words">${manuale.author || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-16 break-words">${manuale.publisher || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-16 break-words">${manuale.macroarea || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-24 break-words">${manuale.materia || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-10 text-center">${manuale.chapters_count || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs w-16">${tipoBadge}</td>
                        <td class="px-1 py-1 text-sm font-medium w-14 whitespace-nowrap">
                            <button onclick="editManuale('${manuale.id}')" class="text-indigo-600 hover:text-indigo-900" title="Modifica">‚úèÔ∏è</button>
                            <button onclick="deleteManuale('${manuale.id}')" class="text-red-600 hover:text-red-900" title="Elimina">üóëÔ∏è</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                } catch (error) {
                    console.error('‚ùå Errore rendering manuale:', manuale.id, error);
                }
            });
            
            // Popola filtro materie dinamicamente
            populateFilterMaterie([...materieSet].sort());
            
            console.log(`‚úÖ Tabella popolata con ${tbody.children.length} righe`);
            
            // Se la tabella √® vuota, mostra un messaggio
            if (tbody.children.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                        <div class="text-lg mb-2">üì≠ Nessun manuale trovato</div>
                        <div class="text-sm">Prova a modificare i filtri o ad aggiungere un nuovo manuale</div>
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
            
            // Aggiorna contatore
            const countEl = document.getElementById('manualiCount');
            if (countEl) {
                const customCount = Object.keys(customManuals).length;
                const modifiedCount = Object.keys(modifiedManuals).length;
                const originalCount = manualiArray.length - customCount - modifiedCount;
                
                countEl.innerHTML = `
                    üìö <strong>${manualiArray.length}</strong> manuali totali
                    <span class="text-gray-400">‚Ä¢</span>
                    <span class="text-green-600">${originalCount} originali</span>
                    <span class="text-gray-400">‚Ä¢</span>
                    <span class="text-yellow-600">${modifiedCount} modificati</span>
                    <span class="text-gray-400">‚Ä¢</span>
                    <span class="text-blue-600">${customCount} custom</span>
                `;
            }
        }
        
        function populateFilterMaterie(materie) {
            const filterSelect = document.getElementById('filterMateria');
            if (!filterSelect) return;
            
            const currentValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">üìö Tutte le materie</option>';
            
            materie.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia;
                option.textContent = materia;
                filterSelect.appendChild(option);
            });
            
            // Ripristina valore selezionato
            if (currentValue && materie.includes(currentValue)) {
                filterSelect.value = currentValue;
            }
        }
        
        // ============================================
        // CRUD MANUALI - FILTRI
        // ============================================
        
        function filterManuali() {
            const searchTerm = document.getElementById('searchManuali').value.toLowerCase();
            const filterMacroarea = document.getElementById('filterMacroarea').value;
            const filterMateria = document.getElementById('filterMateria').value;
            const filterEditore = document.getElementById('filterEditore').value;
            const filterTipo = document.getElementById('filterTipo').value;
            
            const rows = document.querySelectorAll('.manuale-row');
            
            rows.forEach(row => {
                const title = row.dataset.title.toLowerCase();
                const author = row.dataset.author.toLowerCase();
                const macroarea = row.dataset.macroarea;
                const materia = row.dataset.materia;
                const publisher = row.dataset.publisher;
                const type = row.dataset.type;
                
                const matchSearch = title.includes(searchTerm) || author.includes(searchTerm);
                const matchMacroarea = !filterMacroarea || macroarea === filterMacroarea;
                const matchMateria = !filterMateria || materia === filterMateria;
                const matchEditore = !filterEditore || publisher === filterEditore;
                const matchTipo = !filterTipo || type === filterTipo;
                
                if (matchSearch && matchMacroarea && matchMateria && matchEditore && matchTipo) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // ============================================
        // CRUD MANUALI - MODAL AGGIUNGI/MODIFICA
        // ============================================
        
        function openAddManualeModal() {
            editingManualeId = null;
            currentManualeData = null;
            
            document.getElementById('manualeModalTitle').textContent = '‚ûï Nuovo Manuale';
            document.getElementById('manualeId').value = '';
            document.getElementById('manualeId').disabled = false;
            document.getElementById('manualeMacroarea').value = '';
            document.getElementById('manualeMateria').value = '';
            document.getElementById('manualeTipo').value = '';
            document.getElementById('manualeJsonFile').value = '';
            
            // Mostra STEP 2 (upload JSON) per nuovi manuali
            const step2Upload = document.querySelector('#manualeModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.remove('hidden');
            }
            
            document.getElementById('materieDatalist').innerHTML = '';
            document.getElementById('jsonFileInfo').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('jsonEditorSection').classList.add('hidden'); // Nascondi editor per nuovi
            document.getElementById('validationErrors').classList.add('hidden');
            
            document.getElementById('manualeModal').classList.remove('hidden');
        }
        
        function editManuale(manualeId) {
            console.log('‚úèÔ∏è Modifica manuale:', manualeId);
            
            // Carica dati del manuale
            const originalManuals = getManualsAsObject();
            const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
            const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
            const allManuals = { ...originalManuals, ...modifiedManuals, ...customManuals };
            
            console.log(`üîç Cercando manuale con ID: "${manualeId}"`);
            console.log(`üìä Totale manuali disponibili: ${Object.keys(allManuals).length}`);
            
            const manuale = allManuals[manualeId];
            if (!manuale) {
                console.error(`‚ùå Manuale "${manualeId}" non trovato in:`, Object.keys(allManuals).slice(0, 10));
                alert(`Manuale "${manualeId}" non trovato nel catalogo`);
                return;
            }
            
            console.log('‚úÖ Manuale trovato:', manuale);
            
            editingManualeId = manualeId;
            
            // Gestisci legacy: se esiste subject ma non macroarea, mappa
            if (!manuale.macroarea && manuale.subject) {
                const mapped = mapSubjectToMacroareaMateria(manuale.subject);
                manuale.macroarea = mapped.macroarea;
                manuale.materia = mapped.materia;
            }
            
            // Imposta titolo modal
            document.getElementById('manualeModalTitle').textContent = '‚úèÔ∏è Modifica Manuale';
            
            // STEP 1: Popola identificativi
            document.getElementById('manualeId').value = manuale.id || '';
            document.getElementById('manualeId').disabled = true; // ID non modificabile
            document.getElementById('manualeMacroarea').value = manuale.macroarea || '';
            document.getElementById('manualeMateria').value = manuale.materia || '';
            document.getElementById('manualeTipo').value = manuale.type || '';
            
            // Aggiorna autocomplete per la macroarea selezionata
            updateMaterieAutocomplete();
            
            // STEP 2: Nascondi upload JSON e mostra preview dati esistenti
            const step2Upload = document.querySelector('#manualeModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.add('hidden');
            }
            
            // Carica JSON completo se disponibile
            if (customManuals[manualeId]) {
                // Manuale custom: carica da localStorage
                currentManualeData = customManuals[manualeId];
                showPreview(currentManualeData);
                showJsonEditor(currentManualeData);
            } else if (manuale.filepath) {
                // Manuale originale: carica da file
                fetch(manuale.filepath)
                    .then(r => r.json())
                    .then(data => {
                        currentManualeData = data;
                        showPreview(currentManualeData);
                        showJsonEditor(currentManualeData);
                    })
                    .catch(err => {
                        console.error('‚ùå Errore caricamento JSON:', err);
                        // Mostra preview con dati base
                        showPreview(manuale);
                    });
            } else {
                // Nessun JSON disponibile, mostra dati base
                showPreview(manuale);
            }
            
            document.getElementById('validationErrors').classList.add('hidden');
            document.getElementById('manualeModal').classList.remove('hidden');
        }
        
        function closeManualeModal() {
            document.getElementById('manualeModal').classList.add('hidden');
            editingManualeId = null;
            currentManualeData = null;
        }
        
        // ============================================
        // CRUD MANUALI - UPLOAD E VALIDAZIONE JSON
        // ============================================
        
        async function handleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üìÅ Caricamento file JSON:', file.name);
            
            // Mostra info file
            document.getElementById('jsonFileName').textContent = file.name;
            document.getElementById('jsonFileSize').textContent = `${(file.size / 1024).toFixed(2)} KB`;
            document.getElementById('jsonFileInfo').classList.remove('hidden');
            
            try {
                const text = await file.text();
                const json = JSON.parse(text);
                
                console.log('‚úÖ JSON parsato con successo');
                
                // Valida struttura
                const errors = validateManualeJson(json);
                
                if (errors.length > 0) {
                    showValidationErrors(errors);
                    currentManualeData = null;
                    document.getElementById('previewSection').classList.add('hidden');
                    return;
                }
                
                // JSON valido
                currentManualeData = json;
                document.getElementById('validationErrors').classList.add('hidden');
                showPreview(json);
                
            } catch (error) {
                console.error('‚ùå Errore parsing JSON:', error);
                showValidationErrors(['Errore nel parsing del file JSON: ' + error.message]);
                currentManualeData = null;
            }
        }
        
        function validateManualeJson(json) {
            const errors = [];
            
            if (!json.id || typeof json.id !== 'string') {
                errors.push('Campo "id" obbligatorio (stringa)');
            }
            
            if (!json.title || typeof json.title !== 'string') {
                errors.push('Campo "title" obbligatorio (stringa)');
            }
            
            if (!json.author || typeof json.author !== 'string') {
                errors.push('Campo "author" obbligatorio (stringa)');
            }
            
            if (!json.chapters || !Array.isArray(json.chapters)) {
                errors.push('Campo "chapters" obbligatorio (array)');
            } else if (json.chapters.length === 0) {
                errors.push('Il manuale deve avere almeno un capitolo');
            }
            
            return errors;
        }
        
        function showValidationErrors(errors) {
            const errorList = document.getElementById('errorList');
            errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
            document.getElementById('validationErrors').classList.remove('hidden');
        }
        
        function showPreview(json) {
            document.getElementById('previewTitle').textContent = json.title || '‚Äî';
            document.getElementById('previewAuthor').textContent = json.author || '‚Äî';
            document.getElementById('previewPublisher').textContent = json.publisher || '‚Äî';
            document.getElementById('previewChapters').textContent = json.chapters ? json.chapters.length : '‚Äî';
            document.getElementById('previewPages').textContent = json.pages || '‚Äî';
            document.getElementById('previewPrice').textContent = json.price ? `‚Ç¨${json.price}` : '‚Äî';
            
            document.getElementById('previewSection').classList.remove('hidden');
        }
        
        function showJsonEditor(json) {
            const editor = document.getElementById('jsonEditor');
            if (editor) {
                editor.value = JSON.stringify(json, null, 2);
                document.getElementById('jsonEditorSection').classList.remove('hidden');
            }
        }
        
        // ============================================
        // CRUD MANUALI - SALVATAGGIO
        // ============================================
        
        async function saveManualeData() {
            console.log('üíæ Salvataggio manuale...');
            
            // Valida form
            const id = document.getElementById('manualeId').value.trim();
            const macroarea = document.getElementById('manualeMacroarea').value;
            const materia = document.getElementById('manualeMateria').value.trim();
            const tipo = document.getElementById('manualeTipo').value;
            
            const errors = [];
            
            if (!id) {
                errors.push('ID manuale obbligatorio');
            } else if (!/^[a-zA-Z0-9_]+$/.test(id)) {
                errors.push('ID deve contenere solo lettere, numeri e underscore');
            }
            
            if (!macroarea) {
                errors.push('Macroarea obbligatoria');
            }
            
            if (!materia) {
                errors.push('Materia obbligatoria');
            }
            
            if (!tipo) {
                errors.push('Tipo obbligatorio');
            }
            
            if (!currentManualeData && !editingManualeId) {
                errors.push('File JSON obbligatorio per nuovi manuali');
            }
            
            // Controllo duplicati (solo per nuovi)
            if (!editingManualeId) {
                const originalManuals = getManualsAsObject();
                const allManuals = { 
                    ...originalManuals, 
                    ...JSON.parse(localStorage.getItem('custom_manuals') || '{}'),
                    ...JSON.parse(localStorage.getItem('modified_manuals') || '{}')
                };
                
                if (allManuals[id]) {
                    errors.push('ID gi√† esistente. Scegli un ID diverso.');
                }
            }
            
            if (errors.length > 0) {
                showValidationErrors(errors);
                return;
            }
            
            // Aggiungi materia al registry per autocomplete futuro
            addMateriaToRegistry(macroarea, materia);
            
            // Prepara dati da salvare
            let manualeToSave;
            
            // Se l'editor JSON √® visibile, leggi da l√¨
            const jsonEditorSection = document.getElementById('jsonEditorSection');
            if (jsonEditorSection && !jsonEditorSection.classList.contains('hidden')) {
                const jsonEditorContent = document.getElementById('jsonEditor').value;
                try {
                    const parsedJson = JSON.parse(jsonEditorContent);
                    manualeToSave = {
                        ...parsedJson,
                        id: id,
                        macroarea: macroarea,
                        materia: materia,
                        subject: materia,
                        type: tipo
                    };
                    console.log('‚úÖ JSON letto dall\'editor');
                } catch (e) {
                    errors.push('JSON non valido nell\'editor: ' + e.message);
                    showValidationErrors(errors);
                    return;
                }
            } else if (currentManualeData) {
                // Nuovo manuale o sostituzione JSON
                manualeToSave = {
                    ...currentManualeData,
                    id: id,
                    macroarea: macroarea,
                    materia: materia,
                    subject: materia,
                    type: tipo
                };
            } else {
                // Modifica solo metadata (mantieni JSON originale)
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                const originalManuals = getManualsAsObject();
                const originalManual = customManuals[editingManualeId] || originalManuals[editingManualeId];
                
                manualeToSave = {
                    ...originalManual,
                    macroarea: macroarea,
                    materia: materia,
                    subject: materia,
                    type: tipo
                };
            }
            
            // Salva in localStorage
            try {
                if (!editingManualeId || !MANUAL_CATALOG[id]) {
                    // Nuovo manuale custom
                    const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                    customManuals[id] = manualeToSave;
                    localStorage.setItem('custom_manuals', JSON.stringify(customManuals));
                    console.log('‚úÖ Nuovo manuale custom salvato');
                } else {
                    // Modifica di manuale esistente
                    const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                    modifiedManuals[id] = manualeToSave;
                    localStorage.setItem('modified_manuals', JSON.stringify(modifiedManuals));
                    console.log('‚úÖ Manuale modificato salvato');
                }
                
                // Rigenera catalog entry
                regenerateCatalogEntry(id, manualeToSave);
                
                // Chiudi modal e ricarica lista
                closeManualeModal();
                loadManualiList();
                
                alert('‚úÖ Manuale salvato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore salvataggio:', error);
                alert('Errore nel salvataggio: ' + error.message);
            }
        }
        
        function regenerateCatalogEntry(id, manualeData) {
            // Genera metadata per il catalog
            const catalogEntry = {
                id: id,
                filename: `${id}.json`,
                filepath: `custom/${id}.json`,
                title: manualeData.title,
                author: manualeData.author,
                publisher: manualeData.publisher || 'N/A',
                type: manualeData.type,
                subject: manualeData.subject,
                price: manualeData.price || 0,
                pages: manualeData.pages || 0,
                edition: manualeData.edition || 'N/A',
                year: manualeData.year || 'N/A',
                chapters_count: manualeData.chapters ? manualeData.chapters.length : 0
            };
            
            // Salva nel catalog entries
            const catalogEntries = JSON.parse(localStorage.getItem('catalog_entries') || '{}');
            catalogEntries[id] = catalogEntry;
            localStorage.setItem('catalog_entries', JSON.stringify(catalogEntries));
        }
        
        // ============================================
        // CRUD MANUALI - ELIMINAZIONE
        // ============================================
        
        let deleteTargetId = null;
        
        function deleteManuale(manualeId) {
            console.log('üóëÔ∏è Richiesta eliminazione:', manualeId);
            
            // Carica dati del manuale
            const originalManuals = getManualsAsObject();
            const allManuals = { 
                ...originalManuals, 
                ...JSON.parse(localStorage.getItem('custom_manuals') || '{}'),
                ...JSON.parse(localStorage.getItem('modified_manuals') || '{}')
            };
            
            console.log(`üîç Cercando manuale da eliminare con ID: "${manualeId}"`);
            
            const manuale = allManuals[manualeId];
            if (!manuale) {
                console.error(`‚ùå Manuale "${manualeId}" non trovato`);
                alert(`Manuale "${manualeId}" non trovato nel catalogo`);
                return;
            }
            
            console.log('‚úÖ Manuale trovato per eliminazione:', manuale);
            
            deleteTargetId = manualeId;
            document.getElementById('deleteManualeName').textContent = `${manuale.title} (${manuale.author})`;
            document.getElementById('deleteManualeModal').classList.remove('hidden');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteManualeModal').classList.add('hidden');
            deleteTargetId = null;
        }
        
        function confirmDeleteManuale() {
            if (!deleteTargetId) return;
            
            console.log('üóëÔ∏è Eliminazione confermata:', deleteTargetId);
            
            try {
                // Rimuovi da custom
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                if (customManuals[deleteTargetId]) {
                    delete customManuals[deleteTargetId];
                    localStorage.setItem('custom_manuals', JSON.stringify(customManuals));
                }
                
                // Rimuovi da modified
                const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                if (modifiedManuals[deleteTargetId]) {
                    delete modifiedManuals[deleteTargetId];
                    localStorage.setItem('modified_manuals', JSON.stringify(modifiedManuals));
                }
                
                // Rimuovi da catalog entries
                const catalogEntries = JSON.parse(localStorage.getItem('catalog_entries') || '{}');
                if (catalogEntries[deleteTargetId]) {
                    delete catalogEntries[deleteTargetId];
                    localStorage.setItem('catalog_entries', JSON.stringify(catalogEntries));
                }
                
                console.log('‚úÖ Manuale eliminato');
                
                closeDeleteModal();
                loadManualiList();
                
                alert('‚úÖ Manuale eliminato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione:', error);
                alert('Errore nell\'eliminazione: ' + error.message);
            }
        }
        
        // ============================================
        // CRUD MANUALI - EXPORT/IMPORT
        // ============================================
        
        function exportCatalog() {
            console.log('üíæ Export catalog JSON...');
            
            try {
                const originalManuals = getManualsAsObject();
                
                // Merge tutti i cataloghi
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                const catalogEntries = JSON.parse(localStorage.getItem('catalog_entries') || '{}');
                
                const fullCatalog = {
                    catalog_format_version: MANUAL_CATALOG.catalog_format_version || MANUAL_CATALOG.version || '1.0.0',
                    last_updated: new Date().toISOString().split('T')[0],
                    total_manuals: Object.keys(originalManuals).length + Object.keys(modifiedManuals).length + Object.keys(catalogEntries).length,
                    manuals: {
                        ...originalManuals,
                        ...modifiedManuals,
                        ...catalogEntries
                    }
                };
                
                // Download JSON
                const blob = new Blob([JSON.stringify(fullCatalog, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'manual_catalog_updated.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Catalog esportato');
                alert('‚úÖ Catalog esportato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore export:', error);
                alert('Errore nell\'export: ' + error.message);
            }
        }
        
        function exportCatalogZIP() {
            alert('üì¶ Funzionalit√† Export ZIP in fase di implementazione...\n\nPer ora usa "Export JSON" e carica manualmente i file JSON dei manuali custom.');
        }
        
        function importCatalog() {
            alert('üì• Funzionalit√† Import in fase di implementazione...\n\nPer ora aggiungi i manuali uno per uno con "Nuovo Manuale".');
        }

        // ============================================
        // CRUD FRAMEWORK - CARICAMENTO LISTA
        // ============================================
        
        let editingFrameworkId = null;
        let currentFrameworkData = null;
        
        async function loadFrameworkList() {
            console.log('üìã Caricamento lista framework...');
            
            const tbody = document.getElementById('frameworkTableBody');
            if (!tbody) {
                console.error('‚ùå Element frameworkTableBody not found!');
                return;
            }
            
            // Se FRAMEWORK_CATALOG non √® caricato, caricalo ORA
            if (!window.FRAMEWORK_CATALOG) {
                console.warn('‚ö†Ô∏è FRAMEWORK_CATALOG non caricato, carico ora...');
                try {
                    const response = await fetch('framework_catalog.json');
                    window.FRAMEWORK_CATALOG = await response.json();
                    console.log('‚úÖ FRAMEWORK_CATALOG caricato:', window.FRAMEWORK_CATALOG);
                } catch (error) {
                    console.error('‚ùå Errore caricamento FRAMEWORK_CATALOG:', error);
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-600">‚ùå Errore caricamento framework: ' + error.message + '</td></tr>';
                    return;
                }
            }
            
            console.log('üîç FRAMEWORK_CATALOG:', window.FRAMEWORK_CATALOG);
            
            // Carica framework originali + custom + modificati
            const originalFrameworks = getFrameworksAsObject();
            console.log('üì¶ Original frameworks:', Object.keys(originalFrameworks).length);
            
            const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
            const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
            
            // Merge con priorit√†: modificati > custom > originali
            const allFrameworks = {
                ...originalFrameworks,
                ...customFrameworks,
                ...modifiedFrameworks
            };
            
            console.log(`‚úÖ Framework totali: ${Object.keys(allFrameworks).length}`);
            
            // Ordina per nome
            const sortedFrameworks = Object.values(allFrameworks).sort((a, b) => 
                (a.name || '').localeCompare(b.name || '')
            );
            
            // Genera righe tabella
            tbody.innerHTML = sortedFrameworks.map(fw => {
                // Determina badge di stato
                let badge = '';
                if (modifiedFrameworks[fw.id]) {
                    badge = '<span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">üü° Modificato</span>';
                } else if (customFrameworks[fw.id]) {
                    badge = '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">üîµ Custom</span>';
                } else {
                    badge = '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">üü¢ Originale</span>';
                }
                
                const modulesCount = fw.modules_count || (fw.content?.syllabus_modules?.length) || 0;
                const profilesCount = fw.program_profiles_count || (fw.content?.program_profiles?.length) || 0;
                
                return `
                    <tr class="framework-row" data-id="${fw.id}" data-subject="${fw.subject || ''}" data-tipo="${badge.includes('Originale') ? 'originale' : (badge.includes('Modificato') ? 'modificato' : 'custom')}">
                        <td class="px-1 py-1 text-xs text-gray-900 break-words">${fw.id}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 break-words">${fw.name || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 break-words">${fw.subject || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-center text-gray-900">${modulesCount}</td>
                        <td class="px-1 py-1 text-xs text-center text-gray-900">${profilesCount}</td>
                        <td class="px-1 py-1 text-xs">${badge}</td>
                        <td class="px-1 py-1 text-xs">
                            <div class="flex gap-1">
                                <button onclick="editFramework('${fw.id}')" class="text-indigo-600 hover:text-indigo-800" title="Modifica">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteFramework('${fw.id}')" class="text-red-600 hover:text-red-800" title="Elimina">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Aggiorna contatori
            const originalCount = Object.keys(originalFrameworks).length;
            const modifiedCount = Object.keys(modifiedFrameworks).length;
            const customCount = Object.keys(customFrameworks).length;
            const total = Object.keys(allFrameworks).length;
            
            document.getElementById('frameworkCount').innerHTML = `
                üìã <strong>${total}</strong> framework totali
                ‚Ä¢ ${originalCount} originali
                ‚Ä¢ ${modifiedCount} modificati
                ‚Ä¢ ${customCount} custom
            `;
        }
        
        function getFrameworksAsObject() {
            // Converti FRAMEWORK_CATALOG in oggetto per coerenza
            console.log('üîß getFrameworksAsObject called');
            console.log('üîç window.FRAMEWORK_CATALOG:', window.FRAMEWORK_CATALOG);
            
            if (!window.FRAMEWORK_CATALOG) {
                console.error('‚ùå FRAMEWORK_CATALOG is not defined!');
                return {};
            }
            
            const frameworks = {};
            if (FRAMEWORK_CATALOG.frameworks) {
                console.log('‚úÖ Found FRAMEWORK_CATALOG.frameworks:', FRAMEWORK_CATALOG.frameworks.length);
                FRAMEWORK_CATALOG.frameworks.forEach(fw => {
                    frameworks[fw.id] = fw;
                });
            } else {
                console.error('‚ùå FRAMEWORK_CATALOG.frameworks is missing!');
            }
            
            console.log('üì¶ Returning frameworks object with', Object.keys(frameworks).length, 'items');
            return frameworks;
        }
        
        function filterFramework() {
            const searchText = document.getElementById('searchFramework').value.toLowerCase();
            const filterMateria = document.getElementById('filterFrameworkMateria').value;
            const filterTipo = document.getElementById('filterFrameworkTipo').value;
            
            const rows = document.querySelectorAll('.framework-row');
            
            rows.forEach(row => {
                const id = row.dataset.id.toLowerCase();
                const subject = row.dataset.subject;
                const tipo = row.dataset.tipo;
                const text = row.textContent.toLowerCase();
                
                const matchSearch = !searchText || text.includes(searchText);
                const matchMateria = !filterMateria || subject === filterMateria;
                const matchTipo = !filterTipo || tipo === filterTipo;
                
                if (matchSearch && matchMateria && matchTipo) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // ============================================
        // CRUD FRAMEWORK - MODAL AGGIUNGI/MODIFICA
        // ============================================
        
        function openAddFrameworkModal() {
            console.log('‚ûï Apertura modal nuovo framework');
            
            editingFrameworkId = null;
            currentFrameworkData = null;
            
            document.getElementById('frameworkModalTitle').textContent = '‚ûï Nuovo Framework';
            document.getElementById('frameworkId').value = '';
            document.getElementById('frameworkId').disabled = false;
            document.getElementById('frameworkName').value = '';
            document.getElementById('frameworkSubject').value = '';
            
            // Reset upload JSON
            document.getElementById('frameworkJsonFile').value = '';
            document.getElementById('frameworkJsonFileInfo').classList.add('hidden');
            document.getElementById('frameworkPreviewSection').classList.add('hidden');
            document.getElementById('frameworkJsonEditorSection').classList.add('hidden');
            document.getElementById('frameworkValidationErrors').classList.add('hidden');
            
            // Mostra sezione upload JSON
            const step2Upload = document.querySelector('#frameworkModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.remove('hidden');
            }
            
            document.getElementById('frameworkModal').classList.remove('hidden');
        }
        
        function editFramework(frameworkId) {
            console.log('‚úèÔ∏è Modifica framework:', frameworkId);
            
            editingFrameworkId = frameworkId;
            
            // Carica dati framework
            const originalFrameworks = getFrameworksAsObject();
            const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
            const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
            
            const framework = modifiedFrameworks[frameworkId] || customFrameworks[frameworkId] || originalFrameworks[frameworkId];
            
            if (!framework) {
                alert('Framework non trovato');
                return;
            }
            
            document.getElementById('frameworkModalTitle').textContent = '‚úèÔ∏è Modifica Framework';
            document.getElementById('frameworkId').value = framework.id;
            document.getElementById('frameworkId').disabled = true;
            document.getElementById('frameworkName').value = framework.name || '';
            document.getElementById('frameworkSubject').value = framework.subject || '';
            
            // Nascondi upload JSON e mostra preview dati esistenti
            const step2Upload = document.querySelector('#frameworkModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.add('hidden');
            }
            
            // Carica JSON completo se disponibile
            if (customFrameworks[frameworkId]) {
                // Framework custom: carica da localStorage
                currentFrameworkData = customFrameworks[frameworkId];
                showFrameworkPreview(currentFrameworkData);
                showFrameworkJsonEditor(currentFrameworkData);
            } else if (framework.filepath) {
                // Framework originale: carica da file
                fetch(framework.filepath)
                    .then(r => r.json())
                    .then(data => {
                        currentFrameworkData = data;
                        showFrameworkPreview(currentFrameworkData);
                        showFrameworkJsonEditor(currentFrameworkData);
                    })
                    .catch(err => {
                        console.error('‚ùå Errore caricamento JSON:', err);
                        // Mostra preview con dati base
                        showFrameworkPreview(framework);
                    });
            } else {
                // Nessun JSON disponibile, mostra dati base
                showFrameworkPreview(framework);
            }
            
            document.getElementById('frameworkValidationErrors').classList.add('hidden');
            document.getElementById('frameworkModal').classList.remove('hidden');
        }
        
        function closeFrameworkModal() {
            document.getElementById('frameworkModal').classList.add('hidden');
            editingFrameworkId = null;
            currentFrameworkData = null;
        }
        
        // ============================================
        // CRUD FRAMEWORK - UPLOAD E VALIDAZIONE JSON
        // ============================================
        
        async function handleFrameworkJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üìÅ Caricamento file JSON framework:', file.name);
            
            // Mostra info file
            document.getElementById('frameworkJsonFileName').textContent = file.name;
            document.getElementById('frameworkJsonFileSize').textContent = `${(file.size / 1024).toFixed(2)} KB`;
            document.getElementById('frameworkJsonFileInfo').classList.remove('hidden');
            
            try {
                const text = await file.text();
                const json = JSON.parse(text);
                
                console.log('‚úÖ JSON parsato con successo');
                
                // Valida struttura
                const errors = validateFrameworkJson(json);
                
                if (errors.length > 0) {
                    showFrameworkValidationErrors(errors);
                    currentFrameworkData = null;
                    document.getElementById('frameworkPreviewSection').classList.add('hidden');
                    return;
                }
                
                // JSON valido
                currentFrameworkData = json;
                document.getElementById('frameworkValidationErrors').classList.add('hidden');
                showFrameworkPreview(json);
                
            } catch (error) {
                console.error('‚ùå Errore parsing JSON:', error);
                showFrameworkValidationErrors(['Errore nel parsing del file JSON: ' + error.message]);
                currentFrameworkData = null;
            }
        }
        
        function validateFrameworkJson(json) {
            const errors = [];
            
            if (!json.id || typeof json.id !== 'string') {
                errors.push('Campo "id" obbligatorio (stringa)');
            }
            
            if (!json.name || typeof json.name !== 'string') {
                errors.push('Campo "name" obbligatorio (stringa)');
            }
            
            if (!json.subject || typeof json.subject !== 'string') {
                errors.push('Campo "subject" obbligatorio (stringa)');
            }
            
            // Valida content
            if (!json.content || typeof json.content !== 'object') {
                errors.push('Campo "content" obbligatorio (oggetto)');
            } else {
                if (!json.content.syllabus_modules || !Array.isArray(json.content.syllabus_modules)) {
                    errors.push('Campo "content.syllabus_modules" obbligatorio (array)');
                } else if (json.content.syllabus_modules.length === 0) {
                    errors.push('Il framework deve avere almeno un modulo');
                }
                
                if (!json.content.program_profiles || !Array.isArray(json.content.program_profiles)) {
                    errors.push('Campo "content.program_profiles" obbligatorio (array)');
                }
                
                if (!json.content.target_degrees || !Array.isArray(json.content.target_degrees)) {
                    errors.push('Campo "content.target_degrees" obbligatorio (array)');
                }
            }
            
            return errors;
        }
        
        function showFrameworkValidationErrors(errors) {
            const errorList = document.getElementById('frameworkErrorList');
            errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
            document.getElementById('frameworkValidationErrors').classList.remove('hidden');
        }
        
        function showFrameworkPreview(json) {
            const content = json.content || {};
            
            document.getElementById('frameworkPreviewName').textContent = json.name || '‚Äî';
            document.getElementById('frameworkPreviewSubject').textContent = json.subject || '‚Äî';
            document.getElementById('frameworkPreviewModules').textContent = content.syllabus_modules ? content.syllabus_modules.length : '‚Äî';
            document.getElementById('frameworkPreviewProfiles').textContent = content.program_profiles ? content.program_profiles.length : '‚Äî';
            document.getElementById('frameworkPreviewDegrees').textContent = content.target_degrees ? content.target_degrees.length : '‚Äî';
            
            document.getElementById('frameworkPreviewSection').classList.remove('hidden');
        }
        
        function showFrameworkJsonEditor(json) {
            const editor = document.getElementById('frameworkJsonEditor');
            if (editor) {
                editor.value = JSON.stringify(json, null, 2);
                document.getElementById('frameworkJsonEditorSection').classList.remove('hidden');
            }
        }
        
        // ============================================
        // CRUD FRAMEWORK - SALVATAGGIO
        // ============================================
        
        async function saveFrameworkData() {
            console.log('üíæ Salvataggio framework...');
            
            // Valida form
            const id = document.getElementById('frameworkId').value.trim();
            const name = document.getElementById('frameworkName').value.trim();
            const subject = document.getElementById('frameworkSubject').value;
            
            const errors = [];
            
            if (!id) {
                errors.push('ID framework obbligatorio');
            } else if (!/^[a-zA-Z0-9_]+$/.test(id)) {
                errors.push('ID deve contenere solo lettere, numeri e underscore');
            }
            
            if (!name) {
                errors.push('Nome framework obbligatorio');
            }
            
            if (!subject) {
                errors.push('Materia obbligatoria');
            }
            
            if (!currentFrameworkData && !editingFrameworkId) {
                errors.push('File JSON obbligatorio per nuovi framework');
            }
            
            // Controllo duplicati (solo per nuovi)
            if (!editingFrameworkId) {
                const originalFrameworks = getFrameworksAsObject();
                const allFrameworks = { 
                    ...originalFrameworks, 
                    ...JSON.parse(localStorage.getItem('custom_frameworks') || '{}'),
                    ...JSON.parse(localStorage.getItem('modified_frameworks') || '{}')
                };
                
                if (allFrameworks[id]) {
                    errors.push('ID gi√† esistente. Scegli un ID diverso.');
                }
            }
            
            if (errors.length > 0) {
                showFrameworkValidationErrors(errors);
                return;
            }
            
            // Prepara dati da salvare
            let frameworkToSave;
            
            // Se l'editor JSON √® visibile, leggi da l√¨
            const jsonEditorSection = document.getElementById('frameworkJsonEditorSection');
            if (jsonEditorSection && !jsonEditorSection.classList.contains('hidden')) {
                const jsonEditorContent = document.getElementById('frameworkJsonEditor').value;
                try {
                    const parsedJson = JSON.parse(jsonEditorContent);
                    frameworkToSave = {
                        ...parsedJson,
                        id: id,
                        name: name,
                        subject: subject
                    };
                    console.log('‚úÖ JSON letto dall\'editor');
                } catch (e) {
                    errors.push('JSON non valido nell\'editor: ' + e.message);
                    showFrameworkValidationErrors(errors);
                    return;
                }
            } else if (currentFrameworkData) {
                // Nuovo framework o sostituzione JSON
                frameworkToSave = {
                    ...currentFrameworkData,
                    id: id,
                    name: name,
                    subject: subject
                };
            } else {
                // Modifica solo metadata (mantieni JSON originale)
                const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                const originalFrameworks = getFrameworksAsObject();
                const originalFramework = customFrameworks[editingFrameworkId] || originalFrameworks[editingFrameworkId];
                
                frameworkToSave = {
                    ...originalFramework,
                    name: name,
                    subject: subject
                };
            }
            
            // Salva in localStorage
            try {
                const originalFrameworks = getFrameworksAsObject();
                
                if (!editingFrameworkId || !originalFrameworks[id]) {
                    // Nuovo framework custom
                    const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                    customFrameworks[id] = frameworkToSave;
                    localStorage.setItem('custom_frameworks', JSON.stringify(customFrameworks));
                    console.log('‚úÖ Nuovo framework custom salvato');
                } else {
                    // Modifica di framework esistente
                    const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
                    modifiedFrameworks[id] = frameworkToSave;
                    localStorage.setItem('modified_frameworks', JSON.stringify(modifiedFrameworks));
                    console.log('‚úÖ Framework modificato salvato');
                }
                
                // Chiudi modal e ricarica lista
                closeFrameworkModal();
                loadFrameworkList();
                
                alert('‚úÖ Framework salvato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore salvataggio:', error);
                alert('Errore nel salvataggio: ' + error.message);
            }
        }
        
        // ============================================
        // CRUD FRAMEWORK - ELIMINAZIONE
        // ============================================
        
        let deleteFrameworkTargetId = null;
        
        function deleteFramework(frameworkId) {
            console.log('üóëÔ∏è Richiesta eliminazione framework:', frameworkId);
            
            // Carica dati del framework
            const originalFrameworks = getFrameworksAsObject();
            const allFrameworks = { 
                ...originalFrameworks, 
                ...JSON.parse(localStorage.getItem('custom_frameworks') || '{}'),
                ...JSON.parse(localStorage.getItem('modified_frameworks') || '{}')
            };
            
            const framework = allFrameworks[frameworkId];
            if (!framework) {
                console.error(`‚ùå Framework "${frameworkId}" non trovato`);
                alert(`Framework "${frameworkId}" non trovato nel catalogo`);
                return;
            }
            
            console.log('‚úÖ Framework trovato per eliminazione:', framework);
            
            deleteFrameworkTargetId = frameworkId;
            document.getElementById('deleteFrameworkName').textContent = `${framework.name} (${framework.subject})`;
            document.getElementById('deleteFrameworkModal').classList.remove('hidden');
        }
        
        function closeDeleteFrameworkModal() {
            document.getElementById('deleteFrameworkModal').classList.add('hidden');
            deleteFrameworkTargetId = null;
        }
        
        function confirmDeleteFramework() {
            if (!deleteFrameworkTargetId) return;
            
            console.log('üóëÔ∏è Eliminazione confermata:', deleteFrameworkTargetId);
            
            try {
                // Rimuovi da custom
                const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                if (customFrameworks[deleteFrameworkTargetId]) {
                    delete customFrameworks[deleteFrameworkTargetId];
                    localStorage.setItem('custom_frameworks', JSON.stringify(customFrameworks));
                }
                
                // Rimuovi da modified
                const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
                if (modifiedFrameworks[deleteFrameworkTargetId]) {
                    delete modifiedFrameworks[deleteFrameworkTargetId];
                    localStorage.setItem('modified_frameworks', JSON.stringify(modifiedFrameworks));
                }
                
                console.log('‚úÖ Framework eliminato');
                
                closeDeleteFrameworkModal();
                loadFrameworkList();
                
                alert('‚úÖ Framework eliminato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione:', error);
                alert('Errore nell\'eliminazione: ' + error.message);
            }
        }
        
        // ============================================
        // CRUD FRAMEWORK - EXPORT/IMPORT
        // ============================================
        
        function exportFrameworkCatalog() {
            console.log('üíæ Export framework catalog JSON...');
            
            try {
                const originalFrameworks = getFrameworksAsObject();
                
                // Merge tutti i cataloghi
                const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
                
                const fullCatalog = {
                    version: '1.0.0',
                    last_updated: new Date().toISOString().split('T')[0],
                    total_frameworks: Object.keys({ ...originalFrameworks, ...modifiedFrameworks, ...customFrameworks }).length,
                    frameworks: Object.values({
                        ...originalFrameworks,
                        ...modifiedFrameworks,
                        ...customFrameworks
                    })
                };
                
                // Crea file JSON
                const blob = new Blob([JSON.stringify(fullCatalog, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `framework_catalog_updated_${fullCatalog.last_updated}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Export completato');
                
            } catch (error) {
                console.error('‚ùå Errore export:', error);
                alert('Errore nell\'export: ' + error.message);
            }
        }
        
        function exportFrameworkZIP() {
            alert('üì¶ Funzionalit√† Export ZIP in fase di implementazione...\n\nPer ora usa "Export JSON" e carica manualmente i file JSON dei framework custom.');
        }
        
        function importFrameworkCatalog() {
            alert('üì• Funzionalit√† Import in fase di implementazione...\n\nPer ora aggiungi i framework uno per uno con "Nuovo Framework".');
        }

        // Gestione file
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').textContent = file.name;

            if (file.type === 'application/pdf') {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let text = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        text += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    
                    fileContent = text;
                    document.getElementById('testoInput').value = text;
                } catch (error) {
                    showError('Errore nella lettura del PDF: ' + error.message);
                }
            } else if (file.type === 'text/plain') {
                try {
                    const text = await file.text();
                    fileContent = text;
                    document.getElementById('testoInput').value = text;
                } catch (error) {
                    showError('Errore nella lettura del file: ' + error.message);
                }
            } else {
                showError('Formato file non supportato. Usa PDF o TXT.');
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorMessage').classList.add('hidden');
            }, 5000);
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        // Analisi principale
        async function avviaAnalisi() {
            // Verifica che almeno una chiave API sia configurata
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const apiKeyOpenAI = localStorage.getItem('openai_api_key');
            const apiKeyPerplexity = localStorage.getItem('perplexity_api_key');
            
            // Per OpenAI: permetti uso anche senza chiave (user√† quella su Netlify)
            // Per Perplexity: richiedi sempre la chiave
            if (provider === 'perplexity' && !apiKeyPerplexity) {
                showError('Chiave API Perplexity non configurata. Vai in Impostazioni.');
                return;
            }

            const contesto = document.getElementById('contestoSelect').value;
            let manuale = document.getElementById('manualeSelect').value;
            const cfu = document.getElementById('cfuInput').value;
            const ore = document.getElementById('oreInput').value;
            const testo = document.getElementById('testoInput').value.trim();
            const tipoAnalisi = document.querySelector('input[name="tipoAnalisi"]:checked').value;
            
            // Se "Altro manuale", usa il nome personalizzato
            let manualeNomePersonalizzato = null;
            if (manuale === 'Altro') {
                manualeNomePersonalizzato = document.getElementById('altroManualeNome').value.trim();
                if (!manualeNomePersonalizzato) {
                    showError('Specifica il nome del manuale adottato');
                    return;
                }
            }
            
            // Raccogli manuali alternativi
            // Raccogli manuali alternativi selezionati (checkbox dinamici con id che inizia per "alt")
            const manualiAlternativi = [];
            document.querySelectorAll('input[type="checkbox"][id^="alt"]').forEach(checkbox => {
                if (checkbox.checked && checkbox.value && checkbox.value !== manuale) {
                    manualiAlternativi.push(checkbox.value);
                    console.log(`‚úÖ Manuale alternativo selezionato: ${checkbox.value}`);
                }
            });

            if (!contesto || !manuale) {
                showError('Seleziona contesto didattico e manuale adottato');
                return;
            }
            
            // Verifica che sia stato selezionato un framework
            if (!CURRENT_FRAMEWORK) {
                showError('Seleziona prima una materia e un framework specifico');
                return;
            }
            
            // Estrai il nome del framework dal catalogo o usa un fallback
            const frameworkInfo = FRAMEWORK_CATALOG?.frameworks?.find(f => f.filepath === window.lastFrameworkPath);
            const frameworkName = frameworkInfo ? frameworkInfo.name : 'del corso';
            const materiaName = frameworkInfo ? frameworkInfo.subject : 'la materia selezionata';
            
            console.log('üìö Framework selezionato:', frameworkName);
            console.log('üìñ Materia:', materiaName);

            if (!testo) {
                showError('Carica un file o incolla il testo del programma');
                return;
            }

            if (testo.length < 100) {
                showError('Il testo del programma √® troppo breve (minimo 100 caratteri)');
                return;
            }

            document.getElementById('btnAnalizza').disabled = true;
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            try {
                // Fase 0: Analisi Preliminare (Quadro Generale + Profilo Pedagogico)
                updateLoadingText('Fase 0/5: Analisi preliminare del programma...');
                
                let fase0;
                try {
                    const analisiPreliminare = await callLLM(`Analizza questo programma universitario di ${materiaName} e fornisci un'analisi preliminare.

IMPORTANTE: Rispondi ESCLUSIVAMENTE con un oggetto JSON valido. Non aggiungere testo prima o dopo il JSON.
Usa SEMPRE virgolette doppie per le stringhe. Non usare apici singoli.
Evita caratteri speciali non escapati nelle stringhe.

PROGRAMMA DEL CORSO:
${testo.substring(0, 8000)}

CONTESTO:
- Materia: ${materiaName}
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

Genera un JSON con questa struttura esatta:

{
  "quadro_generale": {
    "tipologia": "descrizione breve del tipo di corso (max 250 caratteri)",
    "distribuzione_tematica": [
      {"area": "nome area", "percentuale": 40},
      {"area": "altra area", "percentuale": 30}
    ],
    "livello_complessita": "base o intermedio o avanzato",
    "note": "osservazioni generali (max 400 caratteri)"
  },
  "profilo_pedagogico": {
    "approccio": "teorico o applicativo o sperimentale o interdisciplinare o misto",
    "livello": "base o intermedio o avanzato",
    "enfasi": ["argomento1", "argomento2", "argomento3"],
    "stile": "classico o moderno o innovativo o tradizionale",
    "orientamento": "puro o applicato o misto",
    "note": "caratteristiche distintive (max 300 caratteri)"
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`, 0.1);

                    console.log('üìù Risposta Fase 0 (lunghezza):', analisiPreliminare.length);
                    fase0 = JSON.parse(sanitizeJSON(analisiPreliminare));
                    
                    // Salva fase 0 per uso successivo
                    window.currentAnalisiPreliminare = fase0;
                    
                    console.log('‚úÖ Fase 0 completata:', fase0);
                } catch (error) {
                    console.error('‚ùå ERRORE Fase 0:', error.message);
                    throw new Error('Fase 0 fallita: ' + error.message);
                }

                // Fase 0b: Analisi Avanzata - Profilo Docente (SOLO se Analisi Avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Fase 0b/5: Analisi avanzata profilo docente...');
                    
                    try {
                        const profiloDocentePrompt = `Basandoti ESCLUSIVAMENTE sull'analisi preliminare gi√† effettuata, genera insights per un promotore editoriale.

ANALISI PRELIMINARE GI√Ä EFFETTUATA:
${JSON.stringify(fase0, null, 2)}

PROGRAMMA (per contesto):
${testo.substring(0, 5000)}

CONTESTO:
- Materia: ${materiaName}
- Classe di Laurea: ${contesto}

IMPORTANTE: 
- NON inventare dati numerici (ore, costi, percentuali)
- Usa linguaggio qualitativo: "potrebbe", "probabilmente", "tendenzialmente"
- Basa tutto solo su ci√≤ che emerge dal programma e dall'analisi preliminare

Genera un JSON con questa struttura:

{
  "profilo_docente_insights": {
    "tipo_docente": "Tradizionalista / Innovatore / Pragmatico / Accademico (basato su stile e approccio identificati)",
    "sensibilita_chiave": "Cosa sembra importante per questo docente (basato su enfasi e orientamento)",
    "approccio_consigliato": "Come presentare un manuale alternativo a questo docente",
    "leve_potenziali": ["elemento1 che potrebbe interessare", "elemento2 basato su enfasi programma"],
    "possibili_resistenze": ["resistenza1 basata su stile tradizionale/innovativo", "resistenza2"],
    "argomenti_rilevanti": ["tipo di contenuto che il programma enfatizza", "aspetto distintivo del programma"]
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                        const profiloDocenteResponse = await callLLM(profiloDocentePrompt, 0.2);
                        const profiloDocenteObj = JSON.parse(sanitizeJSON(profiloDocenteResponse));
                        
                        // Aggiungi al fase0
                        fase0.profilo_docente_insights = profiloDocenteObj.profilo_docente_insights;
                        console.log('‚úÖ Fase 0b (Avanzata) completata:', profiloDocenteObj);
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Fase 0b (Avanzata) fallita, continuo comunque:', error.message);
                        // Non blocco l'analisi se questa fase fallisce
                    }
                }

                // Fase 1: Estrai metadata
                updateLoadingText('Fase 1/5: Estrazione metadata...');
                
                let metadataObj;
                try {
                    const metadata = await callLLM(`Estrai i metadati da questo programma universitario di ${materiaName}.

IMPORTANTE: Rispondi ESCLUSIVAMENTE con un oggetto JSON valido.
Usa SEMPRE virgolette doppie, non apici singoli.
Se un campo non √® presente, usa stringa vuota "".

TESTO DEL PROGRAMMA:
${testo.substring(0, 2000)}

Estrai questi campi e rispondi SOLO con questo JSON:

{
  "universita": "nome universita (senza accenti nei nomi campo)",
  "corso_laurea_nome": "nome corso di laurea",
  "denominazione_corso": "nome insegnamento",
  "docente": "nome docente"
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`, 0.1);

                    console.log('üìù Risposta Fase 1 (lunghezza):', metadata.length);
                    metadataObj = JSON.parse(sanitizeJSON(metadata));
                    console.log('‚úÖ Fase 1 completata:', metadataObj);
                } catch (error) {
                    console.error('‚ùå ERRORE Fase 1:', error.message);
                    throw new Error('Fase 1 fallita: ' + error.message);
                }

                // Fase 2: Analizza programma (TEMPERATURE ABBASSATA A 0.1 per massima coerenza)
                updateLoadingText('Fase 2/5: Valutazione programma (5 dimensioni)...');
                
                // Costruzione dinamica del prompt basato sul framework caricato
                const frameworkData = CURRENT_FRAMEWORK;
                if (!frameworkData || !frameworkData.content) {
                    throw new Error('Framework non caricato. Seleziona prima un framework valido.');
                }
                const moduliList = frameworkData.content.syllabus_modules.map((mod, idx) => {
                    const modNum = String(idx + 1).padStart(2, '0');
                    const keyConcepts = mod.key_concepts.map(k => typeof k === 'string' ? k : k.concetto).join(', ');
                    return `   MOD-${modNum} ${mod.name} (0-13): ${keyConcepts}`;
                }).join('\n');
                
                const profilesList = frameworkData.content.program_profiles.map(prof => {
                    return `   - ${prof.name}: ${prof.priority_modules}`;
                }).join('\n');
                
                // Genera evaluation_criteria se esistono
                let evaluationCriteriaText = '';
                if (frameworkData.content.evaluation_criteria) {
                    const criteriaEntries = Object.entries(frameworkData.content.evaluation_criteria);
                    if (criteriaEntries.length > 0) {
                        evaluationCriteriaText = '\nCRITERI DI VALUTAZIONE SPECIFICI PER ' + materiaName.toUpperCase() + ':\n' +
                            criteriaEntries.map(([key, value]) => `   ‚Ä¢ ${value}`).join('\n') + '\n';
                        console.log('‚úÖ FASE 2: Inclusi ' + criteriaEntries.length + ' evaluation_criteria per ' + materiaName);
                    }
                } else {
                    console.log('‚ÑπÔ∏è FASE 2: Nessun evaluation_criteria per ' + materiaName);
                }
                
                const valutazione = await callLLM( `Analizza questo programma universitario di ${materiaName} secondo il FRAMEWORK DI VALUTAZIONE STRUTTURATO.

CONTESTO:
- Materia: ${materiaName}
- Framework: ${frameworkName}
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

TESTO PROGRAMMA:
${testo}

FRAMEWORK DI VALUTAZIONE (270 punti totali):

1. OBIETTIVI FORMATIVI (max 40 punti):
   - Completezza (0-10): Quanto sono completi e articolati
   - Chiarezza e Misurabilit√† (0-10): Quanto sono espliciti e misurabili
   - Coerenza con standard accademici (0-10): Allineamento con standard nazionali/internazionali
   - Interdisciplinarit√† (0-10): Collegamenti con altre discipline

2. CONTENUTI PROGRAMMATICI (max 130 punti):
   Valuta la copertura dei MODULI del framework ${frameworkName} basandoti sulle PRIORIT√Ä per ${contesto}:
   
${moduliList}
   
   PRIORIT√Ä SPECIFICHE PER CLASSE DI LAUREA:
${profilesList}
${evaluationCriteriaText}   
   Organizzazione didattica e materiale (0-13): Qualit√† supporti, esercizi, esempi

3. METODOLOGIA DIDATTICA (max 40 punti):
   - Didattica attiva (0-10): Esercizi, problem solving, casi studio
   - Materiali didattici (0-10): Variet√† e qualit√† supporti
   - Valutazione e feedback (0-10): Modalit√† valutazione chiare
   - Supporto allo studente (0-10): Risorse di supporto

4. ALLINEAMENTO CURRICULUM (max 30 punti):
   - Coerenza con altri moduli (0-10): Integrazione con altri insegnamenti
   - Progressione didattica (0-10): Sequenza logica argomenti
   - Flessibilit√† e personalizzazione (0-10): Adattabilit√† percorsi

5. RISULTATI ATTESI (max 30 punti):
   - Competenze tecnico-scientifiche (0-10): Solide basi teoriche
   - Competenze trasversali (0-10): Comunicazione, problem solving
   - Preparazione professionale (0-10): Applicabilit√† professionale

GIUDIZI QUALITATIVI per ogni dimensione:
- Obiettivi: Eccellente / Buono / Sufficiente / Carente
- Contenuti: Molto completo / Completo / Parziale / Limitato
- Metodologia: Innovativa / Tradizionale efficace / Basilare / Assente
- Allineamento: Perfettamente allineato / Allineato / Parzialmente allineato / Non allineato
- Risultati: Chiaramente definiti / Definiti / Vaghi / Non specificati

${evaluationCriteriaText ? `
‚ö†Ô∏è IMPORTANTE: Rispondi ai CRITERI DI VALUTAZIONE SPECIFICI nel campo "analisi_criteri":
${evaluationCriteriaText}` : ''}

Rispondi SOLO con un JSON valido:
{
  "obiettivi": {"punteggio": numero_su_40, "giudizio": "...", "note": "..."},
  "contenuti": {"punteggio": numero_su_130, "giudizio": "...", "note": "...", "argomenti_principali": ["..."], "moduli_coperti": ["MOD-01", "MOD-05", ...]},
  "metodologia": {"punteggio": numero_su_40, "giudizio": "...", "note": "..."},
  "allineamento": {"punteggio": numero_su_30, "giudizio": "...", "note": "..."},
  "risultati": {"punteggio": numero_su_30, "giudizio": "...", "note": "..."},${evaluationCriteriaText ? `
  "analisi_criteri": {
    "growth_models": "risposta concisa al criterio growth_models",
    "macro_models_included": "risposta concisa al criterio macro_models_included",
    "macro_sequence": "risposta concisa al criterio macro_sequence",
    "micro_models_focus": "risposta concisa al criterio micro_models_focus",
    "school_of_thought": "risposta concisa al criterio school_of_thought"
  },` : ''}
  "sintesi": "sintesi generale considerando le priorit√† specifiche per ${contesto}"
}`, 0.1);

                const valutazioneObj = JSON.parse(sanitizeJSON(valutazione));
                const totale = valutazioneObj.obiettivi.punteggio + valutazioneObj.contenuti.punteggio + 
                               valutazioneObj.metodologia.punteggio + valutazioneObj.allineamento.punteggio + 
                               valutazioneObj.risultati.punteggio;

                // Fase 2b: Analisi Avanzata - Insights per Adozione (SOLO se Analisi Avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Fase 2b/5: Analisi avanzata insights adozione...');
                    
                    try {
                        const insightsPrompt = `Basandoti ESCLUSIVAMENTE sulla valutazione del programma gi√† effettuata, genera insights per un promotore editoriale.

VALUTAZIONE PROGRAMMA GI√Ä EFFETTUATA:
${JSON.stringify(valutazioneObj, null, 2)}

${valutazioneObj.analisi_criteri ? `
CRITERI SPECIFICI IDENTIFICATI:
${JSON.stringify(valutazioneObj.analisi_criteri, null, 2)}
` : ''}

IMPORTANTE:
- NON inventare dati numerici (ore, percentuali, costi)
- Basa tutto SOLO sulla valutazione gi√† fatta
- Usa linguaggio qualitativo: "potrebbe", "tendenzialmente", "in generale"
- NON fare affermazioni categoriche senza evidenza dal programma

Genera un JSON con questa struttura:

{
  "insights_adozione": {
    "punti_forza_programma": ["forza1 basata su punteggi alti", "forza2"],
    "aspetti_migliorabili": ["aspetto1 basato su punteggi bassi o note critiche", "aspetto2"],
    "opportunita_manuale": "Descrizione qualitativa (150-200 parole) di che tipo di manuale sarebbe ideale per questo programma, basandoti su: moduli coperti, livello, enfasi, criteri specifici (se presenti)"
  }${valutazioneObj.analisi_criteri ? `,
  "analisi_criteri_approfondita": {
    "implicazioni_didattiche": "Analisi (200-300 parole) di cosa significano i criteri identificati per la scelta del manuale. Es: se programma √® Keynesiano, quale tipo di manuale serve? Se sequenza √® Breve->Lungo, cosa cercare?",
    "compatibilita_manuale_ideale": "Descrizione del manuale ideale che rispetta questi criteri"
  }` : ''}
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                        const insightsResponse = await callLLM(insightsPrompt, 0.2);
                        const insightsObj = JSON.parse(sanitizeJSON(insightsResponse));
                        
                        // Aggiungi a valutazioneObj
                        valutazioneObj.insights_adozione = insightsObj.insights_adozione;
                        if (insightsObj.analisi_criteri_approfondita) {
                            valutazioneObj.analisi_criteri_approfondita = insightsObj.analisi_criteri_approfondita;
                        }
                        console.log('‚úÖ Fase 2b (Avanzata) completata');
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Fase 2b (Avanzata) fallita, continuo comunque:', error.message);
                    }
                }

                // Fase 3: Gap analysis vs manuale adottato (TEMPERATURE ABBASSATA A 0.1)
                updateLoadingText('Fase 3/5: Analisi gap con manuale adottato...');
                const manualeInfo = MANUALI_DB[manuale] || {};
                
                // Carica indice completo del manuale adottato (se presente nel catalogo)
                let indiceManualeAdottato = '';
                try {
                    console.log(`üîç Ricerca manuale adottato nel MANUAL_CATALOG: "${manuale}"`);
                    // Ricerca pi√π precisa: priorit√† a ID esatto, poi match parziali pi√π stringenti
                    const catalogEntryAdottato = MANUAL_CATALOG.manuals.find(m => m.id === manuale) ||
                        MANUAL_CATALOG.manuals.find(m => {
                            const manualeWords = manuale.toLowerCase().split(/[_\s-]+/);
                            const titleWords = m.title.toLowerCase().split(/[_\s-]+/);
                            const authorWords = (m.author || '').toLowerCase().split(/[_\s-]+/);
                            // Match se almeno 2 parole del manuale appaiono nel titolo o 1 parola nel titolo + 1 nell'autore
                            const titleMatches = manualeWords.filter(w => w.length > 2 && titleWords.some(tw => tw.includes(w) || w.includes(tw)));
                            const authorMatches = manualeWords.filter(w => w.length > 2 && authorWords.some(aw => aw.includes(w) || w.includes(aw)));
                            return titleMatches.length >= 2 || (titleMatches.length >= 1 && authorMatches.length >= 1);
                        });
                    
                    if (catalogEntryAdottato && catalogEntryAdottato.filepath) {
                        console.log(`‚úÖ Manuale adottato trovato nel catalog: ${catalogEntryAdottato.title}`);
                        const manualeAdottatoData = await fetch(catalogEntryAdottato.filepath).then(r => r.json());
                        if (manualeAdottatoData.chapters && manualeAdottatoData.chapters.length > 0) {
                            indiceManualeAdottato = '\n\nINDICE COMPLETO DEL MANUALE ADOTTATO:\n' + manualeAdottatoData.chapters.map(ch => 
                                `   ${ch.number}. ${ch.title}`
                            ).join('\n');
                            console.log(`‚úÖ Indice manuale adottato caricato (${manualeAdottatoData.chapters.length} capitoli)`);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è Manuale adottato "${manuale}" non trovato nel MANUAL_CATALOG`);
                    }
                } catch (err) {
                    console.warn(`‚ö†Ô∏è Impossibile caricare indice del manuale adottato:`, err.message);
                }
                
                // Costruzione dinamica del prompt basato sul framework caricato
                const frameworkData3 = CURRENT_FRAMEWORK;
                if (!frameworkData3 || !frameworkData3.content) {
                    throw new Error('Framework non caricato. Seleziona prima un framework valido.');
                }
                const moduliList3 = frameworkData3.content.syllabus_modules.map((mod, idx) => {
                    const modNum = String(idx + 1).padStart(2, '0');
                    return `   - MOD-${modNum} ${mod.name}`;
                }).join('\n');
                
                const profilesList3 = frameworkData3.content.program_profiles.map(prof => {
                    return `   - ${prof.name}: ${prof.priority_modules}`;
                }).join('\n');
                
                // Genera evaluation_criteria se esistono (Fase 3)
                let evaluationCriteriaText3 = '';
                if (frameworkData3.content.evaluation_criteria) {
                    const criteriaEntries = Object.entries(frameworkData3.content.evaluation_criteria);
                    if (criteriaEntries.length > 0) {
                        evaluationCriteriaText3 = '\nCRITERI DI VALUTAZIONE SPECIFICI PER ' + materiaName.toUpperCase() + ':\n' +
                            criteriaEntries.map(([key, value]) => `   ‚Ä¢ ${value}`).join('\n') + '\n';
                        console.log('‚úÖ FASE 3: Inclusi ' + criteriaEntries.length + ' evaluation_criteria per ' + materiaName);
                    }
                } else {
                    console.log('‚ÑπÔ∏è FASE 3: Nessun evaluation_criteria per ' + materiaName);
                }
                
                // Prompt diverso per Base vs Avanzata
                const istruzioniDettaglio = tipoAnalisi === 'avanzata' ? `
MODALIT√Ä ANALISI AVANZATA:
- Per ogni punto di forza/debolezza, fornisci una spiegazione dettagliata (1-2 frasi) con esempi concreti dal contenuto del manuale
- Nel campo "note", scrivi un'analisi dettagliata (100-150 parole) che spieghi:
  * Come il manuale tratta gli argomenti chiave del programma
  * Limitazioni specifiche con esempi concreti
  * Conseguenze per gli studenti
- Usa linguaggio descrittivo e professionale, evita percentuali generiche` : `
MODALIT√Ä ANALISI BASE:
- Punti di forza/debolezza sintetici (1 frase ciascuno)
- Note concise (50-100 parole)`;
                
                const gapManuale = await callLLM( `Valuta il manuale "${manuale}" (${manualeInfo.editore || ''}) rispetto a questo programma di ${materiaName} usando il FRAMEWORK DI VALUTAZIONE MANUALI.${istruzioniDettaglio}

MATERIA: ${materiaName}
FRAMEWORK: ${frameworkName}

PROGRAMMA:
${testo}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

MANUALE ADOTTATO: ${manuale}
EDITORE: ${manualeInfo.editore || 'N/D'}${indiceManualeAdottato}

CARATTERISTICHE MANUALE:
${JSON.stringify(manualeInfo.caratteristiche || [])}

FRAMEWORK VALUTAZIONE MANUALI (270 punti):
Valuta il manuale su 5 criteri principali considerando le PRIORIT√Ä per ${contesto}:

1. OBIETTIVI FORMATIVI (max 40):
   - Completezza, Chiarezza, Coerenza standard, Interdisciplinarit√†

2. CONTENUTI PROGRAMMATICI (max 130):
   Valuta copertura dei MODULI del framework ${frameworkName} rispetto al programma:
${moduliList3}
   
   PRIORIT√Ä SPECIFICHE PER CLASSE DI LAUREA:
${profilesList3}
${evaluationCriteriaText3}

3. METODOLOGIA DIDATTICA (max 40):
   - Didattica attiva, Materiali, Valutazione, Supporto studente

4. ALLINEAMENTO CURRICULUM (max 30):
   - Coerenza moduli, Progressione, Flessibilit√†

5. RISULTATI ATTESI (max 30):
   - Competenze tecnico-scientifiche, trasversali, preparazione professionale

ANALISI DETTAGLIATA:
1. Argomenti del programma COPERTI dal manuale
2. Argomenti del programma NON COPERTI (gap) - CRITICI per ${contesto}
3. Argomenti del manuale ECCEDENTI rispetto al programma
4. PUNTI DI FORZA del manuale per questo programma
5. PUNTI DI DEBOLEZZA del manuale per questo programma

${evaluationCriteriaText3 ? `
‚ö†Ô∏è IMPORTANTE: Valuta la COMPATIBILIT√Ä del manuale rispetto ai CRITERI SPECIFICI identificati nel programma:
- Confronta la scuola di pensiero del programma con quella del manuale
- Confronta la sequenza didattica (breve/lungo periodo)
- Confronta il livello di formalizzazione matematica
- Identifica eventuali INCOMPATIBILIT√Ä FILOSOFICHE O DIDATTICHE
` : ''}

Rispondi SOLO con un JSON valido:
{
  "coperti": ["arg1", "arg2"],
  "gap": ["arg_mancante1", "arg_mancante2"],
  "eccedenti": ["arg_extra1"],
  "punti_forza": ["forza1", "forza2", "forza3"],
  "punti_debolezza": ["debolezza1", "debolezza2"],
  "copertura_percentuale": numero,
  "compatibilita": "Alta/Media/Bassa",
  "punteggio_framework": numero_su_270,${evaluationCriteriaText3 ? `
  "compatibilita_criteri": {
    "scuola_pensiero_programma": "identificata dal programma",
    "scuola_pensiero_manuale": "identificata nel manuale",
    "allineamento_filosofico": "Alta/Media/Bassa con spiegazione",
    "sequenza_programma": "identificata dal programma",
    "sequenza_manuale": "identificata nel manuale",
    "allineamento_didattico": "Alta/Media/Bassa con spiegazione",
    "note_compatibilita": "analisi dettagliata delle compatibilit√†/incompatibilit√†"
  },` : ''}
  "note": "commento dettagliato sulla compatibilit√† considerando le priorit√† ${contesto}"
}`, 0.1);

                const gapManualeObj = JSON.parse(sanitizeJSON(gapManuale));

                // Fase 3c: Analisi Avanzata - Insights Adozione Gap (SOLO se Analisi Avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Fase 3c/5: Analisi avanzata impatto gap...');
                    
                    try {
                        const gapInsightsPrompt = `Basandoti ESCLUSIVAMENTE sull'analisi gap gi√† effettuata, genera insights per un promotore editoriale.

ANALISI GAP GI√Ä EFFETTUATA:
- Manuale analizzato: ${manuale}
- Gap identificati: ${JSON.stringify(gapManualeObj.gap || [])}
- Punti debolezza: ${JSON.stringify(gapManualeObj.punti_debolezza || [])}
- Compatibilit√†: ${gapManualeObj.compatibilita}
- Copertura: ${gapManualeObj.copertura_percentuale}%

${gapManualeObj.compatibilita_criteri ? `
INCOMPATIBILIT√Ä CRITERI SPECIFICI:
${JSON.stringify(gapManualeObj.compatibilita_criteri, null, 2)}
` : ''}

IMPORTANTE:
- NON inventare dati numerici (ore, percentuali precise, costi)
- Basa tutto SOLO sui gap e incompatibilit√† gi√† identificate
- Usa linguaggio qualitativo: "potrebbe richiedere", "probabilmente necessita"
- Sii specifico ma qualitativo

Genera un JSON con questa struttura:

{
  "analisi_impatto_adozione": {
    "gap_critici_insegnamento": [
      {
        "gap": "gap identificato dall'analisi",
        "possibile_impatto_docente": "Cosa il docente potrebbe dover fare (es: preparare materiale integrativo)",
        "possibile_impatto_studenti": "Come questo gap potrebbe influenzare la preparazione"
      }
    ],
    "sintesi_criticita": "Descrizione qualitativa (150-200 parole) delle principali criticit√† del manuale attuale per questo specifico programma",
    "benefici_potenziali_cambio": "Descrizione qualitativa (100-150 parole) di cosa un manuale pi√π allineato potrebbe offrire, basandoti sui gap identificati"
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                        const gapInsightsResponse = await callLLM(gapInsightsPrompt, 0.2);
                        const gapInsightsObj = JSON.parse(sanitizeJSON(gapInsightsResponse));
                        
                        // Aggiungi a gapManualeObj
                        gapManualeObj.analisi_impatto_adozione = gapInsightsObj.analisi_impatto_adozione;
                        console.log('‚úÖ Fase 3c (Avanzata) completata');
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Fase 3c (Avanzata) fallita, continuo comunque:', error.message);
                    }
                }

                // Fase 3b: Analisi gap manuali alternativi (se presenti)
                const gapAlternativi = [];
                if (manualiAlternativi.length > 0) {
                    updateLoadingText(`Fase 3b/4: Analisi ${manualiAlternativi.length} manuali alternativi...`);
                    
                    for (const manualeAlt of manualiAlternativi) {
                        console.log(`üîç Elaborazione manuale alternativo: "${manualeAlt}"`);
                        const manualeInfo = MANUALI_DB[manualeAlt] || {};
                        
                        // Carica indice completo del manuale alternativo dal JSON
                        let indiceManuale = '';
                        try {
                            console.log(`üìö Ricerca nel MANUAL_CATALOG per ID: "${manualeAlt}"`);
                            const catalogEntry = MANUAL_CATALOG.manuals.find(m => m.id === manualeAlt);
                            
                            if (!catalogEntry) {
                                console.warn(`‚ùå Manuale "${manualeAlt}" NON trovato nel MANUAL_CATALOG`);
                                console.log(`üìã Manuali disponibili:`, MANUAL_CATALOG.manuals.map(m => m.id).join(', '));
                            } else {
                                console.log(`‚úÖ Trovato nel catalog:`, catalogEntry.title, `- filepath: ${catalogEntry.filepath}`);
                                
                                if (catalogEntry.filepath) {
                                    console.log(`üîÑ Caricamento file JSON: ${catalogEntry.filepath}`);
                                    const manualeData = await fetch(catalogEntry.filepath).then(r => r.json());
                                    console.log(`üìñ File caricato, capitoli trovati: ${manualeData.chapters?.length || 0}`);
                                    
                                    if (manualeData.chapters && manualeData.chapters.length > 0) {
                                        // Include TUTTI i capitoli (non limitare a 15)
                                        indiceManuale = '\n   INDICE:\n' + manualeData.chapters.map(ch => 
                                            `   ${ch.number}. ${ch.title}`
                                        ).join('\n');
                                        console.log(`‚úÖ Indice generato (${manualeData.chapters.length} capitoli)`);
                                    }
                                }
                            }
                        } catch (err) {
                            console.error(`‚ö†Ô∏è Errore caricamento indice di ${manualeAlt}:`, err);
                        }
                        
                        const gapAlt = await callLLM(`Valuta il manuale "${manualeAlt}" (${manualeInfo.editore || ''}) rispetto a questo programma di ${materiaName} usando il FRAMEWORK DI VALUTAZIONE MANUALI.${istruzioniDettaglio}

MATERIA: ${materiaName}
FRAMEWORK: ${frameworkName}

PROGRAMMA:
${testo}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

MANUALE ALTERNATIVO: ${manualeAlt}
EDITORE: ${manualeInfo.editore || 'N/D'}${indiceManuale}

CARATTERISTICHE MANUALE:
${JSON.stringify(manualeInfo.caratteristiche || [])}

FRAMEWORK VALUTAZIONE MANUALI (270 punti):
Valuta il manuale su 5 criteri principali considerando le PRIORIT√Ä per ${contesto}:

1. OBIETTIVI FORMATIVI (max 40):
   - Completezza, Chiarezza, Coerenza standard, Interdisciplinarit√†

2. CONTENUTI PROGRAMMATICI (max 130):
   Valuta copertura dei MODULI del framework ${frameworkName} rispetto al programma:
${moduliList3}
   
   PRIORIT√Ä SPECIFICHE PER CLASSE DI LAUREA:
${profilesList3}
${evaluationCriteriaText3}

3. METODOLOGIA DIDATTICA (max 40):
   - Didattica attiva, Materiali, Valutazione, Supporto studente

4. ALLINEAMENTO CURRICULUM (max 30):
   - Coerenza moduli, Progressione, Flessibilit√†

5. RISULTATI ATTESI (max 30):
   - Competenze tecnico-scientifiche, trasversali, preparazione professionale

ANALISI DETTAGLIATA:
1. Argomenti del programma COPERTI dal manuale
2. Argomenti del programma NON COPERTI (gap) - CRITICI per ${contesto}
3. Argomenti del manuale ECCEDENTI rispetto al programma
4. PUNTI DI FORZA del manuale per questo programma
5. PUNTI DI DEBOLEZZA del manuale per questo programma

${evaluationCriteriaText3 ? `
‚ö†Ô∏è IMPORTANTE: Valuta la COMPATIBILIT√Ä del manuale rispetto ai CRITERI SPECIFICI identificati nel programma:
- Confronta la scuola di pensiero del programma con quella del manuale
- Confronta la sequenza didattica (breve/lungo periodo)
- Confronta il livello di formalizzazione matematica
` : ''}

Rispondi SOLO con un JSON valido:
{
  "manuale": "${manualeAlt}",
  "coperti": ["arg1", "arg2"],
  "gap": ["arg_mancante1", "arg_mancante2"],
  "eccedenti": ["arg_extra1"],
  "punti_forza": ["forza1", "forza2", "forza3"],
  "punti_debolezza": ["debolezza1", "debolezza2"],
  "copertura_percentuale": numero,
  "compatibilita": "Alta/Media/Bassa",
  "punteggio_framework": numero_su_270,${evaluationCriteriaText3 ? `
  "compatibilita_criteri": {
    "scuola_pensiero_manuale": "identificata",
    "allineamento_filosofico": "Alta/Media/Bassa",
    "note": "breve nota compatibilit√†"
  },` : ''}
  "note": "commento dettagliato sulla compatibilit√† considerando le priorit√† ${contesto}"
}`, 0.1);

                        try {
                            console.log(`Risposta GPT per ${manualeAlt}:`, gapAlt);
                            const gapAltObj = JSON.parse(sanitizeJSON(gapAlt));
                            console.log(`JSON parsed per ${manualeAlt}:`, gapAltObj);
                            gapAlternativi.push(gapAltObj);
                        } catch (e) {
                            console.error(`Errore parsing gap ${manualeAlt}:`, e);
                            console.error(`Risposta raw:`, gapAlt);
                        }
                    }
                }

                // Fase 4: Valutazione Manuali Zanichelli (DINAMICA)
                updateLoadingText('Fase 4/5: Valutazione manuali consigliati...');
                
                // Filtra manuali Zanichelli per la materia corrente
                const manualiZanichelliPerMateria = Object.values(MANUAL_CATALOG.manuals).filter(m => 
                    m.type === 'zanichelli' && m.subject === materiaName
                );
                
                console.log(`üìö Trovati ${manualiZanichelliPerMateria.length} manuali Zanichelli per ${materiaName}`);
                
                let zanichelliObj = null;
                
                if (manualiZanichelliPerMateria.length === 0) {
                    console.warn('‚ö†Ô∏è Nessun manuale Zanichelli trovato per questa materia');
                    zanichelliObj = {
                        manuali: [],
                        nota: `Nessun manuale Zanichelli disponibile nel catalogo per ${materiaName}`
                    };
                } else {
                    // Carica indici completi dei manuali Zanichelli
                    const manualiConIndici = [];
                    for (const manuale of manualiZanichelliPerMateria.slice(0, 3)) {
                        let indice = '';
                        try {
                            const manualeData = await fetch(manuale.filepath).then(r => r.json());
                            if (manualeData.chapters && manualeData.chapters.length > 0) {
                                // Include TUTTI i capitoli
                                indice = '\n   INDICE:\n' + manualeData.chapters.map(ch => 
                                    `   ${ch.number}. ${ch.title}`
                                ).join('\n');
                                console.log(`‚úÖ Indice Zanichelli caricato: ${manuale.title} (${manualeData.chapters.length} capitoli)`);
                            }
                        } catch (err) {
                            console.warn(`‚ö†Ô∏è Impossibile caricare indice di ${manuale.title}:`, err.message);
                        }
                        manualiConIndici.push({
                            info: `${manuale.author} - ${manuale.title} (${manuale.pages} pag, ‚Ç¨${manuale.price || 'N/D'})`,
                            indice: indice
                        });
                    }
                    
                    // Genera valutazione dinamica per i manuali Zanichelli
                    const manualiInfo = manualiConIndici.map((m, idx) => 
                        `${idx + 1}. ${m.info}${m.indice}`
                    ).join('\n');
                    
                    const zanichelliPrompt = `Sei un esperto valutatore di manuali universitari.

Valuta la compatibilit√† dei seguenti manuali Zanichelli con questo programma di ${materiaName}:

MANUALI ZANICHELLI DISPONIBILI:
${manualiInfo}

PROGRAMMA DEL CORSO:
${testo}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}
- Framework: ${frameworkName}

PROFILO PEDAGOGICO (Fase 0):
- Approccio: ${fase0.profilo_pedagogico.approccio}
- Livello: ${fase0.profilo_pedagogico.livello}
- Enfasi: ${fase0.profilo_pedagogico.enfasi.join(', ')}

BIBLIOGRAFIA ADOTTATA:
${Array.isArray(manuale) ? manuale.join(' + ') : manuale}

${evaluationCriteriaText3 ? `
ANALISI CRITERI SPECIFICI DEL PROGRAMMA (dalla Fase 2):
${JSON.stringify(valutazioneObj.analisi_criteri || {}, null, 2)}

‚ö†Ô∏è USA QUESTI CRITERI PER LA RACCOMANDAZIONE:
Nella valutazione dei manuali Zanichelli, considera:
- Scuola di pensiero del programma vs scuola del manuale
- Sequenza didattica del programma vs sequenza del manuale
- Livello di formalizzazione richiesto vs livello del manuale
- Modelli trattati nel programma vs modelli nel manuale
` : ''}

COMPITO:
Ordina i manuali Zanichelli per compatibilit√† con questo programma specifico.
Per ogni manuale, valuta:

1. COMPATIBILIT√Ä CON IL PROGRAMMA (0-100 punti):
   - Copertura degli argomenti del programma
   - Allineamento con il profilo pedagogico del docente
   - Adeguatezza al livello del corso

2. PUNTI DI FORZA:
   - Aspetti distintivi del manuale
   - Quando √® particolarmente adatto

3. GAP (se presenti):
   - Argomenti del programma non coperti
   - Limitazioni rispetto alle esigenze del corso

4. RACCOMANDAZIONE:
   - "RACCOMANDATO" per il manuale pi√π compatibile
   - "ALTERNATIVA" per gli altri manuali

5. CONFRONTO CON BIBLIOGRAFIA ADOTTATA:
   - Come il manuale Zanichelli si confronta con quello attualmente adottato
   - Vantaggi specifici

Rispondi SOLO con un JSON valido:
{
  "manuali": [
    {
      "nome": "nome completo manuale",
      "autore": "autore",
      "compatibilita": numero_0_100,
      "punti_forza": ["forza1", "forza2", "forza3"],
      "gap": ["gap1", "gap2"] oppure [],
      "quando_preferirlo": "descrizione contesto ideale",
      "confronto_bibliografia": "confronto con manuale adottato",${evaluationCriteriaText3 ? `
      "compatibilita_criteri": "analisi compatibilit√† con scuola pensiero/sequenza/formalizzazione programma",` : ''}
      "raccomandazione": "RACCOMANDATO|ALTERNATIVA"
    }
  ],
  "sintesi": "sintesi generale della valutazione"
}`;

                    try {
                        const zanichelliResponse = await callLLM(zanichelliPrompt, 0.2);
                        zanichelliObj = JSON.parse(sanitizeJSON(zanichelliResponse));
                        console.log('‚úÖ Valutazione Zanichelli completata:', zanichelliObj);
                        
                        // Fase 4b: Analisi Avanzata - Strategia Adozione (SOLO se Analisi Avanzata E ci sono manuali)
                        if (tipoAnalisi === 'avanzata' && zanichelliObj.manuali && zanichelliObj.manuali.length > 0) {
                            updateLoadingText('Fase 4b/5: Strategia adozione avanzata...');
                            
                            try {
                                const strategiaPrompt = `Basandoti ESCLUSIVAMENTE sulla valutazione Zanichelli gi√† effettuata, genera una strategia di adozione per un promotore editoriale.

VALUTAZIONE ZANICHELLI GI√Ä EFFETTUATA:
${JSON.stringify(zanichelliObj, null, 2)}

MANUALE ATTUALMENTE ADOTTATO: ${manuale}

GAP MANUALE ATTUALE:
${JSON.stringify(gapManualeObj.gap || [])}
${JSON.stringify(gapManualeObj.punti_debolezza || [])}

${gapManualeObj.compatibilita_criteri ? `
INCOMPATIBILIT√Ä MANUALE ATTUALE:
${JSON.stringify(gapManualeObj.compatibilita_criteri, null, 2)}
` : ''}

IMPORTANTE:
- NON inventare dati (prezzi, percentuali precise, ore esatte)
- Basa tutto SOLO sulle valutazioni gi√† fatte
- Usa linguaggio qualitativo e professionale
- Focus su benefici didattici, non commerciali

Genera un JSON con questa struttura:

{
  "strategia_adozione": {
    "manuale_primario": {
      "nome": "nome del manuale RACCOMANDATO dalla valutazione",
      "argomenti_chiave": ["argomento1 specifico basato su punti_forza", "argomento2 che risolve gap manuale attuale"],
      "confronto_manuale_attuale": "Descrizione qualitativa (150-200 parole) di come questo manuale Zanichelli risolve i gap e incompatibilit√† del manuale attuale, basandoti SOLO su gap identificati",
      "possibili_obiezioni": [
        {
          "obiezione": "obiezione realistica che il docente potrebbe sollevare",
          "risposta": "risposta basata su evidenze dall'analisi (gap risolti, compatibilit√† criteri)"
        }
      ]
    },
    "note_colloquio": "Suggerimenti (100-150 parole) su come presentare il manuale al docente, basandoti su: profilo docente (se disponibile), gap identificati, compatibilit√† criteri"
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                                const strategiaResponse = await callLLM(strategiaPrompt, 0.2);
                                const strategiaObj = JSON.parse(sanitizeJSON(strategiaResponse));
                                
                                // Aggiungi a zanichelliObj
                                zanichelliObj.strategia_adozione = strategiaObj.strategia_adozione;
                                console.log('‚úÖ Fase 4b (Avanzata) completata');
                                
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Fase 4b (Avanzata) fallita, continuo comunque:', error.message);
                            }
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Errore valutazione Zanichelli:', error);
                        zanichelliObj = {
                            manuali: [],
                            errore: error.message,
                            nota: 'Impossibile completare la valutazione Zanichelli'
                        };
                    }
                }
                
                /* VECCHIA FASE 4 - DISABILITATA
                // Fase 4: Valutazione Zanichelli (TEMPERATURE ABBASSATA A 0.1)
                updateLoadingText('Fase 4/5: Valutazione compatibilit√† Zanichelli...');
                
                // Verifica se il manuale adottato √® Zanichelli
                const manualiZanichelli = ['McMurryBiologico', 'Hart', 'McMurryFondamenti'];
                const isZanichelliAdottato = manualiZanichelli.includes(manuale);
                
                // Istruzioni per modalit√† avanzata Zanichelli
                const istruzioniZanichelli = tipoAnalisi === 'avanzata' ? `
MODALIT√Ä ANALISI AVANZATA:
- Per ogni punto di forza, fornisci spiegazione dettagliata (1-2 frasi) con esempi concreti di come il manuale tratta gli argomenti
- Per ogni gap, spiega le conseguenze per gli studenti
- Nel campo "quando_preferirlo", scrivi un paragrafo dettagliato (80-100 parole) che spieghi:
  * Caratteristiche del corso ideale (CFU, obiettivi, contesto)
  * Tipologia di studenti pi√π adatta
  * Vantaggi specifici per quel contesto
- Nel campo "confronto_bibliografia", scrivi un'analisi dettagliata (100-120 parole) che confronti:
  * Come il manuale Zanichelli risolve le limitazioni del manuale adottato
  * Esempi concreti di argomenti trattati meglio
- Usa linguaggio descrittivo e argomentazioni commerciali esplicite` : `
MODALIT√Ä ANALISI BASE:
- Punti di forza/gap sintetici (1 frase ciascuno)
- Quando preferirlo: descrizione breve (50 parole)
- Confronto bibliografia: sintesi concisa (50-100 parole)`;
                
                const zanichelli = await callLLM( `Valuta la compatibilit√† di TUTTI E 3 i manuali Zanichelli di Chimica Organica con questo programma:${istruzioniZanichelli}

1. Hart - Fondamenti di chimica organica (520 pag, ‚Ç¨65, livello base)
2. McMurry - Fondamenti di chimica organica (536 pag, ‚Ç¨67.50, livello intermedio)  
3. McMurry - Chimica organica: approccio biologico (896 pag, ‚Ç¨101.40, livello avanzato con focus bio)

Programma:
${testo.substring(0, 2000)}

Contesto: ${contesto}
Bibliografia adottata: ${Array.isArray(manuale) ? manuale.join(' + ') : manuale}

${isZanichelliAdottato ? `
IMPORTANTE: Il manuale attualmente adottato √à GI√Ä ZANICHELLI (${manuale}).
Devi valutare se:
- MANTENERE il manuale attuale (se √® ottimale)
- UPGRADE a un altro Zanichelli (se ce n'√® uno migliore)
- DOWNGRADE a un altro Zanichelli (se il programma √® pi√π semplice)

Nel campo "raccomandazione" usa: "MANTENERE", "UPGRADE", o "DOWNGRADE".
` : `
IMPORTANTE: Il manuale attualmente adottato NON √à ZANICHELLI (${manuale}).
Stai raccomandando un NUOVO manuale Zanichelli per sostituire quello attuale.

Nel campo "raccomandazione" usa SEMPRE:
- "RACCOMANDATO" per il manuale pi√π compatibile
- "ALTERNATIVA" per gli altri due manuali

NON usare MAI "MANTENERE" perch√© il docente non usa attualmente Zanichelli.
`}

CRITERI DI VALUTAZIONE:
1. Compatibilit√† con il programma (copertura argomenti)
2. Adeguatezza al livello del corso (un manuale troppo completo per un programma breve √® uno SVANTAGGIO!)
3. Rapporto qualit√†/prezzo (Hart ‚Ç¨65 vs McMurry ‚Ç¨90-100)
4. Accessibilit√† per gli studenti (520 pag vs 896 pag)

Raccomanda il manuale con il MIGLIOR EQUILIBRIO tra questi fattori, non necessariamente il pi√π completo.

IMPORTANTE SU HART:
Hart √® il manuale pi√π SINTETICO (‚Ç¨65, 520 pag) ed ECONOMICO.
Raccomandalo quando:
- Programma < 6 CFU o essenziale (solo reazioni base)
- Nessuna enfasi particolare su biomolecole
- Studenti con difficolt√† in chimica (sintesi = vantaggio)
- Budget limitato
NON penalizzarlo solo perch√© √® pi√π breve! La SINTESI pu√≤ essere un VANTAGGIO.

Ordina i 3 manuali per compatibilit√† (dal pi√π al meno compatibile) e fornisci per ognuno:
- Punteggio compatibilit√† (0-100)
- Punti di forza specifici
- Gap specifici (se presenti)
- Quando preferirlo (contesto ideale)
- Confronto con bibliografia adottata
- Raccomandazione (MANTENERE/UPGRADE/DOWNGRADE/RACCOMANDATO)

Rispondi SOLO con un JSON valido:
{
  "raccomandato": {
    "titolo": "Nome manuale pi√π compatibile",
    "punteggio": numero,
    "compatibilita": "Alta/Media/Bassa",
    "raccomandazione": "MANTENERE/UPGRADE/DOWNGRADE/RACCOMANDATO",
    "punti_forza": ["punto1", "punto2"],
    "gap": ["gap1", "gap2"],
    "quando_preferirlo": "descrizione contesto ideale",
    "confronto_bibliografia": "confronto con bibliografia adottata",
    "prezzo": "‚Ç¨XX"
  },
  "alternative": [
    {
      "titolo": "Seconda scelta",
      "punteggio": numero,
      "compatibilita": "Alta/Media/Bassa",
      "raccomandazione": "MANTENERE/UPGRADE/DOWNGRADE/ALTERNATIVA", 
      "punti_forza": ["punto1", "punto2"],
      "gap": ["gap1", "gap2"],
      "quando_preferirlo": "descrizione",
      "confronto_bibliografia": "confronto",
      "prezzo": "‚Ç¨XX"
    },
    {
      "titolo": "Terza scelta",
      "punteggio": numero,
      "compatibilita": "Alta/Media/Bassa",
      "raccomandazione": "MANTENERE/UPGRADE/DOWNGRADE/ALTERNATIVA",
      "punti_forza": ["punto1", "punto2"], 
      "gap": ["gap1", "gap2"],
      "quando_preferirlo": "descrizione",
      "confronto_bibliografia": "confronto",
      "prezzo": "‚Ç¨XX"
    }
  ],
  "raccomandazioni_generali": ["racc1", "racc2"]
}`, 0.1);

                const zanichelliObj = JSON.parse(sanitizeJSON(zanichelli));
                */  // FINE VECCHIA FASE 4 - DISABILITATA
                
                // Crea risultato
                currentProgramma = {
                    id: Date.now(),
                    ...metadataObj,
                    framework_name: frameworkName, // Nome del framework selezionato
                    materia: materiaName, // Nome della materia
                    contesto: contesto,
                    manuale_adottato: manuale === 'Altro' ? manualeNomePersonalizzato : manuale,
                    manuale_adottato_tipo: manuale, // 'Altro' o nome manuale standard
                    manuali_alternativi: manualiAlternativi,
                    cfu: cfu || null,
                    ore: ore || null,
                    analisi_preliminare: fase0, // Fase 0: Quadro Generale + Profilo Pedagogico
                    punteggi: {
                        obiettivi: valutazioneObj.obiettivi.punteggio,
                        contenuti: valutazioneObj.contenuti.punteggio,
                        metodologia: valutazioneObj.metodologia.punteggio,
                        allineamento: valutazioneObj.allineamento.punteggio,
                        risultati: valutazioneObj.risultati.punteggio,
                        totale: totale
                    },
                    valutazione: valutazioneObj,
                    gap_manuale: gapManualeObj,
                    gap_alternativi: gapAlternativi,
                    zanichelli: zanichelliObj,
                    tipo_analisi: tipoAnalisi,
                    created_at: new Date().toISOString()
                };

                // Salva nello storico
                saveToStorico(currentProgramma);

                // Mostra risultati
                mostraRisultati(currentProgramma);

            } catch (error) {
                showError('Errore durante l\'analisi: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('btnAnalizza').disabled = false;
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }

        // Funzione per sanitizzare JSON da risposte GPT-4
        function sanitizeJSON(text) {
            // Rimuovi markdown code blocks
            text = text.replace(/```json|```/g, '').trim();
            
            // Rimuovi eventuali testi prima/dopo il JSON
            // Cerca il primo { e l'ultimo }
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            
            if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                text = text.substring(firstBrace, lastBrace + 1);
            }
            
            // Prova prima il parsing diretto
            try {
                JSON.parse(text);
                return text; // Se funziona, ritorna cos√¨ com'√®
            } catch (e) {
                // Se fallisce, prova a riparare il JSON
                console.log('‚ö†Ô∏è JSON non valido, tento riparazione:', e.message);
                console.log('üìÑ Primi 500 caratteri:', text.substring(0, 500));
                
                // Strategia 1: Rimuovi caratteri di controllo
                let fixed = text
                    .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Rimuovi caratteri di controllo
                    .replace(/\n/g, ' ') // Sostituisci newline con spazio
                    .replace(/\r/g, ' ') // Sostituisci carriage return
                    .replace(/\t/g, ' '); // Sostituisci tab
                
                // Strategia 2: Fixa virgole mancanti o extra
                fixed = fixed
                    .replace(/,\s*([}\]])/g, '$1') // Rimuovi virgole prima di } o ]
                    .replace(/([}\]])\s*([^,}\]])/g, '$1,$2'); // Aggiungi virgole mancanti
                
                // Strategia 3: Fixa apici non escaped
                fixed = fixed.replace(/"([^"\\]*(?:\\.[^"\\]*)*)"/g, (match, content) => {
                    // Escape caratteri speciali dentro le stringhe
                    let sanitized = content
                        .replace(/\\/g, '\\\\')  // Escape backslash
                        .replace(/"/g, '\\"')    // Escape quote
                        .replace(/\n/g, '\\n')   // Escape newline
                        .replace(/\r/g, '\\r')   // Escape carriage return
                        .replace(/\t/g, '\\t');  // Escape tab
                    return '"' + sanitized + '"';
                });
                
                // Verifica se ora funziona
                try {
                    JSON.parse(fixed);
                    console.log('‚úÖ JSON riparato con successo!');
                    return fixed;
                } catch (e2) {
                    console.error('‚ùå Impossibile riparare il JSON:', e2.message);
                    console.error('üìÑ JSON originale (primi 800 caratteri):', text.substring(0, 800));
                    console.error('üîß JSON riparato (primi 800 caratteri):', fixed.substring(0, 800));
                    
                    // Ultimo tentativo: prova con json-repair library logic
                    // (implementazione manuale di fix comuni)
                    try {
                        // Strategia 4: Aggiungi virgolette mancanti alle chiavi
                        let lastFix = fixed.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                        JSON.parse(lastFix);
                        console.log('‚úÖ JSON riparato con fix chiavi!');
                        return lastFix;
                    } catch (e3) {
                        console.error('‚ùå Tutti i tentativi di riparazione falliti');
                        throw new Error('JSON non valido anche dopo sanitizzazione: ' + e2.message);
                    }
                }
            }
        }

        // Chiamata LLM Unificata (OpenAI o Perplexity) con Retry Automatico
        async function callLLM(prompt, temperature, maxRetries = 3) {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`Tentativo ${attempt}/${maxRetries} per chiamata LLM...`);
                    
                    let response;
                    if (provider === 'openai') {
                        response = await callOpenAI(prompt, temperature);
                    } else {
                        response = await callPerplexity(prompt, temperature);
                    }
                    
                    // Verifica che la risposta non sia vuota
                    if (!response || response.trim().length === 0) {
                        throw new Error('Risposta vuota da GPT-4');
                    }
                    
                    console.log(`Risposta ricevuta (${response.length} caratteri)`);
                    return response;
                    
                } catch (error) {
                    console.error(`Tentativo ${attempt} fallito:`, error.message);
                    
                    if (attempt === maxRetries) {
                        // Ultimo tentativo fallito, lancia errore
                        throw new Error(`Chiamata LLM fallita dopo ${maxRetries} tentativi: ${error.message}`);
                    }
                    
                    // Attendi prima di riprovare (backoff esponenziale)
                    const waitTime = Math.pow(2, attempt) * 1000; // 2s, 4s, 8s
                    console.log(`Attendo ${waitTime/1000}s prima di riprovare...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }
        
        async function callOpenAI(prompt, temperature) {
            const apiKey = localStorage.getItem('openai_api_key') || null; // null = user√† quella su Netlify
            const model = localStorage.getItem('openai_model') || 'gpt-4.1-mini';
            
            // Usa il proxy Netlify invece della chiamata diretta
            const response = await fetch('/.netlify/functions/openai-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiKey: apiKey,
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: temperature,
                    max_tokens: 16000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || error.message || 'Errore API OpenAI');
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }
        
        async function callPerplexity(prompt, temperature) {
            const apiKey = localStorage.getItem('perplexity_api_key');
            const model = localStorage.getItem('perplexity_model') || 'llama-3.1-sonar-large-128k-online';
            
            if (!apiKey) {
                throw new Error('Chiave API Perplexity non configurata');
            }
            
            // Usa il proxy Netlify invece della chiamata diretta
            const response = await fetch('/.netlify/functions/perplexity-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiKey: apiKey,
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: temperature,
                    max_tokens: 16000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || error.message || 'Errore API Perplexity');
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // Mostra risultati (continua nel prossimo blocco...)
        function mostraRisultati(prog) {
            const getPunteggioColor = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'text-green-600' : perc >= 60 ? 'text-yellow-600' : 'text-red-600';
            };

            const getPunteggioLabel = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'Ottimo' : perc >= 60 ? 'Buono' : perc >= 40 ? 'Sufficiente' : 'Insufficiente';
            };

            const getCompatibilitaColor = (comp) => {
                return comp === 'Alta' ? 'text-green-600' : comp === 'Media' ? 'text-yellow-600' : 'text-red-600';
            };

            const html = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-start justify-between">
                            <div>
                                <h2 class="text-2xl font-bold">${prog.denominazione_corso}</h2>
                                <div class="mt-2 space-y-1 text-sm text-gray-600">
                                    <p><strong>Universit√†:</strong> ${prog.universita}</p>
                                    <p><strong>Corso di Laurea:</strong> ${prog.corso_laurea_nome} (${prog.contesto})</p>
                                    ${prog.docente ? `<p><strong>Docente:</strong> ${prog.docente}</p>` : ''}
                                    ${prog.cfu ? `<p><strong>CFU:</strong> ${prog.cfu}</p>` : ''}
                                    ${prog.ore ? `<p><strong>Ore:</strong> ${prog.ore}</p>` : ''}
                                    <p><strong>Manuale Adottato:</strong> ${prog.manuale_adottato}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-bold text-indigo-600">
                                    ${prog.punteggi.totale}<span class="text-xl text-gray-400">/270</span>
                                </div>
                                <p class="text-sm font-medium mt-1 ${getPunteggioColor(prog.punteggi.totale, 270)}">
                                    ${getPunteggioLabel(prog.punteggi.totale, 270)}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Sezione 0: Analisi Preliminare (Fase 0) -->
                    ${prog.analisi_preliminare ? `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">
                        <h3 class="text-xl font-bold mb-4 flex items-center text-indigo-900">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">0</span>
                            Analisi Preliminare del Programma
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Quadro Generale -->
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="text-lg font-semibold text-indigo-800 mb-3 flex items-center">
                                    üìä Quadro Generale
                                </h4>
                                
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-1">Tipologia Corso</p>
                                        <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.quadro_generale.tipologia}</p>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-2">Distribuzione Tematica</p>
                                        <div class="space-y-2">
                                            ${prog.analisi_preliminare.quadro_generale.distribuzione_tematica.map(area => `
                                                <div class="flex items-center justify-between">
                                                    <span class="text-sm text-gray-700">${area.area}</span>
                                                    <div class="flex items-center space-x-2">
                                                        <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                            <div class="h-full bg-indigo-500" style="width: ${area.percentuale}%"></div>
                                                        </div>
                                                        <span class="text-sm font-medium text-indigo-600">${area.percentuale}%</span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-1">Livello di Complessit√†</p>
                                        <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full ${
                                            prog.analisi_preliminare.quadro_generale.livello_complessita === 'avanzato' ? 'bg-red-100 text-red-800' :
                                            prog.analisi_preliminare.quadro_generale.livello_complessita === 'intermedio' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                        }">
                                            ${prog.analisi_preliminare.quadro_generale.livello_complessita.toUpperCase()}
                                        </span>
                                    </div>
                                    
                                    ${prog.analisi_preliminare.quadro_generale.note ? `
                                        <div class="mt-3 pt-3 border-t">
                                            <p class="text-xs text-gray-600">${prog.analisi_preliminare.quadro_generale.note}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Profilo Pedagogico -->
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="text-lg font-semibold text-indigo-800 mb-3 flex items-center">
                                    üë§ Profilo Pedagogico del Docente
                                </h4>
                                
                                <div class="space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Approccio</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.approccio}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Livello</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.livello}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Stile</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.stile}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Orientamento</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.orientamento}</p>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-2">Enfasi Particolari</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${prog.analisi_preliminare.profilo_pedagogico.enfasi.map(e => `
                                                <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-medium rounded-full">
                                                    ${e}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    ${prog.analisi_preliminare.profilo_pedagogico.note ? `
                                        <div class="mt-3 pt-3 border-t">
                                            <p class="text-xs text-gray-600">${prog.analisi_preliminare.profilo_pedagogico.note}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${prog.analisi_preliminare && prog.analisi_preliminare.profilo_docente_insights ? `
                    <div class="bg-orange-50 border-2 border-orange-300 rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4 text-orange-900 flex items-center">
                            <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Insights Profilo Docente (Analisi Avanzata)
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="font-semibold text-orange-800 mb-1">Tipo Docente:</p>
                                <p class="text-gray-700">${prog.analisi_preliminare.profilo_docente_insights.tipo_docente}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-orange-800 mb-1">Sensibilit√† Chiave:</p>
                                <p class="text-gray-700">${prog.analisi_preliminare.profilo_docente_insights.sensibilita_chiave}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="font-semibold text-orange-800 mb-1">Approccio Consigliato:</p>
                                <p class="text-gray-700">${prog.analisi_preliminare.profilo_docente_insights.approccio_consigliato}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-orange-800 mb-2">Leve Potenziali:</p>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">
                                    ${prog.analisi_preliminare.profilo_docente_insights.leve_potenziali.map(l => `<li class="text-xs">${l}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <p class="font-semibold text-orange-800 mb-2">Possibili Resistenze:</p>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">
                                    ${prog.analisi_preliminare.profilo_docente_insights.possibili_resistenze.map(r => `<li class="text-xs">${r}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="md:col-span-2">
                                <p class="font-semibold text-orange-800 mb-2">Argomenti Rilevanti:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${prog.analisi_preliminare.profilo_docente_insights.argomenti_rilevanti.map(a => `
                                        <span class="px-2 py-1 bg-orange-200 text-orange-900 text-xs rounded">${a}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Sezione 1: Analisi Programma -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">1</span>
                            Analisi Dettagliata Programma
                        </h3>
                        
                        <!-- Punteggi -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            ${['obiettivi', 'contenuti', 'metodologia', 'allineamento', 'risultati'].map(dim => {
                                const max = dim === 'contenuti' ? 130 : dim === 'obiettivi' || dim === 'metodologia' ? 40 : 30;
                                const label = {obiettivi: 'Obiettivi Formativi', contenuti: 'Contenuti Programmatici', 
                                              metodologia: 'Metodologia Didattica', allineamento: 'Allineamento Curriculum', 
                                              risultati: 'Risultati Attesi'}[dim];
                                return `
                                    <div class="border rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-600 mb-2">${label}</h4>
                                        <div class="flex items-baseline space-x-2 mb-2">
                                            <span class="text-3xl font-bold ${getPunteggioColor(prog.punteggi[dim], max)}">
                                                ${prog.punteggi[dim]}
                                            </span>
                                            <span class="text-gray-400">/${max}</span>
                                        </div>
                                        ${prog.valutazione[dim]?.giudizio ? `<p class="text-sm font-semibold ${getPunteggioColor(prog.punteggi[dim], max)} mb-1">${prog.valutazione[dim].giudizio}</p>` : ''}
                                        ${prog.valutazione[dim]?.note ? `<p class="text-xs text-gray-600">${prog.valutazione[dim].note}</p>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${prog.valutazione.sintesi ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Sintesi dell'Analisi</h4>
                                <p class="text-sm text-gray-700">${prog.valutazione.sintesi}</p>
                            </div>
                        ` : ''}

                        ${prog.valutazione.analisi_criteri ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-yellow-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                    Analisi Criteri Specifici
                                </h4>
                                <div class="space-y-2">
                                    ${Object.entries(prog.valutazione.analisi_criteri).map(([key, value]) => `
                                        <div class="flex">
                                            <span class="text-xs font-medium text-yellow-800 w-40 flex-shrink-0">${key.replace(/_/g, ' ').toUpperCase()}:</span>
                                            <span class="text-xs text-yellow-900">${value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${prog.valutazione.insights_adozione ? `
                            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-green-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Insights Adozione (Analisi Avanzata)
                                </h4>
                                <div class="space-y-3 text-xs">
                                    ${prog.valutazione.insights_adozione.punti_forza_programma?.length ? `
                                        <div>
                                            <p class="font-semibold text-green-800 mb-1">Punti Forza Programma:</p>
                                            <ul class="list-disc list-inside text-green-900 space-y-1">
                                                ${prog.valutazione.insights_adozione.punti_forza_programma.map(p => `<li>${p}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${prog.valutazione.insights_adozione.aspetti_migliorabili?.length ? `
                                        <div>
                                            <p class="font-semibold text-green-800 mb-1">Aspetti Migliorabili:</p>
                                            <ul class="list-disc list-inside text-green-900 space-y-1">
                                                ${prog.valutazione.insights_adozione.aspetti_migliorabili.map(a => `<li>${a}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${prog.valutazione.insights_adozione.opportunita_manuale ? `
                                        <div class="bg-white rounded p-3">
                                            <p class="font-semibold text-green-800 mb-1">Opportunit√† Manuale:</p>
                                            <p class="text-green-900">${prog.valutazione.insights_adozione.opportunita_manuale}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${prog.valutazione.analisi_criteri_approfondita ? `
                            <div class="bg-blue-50 border border-blue-300 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-blue-900 mb-3">Analisi Criteri Approfondita (Avanzata)</h4>
                                <div class="space-y-3 text-xs">
                                    <div class="bg-white rounded p-3">
                                        <p class="font-semibold text-blue-800 mb-1">Implicazioni Didattiche:</p>
                                        <p class="text-blue-900">${prog.valutazione.analisi_criteri_approfondita.implicazioni_didattiche}</p>
                                    </div>
                                    <div class="bg-white rounded p-3">
                                        <p class="font-semibold text-blue-800 mb-1">Compatibilit√† Manuale Ideale:</p>
                                        <p class="text-blue-900">${prog.valutazione.analisi_criteri_approfondita.compatibilita_manuale_ideale}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Sezione 2: Gap Analysis Manuale Adottato -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">2</span>
                            Analisi Manuale Adottato: ${prog.manuale_adottato}
                        </h3>
                        


                        ${prog.gap_manuale.note ? `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-blue-900">${prog.gap_manuale.note}</p>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${prog.gap_manuale.coperti?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Argomenti Coperti
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.coperti.map(arg => 
                                            `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${prog.gap_manuale.gap?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Gap (Non Coperti)
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.gap.map(arg => 
                                            `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${prog.gap_manuale.eccedenti?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Argomenti Eccedenti
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.eccedenti.map(arg => 
                                            `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${prog.gap_manuale.compatibilita_criteri ? `
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-purple-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    Compatibilit√† Criteri Specifici (Programma vs Manuale)
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${Object.entries(prog.gap_manuale.compatibilita_criteri).filter(([k]) => k !== 'note_compatibilita').map(([key, value]) => `
                                        <div class="bg-white rounded p-3">
                                            <div class="text-xs font-medium text-purple-700 mb-1">${key.replace(/_/g, ' ').toUpperCase()}</div>
                                            <div class="text-xs text-gray-800">${value}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${prog.gap_manuale.compatibilita_criteri.note_compatibilita ? `
                                    <div class="mt-3 text-xs text-purple-900 bg-white rounded p-3">
                                        <strong>Analisi Dettagliata:</strong> ${prog.gap_manuale.compatibilita_criteri.note_compatibilita}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${prog.gap_manuale.analisi_impatto_adozione ? `
                            <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-red-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    Analisi Impatto Adozione (Analisi Avanzata)
                                </h4>
                                <div class="space-y-3 text-xs">
                                    ${prog.gap_manuale.analisi_impatto_adozione.gap_critici_insegnamento?.length ? `
                                        <div>
                                            <p class="font-semibold text-red-800 mb-2">Gap Critici per Insegnamento:</p>
                                            ${prog.gap_manuale.analisi_impatto_adozione.gap_critici_insegnamento.map(g => `
                                                <div class="bg-white rounded p-3 mb-2">
                                                    <p class="font-medium text-red-900 mb-1">Gap: ${g.gap}</p>
                                                    <p class="text-gray-700 mb-1"><strong>Impatto Docente:</strong> ${g.possibile_impatto_docente}</p>
                                                    <p class="text-gray-700"><strong>Impatto Studenti:</strong> ${g.possibile_impatto_studenti}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    ${prog.gap_manuale.analisi_impatto_adozione.sintesi_criticita ? `
                                        <div class="bg-white rounded p-3">
                                            <p class="font-semibold text-red-800 mb-1">Sintesi Criticit√†:</p>
                                            <p class="text-red-900">${prog.gap_manuale.analisi_impatto_adozione.sintesi_criticita}</p>
                                        </div>
                                    ` : ''}
                                    ${prog.gap_manuale.analisi_impatto_adozione.benefici_potenziali_cambio ? `
                                        <div class="bg-green-100 rounded p-3">
                                            <p class="font-semibold text-green-800 mb-1">Benefici Potenziali Cambio Manuale:</p>
                                            <p class="text-green-900">${prog.gap_manuale.analisi_impatto_adozione.benefici_potenziali_cambio}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Sezione 2b: Confronto Manuali Alternativi -->
                    ${prog.gap_alternativi && prog.gap_alternativi.length > 0 ? `
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">2b</span>
                                Confronto Manuali Alternativi
                            </h3>
                            
                            <p class="text-sm text-gray-600 mb-4">Valutazione rapida dei manuali alternativi selezionati</p>
                            
                            <div class="space-y-6">
                                ${prog.gap_alternativi.map(alt => `
                                    <div class="border-2 rounded-lg p-6 hover:shadow-lg transition">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-lg font-bold text-gray-900">${alt.manuale}</h4>
                                            <span class="px-3 py-1 rounded-full text-sm font-bold ${getCompatibilitaColor(alt.compatibilita)}">${alt.compatibilita}</span>
                                        </div>
                                        

                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            ${alt.punti_forza && alt.punti_forza.length > 0 ? `
                                                <div class="bg-green-50 rounded-lg p-3">
                                                    <h5 class="text-sm font-semibold text-green-900 mb-2 flex items-center">
                                                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                        Punti di Forza
                                                    </h5>
                                                    <ul class="space-y-1">
                                                        ${alt.punti_forza.map(f => `<li class="text-xs text-green-800">‚Ä¢ ${f}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            
                                            ${alt.punti_debolezza && alt.punti_debolezza.length > 0 ? `
                                                <div class="bg-orange-50 rounded-lg p-3">
                                                    <h5 class="text-sm font-semibold text-orange-900 mb-2 flex items-center">
                                                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                        </svg>
                                                        Punti di Debolezza
                                                    </h5>
                                                    <ul class="space-y-1">
                                                        ${alt.punti_debolezza.map(d => `<li class="text-xs text-orange-800">‚Ä¢ ${d}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        ${alt.gap && alt.gap.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-sm font-semibold text-red-900 mb-2">Gap (Argomenti Non Coperti)</h5>
                                                <div class="flex flex-wrap gap-1">
                                                    ${alt.gap.map(g => `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">${g}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        ${alt.note ? `
                                            <div class="bg-gray-50 rounded-lg p-3 mt-3">
                                                <p class="text-sm text-gray-700">${alt.note}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Sezione 4: Valutazione Compatibilit√† Manuali Consigliati -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">4</span>
                            Valutazione Compatibilit√† Manuali Consigliati
                        </h3>
                        
                        ${prog.zanichelli && prog.zanichelli.nota ? `
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <p class="text-yellow-700">${prog.zanichelli.nota}</p>
                            </div>
                        ` : ''}
                        
                        ${prog.zanichelli && prog.zanichelli.manuali && prog.zanichelli.manuali.length > 0 ? `
                            ${prog.zanichelli.manuali.map((man, idx) => `
                                <div class="${man.raccomandazione === 'RACCOMANDATO' ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 border border-gray-300'} rounded-lg p-6 mb-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <span class="${man.raccomandazione === 'RACCOMANDATO' ? 'bg-green-600' : 'bg-gray-600'} text-white px-3 py-1 rounded-full text-sm font-bold mr-3">
                                                ${man.raccomandazione === 'RACCOMANDATO' ? '‚≠ê RACCOMANDATO' : 'üìö ALTERNATIVA'}
                                            </span>
                                            <h4 class="text-lg font-bold text-gray-900">${man.autore} - ${man.nome}</h4>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-600">Compatibilit√†</p>
                                            <p class="text-2xl font-bold ${man.compatibilita >= 80 ? 'text-green-600' : man.compatibilita >= 60 ? 'text-yellow-600' : 'text-red-600'}">${man.compatibilita}/100</p>
                                        </div>
                                    </div>
                                    
                                    ${man.punti_forza && man.punti_forza.length > 0 ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-green-700 mb-2">‚úÖ Punti di Forza:</h5>
                                            <ul class="list-disc list-inside text-sm space-y-1">
                                                ${man.punti_forza.map(pf => `<li>${pf}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.gap && man.gap.length > 0 ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-red-700 mb-2">‚ö†Ô∏è Gap:</h5>
                                            <ul class="list-disc list-inside text-sm space-y-1">
                                                ${man.gap.map(g => `<li>${g}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.quando_preferirlo ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-blue-700 mb-2">üí° Quando Preferirlo:</h5>
                                            <p class="text-sm text-gray-700">${man.quando_preferirlo}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.confronto_bibliografia ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-indigo-700 mb-2">üìä Confronto con Bibliografia Adottata:</h5>
                                            <p class="text-sm text-gray-700">${man.confronto_bibliografia}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.compatibilita_criteri ? `
                                        <div class="bg-purple-100 border border-purple-300 rounded p-3">
                                            <h5 class="font-semibold text-purple-800 mb-2">üîç Compatibilit√† Criteri Specifici:</h5>
                                            <p class="text-xs text-purple-900">${man.compatibilita_criteri}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                            
                            ${prog.zanichelli.sintesi ? `
                                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mt-4">
                                    <h5 class="font-semibold text-blue-900 mb-2">üìù Sintesi Generale:</h5>
                                    <p class="text-sm text-blue-800">${prog.zanichelli.sintesi}</p>
                                </div>
                            ` : ''}
                        ` : ''}
                        
                        ${prog.zanichelli && prog.zanichelli.errore ? `
                            <div class="bg-red-50 border-l-4 border-red-400 p-4">
                                <p class="text-red-700">‚ö†Ô∏è Errore nella valutazione: ${prog.zanichelli.errore}</p>
                            </div>
                        ` : ''}

                        ${prog.zanichelli && prog.zanichelli.strategia_adozione ? `
                            <div class="bg-indigo-50 border-2 border-indigo-300 rounded-lg p-6 mt-4">
                                <h4 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center">
                                    <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    Strategia Adozione (Analisi Avanzata)
                                </h4>
                                <div class="space-y-4 text-sm">
                                    <div class="bg-white rounded-lg p-4">
                                        <p class="font-semibold text-indigo-900 mb-2">Manuale Primario: ${prog.zanichelli.strategia_adozione.manuale_primario.nome}</p>
                                        ${prog.zanichelli.strategia_adozione.manuale_primario.argomenti_chiave?.length ? `
                                            <div class="mb-3">
                                                <p class="font-medium text-indigo-800 mb-1">Argomenti Chiave:</p>
                                                <ul class="list-disc list-inside text-gray-700 text-xs space-y-1">
                                                    ${prog.zanichelli.strategia_adozione.manuale_primario.argomenti_chiave.map(a => `<li>${a}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${prog.zanichelli.strategia_adozione.manuale_primario.confronto_manuale_attuale ? `
                                            <div class="mb-3">
                                                <p class="font-medium text-indigo-800 mb-1">Confronto con Manuale Attuale:</p>
                                                <p class="text-gray-700 text-xs">${prog.zanichelli.strategia_adozione.manuale_primario.confronto_manuale_attuale}</p>
                                            </div>
                                        ` : ''}
                                        ${prog.zanichelli.strategia_adozione.manuale_primario.possibili_obiezioni?.length ? `
                                            <div>
                                                <p class="font-medium text-indigo-800 mb-2">Possibili Obiezioni e Risposte:</p>
                                                ${prog.zanichelli.strategia_adozione.manuale_primario.possibili_obiezioni.map(o => `
                                                    <div class="bg-gray-50 rounded p-3 mb-2 text-xs">
                                                        <p class="font-medium text-red-700 mb-1">Obiezione: ${o.obiezione}</p>
                                                        <p class="text-green-700">Risposta: ${o.risposta}</p>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${prog.zanichelli.strategia_adozione.note_colloquio ? `
                                        <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                                            <p class="font-medium text-yellow-900 mb-2">üí° Note per il Colloquio:</p>
                                            <p class="text-yellow-900 text-xs">${prog.zanichelli.strategia_adozione.note_colloquio}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex space-x-4 mb-4">
                        <button onclick="showView('upload'); resetForm();" class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Nuova Analisi
                        </button>
                        <button onclick="exportResults()" class="px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Esporta Risultati
                        </button>
                    </div>

                </div>
            `;

            document.getElementById('viewRisultati').innerHTML = html;
            showView('risultati');
        }

        function resetForm() {
            document.getElementById('fileInput').value = '';
            document.getElementById('testoInput').value = '';
            document.getElementById('contestoSelect').value = '';
            document.getElementById('manualeSelect').value = '';
            document.getElementById('cfuInput').value = '';
            document.getElementById('oreInput').value = '';
            document.getElementById('fileNameDisplay').textContent = 'Clicca per selezionare un file';
            fileContent = null;
        }

        function exportResults() {
            if (!currentProgramma) return;
            const dataStr = JSON.stringify(currentProgramma, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analisi_${currentProgramma.id}.json`;
            link.click();
        }

        // Storico
        function saveToStorico(prog) {
            let storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            storico.unshift(prog);
            if (storico.length > 50) storico = storico.slice(0, 50);
            localStorage.setItem('storico_analisi', JSON.stringify(storico));
            loadStorico();
        }

        function deleteFromStorico(index) {
            if (!confirm('Sei sicuro di voler eliminare questa analisi?')) {
                return;
            }
            let storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            storico.splice(index, 1);
            localStorage.setItem('storico_analisi', JSON.stringify(storico));
            loadStorico();
        }

        function loadStorico() {
            const storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            const container = document.getElementById('storicoContent');
            
            if (storico.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Nessun programma analizzato</p>';
                return;
            }

            const getPunteggioColor = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'text-green-600' : perc >= 60 ? 'text-yellow-600' : 'text-red-600';
            };

            const getPunteggioLabel = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'Ottimo' : perc >= 60 ? 'Buono' : perc >= 40 ? 'Sufficiente' : 'Insufficiente';
            };

            container.innerHTML = storico.map((prog, index) => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 cursor-pointer" onclick='visualizzaProgramma(${JSON.stringify(prog).replace(/'/g, "&apos;")})'>
                            <div class="flex items-center space-x-2 mb-1">
                                <h3 class="font-medium text-gray-900">${prog.denominazione_corso}</h3>
                                <span class="px-2 py-0.5 text-xs font-medium rounded ${prog.tipo_analisi === 'avanzata' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                                    ${prog.tipo_analisi === 'avanzata' ? 'üî¨ Avanzata' : '‚ö° Base'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">${prog.universita} - ${prog.contesto}</p>
                            <p class="text-xs text-gray-500 mt-1">Manuale: ${prog.manuale_adottato} | ${new Date(prog.created_at).toLocaleDateString('it-IT')}</p>
                        </div>
                        <div class="flex items-center space-x-3 ml-4">
                            <div class="text-right cursor-pointer" onclick='visualizzaProgramma(${JSON.stringify(prog).replace(/'/g, "&apos;")})'>  
                                <div class="text-2xl font-bold text-indigo-600">
                                    ${prog.punteggi.totale}<span class="text-sm text-gray-400">/270</span>
                                </div>
                                <p class="text-xs font-medium ${getPunteggioColor(prog.punteggi.totale, 270)}">
                                    ${getPunteggioLabel(prog.punteggi.totale, 270)}
                                </p>
                            </div>
                            <button onclick="event.stopPropagation(); esportaPDF(${index});" class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition" title="Esporta PDF">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteFromStorico(${index});" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Elimina analisi">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function esportaPDF(index) {
            const storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            const prog = storico[index];
            
            if (!prog) {
                alert('Analisi non trovata');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let y = 20;
            const lineHeight = 7;
            const pageHeight = 280;
            const margin = 20;
            const maxWidth = 170;
            
            // Funzione per aggiungere testo con wrap e gestione pagine
            function addText(text, fontSize = 10, isBold = false) {
                doc.setFontSize(fontSize);
                doc.setFont('helvetica', isBold ? 'bold' : 'normal');
                const lines = doc.splitTextToSize(text, maxWidth);
                
                lines.forEach(line => {
                    if (y > pageHeight) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, margin, y);
                    y += lineHeight;
                });
            }
            
            function addSpace(space = 5) {
                y += space;
            }
            
            // Intestazione
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`Analisi Programma ${prog.framework_name || prog.denominazione_corso}`, margin, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${prog.universita} | ${prog.corso_laurea_nome || prog.contesto}`, margin, y);
            y += 6;
            doc.text(`Docente: ${prog.docente || 'N/D'} | CFU: ${prog.cfu || 'N/D'}`, margin, y);
            y += 6;
            doc.text(`Tipo Analisi: ${prog.tipo_analisi === 'avanzata' ? 'Avanzata' : 'Base'}`, margin, y);
            y += 10;
            
            // Linea separatore
            doc.setDrawColor(79, 70, 229);
            doc.setLineWidth(0.5);
            doc.line(margin, y, 190, y);
            y += 10;
            
            // Sintesi
            if (prog.valutazione?.sintesi) {
                addText('SINTESI', 12, true);
                addSpace(3);
                addText(prog.valutazione.sintesi);
                addSpace(8);
            }
            
            // Valutazione Programma
            addText('VALUTAZIONE PROGRAMMA', 12, true);
            addSpace(3);
            addText(`Punteggio Totale: ${prog.punteggi.totale}/270`);
            addText(`Obiettivi Formativi: ${prog.punteggi.obiettivi}/40`);
            addText(`Contenuti Programmatici: ${prog.punteggi.contenuti}/130`);
            addText(`Metodologia Didattica: ${prog.punteggi.metodologia}/40`);
            addText(`Allineamento Curriculum: ${prog.punteggi.allineamento}/30`);
            addText(`Risultati Attesi: ${prog.punteggi.risultati}/30`);
            addSpace(8);
            
            // Manuale Adottato
            addText('MANUALE ADOTTATO: ' + prog.manuale_adottato, 12, true);
            addSpace(3);
            
            if (prog.gap_manuale?.note) {
                addText(prog.gap_manuale.note);
                addSpace(5);
            }
            
            if (prog.gap_manuale?.gap?.length > 0) {
                addText('Gap (Argomenti Non Coperti):', 10, true);
                prog.gap_manuale.gap.forEach(gap => {
                    addText('‚Ä¢ ' + gap);
                });
                addSpace(5);
            }
            
            if (prog.gap_manuale?.punti_debolezza?.length > 0) {
                addText('Punti di Debolezza:', 10, true);
                prog.gap_manuale.punti_debolezza.forEach(deb => {
                    addText('‚Ä¢ ' + deb);
                });
                addSpace(8);
            }
            
            // Raccomandazione Zanichelli
            if (prog.zanichelli?.raccomandato) {
                addText('RACCOMANDAZIONE ZANICHELLI', 12, true);
                addSpace(3);
                addText(`Manuale Raccomandato: ${prog.zanichelli.raccomandato.titolo}`, 11, true);
                addText(`Compatibilit√†: ${prog.zanichelli.raccomandato.compatibilita} (${prog.zanichelli.raccomandato.punteggio}/100)`);
                addText(`Prezzo: ${prog.zanichelli.raccomandato.prezzo}`);
                addSpace(5);
                
                if (prog.zanichelli.raccomandato.confronto_bibliografia) {
                    addText('Confronto con Bibliografia Adottata:', 10, true);
                    addText(prog.zanichelli.raccomandato.confronto_bibliografia);
                    addSpace(5);
                }
                
                if (prog.zanichelli.raccomandato.punti_forza?.length > 0) {
                    addText('Punti di Forza:', 10, true);
                    prog.zanichelli.raccomandato.punti_forza.forEach(forza => {
                        addText('‚Ä¢ ' + forza);
                    });
                    addSpace(5);
                }
                
                if (prog.zanichelli.raccomandato.quando_preferirlo) {
                    addText('Quando Raccomandare:', 10, true);
                    addText(prog.zanichelli.raccomandato.quando_preferirlo);
                }
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} - Zanichelli Editore - Pagina ${i}/${pageCount}`, margin, 290);
            }
            
            // Salva PDF
            const filename = `Analisi_${prog.universita.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        function visualizzaProgramma(prog) {
            currentProgramma = prog;
            mostraRisultati(prog);
        }

        function toggleFAQ() {
            const content = document.getElementById('faqContent');
            const chevron = document.getElementById('faqChevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // ============================================
        // FASE C - FUNZIONI PREPARA COLLOQUIO
        // ============================================

        // ============================================
        // VALUTAZIONE ASSOLUTA MANUALI
        // ============================================
        
        // Global variables for evaluation
        let evalAbs_selectedMacroarea = null;
        let evalAbs_selectedMateria = null;
        let evalAbs_selectedManuale = null;
        let evalAbs_selectedFramework = null;
        let evalAbs_currentReportData = null;

        // STEP 1: Initialize dropdown on tab load
        function evalAbs_initTab() {
            console.log('üîÑ Inizializzo tab Valutazione Assoluta');
            
            // Wait for FRAMEWORK_CATALOG to be loaded
            if (!FRAMEWORK_CATALOG || !FRAMEWORK_CATALOG.by_subject) {
                console.error('‚ùå FRAMEWORK_CATALOG non ancora caricato!');
                setTimeout(evalAbs_initTab, 500); // Retry after 500ms
                return;
            }
            
            evalAbs_loadMacroareeDropdown();
            evalAbs_loadSavedEvaluations();
        }

        // Load Macroaree (STEP 1)
        function evalAbs_loadMacroareeDropdown() {
            const select = document.getElementById('evalAbsMacroarea');
            if (!select) return;
            
            // Get unique macroaree from FRAMEWORK_CATALOG.by_subject
            const macroaree = Object.keys(FRAMEWORK_CATALOG.by_subject || {});
            
            console.log('üìö Macroaree trovate:', macroaree);
            
            select.innerHTML = '<option value="">Seleziona macroarea...</option>';
            macroaree.forEach(macro => {
                const opt = document.createElement('option');
                opt.value = macro;
                opt.textContent = macro;
                select.appendChild(opt);
            });
        }

        // STEP 1 ‚Üí STEP 2: On Macroarea change
        function evalAbs_onMacroareaChange() {
            const select = document.getElementById('evalAbsMacroarea');
            const macroarea = select.value;
            
            evalAbs_selectedMacroarea = macroarea;
            
            if (!macroarea) {
                // Hide all subsequent steps
                document.getElementById('evalAbsMateriaContainer').classList.add('hidden');
                document.getElementById('evalAbsManualeContainer').classList.add('hidden');
                document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
                document.getElementById('evalAbsButtonContainer').classList.add('hidden');
                return;
            }
            
            console.log('‚úÖ Macroarea selezionata:', macroarea);
            
            // Get frameworks for this macroarea
            const frameworkIds = FRAMEWORK_CATALOG.by_subject[macroarea] || [];
            
            // Get unique materias from frameworks
            const materias = new Set();
            const frameworks = FRAMEWORK_CATALOG.frameworks || [];
            
            frameworkIds.forEach(fwId => {
                const fw = frameworks.find(f => f.id === fwId);
                if (fw && fw.name) {
                    materias.add(fw.name);
                }
            });
            
            const materiasArray = Array.from(materias);
            
            console.log('üìñ Materie trovate per', macroarea, ':', materiasArray);
            
            // If only 1 materia, skip STEP 2 and go directly to manuali
            if (materiasArray.length === 1) {
                evalAbs_selectedMateria = materiasArray[0];
                document.getElementById('evalAbsMateriaContainer').classList.add('hidden');
                evalAbs_loadManualiDropdown();
            } else {
                // Show STEP 2: Materia dropdown
                evalAbs_loadMateriaDropdown(materiasArray);
                document.getElementById('evalAbsMateriaContainer').classList.remove('hidden');
            }
            
            // Hide subsequent steps
            document.getElementById('evalAbsManualeContainer').classList.add('hidden');
            document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
            document.getElementById('evalAbsButtonContainer').classList.add('hidden');
        }

        // Load Materia dropdown (STEP 2)
        function evalAbs_loadMateriaDropdown(materias) {
            const select = document.getElementById('evalAbsMateria');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona materia...</option>';
            materias.forEach(mat => {
                const opt = document.createElement('option');
                opt.value = mat;
                opt.textContent = mat;
                select.appendChild(opt);
            });
        }

        // STEP 2 ‚Üí STEP 3: On Materia change
        function evalAbs_onMateriaChange() {
            const select = document.getElementById('evalAbsMateria');
            evalAbs_selectedMateria = select.value;
            
            if (!evalAbs_selectedMateria) {
                document.getElementById('evalAbsManualeContainer').classList.add('hidden');
                document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
                document.getElementById('evalAbsButtonContainer').classList.add('hidden');
                return;
            }
            
            console.log('‚úÖ Materia selezionata:', evalAbs_selectedMateria);
            evalAbs_loadManualiDropdown();
        }

        // Load Manuali dropdown (STEP 3)
        function evalAbs_loadManualiDropdown() {
            const select = document.getElementById('evalAbsManuale');
            if (!select) return;
            
            // Mapping: Macroarea Framework ‚Üí Subject Manuali
            const macroareaToSubjects = {
                'Matematica': ['Matematica', 'Analisi Matematica', 'Matematica Generale', 'Istituzioni di Matematiche'],
                'Fisica': ['Fisica', 'Fisica Generale'],
                'Chimica': ['Chimica Generale', 'Chimica Organica', 'Chimica Inorganica'],
                'Biologia': ['Biochimica', 'Biologia Cellulare', 'Biologia Molecolare', 'Microbiologia', 'Genetica'],
                'Economia': ['Macroeconomia', 'Microeconomia', 'Economia Politica'],
                'Medicina e Chirurgia': ['Biologia', 'Chimica', 'Fisica'], // Semestre Filtro
                'Istologia': ['Istologia', 'Istologia ed Embriologia']
            };
            
            // Get subjects for selected macroarea
            const allowedSubjects = macroareaToSubjects[evalAbs_selectedMacroarea] || [];
            
            console.log('üîç Filtro per macroarea:', evalAbs_selectedMacroarea);
            console.log('üìö Subject consentiti:', allowedSubjects);
            
            // Filter manuali by subject
            const allManuali = getManualsAsObject();
            const filteredManuali = [];
            
            for (const id in allManuali) {
                const man = allManuali[id];
                
                // Check if manual subject matches allowed subjects
                if (allowedSubjects.some(subj => {
                    // Fuzzy match: check if subject contains or is contained
                    const manSubject = (man.subject || '').toLowerCase();
                    const targetSubject = subj.toLowerCase();
                    return manSubject.includes(targetSubject) || targetSubject.includes(manSubject);
                })) {
                    filteredManuali.push(man);
                }
            }
            
            console.log('üìö Manuali trovati:', filteredManuali.length);
            
            select.innerHTML = '<option value="">Seleziona manuale...</option>';
            
            // Sort by title
            filteredManuali.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            
            filteredManuali.forEach(man => {
                const opt = document.createElement('option');
                opt.value = man.id;
                opt.textContent = `${man.title} (${man.author || 'N/A'})`;
                select.appendChild(opt);
            });
            
            // Show manuale container
            document.getElementById('evalAbsManualeContainer').classList.remove('hidden');
            
            // Hide subsequent steps
            document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
            document.getElementById('evalAbsButtonContainer').classList.add('hidden');
        }

        // STEP 3 ‚Üí STEP 4: On Manuale change
        function evalAbs_onManualeChange() {
            const select = document.getElementById('evalAbsManuale');
            evalAbs_selectedManuale = select.value;
            
            if (!evalAbs_selectedManuale) {
                document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
                document.getElementById('evalAbsButtonContainer').classList.add('hidden');
                return;
            }
            
            console.log('‚úÖ Manuale selezionato:', evalAbs_selectedManuale);
            evalAbs_loadFrameworkDropdown();
        }

        // Load Framework dropdown (STEP 4) - auto-selected
        function evalAbs_loadFrameworkDropdown() {
            const select = document.getElementById('evalAbsFramework');
            if (!select) return;
            
            // Get frameworks for selected macroarea
            const frameworkIds = FRAMEWORK_CATALOG.by_subject[evalAbs_selectedMacroarea] || [];
            const frameworks = FRAMEWORK_CATALOG.frameworks || [];
            
            const filteredFrameworks = frameworks.filter(fw => frameworkIds.includes(fw.id));
            
            console.log('üéØ Framework disponibili:', filteredFrameworks.length);
            
            select.innerHTML = '<option value="">Seleziona framework...</option>';
            
            filteredFrameworks.forEach(fw => {
                const opt = document.createElement('option');
                opt.value = fw.id;
                opt.textContent = fw.name || fw.id;
                select.appendChild(opt);
            });
            
            // Auto-select first framework if only 1
            if (filteredFrameworks.length === 1) {
                select.value = filteredFrameworks[0].id;
                evalAbs_selectedFramework = filteredFrameworks[0].id;
            }
            
            // Show framework container and button
            document.getElementById('evalAbsFrameworkContainer').classList.remove('hidden');
            document.getElementById('evalAbsButtonContainer').classList.remove('hidden');
        }

        // Start Evaluation (STEP 5)
        async function evalAbs_startEvaluation() {
            // Get selected framework
            const frameworkSelect = document.getElementById('evalAbsFramework');
            evalAbs_selectedFramework = frameworkSelect.value;
            
            if (!evalAbs_selectedFramework) {
                alert('‚ö†Ô∏è Seleziona un framework prima di avviare la valutazione');
                return;
            }
            
            console.log('üöÄ Avvio valutazione:', {
                macroarea: evalAbs_selectedMacroarea,
                materia: evalAbs_selectedMateria,
                manuale: evalAbs_selectedManuale,
                framework: evalAbs_selectedFramework
            });
            
            // Show loading
            document.getElementById('evalAbsLoading').classList.remove('hidden');
            document.getElementById('evalAbsResult').classList.add('hidden');
            
            try {
                // Load manual data
                const manuale = await evalAbs_loadManualeData(evalAbs_selectedManuale);
                
                // Load framework data
                const framework = await evalAbs_loadFrameworkData(evalAbs_selectedFramework);
                
                // Build prompt
                const prompt = evalAbs_buildPrompt(manuale, framework);
                
                console.log('üìù Prompt pronto, lunghezza:', prompt.length);
                
                // Call LLM
                const reportHTML = await evalAbs_callLLM(prompt);
                
                console.log('‚úÖ Report generato, lunghezza:', reportHTML.length);
                
                // Store report data
                evalAbs_currentReportData = {
                    manual_id: evalAbs_selectedManuale,
                    manual_title: manuale.title,
                    manual_author: manuale.author,
                    framework_id: evalAbs_selectedFramework,
                    framework_name: framework.name,
                    evaluation_date: new Date().toISOString(),
                    report_html: reportHTML
                };
                
                // Show report
                evalAbs_showReport(reportHTML);
                
            } catch (error) {
                console.error('‚ùå Errore valutazione:', error);
                alert('‚ùå Errore durante la valutazione: ' + error.message);
            } finally {
                document.getElementById('evalAbsLoading').classList.add('hidden');
            }
        }

        // Load Manual Data
        async function evalAbs_loadManualeData(manualeId) {
            console.log('üìñ Carico dati manuale:', manualeId);
            
            // First check in custom/modified
            const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
            const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
            
            if (modifiedManuals[manualeId]) {
                console.log('‚úÖ Manuale trovato in modified_manuals');
                return modifiedManuals[manualeId];
            }
            
            if (customManuals[manualeId]) {
                console.log('‚úÖ Manuale trovato in custom_manuals');
                return customManuals[manualeId];
            }
            
            // Load from original catalog
            const allManuali = getManualsAsObject();
            const manual = allManuali[manualeId];
            
            if (!manual || !manual.filepath) {
                throw new Error('Manuale non trovato: ' + manualeId);
            }
            
            console.log('üì• Carico JSON da:', manual.filepath);
            const response = await fetch(manual.filepath);
            
            if (!response.ok) {
                throw new Error('Errore caricamento manuale: ' + response.statusText);
            }
            
            return await response.json();
        }

        // Load Framework Data
        async function evalAbs_loadFrameworkData(frameworkId) {
            console.log('üéØ Carico dati framework:', frameworkId);
            
            // Get framework from catalog
            const frameworks = FRAMEWORK_CATALOG.frameworks || [];
            const framework = frameworks.find(f => f.id === frameworkId);
            
            if (!framework) {
                throw new Error('Framework non trovato: ' + frameworkId);
            }
            
            // If content is already loaded, return it
            if (framework.content) {
                console.log('‚úÖ Framework content gi√† caricato');
                return framework;
            }
            
            // Load from file
            if (!framework.filepath) {
                throw new Error('Framework filepath non trovato per: ' + frameworkId);
            }
            
            console.log('üì• Carico JSON da:', framework.filepath);
            const response = await fetch(framework.filepath);
            
            if (!response.ok) {
                throw new Error('Errore caricamento framework: ' + response.statusText);
            }
            
            const data = await response.json();
            framework.content = data.content || data;
            
            return framework;
        }

        // Build Prompt for LLM
        function evalAbs_buildPrompt(manuale, framework) {
            // Build Table of Contents (TOC) from manual chapters
            let toc = '';
            if (manuale.chapters && Array.isArray(manuale.chapters)) {
                toc = manuale.chapters.map((ch, idx) => `${idx + 1}. ${ch.title || ch}`).join('\n');
            }
            
            // Build Framework Syllabus
            let syllabus = '';
            if (framework.content && framework.content.syllabus_modules) {
                syllabus = framework.content.syllabus_modules.map((mod, idx) => 
                    `Modulo ${idx + 1}: ${mod.title || mod.name || mod}\n${mod.description || ''}`
                ).join('\n\n');
            }
            
            // Build Program Profiles
            let profiles = '';
            if (framework.content && framework.content.program_profiles) {
                profiles = framework.content.program_profiles.map((prof, idx) => 
                    `Profilo ${idx + 1}: ${prof.name || prof.title || prof}\nTarget: ${prof.target_degrees ? prof.target_degrees.join(', ') : 'N/A'}`
                ).join('\n\n');
            }
            
            const prompt = `# VALUTAZIONE ASSOLUTA MANUALE ZANICHELLI

## Contesto
Sei un promotore editoriale Zanichelli esperto. Devi valutare il manuale "${manuale.title}" di ${manuale.author || 'N/A'} (${manuale.publisher || 'Zanichelli'}) rispetto al framework di riferimento "${framework.name}".

## Dati Manuale
**Titolo**: ${manuale.title}
**Autore**: ${manuale.author || 'N/A'}
**Editore**: ${manuale.publisher || 'Zanichelli'}
**Prezzo**: ${manuale.price || 'N/A'} ‚Ç¨
**Pagine**: ${manuale.pages || 'N/A'}
**Edizione**: ${manuale.edition || 'N/A'}

### Indice Completo (Capitoli)
\`\`\`
${toc || 'Indice non disponibile'}
\`\`\`

## Framework di Riferimento: ${framework.name}

### Syllabus Moduli
\`\`\`
${syllabus || 'Syllabus non disponibile'}
\`\`\`

### Profili di Programma
\`\`\`
${profiles || 'Profili non disponibili'}
\`\`\`

---

## COMPITO
Fornisci un report dettagliato di valutazione del manuale. Struttura il report in HTML (usa tag <h3>, <p>, <ul>, <li>, <strong>) con le seguenti sezioni:

### 1. üìö Struttura dell'Opera
Descrivi l'organizzazione dei contenuti, la sequenza dei capitoli, e la copertura degli argomenti rispetto al framework.

### 2. ‚úçÔ∏è Chiarezza Espositiva e Stile
Valuta il linguaggio, la chiarezza delle spiegazioni, e l'approccio didattico.

### 3. üìñ Apparato Didattico
Analizza esempi, esercizi, figure, tabelle, materiali supplementari.

### 4. üéØ Supporto allo Studio
Valuta strumenti come riassunti, mappe concettuali, test di autovalutazione, risorse online.

### 5. üéì Pubblico Ideale e Livello
Indica per quale tipologia di studenti √® pi√π adatto il manuale (es. classi di laurea, livello di difficolt√†).

### 6. üèÜ Confronto con Framework
In base al framework "${framework.name}", indica quale pubblico √® pi√π adatto motivando la scelta (confronta con i profili di programma).

### 7. ‚úÖ Punti di Forza
Elenca i principali punti di forza del manuale (contenutistici, didattici, elementi distintivi).

### 8. ‚ö†Ô∏è Debolezze e Criticit√†
Indica eventuali ostacoli all'adozione, necessit√† di aggiornamento, problemi di usabilit√†, lacune tematiche.

---

**IMPORTANTE**: Restituisci SOLO il contenuto HTML del report (senza tag <html>, <head>, <body>). Usa tag semantici e ben formattati.`;

            return prompt;
        }

        // Call LLM API
        async function evalAbs_callLLM(prompt) {
            const apiKey = localStorage.getItem('perplexity_api_key');
            
            if (!apiKey) {
                throw new Error('Chiave API Perplexity non configurata. Vai in Impostazioni.');
            }
            
            console.log('ü§ñ Chiamo LLM...');
            
            const response = await fetch('https://api.perplexity.ai/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.1-sonar-large-128k-online',
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    temperature: 0.2,
                    max_tokens: 4000
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('Risposta API invalida');
            }
            
            return data.choices[0].message.content;
        }

        // Show Report
        function evalAbs_showReport(reportHTML) {
            const container = document.getElementById('evalAbsReportContent');
            container.innerHTML = reportHTML;
            
            document.getElementById('evalAbsResult').classList.remove('hidden');
            
            // Scroll to report
            document.getElementById('evalAbsResult').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Report
        function evalAbs_closeReport() {
            document.getElementById('evalAbsResult').classList.add('hidden');
            evalAbs_currentReportData = null;
        }

        // Save Report to localStorage
        function evalAbs_saveReport() {
            if (!evalAbs_currentReportData) {
                alert('‚ùå Nessun report da salvare');
                return;
            }
            
            // Generate unique ID
            const id = `${evalAbs_currentReportData.manual_id}_${evalAbs_currentReportData.framework_id}`;
            
            // Load existing evaluations
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            
            // Check if already exists
            if (evaluations[id]) {
                if (!confirm('‚ö†Ô∏è Esiste gi√† una valutazione per questo manuale/framework. Sovrascrivere?')) {
                    return;
                }
            }
            
            // Save
            evalAbs_currentReportData.id = id;
            evalAbs_currentReportData.last_edited = new Date().toISOString();
            evaluations[id] = evalAbs_currentReportData;
            
            localStorage.setItem('manual_evaluations_absolute', JSON.stringify(evaluations));
            
            console.log('üíæ Valutazione salvata:', id);
            alert('‚úÖ Valutazione salvata con successo!');
            
            // Refresh saved list
            evalAbs_loadSavedEvaluations();
        }

        // Download Report as HTML
        function evalAbs_downloadHTML() {
            if (!evalAbs_currentReportData) {
                alert('‚ùå Nessun report da scaricare');
                return;
            }
            
            const filename = `valutazione_${evalAbs_currentReportData.manual_id}_${new Date().toISOString().split('T')[0]}.html`;
            
            const htmlContent = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valutazione: ${evalAbs_currentReportData.manual_title}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: #4F46E5; }
        h1 { border-bottom: 3px solid #4F46E5; padding-bottom: 10px; }
        .meta { background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .meta p { margin: 5px 0; }
        ul { margin-left: 20px; }
        strong { color: #1F2937; }
    </style>
</head>
<body>
    <h1>üìä Valutazione Assoluta Manuale Zanichelli</h1>
    
    <div class="meta">
        <p><strong>Manuale:</strong> ${evalAbs_currentReportData.manual_title}</p>
        <p><strong>Autore:</strong> ${evalAbs_currentReportData.manual_author}</p>
        <p><strong>Framework:</strong> ${evalAbs_currentReportData.framework_name}</p>
        <p><strong>Data Valutazione:</strong> ${new Date(evalAbs_currentReportData.evaluation_date).toLocaleDateString('it-IT')}</p>
    </div>
    
    ${evalAbs_currentReportData.report_html}
    
    <hr style="margin: 40px 0;">
    <p style="text-align: center; color: #6B7280; font-size: 0.9em;">
        Report generato da Matrix Analisi Programmi - Zanichelli
    </p>
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('üì• Report scaricato:', filename);
        }

        // Load Saved Evaluations
        function evalAbs_loadSavedEvaluations() {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            const container = document.getElementById('evalAbsSavedListContent');
            
            if (Object.keys(evaluations).length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Nessuna valutazione salvata</p>';
                return;
            }
            
            const evaluationsArray = Object.values(evaluations);
            evaluationsArray.sort((a, b) => new Date(b.evaluation_date) - new Date(a.evaluation_date));
            
            let html = '';
            evaluationsArray.forEach(ev => {
                const date = new Date(ev.evaluation_date).toLocaleDateString('it-IT');
                html += `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900">${ev.manual_title}</h4>
                                <p class="text-sm text-gray-600">Autore: ${ev.manual_author || 'N/A'}</p>
                                <p class="text-sm text-gray-500">Framework: ${ev.framework_name} | Data: ${date}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="evalAbs_viewSaved('${ev.id}')" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">
                                    üëÅÔ∏è Visualizza
                                </button>
                                <button onclick="evalAbs_downloadSaved('${ev.id}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                    üì• HTML
                                </button>
                                <button onclick="evalAbs_deleteSaved('${ev.id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // View Saved Evaluation
        function evalAbs_viewSaved(id) {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            const ev = evaluations[id];
            
            if (!ev) {
                alert('‚ùå Valutazione non trovata');
                return;
            }
            
            evalAbs_currentReportData = ev;
            evalAbs_showReport(ev.report_html);
        }

        // Download Saved Evaluation
        function evalAbs_downloadSaved(id) {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            const ev = evaluations[id];
            
            if (!ev) {
                alert('‚ùå Valutazione non trovata');
                return;
            }
            
            evalAbs_currentReportData = ev;
            evalAbs_downloadHTML();
        }

        // Delete Saved Evaluation
        function evalAbs_deleteSaved(id) {
            if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questa valutazione?')) {
                return;
            }
            
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            delete evaluations[id];
            localStorage.setItem('manual_evaluations_absolute', JSON.stringify(evaluations));
            
            console.log('üóëÔ∏è Valutazione eliminata:', id);
            alert('‚úÖ Valutazione eliminata');
            
            evalAbs_loadSavedEvaluations();
        }

        // Export All Evaluations
        function evalAbs_exportAll() {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            
            if (Object.keys(evaluations).length === 0) {
                alert('‚ö†Ô∏è Nessuna valutazione da esportare');
                return;
            }
            
            const exportData = {
                export_date: new Date().toISOString(),
                total_evaluations: Object.keys(evaluations).length,
                evaluations: evaluations
            };
            
            const filename = `valutazioni_assolute_${new Date().toISOString().split('T')[0]}.json`;
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('üì§ Export completato:', filename);
            alert(`‚úÖ Export completato: ${Object.keys(evaluations).length} valutazioni`);
        }

        // Import Evaluations
        function evalAbs_importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.evaluations || typeof data.evaluations !== 'object') {
                        throw new Error('Formato JSON non valido');
                    }
                    
                    // Merge with existing
                    const existing = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
                    const merged = { ...existing, ...data.evaluations };
                    
                    localStorage.setItem('manual_evaluations_absolute', JSON.stringify(merged));
                    
                    console.log('üì• Import completato:', Object.keys(data.evaluations).length);
                    alert(`‚úÖ Import completato: ${Object.keys(data.evaluations).length} valutazioni importate`);
                    
                    evalAbs_loadSavedEvaluations();
                    
                } catch (error) {
                    console.error('‚ùå Errore import:', error);
                    alert('‚ùå Errore durante l\'import: ' + error.message);
                }
            };
            
            input.click();
        }

        // ============================================
        // END VALUTAZIONE ASSOLUTA MANUALI
        // ============================================

    </script>
    
    <!-- MODAL: Aggiungi/Modifica Manuale -->
    <div id="manualeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h3 id="manualeModalTitle" class="text-xl font-bold">‚ûï Nuovo Manuale</h3>
                <button onclick="closeManualeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- STEP 1: Identificativi -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-3">üìù STEP 1: Identificativi</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ID Manuale *</label>
                            <input type="text" id="manualeId" placeholder="es: brown_intro" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                pattern="[a-zA-Z0-9_]+" title="Solo lettere, numeri e underscore">
                            <p class="text-xs text-gray-500 mt-1">Solo lettere, numeri e underscore. Deve essere univoco.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Macroarea *</label>
                                <select id="manualeMacroarea" onchange="updateMaterieAutocomplete()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona macroarea...</option>
                                    <option value="Biologia">Biologia</option>
                                    <option value="Chimica">Chimica</option>
                                    <option value="Fisica">Fisica</option>
                                    <option value="Matematica">Matematica</option>
                                    <option value="Economia">Economia</option>
                                    <option value="Istologia">Istologia</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Categoria principale (es: Biologia, Chimica)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Materia *</label>
                                <input type="text" id="manualeMateria" list="materieDatalist" placeholder="es: Biologia Vegetale"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    oninput="filterMaterieDatalist()">
                                <datalist id="materieDatalist">
                                    <!-- Popolato dinamicamente da JavaScript -->
                                </datalist>
                                <p class="text-xs text-gray-500 mt-1">Disciplina specifica (campo libero con suggerimenti)</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                            <select id="manualeTipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona tipo...</option>
                                <option value="zanichelli">Zanichelli</option>
                                <option value="competitor">Competitor</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 2: Carica JSON -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 mb-3">üìÅ STEP 2: Carica File JSON</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                File JSON del Manuale *
                            </label>
                            <div class="flex items-center justify-center w-full">
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clicca per caricare</span> o trascina qui</p>
                                        <p class="text-xs text-gray-500">File JSON (MAX 10MB)</p>
                                    </div>
                                    <input id="manualeJsonFile" type="file" accept=".json" class="hidden" onchange="handleJsonUpload(event)">
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Il file JSON deve contenere la struttura completa del manuale con capitoli e sezioni.
                            </p>
                        </div>
                        
                        <div id="jsonFileInfo" class="hidden p-3 bg-white border border-gray-300 rounded-lg">
                            <p class="text-sm font-medium text-gray-700">File caricato:</p>
                            <p id="jsonFileName" class="text-sm text-gray-600"></p>
                            <p id="jsonFileSize" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 3: Preview Dati -->
                <div id="previewSection" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="font-semibold text-purple-900 mb-3">üëÅÔ∏è STEP 3: Preview Dati</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Titolo:</span>
                            <span id="previewTitle" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Autore:</span>
                            <span id="previewAuthor" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Editore:</span>
                            <span id="previewPublisher" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Capitoli:</span>
                            <span id="previewChapters" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Pagine:</span>
                            <span id="previewPages" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Prezzo:</span>
                            <span id="previewPrice" class="font-medium text-gray-900"></span>
                        </div>
                    </div>
                </div>
                
                <!-- EDITOR JSON (solo in modifica) -->
                <div id="jsonEditorSection" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-900 mb-3">üìù Editor JSON</h4>
                    <textarea id="jsonEditor" class="w-full h-96 p-3 border border-gray-300 rounded-lg font-mono text-xs"
                        placeholder="Contenuto JSON del manuale..."></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                        Modifica il JSON direttamente. Assicurati che la sintassi sia valida prima di salvare.
                    </p>
                </div>
                
                <!-- Errori validazione -->
                <div id="validationErrors" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                    <h4 class="font-semibold text-red-900 mb-2">‚ö†Ô∏è Errori di Validazione</h4>
                    <ul id="errorList" class="list-disc list-inside text-sm text-red-700 space-y-1">
                    </ul>
                </div>
            </div>
            
            <!-- Footer con azioni -->
            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button onclick="closeManualeModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    ‚ùå Annulla
                </button>
                <button onclick="saveManualeData()" id="btnSaveManuale" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    üíæ Salva Manuale
                </button>
            </div>
        </div>
    </div>
    <!-- END MODAL -->
    
    <!-- MODAL: Conferma Eliminazione -->
    <div id="deleteManualeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Conferma Eliminazione</h3>
                <p class="text-sm text-gray-500 mb-1">Stai per eliminare il manuale:</p>
                <p id="deleteManualeName" class="text-sm font-semibold text-gray-900 mb-4"></p>
                <p class="text-xs text-red-600 mb-6">Questa azione non pu√≤ essere annullata.</p>
                
                <div class="flex justify-center gap-3">
                    <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                        Annulla
                    </button>
                    <button onclick="confirmDeleteManuale()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                        üóëÔ∏è Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- END MODAL -->

    <!-- MODAL: Aggiungi/Modifica Framework -->
    <div id="frameworkModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h3 id="frameworkModalTitle" class="text-xl font-bold">‚ûï Nuovo Framework</h3>
                <button onclick="closeFrameworkModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- STEP 1: Identificativi -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-3">üìù STEP 1: Identificativi</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ID Framework *</label>
                            <input type="text" id="frameworkId" placeholder="es: chimica_organica_framework" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                pattern="[a-zA-Z0-9_]+" title="Solo lettere, numeri e underscore">
                            <p class="text-xs text-gray-500 mt-1">Solo lettere, numeri e underscore. Deve essere univoco.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome Framework *</label>
                                <input type="text" id="frameworkName" placeholder="es: Chimica Organica"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Materia *</label>
                                <select id="frameworkSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona materia...</option>
                                    <option value="Matematica">Matematica</option>
                                    <option value="Fisica">Fisica</option>
                                    <option value="Chimica">Chimica</option>
                                    <option value="Chimica Generale">Chimica Generale</option>
                                    <option value="Chimica Organica">Chimica Organica</option>
                                    <option value="Biologia">Biologia</option>
                                    <option value="Economia">Economia</option>
                                    <option value="Medicina e Chirurgia">Medicina e Chirurgia</option>
                                    <option value="Istologia">Istologia</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 2: Carica JSON -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 mb-3">üìÅ STEP 2: Carica File JSON</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                File JSON del Framework *
                            </label>
                            <div class="flex items-center justify-center w-full">
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clicca per caricare</span> o trascina qui</p>
                                        <p class="text-xs text-gray-500">File JSON (MAX 10MB)</p>
                                    </div>
                                    <input id="frameworkJsonFile" type="file" accept=".json" class="hidden" onchange="handleFrameworkJsonUpload(event)">
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Il file JSON deve contenere: syllabus_modules, program_profiles, target_degrees.
                            </p>
                        </div>
                        
                        <div id="frameworkJsonFileInfo" class="hidden p-3 bg-white border border-gray-300 rounded-lg">
                            <p class="text-sm font-medium text-gray-700">File caricato:</p>
                            <p id="frameworkJsonFileName" class="text-sm text-gray-600"></p>
                            <p id="frameworkJsonFileSize" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 3: Preview Dati -->
                <div id="frameworkPreviewSection" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="font-semibold text-purple-900 mb-3">üëÅÔ∏è STEP 3: Preview Dati</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Nome:</span>
                            <span id="frameworkPreviewName" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Materia:</span>
                            <span id="frameworkPreviewSubject" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Moduli Programma:</span>
                            <span id="frameworkPreviewModules" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Profili Studente:</span>
                            <span id="frameworkPreviewProfiles" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Corsi di Laurea:</span>
                            <span id="frameworkPreviewDegrees" class="font-medium text-gray-900"></span>
                        </div>
                    </div>
                </div>
                
                <!-- EDITOR JSON (solo in modifica) -->
                <div id="frameworkJsonEditorSection" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-900 mb-3">üìù Editor JSON</h4>
                    <textarea id="frameworkJsonEditor" class="w-full h-96 p-3 border border-gray-300 rounded-lg font-mono text-xs"
                        placeholder="Contenuto JSON del framework..."></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                        Modifica il JSON direttamente. Assicurati che la sintassi sia valida prima di salvare.
                    </p>
                </div>
                
                <!-- Errori validazione -->
                <div id="frameworkValidationErrors" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                    <h4 class="font-semibold text-red-900 mb-2">‚ö†Ô∏è Errori di Validazione</h4>
                    <ul id="frameworkErrorList" class="list-disc list-inside text-sm text-red-700 space-y-1">
                    </ul>
                </div>
            </div>
            
            <!-- Footer con azioni -->
            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button onclick="closeFrameworkModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    ‚ùå Annulla
                </button>
                <button onclick="saveFrameworkData()" id="btnSaveFramework" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    üíæ Salva Framework
                </button>
            </div>
        </div>
    </div>
    <!-- END MODAL -->

    <!-- MODAL: Conferma Eliminazione Framework -->
    <div id="deleteFrameworkModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Conferma Eliminazione</h3>
                <p class="text-sm text-gray-500 mb-1">Stai per eliminare il framework:</p>
                <p id="deleteFrameworkName" class="text-sm font-semibold text-gray-900 mb-4"></p>
                <p class="text-xs text-red-600 mb-6">Questa azione non pu√≤ essere annullata.</p>
                
                <div class="flex justify-center gap-3">
                    <button onclick="closeDeleteFrameworkModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                        Annulla
                    </button>
                    <button onclick="confirmDeleteFramework()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                        üóëÔ∏è Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- END MODAL -->

</body>
</html>
