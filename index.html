
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATRIX v1.0 - Multi-Analysis Teaching Resource Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4F46E5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Catalog Tab Styles */
        .catalog-tab-btn.active {
            border-bottom-color: #4F46E5;
            color: #4F46E5;
        }
        .catalog-tab-content {
            display: block;
        }
        .catalog-tab-content.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Redirect to Welcome Page (if not disabled) -->
    <script>
        // Controlla se veniamo dalla welcome page (evita loop infinito)
        const urlParams = new URLSearchParams(window.location.search);
        const fromWelcome = urlParams.get('from') === 'welcome';
        
        // Se NON veniamo da welcome E l'utente NON ha disabilitato la welcome
        if (!fromWelcome && !localStorage.getItem('matrix_skip_welcome')) {
            // Redirect a welcome.html
            window.location.href = 'welcome.html';
        }
        
        // Rimuovi il parametro dall'URL dopo il controllo (per pulizia)
        if (fromWelcome) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <!-- Logo MATRIX: Hexagon Network con A-G-D-R -->
                    <svg class="h-10 w-10" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="hexGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#667eea" />
                                <stop offset="100%" stop-color="#764ba2" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Connection lines -->
                        <line x1="30" y1="30" x2="48" y2="45" stroke="#a5b4fc" stroke-width="2.5" opacity="0.35"/>
                        <line x1="90" y1="30" x2="72" y2="45" stroke="#a5b4fc" stroke-width="2.5" opacity="0.35"/>
                        <line x1="30" y1="90" x2="48" y2="75" stroke="#a5b4fc" stroke-width="2.5" opacity="0.35"/>
                        <line x1="90" y1="90" x2="72" y2="75" stroke="#a5b4fc" stroke-width="2.5" opacity="0.35"/>
                        
                        <!-- TOP-LEFT: A (Analisi) -->
                        <g transform="translate(30, 30)">
                            <polygon points="0,-11 9.5,-5.5 9.5,5.5 0,11 -9.5,5.5 -9.5,-5.5" 
                                     fill="none" stroke="url(#hexGrad)" stroke-width="3" opacity="0.75"/>
                            <text x="0" y="5" font-size="14" font-weight="bold" fill="#667eea" text-anchor="middle" font-family="system-ui">A</text>
                        </g>
                        
                        <!-- TOP-RIGHT: G (Gap) -->
                        <g transform="translate(90, 30)">
                            <polygon points="0,-11 9.5,-5.5 9.5,5.5 0,11 -9.5,5.5 -9.5,-5.5" 
                                     fill="none" stroke="url(#hexGrad)" stroke-width="3" opacity="0.75"/>
                            <text x="0" y="5" font-size="14" font-weight="bold" fill="#667eea" text-anchor="middle" font-family="system-ui">G</text>
                        </g>
                        
                        <!-- BOTTOM-LEFT: D (Database) -->
                        <g transform="translate(30, 90)">
                            <polygon points="0,-11 9.5,-5.5 9.5,5.5 0,11 -9.5,5.5 -9.5,-5.5" 
                                     fill="none" stroke="url(#hexGrad)" stroke-width="3" opacity="0.75"/>
                            <text x="0" y="5" font-size="14" font-weight="bold" fill="#667eea" text-anchor="middle" font-family="system-ui">D</text>
                        </g>
                        
                        <!-- BOTTOM-RIGHT: R (Raccomandazioni) -->
                        <g transform="translate(90, 90)">
                            <polygon points="0,-11 9.5,-5.5 9.5,5.5 0,11 -9.5,5.5 -9.5,-5.5" 
                                     fill="none" stroke="url(#hexGrad)" stroke-width="3" opacity="0.75"/>
                            <text x="0" y="5" font-size="14" font-weight="bold" fill="#667eea" text-anchor="middle" font-family="system-ui">R</text>
                        </g>
                        
                        <!-- CENTER: M (MATRIX) -->
                        <polygon points="60,35 78,45 78,75 60,85 42,75 42,45" 
                                 fill="url(#hexGrad)" filter="url(#glow)"/>
                        <text x="60" y="70" font-size="32" font-weight="bold" fill="#ffffff" text-anchor="middle" font-family="system-ui">M</text>
                        
                        <!-- Inner detail -->
                        <polygon points="60,43 70,49 70,71 60,77 50,71 50,49" 
                                 fill="none" stroke="#ffffff" stroke-width="1.5" opacity="0.25"/>
                    </svg>
                    <div>
                        <div class="flex items-center space-x-2">
                            <h1 class="text-2xl font-bold text-gray-900">MATRIX</h1>
                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">v1.0</span>
                            <span id="apiKeyBadge" class="hidden px-2 py-1 text-xs font-medium rounded-full"></span>
                        </div>
                        <p id="headerSubtitle" class="text-sm text-gray-500">Multi-Analysis Teaching Resource Intelligence X-platform</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showView('upload')" id="btnUpload" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Nuova Analisi
                    </button>
                    <button onclick="showView('storico')" id="btnStorico" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Storico
                    </button>
                    <button onclick="showView('settings')" id="btnSettings" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center space-x-1">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>Impostazioni</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Banner Miglioramento -->
    <div class="max-w-7xl mx-auto px-4 pt-4 sm:px-6 lg:px-8">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-green-900">‚úÖ Versione v5.7 - Bilanciamento Criteri Valutazione</h3>
                <p class="text-sm text-green-800 mt-1">Questa versione <strong>bilancia i criteri di valutazione</strong> nell'analisi Avanzata: oltre alla completezza, considera anche <strong>adeguatezza al programma</strong>, <strong>rapporto qualit√†/prezzo</strong> e <strong>accessibilit√†</strong>. Hart (manuale sintetico ed economico) ha ora pi√π possibilit√† di essere raccomandato per programmi brevi o budget limitati!</p>
            </div>
        </div>
    </div>

    <!-- Banner Informativo Differenze Base/Avanzata -->
    <div class="max-w-7xl mx-auto px-4 pt-4 sm:px-6 lg:px-8">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-blue-900">üí° Differenze tra Analisi Base e Avanzata</h3>
                <p class="text-sm text-blue-800 mt-1">
                    Analisi Base e Avanzata dello stesso programma possono raccomandare manuali Zanichelli <strong>diversi</strong>. Questo non √® un errore, ma riflette due approcci complementari:
                </p>
                <ul class="text-sm text-blue-800 mt-2 space-y-1 ml-4">
                    <li><strong>‚ö° Analisi Base:</strong> Fornisce una valutazione <strong>rapida e focalizzata</strong> sui contenuti del programma. Privilegia manuali con buon equilibrio tra chiarezza, accessibilit√† e copertura essenziale degli argomenti. Ideale per una prima valutazione veloce.</li>
                    <li><strong>üî¨ Analisi Avanzata:</strong> Include <strong>insights strategici approfonditi</strong> per il promotore: profilo del docente, opportunit√† commerciali, analisi dell'impatto dell'adozione, strategie di colloquio e gestione obiezioni. Privilegia l'allineamento con il profilo pedagogico e gli obiettivi specifici del corso.</li>
                </ul>
                <p class="text-sm text-blue-800 mt-2">
                    <strong>Entrambe le raccomandazioni sono valide:</strong> usa l'Analisi Base per screening iniziali, l'Analisi Avanzata quando prepari un colloquio con il docente o hai bisogno di argomentazioni commerciali dettagliate.
                </p>
            </div>
        </div>
    </div>

    <!-- Banner Benvenuto (solo per nuovi utenti) -->
    <div id="welcomeBanner" class="hidden max-w-7xl mx-auto px-4 pt-6 sm:px-6 lg:px-8">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-blue-900">Benvenuto! Configurazione necessaria</h3>
                <p class="text-sm text-blue-800 mt-1">Prima di iniziare, devi configurare la tua chiave API OpenAI. Clicca su <strong>Impostazioni</strong> per procedere.</p>
                <button onclick="showView('settings'); document.getElementById('welcomeBanner').classList.add('hidden');" class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700">
                    Vai alle Impostazioni ‚Üí
                </button>
            </div>
            <button onclick="document.getElementById('welcomeBanner').classList.add('hidden')" class="text-blue-400 hover:text-blue-600">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Sezione FAQ -->
    <div class="max-w-7xl mx-auto px-4 pt-4 sm:px-6 lg:px-8">
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <button onclick="toggleFAQ()" class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition">
                <div class="flex items-center space-x-2">
                    <svg class="h-5 w-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="text-sm font-medium text-gray-900">‚ùì Perch√© analisi Base e Avanzata dello stesso programma raccomandano manuali Zanichelli diversi?</h3>
                </div>
                <svg id="faqChevron" class="h-5 w-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="faqContent" class="hidden px-4 pb-4 text-sm text-gray-700 space-y-4">
                <p class="font-medium text-gray-900">
                    Questo comportamento √® <strong>intenzionale</strong> e riflette due filosofie di raccomandazione complementari:
                </p>
                
                <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
                    <h4 class="font-semibold text-blue-900 mb-2">‚ö° ANALISI BASE - Approccio "Rapido-Essenziale"</h4>
                    <ul class="space-y-1 ml-4 list-disc text-blue-800">
                        <li><strong>Velocit√†:</strong> 3-5 minuti per l'analisi completa</li>
                        <li><strong>Focus:</strong> Valutazione del programma (270 punti) + Gap analysis del manuale adottato + Raccomandazioni Zanichelli</li>
                        <li><strong>Output:</strong> Punteggi, copertura argomenti, compatibilit√† manuali</li>
                        <li><strong>Ideale per:</strong> Screening iniziale di pi√π programmi, valutazione rapida della situazione, confronto tra corsi diversi</li>
                    </ul>
                </div>
                
                <div class="bg-purple-50 border-l-4 border-purple-400 p-3">
                    <h4 class="font-semibold text-purple-900 mb-2">üî¨ ANALISI AVANZATA - Approccio "Strategico-Commerciale"</h4>
                    <ul class="space-y-1 ml-4 list-disc text-purple-800">
                        <li><strong>Velocit√†:</strong> 6-9 minuti per l'analisi completa</li>
                        <li><strong>Focus:</strong> Tutto ci√≤ che offre l'Analisi Base + 4 sezioni aggiuntive con insights per il promotore</li>
                        <li><strong>Output:</strong> Profilo docente, leve motivazionali, opportunit√† commerciali, impatto adozione, strategia colloquio, obiezioni e risposte</li>
                        <li><strong>Ideale per:</strong> Preparazione colloqui con docenti, sviluppo argomentazioni commerciali, gestione obiezioni, pianificazione strategia di adozione</li>
                    </ul>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                    <h4 class="font-semibold text-yellow-900 mb-2">üéØ QUALE USARE?</h4>
                    <p class="text-yellow-800 mb-2">Dipende dal contesto e dall'obiettivo della tua analisi:</p>
                    <ul class="space-y-1 ml-4 list-disc text-yellow-800">
                        <li><strong>Screening iniziale di pi√π programmi</strong> ‚Üí Usa Analisi Base per velocit√†</li>
                        <li><strong>Preparazione colloquio con docente specifico</strong> ‚Üí Usa Analisi Avanzata per insights strategici</li>
                        <li><strong>Hai bisogno di argomentazioni commerciali</strong> ‚Üí Usa Analisi Avanzata per obiezioni e risposte</li>
                        <li><strong>Confronto rapido tra manuali</strong> ‚Üí Usa Analisi Base per copertura essenziale</li>
                        <li><strong>In dubbio</strong> ‚Üí Inizia con Base, poi richiedi Avanzata se serve approfondire</li>
                    </ul>
                    <p class="text-yellow-800 mt-2 text-sm italic">
                        Nota: Le raccomandazioni possono differire perch√© l'Analisi Avanzata valuta anche il <strong>profilo pedagogico del docente</strong> e l'<strong>allineamento strategico</strong>, non solo la copertura argomenti.
                    </p>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded p-3">
                    <p class="text-gray-700">
                        <strong>üìå RICORDA:</strong> Le raccomandazioni Base e Avanzata sono entrambe valide e basate su criteri diversi. Se i punteggi di compatibilit√† sono simili (es. 85/100 vs 84/100), la scelta finale dipender√† pi√π dal <strong>contesto del colloquio</strong> e dal <strong>profilo del docente</strong> che da una superiorit√† oggettiva del manuale.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        
        <!-- Settings View -->
        <div id="viewSettings" class="hidden">
            <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">ü§ñ Configurazione AI Provider</h2>
                <p class="text-sm text-gray-600 mb-6">Scegli il provider LLM e configura la tua API key. Dati salvati solo nel tuo browser.</p>
                
                <div class="space-y-6">
                    <!-- Provider Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Seleziona Provider AI</label>
                        <div class="grid grid-cols-3 gap-3">
                            <!-- Row 1 -->
                            <button onclick="selectProvider('openai')" id="btnProviderOpenAI" class="provider-btn px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100 text-sm">
                                <div class="font-semibold">OpenAI</div>
                                <div class="text-xs opacity-75">Leader mercato</div>
                            </button>
                            <button onclick="selectProvider('anthropic')" id="btnProviderAnthropic" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">Claude</div>
                                <div class="text-xs opacity-75">Sicurezza</div>
                            </button>
                            <button onclick="selectProvider('google')" id="btnProviderGoogle" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">Gemini</div>
                                <div class="text-xs opacity-75">Economico</div>
                            </button>
                            <!-- Row 2 -->
                            <button onclick="selectProvider('xai')" id="btnProviderXai" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">Grok</div>
                                <div class="text-xs opacity-75">xAI</div>
                            </button>
                            <button onclick="selectProvider('deepseek')" id="btnProviderDeepseek" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">DeepSeek</div>
                                <div class="text-xs opacity-75">Ultra-low cost</div>
                            </button>
                            <button onclick="selectProvider('meta')" id="btnProviderMeta" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">Llama</div>
                                <div class="text-xs opacity-75">Open source</div>
                            </button>
                            <!-- Row 3 -->
                            <button onclick="selectProvider('mistral')" id="btnProviderMistral" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">Mistral</div>
                                <div class="text-xs opacity-75">EU/GDPR</div>
                            </button>
                            <button onclick="selectProvider('cohere')" id="btnProviderCohere" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">Cohere</div>
                                <div class="text-xs opacity-75">Enterprise</div>
                            </button>
                            <button onclick="selectProvider('perplexity')" id="btnProviderPerplexity" class="provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm">
                                <div class="font-semibold">Perplexity</div>
                                <div class="text-xs opacity-75">Web search</div>
                            </button>
                        </div>
                    </div>

                    <!-- Dynamic Provider Configuration -->
                    <div id="providerConfig" class="border-t pt-4">
                        <!-- Popolato dinamicamente da selectProvider() -->
                    </div>

                    <!-- Save Button -->
                    <button onclick="saveConfiguration()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                        Salva Configurazione
                    </button>
                    
                    <!-- Status Message -->
                    <div id="configStatus" class="hidden p-3 rounded-lg"></div>
                </div>
            </div>
        </div>

        
        <!-- Upload View -->
        <div id="viewUpload" class="hidden">
            
            <!-- Tab Navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-8 max-w-4xl mx-auto" aria-label="Tabs">
                    <button id="tabAnalisi" onclick="switchTab('analisi')" class="tab-button border-b-2 border-indigo-500 py-4 px-1 text-indigo-600 font-medium text-sm whitespace-nowrap">
                        üìä Analisi Programma
                    </button>
                    <button id="tabValutazione" onclick="switchTab('valutazione')" class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                        üìö Valutazione Manuali
                    </button>
                    <button id="tabCataloghi" onclick="switchTab('cataloghi')" class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap">
                        ‚öôÔ∏è Gestione Dati
                    </button>
                </nav>
            </div>
            
            <!-- Tab Content: Analisi Programma (DEFAULT - contains all existing content) -->
            <div id="tabContentAnalisi" class="tab-content">
                <div class="max-w-4xl mx-auto space-y-6">
                    
                    <!-- Step 0: Selezione Materia e Framework -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">üéØ Selezione Materia e Framework</h2>
                    <p class="text-sm text-gray-600 mb-6">Seleziona la materia e il framework specifico per l'analisi</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Dropdown 1: Materia -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Materia *</label>
                            <select id="materiaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">üìö Seleziona materia...</option>
                                <!-- Popolato dinamicamente da matrix_config.json -->
                            </select>
                        </div>
                        
                        <!-- Dropdown 2: Framework (appare solo dopo selezione materia) -->
                        <div id="frameworkContainer" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Framework Specifico *</label>
                            <select id="frameworkSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona framework...</option>
                                <!-- Popolato dinamicamente in base alla materia -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Info framework caricato -->
                    <div id="frameworkInfo" class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200" style="display: none;">
                        <p class="text-sm text-blue-800">
                            ‚úÖ <strong>Framework caricato:</strong> <span id="frameworkName" class="font-medium"></span>
                        </p>
                    </div>
                </div>
                
                <!-- Step 1: Informazioni Contesto -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">1. Informazioni sul Contesto</h2>
                    <p class="text-sm text-gray-600 mb-6">Fornisci informazioni sul contesto didattico e il manuale adottato</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contesto Didattico *</label>
                            <select id="contestoSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona contesto...</option>
                                <option value="L-2">L-2: Biotecnologie</option>
                                <option value="L-13">L-13: Scienze biologiche</option>
                                <option value="L-25">L-25: Agraria</option>
                                <option value="L-29">L-29: Scienze farmaceutiche</option>
                                <option value="L-32">L-32: Scienze naturali/ambientali</option>
                                <option value="L-38">L-38: Scienze zootecniche</option>
                                <option value="L-8/9">L-8/9: Ingegneria</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manuale Principale *</label>
                            <select id="manualeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona manuale principale...</option>
                                <optgroup label="Manuali Zanichelli">
                                    <option value="McMurryBiologico">McMurry - Chimica Organica: Un approccio biologico (Zanichelli)</option>
                                    <option value="Hart">Hart - Chimica Organica (Zanichelli)</option>
                                    <option value="McMurryFondamenti">McMurry - Fondamenti di Chimica Organica (Zanichelli)</option>
                                </optgroup>
                                <optgroup label="Altri Editori">
                                    <option value="Botta">Botta (EdiErmes)</option>
                                    <option value="Brown">Brown (Edises)</option>
                                    <option value="Bruice">Bruice (Edises)</option>
                                    <option value="GorzynskiSmith">Gorzynski Smith (McGraw-Hill)</option>
                                    <option value="Wade">Wade (Piccin)</option>
                                </optgroup>
                                <option value="Altro">Altro manuale (specificare sotto)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Il manuale principale sar√† analizzato in dettaglio</p>
                        </div>
                        
                        <!-- Campo testo per "Altro manuale" -->
                        <div id="altroManualeField" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Specifica il manuale adottato</label>
                            <input type="text" id="altroManualeNome" placeholder="Es: Solomons, Vollhardt, Klein..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">L'analisi si concentrer√† sulle raccomandazioni Zanichelli basate sul programma</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manuali Alternativi (opzionale)</label>
                            <p class="text-xs text-gray-500 mb-2">Seleziona eventuali manuali alternativi per un confronto rapido</p>
                            <div class="space-y-2 bg-gray-50 p-3 rounded-lg border border-gray-200 max-h-80 overflow-y-auto">
                                <!-- Manuali Zanichelli -->
                                <div class="border-b border-gray-300 pb-2 mb-2">
                                    <p class="text-xs font-semibold text-gray-600 mb-2 sticky top-0 bg-gray-50 py-1">Zanichelli</p>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altMcMurryBiologico" value="McMurryBiologico" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">McMurry - Approccio Biologico</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altHart" value="Hart" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">Hart - Chimica Organica</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altMcMurryFondamenti" value="McMurryFondamenti" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">McMurry - Fondamenti</span>
                                    </label>
                                </div>
                                <!-- Altri Editori -->
                                <div>
                                    <p class="text-xs font-semibold text-gray-600 mb-2 sticky top-0 bg-gray-50 py-1">Altri Editori</p>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altBotta" value="Botta" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">Botta (EdiErmes)</span>
                                    </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altBrown" value="Brown" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Brown (Edises)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altBruice" value="Bruice" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Bruice (Edises)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altGorzynski" value="GorzynskiSmith" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Gorzynski Smith (McGraw-Hill)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altWade" value="Wade" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Wade (Piccin)</span>
                                </label>
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                        <input type="checkbox" id="altAltro" value="Altro" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">Altro/Non specificato</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo di Analisi *</label>
                            <p class="text-xs text-gray-500 mb-3">Scegli il livello di dettaglio dell'analisi</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-start space-x-3 p-4 border-2 border-indigo-600 bg-indigo-50 rounded-lg cursor-pointer hover:bg-indigo-100 transition">
                                    <input type="radio" name="tipoAnalisi" value="base" checked class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-indigo-900">‚ö° Base</p>
                                        <p class="text-xs text-indigo-700 mt-1">Analisi veloce ed essenziale. Ideale per una prima valutazione rapida del programma.</p>
                                    </div>
                                </label>
                                <label class="flex items-start space-x-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition">
                                    <input type="radio" name="tipoAnalisi" value="avanzata" class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-gray-900">üî¨ Avanzata</p>
                                        <p class="text-xs text-gray-700 mt-1">Analisi dettagliata e approfondita con argomentazioni commerciali complete.</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CFU (Crediti)</label>
                            <input type="number" id="cfuInput" placeholder="es. 9" min="1" max="20"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ore Totali</label>
                            <input type="number" id="oreInput" placeholder="es. 72" min="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Carica Programma -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">2. Carica Programma Universitario</h2>
                    <p class="text-sm text-gray-600 mb-6">Carica un file PDF o incolla il testo del programma</p>
                    
                    <div class="space-y-6">
                        <!-- Upload File -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Carica File (PDF o TXT)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" accept=".pdf,.txt" class="hidden" onchange="handleFileSelect(event)">
                                <svg class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p id="fileNameDisplay" class="text-sm text-gray-600">Clicca per selezionare un file</p>
                                <p class="text-xs text-gray-500 mt-2">PDF o TXT (max 16 MB)</p>
                            </div>
                        </div>

                        <!-- Oppure -->
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                            <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">oppure</span></div>
                        </div>

                        <!-- Textarea -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Incolla il Testo</label>
                            <textarea id="testoInput" placeholder="Incolla qui il testo del programma universitario..." 
                                      class="w-full h-64 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
                        </div>

                        <!-- Error -->
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3">
                            <svg class="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p id="errorText" class="text-sm text-red-800"></p>
                        </div>

                        <!-- Button -->
                        <button onclick="avviaAnalisi()" id="btnAnalizza" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-lg font-medium flex items-center justify-center">
                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Avvia Analisi Completa
                        </button>
                        <div id="loadingMessage" class="hidden text-center space-y-2">
                            <div class="spinner mx-auto"></div>
                            <p class="text-sm text-gray-600" id="loadingText">Analisi in corso...</p>
                            <p class="text-xs text-gray-500">Questo pu√≤ richiedere 30-60 secondi</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- END Tab Content: Analisi Programma -->
            
            <!-- Tab Content: Valutazione Manuali -->
            <div id="tabContentValutazione" class="tab-content hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-6">üìö Valutazione Assoluta Manuali</h2>
                        
                        <!-- Form Valutazione -->
                        <div class="space-y-6">
                            
                            <!-- STEP 1: Macroarea -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 1: Seleziona Macroarea
                                </label>
                                <select id="evalAbsMacroarea" onchange="evalAbs_onMacroareaChange()" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona macroarea...</option>
                                </select>
                            </div>
                            
                            <!-- STEP 2: Materia Specifica (nascosto se non necessario) -->
                            <div id="evalAbsMateriaContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 2: Seleziona Materia Specifica
                                </label>
                                <select id="evalAbsMateria" onchange="evalAbs_onMateriaChange()" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona materia...</option>
                                </select>
                            </div>
                            
                            <!-- STEP 3: Manuale -->
                            <div id="evalAbsManualeContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 3: Seleziona Manuale
                                </label>
                                <select id="evalAbsManuale" onchange="evalAbs_onManualeChange()" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona manuale...</option>
                                </select>
                            </div>
                            
                            <!-- STEP 4: Framework -->
                            <div id="evalAbsFrameworkContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    STEP 4: Framework di Riferimento
                                    <span class="text-xs text-gray-500 ml-2">(auto-selezionato, puoi modificare)</span>
                                </label>
                                <select id="evalAbsFramework" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona framework...</option>
                                </select>
                            </div>
                            
                            <!-- Bottone Avvia -->
                            <div id="evalAbsButtonContainer" class="hidden pt-4">
                                <button onclick="evalAbs_startEvaluation()" 
                                    class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-lg">
                                    üöÄ Avvia Valutazione
                                </button>
                            </div>
                            
                        </div>
                        
                        <!-- Loading State -->
                        <div id="evalAbsLoading" class="hidden mt-8">
                            <div class="flex flex-col items-center justify-center py-12">
                                <div class="spinner mb-4"></div>
                                <p class="text-gray-600 font-medium">‚è≥ Valutazione in corso...</p>
                                <p class="text-sm text-gray-500 mt-2">Analisi del manuale con AI (pu√≤ richiedere 1-2 minuti)</p>
                                <p id="evalAbsLoadingProgress" class="text-xs text-indigo-600 font-mono mt-3"></p>
                            </div>
                        </div>
                        
                        <!-- Report Result -->
                        <div id="evalAbsResult" class="hidden mt-8">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b">
                                <h3 class="text-lg font-bold">üìä Report Valutazione</h3>
                                <div class="flex gap-2">
                                    <button onclick="evalAbs_saveReport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                        üíæ Salva
                                    </button>
                                    <button onclick="evalAbs_downloadHTML()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                        üì• Scarica HTML
                                    </button>
                                    <button onclick="evalAbs_closeReport()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                                        ‚Üê Torna
                                    </button>
                                </div>
                            </div>
                            <div id="evalAbsReportContent" class="prose max-w-none bg-gray-50 p-6 rounded-lg border">
                                <!-- Report HTML will be inserted here -->
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Lista Valutazioni Salvate -->
                    <div id="evalAbsSavedList" class="bg-white rounded-xl shadow-lg p-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold">üìã Valutazioni Salvate</h3>
                            <div class="flex gap-2">
                                <button onclick="evalAbs_exportAll()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-sm">
                                    üì§ Esporta Tutte
                                </button>
                                <button onclick="evalAbs_importJSON()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-sm">
                                    üì• Importa
                                </button>
                            </div>
                        </div>
                        <div id="evalAbsSavedListContent" class="space-y-3">
                            <p class="text-sm text-gray-500 text-center py-8">Nessuna valutazione salvata</p>
                        </div>
                    </div>
                    
                </div>
            </div>
            <!-- END Tab Content: Valutazione Manuali -->
            
            <!-- Tab Content: Gestione Dati -->
            <div id="tabContentCataloghi" class="tab-content hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-6">‚öôÔ∏è Gestione Dati</h2>
                        
                        <!-- Sub-tabs: Manuali / Framework -->
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="switchCatalogTab('manuali')" id="btnTabManuali" class="catalog-tab-btn active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600">
                                    üìö Manuali
                                </button>
                                <button onclick="switchCatalogTab('framework')" id="btnTabFramework" class="catalog-tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                    üìã Framework
                                </button>
                            </nav>
                        </div>
                        
                        <!-- MANUALI TAB -->
                        <div id="catalogTabManuali" class="catalog-tab-content">
                            
                            <!-- Header con filtri e azioni -->
                            <div class="mb-6">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                    <div class="flex-1">
                                        <input type="text" id="searchManuali" placeholder="üîç Cerca per titolo, autore, editore..." 
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            onkeyup="filterManuali()">
                                    </div>
                                    <button onclick="openAddManualeModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium whitespace-nowrap">
                                        ‚ûï Nuovo Manuale
                                    </button>
                                </div>
                                
                                <!-- Filtri -->
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <select id="filterMacroarea" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üóÇÔ∏è Tutte le macroaree</option>
                                        <option value="Biologia">Biologia</option>
                                        <option value="Chimica">Chimica</option>
                                        <option value="Fisica">Fisica</option>
                                        <option value="Matematica">Matematica</option>
                                        <option value="Economia">Economia</option>
                                        <option value="Istologia">Istologia</option>
                                    </select>
                                    
                                    <select id="filterMateria" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üìö Tutte le materie</option>
                                        <!-- Popolato dinamicamente in base ai manuali caricati -->
                                    </select>
                                    
                                    <select id="filterEditore" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üè¢ Tutti gli editori</option>
                                        <option value="Zanichelli">Zanichelli</option>
                                        <option value="Edises">Edises</option>
                                        <option value="McGraw-Hill">McGraw-Hill</option>
                                        <option value="Pearson">Pearson</option>
                                        <option value="Piccin">Piccin</option>
                                        <option value="CEA">CEA</option>
                                    </select>
                                    
                                    <select id="filterTipo" onchange="filterManuali()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üè∑Ô∏è Tutti i tipi</option>
                                        <option value="zanichelli">Zanichelli</option>
                                        <option value="competitor">Competitor</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Tabella manuali -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-20">ID</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-28">Titolo</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-20">Autore</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Edit.</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Macro</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-24">Materia</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-10">Cap</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Tipo</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-14">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manualiTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Popolato dinamicamente da JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Footer con stats -->
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <div class="text-sm text-gray-600">
                                    <span id="manualiCount">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                        <!-- END MANUALI TAB -->
                        
                        <!-- FRAMEWORK TAB -->
                        <div id="catalogTabFramework" class="catalog-tab-content hidden">
                            
                            <!-- Header con filtri e azioni -->
                            <div class="mb-6">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                    <div class="flex-1">
                                        <input type="text" id="searchFramework" placeholder="üîç Cerca per nome, materia..." 
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            onkeyup="filterFramework()">
                                    </div>
                                    <button onclick="openAddFrameworkModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium whitespace-nowrap">
                                        ‚ûï Nuovo Framework
                                    </button>
                                </div>
                                
                                <!-- Filtri -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <select id="filterFrameworkMateria" onchange="filterFramework()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üìö Tutte le materie</option>
                                        <option value="Matematica">Matematica</option>
                                        <option value="Fisica">Fisica</option>
                                        <option value="Chimica">Chimica</option>
                                        <option value="Biologia">Biologia</option>
                                        <option value="Economia">Economia</option>
                                        <option value="Medicina e Chirurgia">Medicina e Chirurgia</option>
                                        <option value="Istologia">Istologia</option>
                                    </select>
                                    
                                    <select id="filterFrameworkTipo" onchange="filterFramework()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">üè∑Ô∏è Tutti i tipi</option>
                                        <option value="originale">Originale</option>
                                        <option value="modificato">Modificato</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Tabella framework -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-24">ID</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-32">Nome</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-20">Materia</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-12">Moduli</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-12">Profili</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-16">Tipo</th>
                                            <th class="px-1 py-1 text-left text-xs font-medium text-gray-500 uppercase w-14">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="frameworkTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Popolato dinamicamente da JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Footer con stats -->
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <div class="text-sm text-gray-600">
                                    <span id="frameworkCount">Caricamento...</span>
                                </div>
                            </div>
                        </div>
                        <!-- END FRAMEWORK TAB -->
                        
                    </div>
                </div>
            </div>
            <!-- END Tab Content: Gestione Dati -->
            
        </div>

        <!-- Risultati View -->
        <div id="viewRisultati" class="hidden">
            <!-- Contenuto dinamico generato da JavaScript -->
        </div>

        <!-- Storico View -->
        <div id="viewStorico" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Storico Analisi</h2>
                <div id="storicoContent" class="space-y-3">
                    <!-- Contenuto dinamico -->
                </div>
            </div>
        </div>

        <!-- View Colloquio (Fase C) -->


    </main>

    <script>
        // Configurazione PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Database manuali (da report forniti)
        const MANUALI_DB = {
            'Botta': {
                editore: 'EdiErmes',
                caratteristiche: ['Approccio italiano', 'Focus biomolecole', 'Esempi biologici'],
                punti_forza: ['Linguaggio accessibile', 'Applicazioni biologiche', 'Esercizi graduati'],
                target: ['L-13', 'L-2']
            },
            'Brown': {
                editore: 'Edises',
                caratteristiche: ['Approccio problem-solving', 'Molti esercizi', 'Visione moderna'],
                punti_forza: ['Chiarezza espositiva', 'Ricchezza esercizi', 'Aggiornato'],
                target: ['L-13', 'L-29', 'L-32']
            },
            'Bruice': {
                editore: 'Edises',
                caratteristiche: ['Approccio biologico', 'Meccanismi dettagliati', 'Applicazioni mediche'],
                punti_forza: ['Profondit√† meccanismi', 'Collegamenti biologia', 'Casi clinici'],
                target: ['L-29', 'L-13']
            },
            'GorzynskiSmith': {
                editore: 'McGraw-Hill',
                caratteristiche: ['Approccio visuale', 'Molte illustrazioni', 'Sintesi organica'],
                punti_forza: ['Chiarezza visiva', 'Sintesi organica', 'Meccanismi'],
                target: ['L-13', 'L-29']
            },
            'Wade': {
                editore: 'Piccin',
                caratteristiche: ['Approccio sistematico', 'Meccanismi dettagliati', 'Esercizi'],
                punti_forza: ['Sistematicit√†', 'Rigore', 'Completezza'],
                target: ['L-13', 'L-29']
            },
            'McMurryBiologico': {
                editore: 'Zanichelli',
                caratteristiche: ['Orientamento biologico', 'Collegamenti biochimica', 'Biomolecole approfondite'],
                punti_forza: ['Integrazione biologica continua', 'Preparazione ottimale per Biochimica', 'Meccanismi dettagliati'],
                target: ['L-13', 'L-2', 'L-29']
            },
            'Hart': {
                editore: 'Zanichelli',
                caratteristiche: ['Sintesi e chiarezza', 'Biomolecole presenti', 'Esercizi graduati'],
                punti_forza: ['Concisione', 'Linguaggio accessibile', 'Buona copertura argomenti base'],
                target: ['L-13', 'L-25', 'L-32']
            },
            'McMurryFondamenti': {
                editore: 'Zanichelli',
                caratteristiche: ['Versione compatta', 'Meccanismi approfonditi', 'Stereochimica dettagliata'],
                punti_forza: ['Rigore scientifico', 'Concisione', 'Linguaggio preciso'],
                target: ['L-27', 'Ingegneria']
            }
        };

        // Database LLM Providers (Gennaio 2026)
        const LLM_PROVIDERS = {
            'openai': {
                name: 'OpenAI',
                description: 'Leader di mercato, migliori performance',
                apiKeyPrefix: 'sk-',
                apiKeyUrl: 'https://platform.openai.com/api-keys',
                endpoint: 'https://api.openai.com/v1/chat/completions',
                models: [
                    { id: 'gpt-4o-mini', name: 'GPT-4o Mini', input: 0.075, output: 0.30, context: '128K', tier: 'economico', description: 'Bilanciato qualit√†-prezzo' },
                    { id: 'gpt-4o', name: 'GPT-4o', input: 1.25, output: 5.00, context: '128K', tier: 'premium', description: 'Prestazioni elevate' },
                    { id: 'gpt-4.1-mini', name: 'GPT-4.1 Mini', input: 0.125, output: 1.00, context: '400K', tier: 'economico', description: 'Economico, contesto esteso' },
                    { id: 'o1-mini', name: 'o1 Mini (reasoning)', input: 0.55, output: 2.20, context: '131K', tier: 'medio', description: 'Reasoning economico' }
                ]
            },
            'anthropic': {
                name: 'Anthropic Claude',
                description: 'Focus su sicurezza e contesto esteso',
                apiKeyPrefix: 'sk-ant-',
                apiKeyUrl: 'https://console.anthropic.com/settings/keys',
                endpoint: 'https://api.anthropic.com/v1/messages',
                models: [
                    { id: 'claude-haiku-4', name: 'Claude Haiku 4', input: 0.25, output: 1.25, context: '200K', tier: 'economico', description: 'Veloce ed economico' },
                    { id: 'claude-sonnet-4', name: 'Claude Sonnet 4', input: 3.00, output: 15.00, context: '1M', tier: 'premium', description: 'Contesto 1M token' },
                    { id: 'claude-sonnet-4.5', name: 'Claude Sonnet 4.5', input: 3.00, output: 15.00, context: '200K', tier: 'premium', description: 'Ultima versione' },
                    { id: 'claude-opus-4.5', name: 'Claude Opus 4.5', input: 5.00, output: 25.00, context: '200K', tier: 'premium', description: 'Top performance' }
                ]
            },
            'google': {
                name: 'Google Gemini',
                description: 'Aggressive pricing, contesto massiccio',
                apiKeyPrefix: 'AI',
                apiKeyUrl: 'https://aistudio.google.com/apikey',
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/',
                models: [
                    { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', input: 0.15, output: 0.60, context: '1M', tier: 'economico', description: 'Ultra-economico, alto volume' },
                    { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro', input: 1.25, output: 10.00, context: '2M', tier: 'premium', description: 'Contesto 2M token' },
                    { id: 'gemini-2.5-flash-reasoning', name: 'Gemini 2.5 Flash (reasoning)', input: 0.15, output: 3.50, context: '1M', tier: 'medio', description: 'Reasoning economico' }
                ]
            },
            'xai': {
                name: 'xAI Grok',
                description: 'Nuovo entrante competitivo',
                apiKeyPrefix: 'xai-',
                apiKeyUrl: 'https://console.x.ai',
                endpoint: 'https://api.x.ai/v1/chat/completions',
                models: [
                    { id: 'grok-mini', name: 'Grok Mini', input: 0.30, output: 4.00, context: '131K', tier: 'economico', description: 'Buon rapporto qualit√†-prezzo' },
                    { id: 'grok-3', name: 'Grok-3', input: 3.00, output: 15.00, context: '131K', tier: 'premium', description: 'Standard performance' },
                    { id: 'grok-4.1-fast', name: 'Grok-4.1 Fast Reasoning', input: 0.30, output: 0.50, context: '131K', tier: 'economico', description: 'Fast reasoning' }
                ]
            },
            'deepseek': {
                name: 'DeepSeek',
                description: 'Rivoluzione low-cost dalla Cina',
                apiKeyPrefix: 'sk-',
                apiKeyUrl: 'https://platform.deepseek.com/api_keys',
                endpoint: 'https://api.deepseek.com/v1/chat/completions',
                models: [
                    { id: 'deepseek-v3.2-exp', name: 'DeepSeek V3.2-Exp', input: 0.28, output: 0.42, context: '64K', tier: 'economico', description: 'Costo minimo, 90% meno di GPT-4' },
                    { id: 'deepseek-r1', name: 'DeepSeek-R1', input: 0.55, output: 2.19, context: '64K', tier: 'economico', description: 'Reasoning economico' }
                ]
            },
            'meta': {
                name: 'Meta Llama',
                description: 'Open source, hosting flessibile',
                apiKeyPrefix: '',
                apiKeyUrl: 'https://together.ai (o altro provider)',
                endpoint: 'https://api.together.xyz/v1/chat/completions',
                models: [
                    { id: 'llama-4-maverick', name: 'Llama 4 Maverick', input: 0.150, output: 0.600, context: '1M', tier: 'economico', description: 'Open source, contesto 1M' },
                    { id: 'llama-3.3-70b', name: 'Llama 3.3 70B', input: 0.100, output: 0.320, context: '131K', tier: 'economico', description: 'Bilanciato' },
                    { id: 'llama-3.2-3b', name: 'Llama 3.2 3B', input: 0.020, output: 0.020, context: '131K', tier: 'economico', description: 'Ultra-economico, piccolo' }
                ]
            },
            'mistral': {
                name: 'Mistral AI',
                description: 'Eccellenza europea, GDPR compliant',
                apiKeyPrefix: '',
                apiKeyUrl: 'https://console.mistral.ai/api-keys',
                endpoint: 'https://api.mistral.ai/v1/chat/completions',
                models: [
                    { id: 'ministral-3b', name: 'Ministral 3B', input: 0.040, output: 0.040, context: '131K', tier: 'economico', description: 'Ultra-economico' },
                    { id: 'ministral-8b', name: 'Ministral 8B', input: 0.100, output: 0.100, context: '131K', tier: 'economico', description: 'Economico, bilanciato' },
                    { id: 'mistral-small-3.2', name: 'Mistral Small 3.2 24B', input: 0.060, output: 0.180, context: '131K', tier: 'economico', description: 'Buone performance' },
                    { id: 'mistral-large-3', name: 'Mistral Large 3', input: 0.500, output: 1.500, context: '262K', tier: 'medio', description: 'Top Mistral, contesto esteso' },
                    { id: 'devstral-2', name: 'Devstral 2 (coding)', input: 0.050, output: 0.220, context: '262K', tier: 'economico', description: 'Specializzato coding' }
                ]
            },
            'cohere': {
                name: 'Cohere',
                description: 'Specialista enterprise e RAG',
                apiKeyPrefix: '',
                apiKeyUrl: 'https://dashboard.cohere.com/api-keys',
                endpoint: 'https://api.cohere.ai/v1/chat',
                models: [
                    { id: 'command-r7b', name: 'Command R7B', input: 0.075, output: 0.300, context: '128K', tier: 'economico', description: 'Economico, veloce' },
                    { id: 'command-r', name: 'Command R', input: 0.150, output: 0.600, context: '128K', tier: 'economico', description: 'Bilanciato' },
                    { id: 'command-r-plus', name: 'Command R+', input: 2.500, output: 10.000, context: '128K', tier: 'premium', description: 'Enterprise grade' },
                    { id: 'command-a', name: 'Command A', input: 2.500, output: 10.000, context: '256K', tier: 'premium', description: 'Top performance' }
                ]
            },
            'perplexity': {
                name: 'Perplexity',
                description: 'Online reasoning e ricerca web',
                apiKeyPrefix: 'pplx-',
                apiKeyUrl: 'https://www.perplexity.ai/settings/api',
                endpoint: 'https://api.perplexity.ai/chat/completions',
                models: [
                    { id: 'llama-3.1-sonar-large-128k-online', name: 'Sonar Large (online)', input: 1.00, output: 1.00, context: '128K', tier: 'medio', description: 'Con ricerca web' },
                    { id: 'llama-3.1-sonar-huge-128k-online', name: 'Sonar Huge (online)', input: 5.00, output: 5.00, context: '128K', tier: 'premium', description: 'Potente con web' },
                    { id: 'llama-3.1-sonar-large-128k-reasoning', name: 'Sonar Reasoning', input: 1.00, output: 5.00, context: '128K', tier: 'medio', description: 'Reasoning con web' }
                ]
            }
        };

        // Database indici manuali Zanichelli (per Fase C - Post-it)
        const INDICI_MANUALI = {"versione":"2.0","data_aggiornamento":"2025-11-09","manuali":[{"id":"hart","nome":"Hart - Fondamenti di chimica organica","editore":"Zanichelli","pagine_totali":520,"capitoli":[{"numero":1,"titolo":"Il legame chimico e l'isomeria","pagina_inizio":1},{"numero":2,"titolo":"Gli alcani e i cicloalcani","pagina_inizio":37},{"numero":3,"titolo":"Gli alcheni e gli alchini","pagina_inizio":68},{"numero":4,"titolo":"I composti aromatici","pagina_inizio":113},{"numero":5,"titolo":"La stereoisomeria","pagina_inizio":140},{"numero":6,"titolo":"Composti organici alogenati","pagina_inizio":170},{"numero":7,"titolo":"Gli alcoli, i fenoli e i tioli","pagina_inizio":193},{"numero":8,"titolo":"Gli eteri e gli epossidi","pagina_inizio":220},{"numero":9,"titolo":"Le aldeidi e i chetoni","pagina_inizio":238},{"numero":10,"titolo":"Acidi carbossilici e derivati","pagina_inizio":272},{"numero":11,"titolo":"Le ammine e altri composti azotati","pagina_inizio":309},{"numero":12,"titolo":"La spettroscopia","pagina_inizio":333},{"numero":13,"titolo":"I composti eterociclici","pagina_inizio":360},{"numero":14,"titolo":"I polimeri sintetici","pagina_inizio":379},{"numero":15,"titolo":"I lipidi e i detergenti","pagina_inizio":405},{"numero":16,"titolo":"I carboidrati","pagina_inizio":426},{"numero":17,"titolo":"Amminoacidi, peptidi e proteine","pagina_inizio":455},{"numero":18,"titolo":"I nucleotidi e gli acidi nucleici","pagina_inizio":486}]},{"id":"mcmurry_fondamenti","nome":"McMurry - Fondamenti di chimica organica","editore":"Zanichelli","pagine_totali":896,"capitoli":[{"numero":1,"titolo":"Struttura e legame chimico; acidi e basi","pagina_inizio":1},{"numero":2,"titolo":"I composti organici: gli alcani","pagina_inizio":31},{"numero":3,"titolo":"Gli alcheni e gli alchini: le reazioni organiche","pagina_inizio":66},{"numero":4,"titolo":"Le reazioni degli alcheni e degli alchini","pagina_inizio":94},{"numero":5,"titolo":"I composti aromatici","pagina_inizio":131},{"numero":6,"titolo":"La stereochimica dei centri tetraedrici","pagina_inizio":161},{"numero":7,"titolo":"Gli organoalogenuri: sostituzioni nucleofile ed eliminazioni","pagina_inizio":190},{"numero":8,"titolo":"Alcoli, fenoli, eteri e loro analoghi solforati","pagina_inizio":221},{"numero":9,"titolo":"Aldeidi e chetoni: le reazioni di addizione nucleofila","pagina_inizio":255},{"numero":10,"titolo":"Gli acidi carbossilici e i loro derivati: reazioni di sostituzione nucleofila acilica","pagina_inizio":281},{"numero":11,"titolo":"Le reazioni di sostituzione in alfa al carbonile e le reazioni di condensazione","pagina_inizio":321},{"numero":12,"titolo":"Le ammine","pagina_inizio":348},{"numero":13,"titolo":"La determinazione della struttura","pagina_inizio":373},{"numero":14,"titolo":"Le biomolecole: i carboidrati","pagina_inizio":404},{"numero":15,"titolo":"Le biomolecole: amminoacidi, peptidi e proteine","pagina_inizio":432},{"numero":16,"titolo":"Le biomolecole: i lipidi e gli acidi nucleici","pagina_inizio":462},{"numero":17,"titolo":"La chimica organica dei percorsi metabolici","pagina_inizio":490}]},{"id":"mcmurry_biologico","nome":"McMurry - Chimica organica: un approccio biologico","editore":"Zanichelli","pagine_totali":1152,"capitoli":[{"numero":1,"titolo":"La struttura e il legame","pagina_inizio":1},{"numero":2,"titolo":"I legami covalenti polari; gli acidi e le basi","pagina_inizio":27},{"numero":3,"titolo":"I composti organici: gli alcani e la loro stereochimica","pagina_inizio":57},{"numero":4,"titolo":"I composti organici: i cicloalcani e la loro stereochimica","pagina_inizio":85},{"numero":5,"titolo":"Una panoramica sulle reazioni organiche","pagina_inizio":109},{"numero":6,"titolo":"Gli alcheni e gli alchini","pagina_inizio":140},{"numero":7,"titolo":"Le reazioni degli alcheni e degli alchini","pagina_inizio":170},{"numero":8,"titolo":"I composti aromatici","pagina_inizio":205},{"numero":9,"titolo":"La stereochimica","pagina_inizio":247},{"numero":10,"titolo":"Gli alogenuri alchilici: le sostituzioni nucleofile e le eliminazioni","pagina_inizio":281},{"numero":11,"titolo":"La determinazione della struttura: spettrometria di massa, spettroscopia infrarossa e ultravioletta","pagina_inizio":323},{"numero":12,"titolo":"La determinazione della struttura: la spettroscopia di risonanza magnetica nucleare","pagina_inizio":355},{"numero":13,"titolo":"Gli alcoli, i fenoli e i tioli; gli eteri e i solfuri","pagina_inizio":390},{"numero":14,"titolo":"Le aldeidi e i chetoni: le reazioni di addizione nucleofila","pagina_inizio":436},{"numero":15,"titolo":"Gli acidi carbossilici e i nitrili","pagina_inizio":470},{"numero":16,"titolo":"I derivati degli acidi carbossilici: le reazioni di sostituzione nucleofila acilica","pagina_inizio":494},{"numero":17,"titolo":"Le reazioni dei composti carbonilici in posizione alfa","pagina_inizio":525},{"numero":18,"titolo":"Le ammine e gli eterocicli","pagina_inizio":557},{"numero":19,"titolo":"Le biomolecole: i carboidrati","pagina_inizio":595},{"numero":20,"titolo":"Le biomolecole: gli amminoacidi, i peptidi e le proteine","pagina_inizio":636},{"numero":21,"titolo":"Le biomolecole: gli enzimi e la vitamina","pagina_inizio":676},{"numero":22,"titolo":"Le biomolecole: i lipidi","pagina_inizio":710},{"numero":23,"titolo":"Le biomolecole: gli acidi nucleici","pagina_inizio":747},{"numero":24,"titolo":"La chimica organica dei percorsi metabolici","pagina_inizio":779}]}]};

        // Variabili globali
        let currentProgramma = null;
        let fileContent = null;
        let postItGenerati = [];
        
        // Variabili MATRIX
        let MATRIX_CONFIG = null;
        let FRAMEWORK_CATALOG = null;
        let MANUAL_CATALOG = null;
        let CURRENT_FRAMEWORK = null;

        // Funzioni MATRIX - Caricamento configurazione
        async function loadMATRIXConfig() {
            try {
                console.log('üîÑ Inizio caricamento MATRIX Config...');
                
                const [config, frameworks, manuals] = await Promise.all([
                    fetch('matrix_config.json').then(r => {
                        console.log('üì• Caricato matrix_config.json');
                        return r.json();
                    }),
                    fetch('framework_catalog.json').then(r => {
                        console.log('üì• Caricato framework_catalog.json');
                        return r.json();
                    }),
                    fetch('manual_catalog.json').then(r => {
                        console.log('üì• Caricato manual_catalog.json');
                        return r.json();
                    })
                ]);
                
                console.log('üì¶ Config ricevuto:', config);
                console.log('üì¶ Frameworks ricevuto:', frameworks);
                console.log('üì¶ Manuals ricevuto:', manuals);
                
                MATRIX_CONFIG = config;
                FRAMEWORK_CATALOG = frameworks;
                MANUAL_CATALOG = manuals;
                
                console.log('‚úÖ Variabili globali assegnate');
                console.log('üîç window.FRAMEWORK_CATALOG dopo assegnazione:', window.FRAMEWORK_CATALOG);
                
                console.log('‚úÖ MATRIX Config caricato:', {
                    subjects: MATRIX_CONFIG?.supported_subjects?.length || 0,
                    frameworks: FRAMEWORK_CATALOG?.total_frameworks || 0,
                    manuals: MANUAL_CATALOG?.total_manuals || 0
                });
                console.log('üìã FRAMEWORK_CATALOG:', FRAMEWORK_CATALOG);
                
                populateMateriaDropdown();
            } catch (error) {
                console.error('‚ùå Errore caricamento MATRIX Config:', error);
                console.error('‚ùå Stack trace:', error.stack);
                alert('Errore caricamento configurazione MATRIX. Ricarica la pagina.');
            }
        }

        // Popola dropdown materie
        function populateMateriaDropdown() {
            const select = document.getElementById('materiaSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">üìö Seleziona materia...</option>';
            
            MATRIX_CONFIG.supported_subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.icon} ${subject.name}`;
                select.appendChild(option);
            });
        }

        // Popola dropdown framework in base alla materia selezionata
        function populateFrameworkDropdown(subject) {
            const select = document.getElementById('frameworkSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona framework...</option>';
            
            subject.frameworks.forEach(frameworkId => {
                const framework = FRAMEWORK_CATALOG.frameworks.find(f => f.id === frameworkId);
                if (framework) {
                    const option = document.createElement('option');
                    option.value = framework.filepath;
                    option.textContent = framework.name;
                    option.dataset.subject = framework.subject;
                    select.appendChild(option);
                }
            });
        }

        // Carica framework JSON e popola form
        async function loadFramework(frameworkPath, frameworkName) {
            try {
                const framework = await fetch(frameworkPath).then(r => r.json());
                CURRENT_FRAMEWORK = framework;
                window.lastFrameworkPath = frameworkPath; // Salva per uso in avviaAnalisi()
                
                console.log('‚úÖ Framework caricato:', frameworkPath);
                
                // Popola contesti dal framework
                populateContestoSelect(framework.content.program_profiles);
                
                // Ottieni il subject dal framework per filtrare i manuali
                const frameworkObj = FRAMEWORK_CATALOG.frameworks.find(f => f.filepath === frameworkPath);
                const frameworkSubject = frameworkObj ? frameworkObj.subject : frameworkName;
                
                console.log('üîç Filtro manuali per subject:', frameworkSubject);
                
                // Popola manuali (principali e alternativi) filtrati per subject
                populateManualeSelect(frameworkSubject);
                populateManualiAlternativi(frameworkSubject);
                
                // Mostra conferma
                const displayName = frameworkPath.split('/').pop().replace('.json', '');
                document.getElementById('frameworkInfo').style.display = 'block';
                document.getElementById('frameworkName').textContent = displayName;
                
                // Aggiorna subtitle header
                const headerSubtitle = document.getElementById('headerSubtitle');
                if (headerSubtitle && frameworkObj) {
                    headerSubtitle.textContent = `${frameworkObj.name} - Analisi Multi-Editore`;
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento framework:', error);
                alert('Errore caricamento framework. Riprova.');
            }
        }

        // Popola dropdown contesti dal framework
        function populateContestoSelect(profiles) {
            const select = document.getElementById('contestoSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona contesto...</option>';
            
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.name;
                option.textContent = profile.name;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ Caricati ${profiles.length} contesti`);
        }

        // Popola dropdown manuali filtrati per subject
        function populateManualeSelect(frameworkSubject) {
            const select = document.getElementById('manualeSelect');
            if (!select || !MANUAL_CATALOG) return;
            
            // Filtra manuali per subject
            const manualsForSubject = Object.values(MANUAL_CATALOG.manuals).filter(m => 
                m.subject === frameworkSubject
            );
            
            // Separa Zanichelli e Competitor
            const zanichelli = manualsForSubject.filter(m => m.type === 'zanichelli');
            const competitor = manualsForSubject.filter(m => m.type === 'competitor');
            
            select.innerHTML = '<option value="">Seleziona manuale principale...</option>';
            
            // Optgroup Zanichelli
            if (zanichelli.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìó Manuali Zanichelli';
                zanichelli.forEach(manual => {
                    const option = document.createElement('option');
                    option.value = manual.id;
                    // Mostra: Autore - Titolo (Editore)
                    option.textContent = manual.author 
                        ? `${manual.author} - ${manual.title}` 
                        : `${manual.title} (${manual.publisher})`;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Optgroup Altri Editori
            if (competitor.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'üìï Altri Editori';
                competitor.forEach(manual => {
                    const option = document.createElement('option');
                    option.value = manual.id;
                    // Mostra: Autore - Titolo (Editore)
                    option.textContent = manual.author 
                        ? `${manual.author} - ${manual.title} (${manual.publisher})` 
                        : `${manual.title} (${manual.publisher})`;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            // Opzione "Altro"
            const optionAltro = document.createElement('option');
            optionAltro.value = 'Altro';
            optionAltro.textContent = 'Altro manuale (specificare sotto)';
            select.appendChild(optionAltro);
            
            console.log(`‚úÖ Caricati ${manualsForSubject.length} manuali (${zanichelli.length} Zanichelli, ${competitor.length} Competitor)`);
        }

        // Popola checkbox manuali alternativi filtrati per subject
        function populateManualiAlternativi(frameworkSubject) {
            // Trova i container dei manuali alternativi
            const zanichellContainer = document.querySelector('.space-y-2.bg-gray-50 > div:first-child');
            const competitorContainer = document.querySelector('.space-y-2.bg-gray-50 > div:nth-child(2)');
            
            if (!zanichellContainer || !competitorContainer || !MANUAL_CATALOG) return;
            
            // Filtra manuali per subject
            const manualsForSubject = Object.values(MANUAL_CATALOG.manuals).filter(m => 
                m.subject === frameworkSubject
            );
            
            // Separa Zanichelli e Competitor
            const zanichelli = manualsForSubject.filter(m => m.type === 'zanichelli');
            const competitor = manualsForSubject.filter(m => m.type === 'competitor');
            
            // Popola Zanichelli
            const zanichellHTML = zanichelli.map(manual => `
                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                    <input type="checkbox" id="alt${manual.id}" value="${manual.id}" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="text-sm text-gray-700">${manual.author ? `${manual.author} - ${manual.title}` : manual.title}</span>
                </label>
            `).join('');
            
            // Popola Competitor
            const competitorHTML = competitor.map(manual => `
                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                    <input type="checkbox" id="alt${manual.id}" value="${manual.id}" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="text-sm text-gray-700">${manual.author ? `${manual.author} - ${manual.title} (${manual.publisher})` : `${manual.title} (${manual.publisher})`}</span>
                </label>
            `).join('');
            
            // Aggiorna i container (mantiene il titolo "Zanichelli" / "Altri Editori")
            const zanichellTitle = zanichellContainer.querySelector('.text-xs.font-semibold');
            if (zanichellTitle) {
                zanichellContainer.innerHTML = '';
                zanichellContainer.appendChild(zanichellTitle);
                zanichellContainer.insertAdjacentHTML('beforeend', zanichellHTML);
            }
            
            const competitorTitle = competitorContainer.querySelector('.text-xs.font-semibold');
            if (competitorTitle) {
                competitorContainer.innerHTML = '';
                competitorContainer.appendChild(competitorTitle);
                competitorContainer.insertAdjacentHTML('beforeend', competitorHTML);
            }
            
            console.log(`‚úÖ Popolati ${zanichelli.length} manuali alternativi Zanichelli, ${competitor.length} Competitor`);
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async function() {
            // Carica configurazione MATRIX e ASPETTA che finisca
            await loadMATRIXConfig();
            
            // Event listener cambio materia
            const materiaSelect = document.getElementById('materiaSelect');
            if (materiaSelect) {
                materiaSelect.addEventListener('change', function() {
                    const materiaId = this.value;
                    const frameworkContainer = document.getElementById('frameworkContainer');
                    const frameworkInfo = document.getElementById('frameworkInfo');
                    
                    if (!materiaId) {
                        frameworkContainer.style.display = 'none';
                        frameworkInfo.style.display = 'none';
                        return;
                    }
                    
                    const subject = MATRIX_CONFIG.supported_subjects.find(s => s.id === materiaId);
                    if (subject) {
                        populateFrameworkDropdown(subject);
                        frameworkContainer.style.display = 'block';
                        frameworkInfo.style.display = 'none';
                    }
                });
            }
            
            // Event listener cambio framework
            const frameworkSelect = document.getElementById('frameworkSelect');
            if (frameworkSelect) {
                frameworkSelect.addEventListener('change', function() {
                    const frameworkPath = this.value;
                    if (!frameworkPath) return;
                    
                    const selectedOption = this.options[this.selectedIndex];
                    const frameworkName = selectedOption.textContent; // Nome completo del framework
                    
                    loadFramework(frameworkPath, frameworkName);
                });
            }
            checkApiKey();
            showView('upload');
            
            // Listener per mostrare/nascondere campo "Altro manuale"
            const manualeSelect = document.getElementById('manualeSelect');
            const altroManualeField = document.getElementById('altroManualeField');
            
            if (manualeSelect && altroManualeField) {
                manualeSelect.addEventListener('change', function() {
                    if (this.value === 'Altro') {
                        altroManualeField.style.display = 'block';
                    } else {
                        altroManualeField.style.display = 'none';
                    }
                });
            }
        });

        // Gestione Configurazione
        function checkApiKey() {
            const providerKey = localStorage.getItem('ai_provider') || 'openai';
            const provider = LLM_PROVIDERS[providerKey];
            const apiKey = localStorage.getItem(`${providerKey}_api_key`);
            const badge = document.getElementById('apiKeyBadge');
            
            if (!provider) {
                badge.textContent = '‚ö† Provider non valido';
                badge.className = 'px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full';
                badge.classList.remove('hidden');
                return;
            }
            
            // OpenAI su Netlify pu√≤ funzionare senza chiave (usa chiave default server-side)
            const isNetlify = window.location.hostname.includes('netlify.app');
            const hasKey = apiKey || (providerKey === 'openai' && isNetlify);
            
            if (hasKey) {
                const isUsingDefault = providerKey === 'openai' && !apiKey && isNetlify;
                if (isUsingDefault) {
                    badge.textContent = `‚úì ${provider.name} (Test)`;
                    badge.className = 'px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full';
                } else {
                    badge.textContent = `‚úì ${provider.name}`;
                    badge.className = 'px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full';
                }
                badge.classList.remove('hidden');
            } else {
                document.getElementById('welcomeBanner')?.classList.remove('hidden');
                badge.textContent = '‚ö† API Non Configurata';
                badge.className = 'px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full';
                badge.classList.remove('hidden');
            }
        }

        // Selezione Provider
        function selectProvider(providerKey) {
            localStorage.setItem('ai_provider', providerKey);
            
            // Aggiorna UI bottoni
            const allButtons = document.querySelectorAll('.provider-btn');
            allButtons.forEach(btn => {
                btn.className = 'provider-btn px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50 text-sm';
            });
            
            const selectedBtn = document.getElementById(`btnProvider${providerKey.charAt(0).toUpperCase() + providerKey.slice(1).replace(/([A-Z])/g, (match) => match)}`);
            if (selectedBtn) {
                selectedBtn.className = 'provider-btn px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100 text-sm';
            }
            
            // Carica configurazione dinamica
            const provider = LLM_PROVIDERS[providerKey];
            if (!provider) {
                console.error('Provider non trovato:', providerKey);
                return;
            }
            
            const configDiv = document.getElementById('providerConfig');
            const savedApiKey = localStorage.getItem(`${providerKey}_api_key`) || '';
            const savedModel = localStorage.getItem(`${providerKey}_model`) || provider.models[0].id;
            
            // Genera HTML configurazione
            let modelsHTML = '';
            provider.models.forEach(model => {
                const costInfo = `$${model.input}/$${model.output} per M token`;
                const badge = model.tier === 'economico' ? 'üí∞' : model.tier === 'medio' ? '‚öñÔ∏è' : '‚≠ê';
                modelsHTML += `<option value="${model.id}" ${model.id === savedModel ? 'selected' : ''}>${badge} ${model.name} - ${costInfo}</option>`;
            });
            
            configDiv.innerHTML = `
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Configurazione ${provider.name}</h3>
                <p class="text-xs text-gray-600 mb-4">${provider.description}</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chiave API ${provider.name}</label>
                        <input type="password" id="providerApiKey" placeholder="${provider.apiKeyPrefix ? provider.apiKeyPrefix + 'xxxxxxxxxxxxx' : 'Inserisci chiave API'}" 
                               value="${savedApiKey}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">
                            La chiave viene salvata solo nel tuo browser. 
                            <a href="${provider.apiKeyUrl}" target="_blank" class="text-indigo-600 hover:underline">Ottieni chiave ‚Üí</a>
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modello</label>
                        <select id="providerModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            ${modelsHTML}
                        </select>
                        <div id="modelInfo" class="mt-2 p-2 bg-blue-50 rounded text-xs text-blue-800">
                            <!-- Popolato da updateModelInfo() -->
                        </div>
                    </div>
                </div>
            `;
            
            // Update model info on change
            document.getElementById('providerModel').addEventListener('change', () => updateModelInfo(providerKey));
            updateModelInfo(providerKey);
        }
        
        function updateModelInfo(providerKey) {
            const provider = LLM_PROVIDERS[providerKey];
            const selectedModelId = document.getElementById('providerModel').value;
            const model = provider.models.find(m => m.id === selectedModelId);
            
            if (model) {
                const infoDiv = document.getElementById('modelInfo');
                infoDiv.innerHTML = `
                    <strong>${model.name}</strong>: ${model.description}<br>
                    üìä Costo: $${model.input} input / $${model.output} output per M token<br>
                    üìù Contesto: ${model.context} | Fascia: ${model.tier}
                `;
            }
        }

        function saveConfiguration() {
            const providerKey = localStorage.getItem('ai_provider') || 'openai';
            const provider = LLM_PROVIDERS[providerKey];
            
            if (!provider) {
                showConfigStatus('Provider non valido', 'error');
                return;
            }
            
            const apiKey = document.getElementById('providerApiKey').value.trim();
            const model = document.getElementById('providerModel').value;
            
            if (!apiKey) {
                showConfigStatus(`Inserisci una chiave API ${provider.name} valida`, 'error');
                return;
            }
            
            // Validazione prefix (se presente)
            if (provider.apiKeyPrefix && !apiKey.startsWith(provider.apiKeyPrefix)) {
                showConfigStatus(`La chiave API ${provider.name} deve iniziare con "${provider.apiKeyPrefix}"`, 'error');
                return;
            }
            
            localStorage.setItem(`${providerKey}_api_key`, apiKey);
            localStorage.setItem(`${providerKey}_model`, model);
            
            const modelObj = provider.models.find(m => m.id === model);
            showConfigStatus(`‚úÖ Configurazione ${provider.name} salvata! Modello: ${modelObj.name}`, 'success');
            
            checkApiKey();
            
            setTimeout(() => {
                showView('upload');
            }, 1500);
        }

        function showConfigStatus(message, type) {
            const status = document.getElementById('configStatus');
            status.textContent = message;
            status.className = `p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            status.classList.remove('hidden');
        }
        
        // Carica configurazione salvata all'apertura settings
        function loadSavedConfiguration() {
            const providerKey = localStorage.getItem('ai_provider') || 'openai';
            selectProvider(providerKey);
        }

        // Gestione tipo analisi (cambio stile radio buttons)
        document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('input[name="tipoAnalisi"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Rimuovi stile selezionato da tutti
                    document.querySelectorAll('input[name="tipoAnalisi"]').forEach(r => {
                        const label = r.closest('label');
                        label.classList.remove('border-indigo-600', 'bg-indigo-50');
                        label.classList.add('border-gray-300');
                    });
                    // Aggiungi stile selezionato
                    if (this.checked) {
                        const label = this.closest('label');
                        label.classList.remove('border-gray-300');
                        label.classList.add('border-indigo-600', 'bg-indigo-50');
                    }
                });
            });
        });

        // Gestione views
        function showView(viewName) {
            const views = ['viewSettings', 'viewUpload', 'viewRisultati', 'viewStorico'];
            const buttons = ['btnSettings', 'btnUpload', 'btnStorico'];
            
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            
            buttons.forEach(btn => {
                const button = document.getElementById(btn);
                if (button) {
                    button.classList.remove('bg-indigo-600', 'text-white');
                    button.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                }
            });
            
            document.getElementById('view' + viewName.charAt(0).toUpperCase() + viewName.slice(1)).classList.remove('hidden');
            
            if (viewName === 'storico') {
                loadStorico();
            } else if (viewName === 'settings') {
                loadSavedConfiguration();
            }
            
            const activeBtn = document.getElementById('btn' + viewName.charAt(0).toUpperCase() + viewName.slice(1));
            if (activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                activeBtn.classList.add('bg-indigo-600', 'text-white');
            }
        }
        
        // Tab switching function (for tabs inside viewUpload)
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('border-indigo-500', 'text-indigo-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            const selectedContent = document.getElementById('tabContent' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }
            
            // Activate selected tab button
            const selectedButton = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedButton) {
                selectedButton.classList.remove('border-transparent', 'text-gray-500');
                selectedButton.classList.add('border-indigo-500', 'text-indigo-600');
            }
            
            // Se √® il tab Cataloghi, carica i manuali
            if (tabName === 'cataloghi') {
                loadManualiList();
            }
            
            // Se √® il tab Valutazione, inizializza
            if (tabName === 'valutazione') {
                evalAbs_initTab();
            }
        }
        
        // ============================================
        // GESTIONE CATALOGHI - SUB TABS
        // ============================================
        
        function switchCatalogTab(tabName) {
            // Hide all catalog tab contents
            const catalogTabs = document.querySelectorAll('.catalog-tab-content');
            catalogTabs.forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all catalog tab buttons
            const catalogButtons = document.querySelectorAll('.catalog-tab-btn');
            catalogButtons.forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600', 'active');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected catalog tab
            const selectedTab = document.getElementById('catalogTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            }
            
            // Activate selected button
            const selectedBtn = document.getElementById('btnTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (selectedBtn) {
                selectedBtn.classList.remove('border-transparent', 'text-gray-500');
                selectedBtn.classList.add('border-indigo-500', 'text-indigo-600', 'active');
            }
            
            // Load data for the selected tab
            if (tabName === 'manuali') {
                loadManualiList();
            } else if (tabName === 'framework') {
                loadFrameworkList();
            }
        }
        
        // ============================================
        // CRUD MANUALI - VARIABILI GLOBALI
        // ============================================
        
        let currentManualeData = null; // JSON caricato dall'utente
        let editingManualeId = null; // ID del manuale in modifica (null = nuovo)
        
        // Helper function: converte MANUAL_CATALOG.manuals (array) in oggetto {id: manual}
        function getManualsAsObject() {
            if (!MANUAL_CATALOG || !MANUAL_CATALOG.manuals) {
                console.error('‚ùå MANUAL_CATALOG non disponibile');
                return {};
            }
            
            const manuals = {};
            MANUAL_CATALOG.manuals.forEach(manual => {
                if (manual.id) {
                    manuals[manual.id] = manual;
                }
            });
            return manuals;
        }
        
        // Mapping subject legacy ‚Üí macroarea/materia
        const SUBJECT_TO_MACROAREA_MATERIA = {
            'Chimica Generale': { macroarea: 'Chimica', materia: 'Chimica Generale' },
            'Chimica Organica': { macroarea: 'Chimica', materia: 'Chimica Organica' },
            'Chimica': { macroarea: 'Chimica', materia: 'Chimica Generale' },
            'Fisica': { macroarea: 'Fisica', materia: 'Fisica Generale' },
            'Matematica': { macroarea: 'Matematica', materia: 'Matematica Generale' },
            'Economia': { macroarea: 'Economia', materia: 'Economia Politica' },
            'Biologia': { macroarea: 'Biologia', materia: 'Biologia Generale' },
            'Istologia': { macroarea: 'Istologia', materia: 'Istologia ed Embriologia' }
        };
        
        // ============================================
        // CRUD MANUALI - REGISTRY MATERIE
        // ============================================
        
        function getMaterieRegistry() {
            return JSON.parse(localStorage.getItem('materie_registry') || '{}');
        }
        
        function saveMaterieRegistry(registry) {
            localStorage.setItem('materie_registry', JSON.stringify(registry));
        }
        
        function addMateriaToRegistry(macroarea, materia) {
            const registry = getMaterieRegistry();
            if (!registry[macroarea]) {
                registry[macroarea] = [];
            }
            if (!registry[macroarea].includes(materia)) {
                registry[macroarea].push(materia);
                registry[macroarea].sort();
                saveMaterieRegistry(registry);
            }
        }
        
        function getMaterieForMacroarea(macroarea) {
            const registry = getMaterieRegistry();
            return registry[macroarea] || [];
        }
        
        function mapSubjectToMacroareaMateria(subject) {
            // Prima controlla mapping predefinito
            if (SUBJECT_TO_MACROAREA_MATERIA[subject]) {
                return SUBJECT_TO_MACROAREA_MATERIA[subject];
            }
            
            // Prova a dedurre da registry
            const registry = getMaterieRegistry();
            for (const [macroarea, materie] of Object.entries(registry)) {
                if (materie.includes(subject)) {
                    return { macroarea, materia: subject };
                }
            }
            
            // Fallback: usa subject come entrambi
            return { macroarea: subject, materia: subject };
        }
        
        function updateMaterieAutocomplete() {
            const macroarea = document.getElementById('manualeMacroarea').value;
            const datalist = document.getElementById('materieDatalist');
            
            if (!datalist) return;
            
            const materie = getMaterieForMacroarea(macroarea);
            datalist.innerHTML = materie.map(m => `<option value="${m}">`).join('');
        }
        
        function filterMaterieDatalist() {
            // Placeholder per futuri miglioramenti (filtro dinamico)
        }
        
        // ============================================
        // CRUD MANUALI - CARICAMENTO LISTA
        // ============================================
        
        async function loadManualiList() {
            console.log('üìö Caricamento lista manuali...');
            
            try {
                // Carica manuali originali dal catalog
                if (!MANUAL_CATALOG || !MANUAL_CATALOG.manuals) {
                    console.error('‚ùå MANUAL_CATALOG non caricato o vuoto');
                    alert('Errore: il catalogo manuali non √® stato caricato. Ricarica la pagina.');
                    return;
                }
                
                // CONVERTI ARRAY IN OGGETTO (manuals √® un array!)
                const originalManuals = {};
                MANUAL_CATALOG.manuals.forEach(manual => {
                    if (manual.id) {
                        originalManuals[manual.id] = manual;
                    }
                });
                
                console.log(`üì¶ Manuali originali caricati: ${Object.keys(originalManuals).length}`);
                
                // Carica manuali custom da localStorage
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                console.log(`üÜï Manuali custom: ${Object.keys(customManuals).length}`);
                
                // Carica modifiche da localStorage
                const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                console.log(`‚úèÔ∏è Manuali modificati: ${Object.keys(modifiedManuals).length}`);
                
                // Merge: modifiche sovrascrivono originali, custom si aggiungono
                const allManuals = {
                    ...originalManuals,
                    ...modifiedManuals,
                    ...customManuals
                };
                
                console.log(`‚úÖ Totale manuali caricati: ${Object.keys(allManuals).length}`);
                
                // Popola registry materie da manuali esistenti
                populateRegistryFromManuals(allManuals);
                
                // Popola la tabella
                displayManualiTable(allManuals, customManuals, modifiedManuals);
                
            } catch (error) {
                console.error('‚ùå Errore caricamento manuali:', error);
                alert('Errore nel caricamento dei manuali: ' + error.message);
            }
        }
        
        function populateRegistryFromManuals(manuals) {
            console.log('üîÑ Popolamento registry materie da manuali esistenti...');
            
            let processedCount = 0;
            Object.values(manuals).forEach(manuale => {
                try {
                    // Se ha gi√† macroarea/materia, aggiungili
                    if (manuale.macroarea && manuale.materia) {
                        addMateriaToRegistry(manuale.macroarea, manuale.materia);
                        processedCount++;
                    } 
                    // Altrimenti mappa da subject legacy
                    else if (manuale.subject) {
                        const mapped = mapSubjectToMacroareaMateria(manuale.subject);
                        addMateriaToRegistry(mapped.macroarea, mapped.materia);
                        processedCount++;
                    }
                } catch (error) {
                    console.error('‚ùå Errore popolamento registry per', manuale.id, error);
                }
            });
            
            const registry = getMaterieRegistry();
            console.log(`‚úÖ Registry popolato con ${processedCount} manuali processati:`, registry);
            console.log(`üìä Materie per macroarea:`, Object.keys(registry).map(m => `${m} (${registry[m].length})`).join(', '));
        }
        
        function displayManualiTable(allManuals, customManuals, modifiedManuals) {
            console.log('üìä Rendering tabella manuali...');
            
            const tbody = document.getElementById('manualiTableBody');
            if (!tbody) {
                console.error('‚ùå Elemento manualiTableBody non trovato!');
                return;
            }
            
            // Reset filtri su "Tutte" di default
            const filterMacroarea = document.getElementById('filterMacroarea');
            const filterMateria = document.getElementById('filterMateria');
            const filterEditore = document.getElementById('filterEditore');
            const filterTipo = document.getElementById('filterTipo');
            const searchInput = document.getElementById('searchManuali');
            
            if (filterMacroarea) filterMacroarea.value = '';
            if (filterMateria) filterMateria.value = '';
            if (filterEditore) filterEditore.value = '';
            if (filterTipo) filterTipo.value = '';
            if (searchInput) searchInput.value = '';
            
            console.log('üîÑ Filtri resettati su "Tutte"');
            
            tbody.innerHTML = '';
            
            const manualiArray = Object.values(allManuals);
            console.log(`üìã Manuali da visualizzare: ${manualiArray.length}`);
            
            // Raccogli tutte le materie uniche per il filtro
            const materieSet = new Set();
            
            // Sort per macroarea, materia e titolo
            manualiArray.sort((a, b) => {
                try {
                    // Gestisci legacy: se esiste subject ma non macroarea, mappa
                    if (!a.macroarea && a.subject) {
                        const mapped = mapSubjectToMacroareaMateria(a.subject);
                        a.macroarea = mapped.macroarea;
                        a.materia = mapped.materia;
                        console.log(`üîÑ Mapped ${a.id}: ${a.subject} ‚Üí ${a.macroarea} / ${a.materia}`);
                    }
                    if (!b.macroarea && b.subject) {
                        const mapped = mapSubjectToMacroareaMateria(b.subject);
                        b.macroarea = mapped.macroarea;
                        b.materia = mapped.materia;
                        console.log(`üîÑ Mapped ${b.id}: ${b.subject} ‚Üí ${b.macroarea} / ${b.materia}`);
                    }
                    
                    const macroareaA = a.macroarea || '';
                    const macroareaB = b.macroarea || '';
                    const materiaA = a.materia || '';
                    const materiaB = b.materia || '';
                    const titleA = a.title || '';
                    const titleB = b.title || '';
                    
                    if (macroareaA !== macroareaB) return macroareaA.localeCompare(macroareaB);
                    if (materiaA !== materiaB) return materiaA.localeCompare(materiaB);
                    return titleA.localeCompare(titleB);
                } catch (error) {
                    console.error('‚ùå Errore nel sort:', error, 'A:', a.id, 'B:', b.id);
                    return 0; // Fallback: mantieni ordine originale
                }
            });
            
            console.log(`üìã Dopo sort: ${manualiArray.length} manuali`);
            console.log(`üìù Primi 3 manuali:`, manualiArray.slice(0, 3).map(m => ({ id: m.id, macroarea: m.macroarea, materia: m.materia })));
            
            manualiArray.forEach(manuale => {
                try {
                    // Gestisci legacy mapping
                    if (!manuale.macroarea && manuale.subject) {
                        const mapped = mapSubjectToMacroareaMateria(manuale.subject);
                        manuale.macroarea = mapped.macroarea;
                        manuale.materia = mapped.materia;
                    }
                    
                    // Aggiungi materia al set per filtro
                    if (manuale.materia) materieSet.add(manuale.materia);
                    
                    const isCustom = customManuals[manuale.id];
                    const isModified = modifiedManuals[manuale.id];
                    
                    const badge = isCustom ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">üîµ Custom</span>' :
                                  isModified ? '<span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded">üü° Modificato</span>' :
                                  '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">üü¢ Originale</span>';
                    
                    const tipoBadge = manuale.type === 'zanichelli' ? 
                        '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Zanichelli</span>' :
                        '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">Competitor</span>';
                    
                    const row = document.createElement('tr');
                    row.className = 'manuale-row hover:bg-gray-50';
                    row.dataset.id = manuale.id || '';
                    row.dataset.macroarea = manuale.macroarea || '';
                    row.dataset.materia = manuale.materia || '';
                    row.dataset.publisher = manuale.publisher || '';
                    row.dataset.type = manuale.type || '';
                    row.dataset.title = manuale.title || '';
                    row.dataset.author = manuale.author || '';
                    
                    row.innerHTML = `
                        <td class="px-1 py-1 text-xs text-gray-500 w-20 break-words">${manuale.id || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs w-28">
                            <div class="font-medium text-gray-900 break-words">${manuale.title || '‚Äî'}</div>
                            <div class="text-xs text-gray-500">${badge}</div>
                        </td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-20 break-words">${manuale.author || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-16 break-words">${manuale.publisher || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-16 break-words">${manuale.macroarea || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-24 break-words">${manuale.materia || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-500 w-10 text-center">${manuale.chapters_count || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs w-16">${tipoBadge}</td>
                        <td class="px-1 py-1 text-sm font-medium w-14 whitespace-nowrap">
                            <button onclick="editManuale('${manuale.id}')" class="text-indigo-600 hover:text-indigo-900" title="Modifica">‚úèÔ∏è</button>
                            <button onclick="deleteManuale('${manuale.id}')" class="text-red-600 hover:text-red-900" title="Elimina">üóëÔ∏è</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                } catch (error) {
                    console.error('‚ùå Errore rendering manuale:', manuale.id, error);
                }
            });
            
            // Popola filtro materie dinamicamente
            populateFilterMaterie([...materieSet].sort());
            
            console.log(`‚úÖ Tabella popolata con ${tbody.children.length} righe`);
            
            // Se la tabella √® vuota, mostra un messaggio
            if (tbody.children.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                        <div class="text-lg mb-2">üì≠ Nessun manuale trovato</div>
                        <div class="text-sm">Prova a modificare i filtri o ad aggiungere un nuovo manuale</div>
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
            
            // Aggiorna contatore
            const countEl = document.getElementById('manualiCount');
            if (countEl) {
                const customCount = Object.keys(customManuals).length;
                const modifiedCount = Object.keys(modifiedManuals).length;
                const originalCount = manualiArray.length - customCount - modifiedCount;
                
                countEl.innerHTML = `
                    üìö <strong>${manualiArray.length}</strong> manuali totali
                    <span class="text-gray-400">‚Ä¢</span>
                    <span class="text-green-600">${originalCount} originali</span>
                    <span class="text-gray-400">‚Ä¢</span>
                    <span class="text-yellow-600">${modifiedCount} modificati</span>
                    <span class="text-gray-400">‚Ä¢</span>
                    <span class="text-blue-600">${customCount} custom</span>
                `;
            }
        }
        
        function populateFilterMaterie(materie) {
            const filterSelect = document.getElementById('filterMateria');
            if (!filterSelect) return;
            
            const currentValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">üìö Tutte le materie</option>';
            
            materie.forEach(materia => {
                const option = document.createElement('option');
                option.value = materia;
                option.textContent = materia;
                filterSelect.appendChild(option);
            });
            
            // Ripristina valore selezionato
            if (currentValue && materie.includes(currentValue)) {
                filterSelect.value = currentValue;
            }
        }
        
        // ============================================
        // CRUD MANUALI - FILTRI
        // ============================================
        
        function filterManuali() {
            const searchTerm = document.getElementById('searchManuali').value.toLowerCase();
            const filterMacroarea = document.getElementById('filterMacroarea').value;
            const filterMateria = document.getElementById('filterMateria').value;
            const filterEditore = document.getElementById('filterEditore').value;
            const filterTipo = document.getElementById('filterTipo').value;
            
            const rows = document.querySelectorAll('.manuale-row');
            
            rows.forEach(row => {
                const title = row.dataset.title.toLowerCase();
                const author = row.dataset.author.toLowerCase();
                const macroarea = row.dataset.macroarea;
                const materia = row.dataset.materia;
                const publisher = row.dataset.publisher;
                const type = row.dataset.type;
                
                const matchSearch = title.includes(searchTerm) || author.includes(searchTerm);
                const matchMacroarea = !filterMacroarea || macroarea === filterMacroarea;
                const matchMateria = !filterMateria || materia === filterMateria;
                const matchEditore = !filterEditore || publisher === filterEditore;
                const matchTipo = !filterTipo || type === filterTipo;
                
                if (matchSearch && matchMacroarea && matchMateria && matchEditore && matchTipo) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // ============================================
        // CRUD MANUALI - MODAL AGGIUNGI/MODIFICA
        // ============================================
        
        function openAddManualeModal() {
            editingManualeId = null;
            currentManualeData = null;
            
            document.getElementById('manualeModalTitle').textContent = '‚ûï Nuovo Manuale';
            document.getElementById('manualeId').value = '';
            document.getElementById('manualeId').disabled = false;
            document.getElementById('manualeMacroarea').value = '';
            document.getElementById('manualeMateria').value = '';
            document.getElementById('manualeTipo').value = '';
            document.getElementById('manualeJsonFile').value = '';
            
            // Mostra STEP 2 (upload JSON) per nuovi manuali
            const step2Upload = document.querySelector('#manualeModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.remove('hidden');
            }
            
            document.getElementById('materieDatalist').innerHTML = '';
            document.getElementById('jsonFileInfo').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('jsonEditorSection').classList.add('hidden'); // Nascondi editor per nuovi
            document.getElementById('validationErrors').classList.add('hidden');
            
            document.getElementById('manualeModal').classList.remove('hidden');
        }
        
        function editManuale(manualeId) {
            console.log('‚úèÔ∏è Modifica manuale:', manualeId);
            
            // Carica dati del manuale
            const originalManuals = getManualsAsObject();
            const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
            const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
            const allManuals = { ...originalManuals, ...modifiedManuals, ...customManuals };
            
            console.log(`üîç Cercando manuale con ID: "${manualeId}"`);
            console.log(`üìä Totale manuali disponibili: ${Object.keys(allManuals).length}`);
            
            const manuale = allManuals[manualeId];
            if (!manuale) {
                console.error(`‚ùå Manuale "${manualeId}" non trovato in:`, Object.keys(allManuals).slice(0, 10));
                alert(`Manuale "${manualeId}" non trovato nel catalogo`);
                return;
            }
            
            console.log('‚úÖ Manuale trovato:', manuale);
            
            editingManualeId = manualeId;
            
            // Gestisci legacy: se esiste subject ma non macroarea, mappa
            if (!manuale.macroarea && manuale.subject) {
                const mapped = mapSubjectToMacroareaMateria(manuale.subject);
                manuale.macroarea = mapped.macroarea;
                manuale.materia = mapped.materia;
            }
            
            // Imposta titolo modal
            document.getElementById('manualeModalTitle').textContent = '‚úèÔ∏è Modifica Manuale';
            
            // STEP 1: Popola identificativi
            document.getElementById('manualeId').value = manuale.id || '';
            document.getElementById('manualeId').disabled = true; // ID non modificabile
            document.getElementById('manualeMacroarea').value = manuale.macroarea || '';
            document.getElementById('manualeMateria').value = manuale.materia || '';
            document.getElementById('manualeTipo').value = manuale.type || '';
            
            // Aggiorna autocomplete per la macroarea selezionata
            updateMaterieAutocomplete();
            
            // STEP 2: Nascondi upload JSON e mostra preview dati esistenti
            const step2Upload = document.querySelector('#manualeModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.add('hidden');
            }
            
            // Carica JSON completo se disponibile
            if (customManuals[manualeId]) {
                // Manuale custom: carica da localStorage
                currentManualeData = customManuals[manualeId];
                showPreview(currentManualeData);
                showJsonEditor(currentManualeData);
            } else if (manuale.filepath) {
                // Manuale originale: carica da file
                fetch(manuale.filepath)
                    .then(r => r.json())
                    .then(data => {
                        currentManualeData = data;
                        showPreview(currentManualeData);
                        showJsonEditor(currentManualeData);
                    })
                    .catch(err => {
                        console.error('‚ùå Errore caricamento JSON:', err);
                        // Mostra preview con dati base
                        showPreview(manuale);
                    });
            } else {
                // Nessun JSON disponibile, mostra dati base
                showPreview(manuale);
            }
            
            document.getElementById('validationErrors').classList.add('hidden');
            document.getElementById('manualeModal').classList.remove('hidden');
        }
        
        function closeManualeModal() {
            document.getElementById('manualeModal').classList.add('hidden');
            editingManualeId = null;
            currentManualeData = null;
        }
        
        // ============================================
        // CRUD MANUALI - UPLOAD E VALIDAZIONE JSON
        // ============================================
        
        async function handleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üìÅ Caricamento file JSON:', file.name);
            
            // Mostra info file
            document.getElementById('jsonFileName').textContent = file.name;
            document.getElementById('jsonFileSize').textContent = `${(file.size / 1024).toFixed(2)} KB`;
            document.getElementById('jsonFileInfo').classList.remove('hidden');
            
            try {
                const text = await file.text();
                const json = JSON.parse(text);
                
                console.log('‚úÖ JSON parsato con successo');
                
                // Valida struttura
                const errors = validateManualeJson(json);
                
                if (errors.length > 0) {
                    showValidationErrors(errors);
                    currentManualeData = null;
                    document.getElementById('previewSection').classList.add('hidden');
                    return;
                }
                
                // JSON valido
                currentManualeData = json;
                document.getElementById('validationErrors').classList.add('hidden');
                showPreview(json);
                
            } catch (error) {
                console.error('‚ùå Errore parsing JSON:', error);
                showValidationErrors(['Errore nel parsing del file JSON: ' + error.message]);
                currentManualeData = null;
            }
        }
        
        function validateManualeJson(json) {
            const errors = [];
            
            if (!json.id || typeof json.id !== 'string') {
                errors.push('Campo "id" obbligatorio (stringa)');
            }
            
            if (!json.title || typeof json.title !== 'string') {
                errors.push('Campo "title" obbligatorio (stringa)');
            }
            
            if (!json.author || typeof json.author !== 'string') {
                errors.push('Campo "author" obbligatorio (stringa)');
            }
            
            if (!json.chapters || !Array.isArray(json.chapters)) {
                errors.push('Campo "chapters" obbligatorio (array)');
            } else if (json.chapters.length === 0) {
                errors.push('Il manuale deve avere almeno un capitolo');
            }
            
            return errors;
        }
        
        function showValidationErrors(errors) {
            const errorList = document.getElementById('errorList');
            errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
            document.getElementById('validationErrors').classList.remove('hidden');
        }
        
        function showPreview(json) {
            document.getElementById('previewTitle').textContent = json.title || '‚Äî';
            document.getElementById('previewAuthor').textContent = json.author || '‚Äî';
            document.getElementById('previewPublisher').textContent = json.publisher || '‚Äî';
            document.getElementById('previewChapters').textContent = json.chapters ? json.chapters.length : '‚Äî';
            document.getElementById('previewPages').textContent = json.pages || '‚Äî';
            document.getElementById('previewPrice').textContent = json.price ? `‚Ç¨${json.price}` : '‚Äî';
            
            document.getElementById('previewSection').classList.remove('hidden');
        }
        
        function showJsonEditor(json) {
            const editor = document.getElementById('jsonEditor');
            if (editor) {
                editor.value = JSON.stringify(json, null, 2);
                document.getElementById('jsonEditorSection').classList.remove('hidden');
            }
        }
        
        // ============================================
        // CRUD MANUALI - SALVATAGGIO
        // ============================================
        
        async function saveManualeData() {
            console.log('üíæ Salvataggio manuale...');
            
            // Valida form
            const id = document.getElementById('manualeId').value.trim();
            const macroarea = document.getElementById('manualeMacroarea').value;
            const materia = document.getElementById('manualeMateria').value.trim();
            const tipo = document.getElementById('manualeTipo').value;
            
            const errors = [];
            
            if (!id) {
                errors.push('ID manuale obbligatorio');
            } else if (!/^[a-zA-Z0-9_]+$/.test(id)) {
                errors.push('ID deve contenere solo lettere, numeri e underscore');
            }
            
            if (!macroarea) {
                errors.push('Macroarea obbligatoria');
            }
            
            if (!materia) {
                errors.push('Materia obbligatoria');
            }
            
            if (!tipo) {
                errors.push('Tipo obbligatorio');
            }
            
            if (!currentManualeData && !editingManualeId) {
                errors.push('File JSON obbligatorio per nuovi manuali');
            }
            
            // Controllo duplicati (solo per nuovi)
            if (!editingManualeId) {
                const originalManuals = getManualsAsObject();
                const allManuals = { 
                    ...originalManuals, 
                    ...JSON.parse(localStorage.getItem('custom_manuals') || '{}'),
                    ...JSON.parse(localStorage.getItem('modified_manuals') || '{}')
                };
                
                if (allManuals[id]) {
                    errors.push('ID gi√† esistente. Scegli un ID diverso.');
                }
            }
            
            if (errors.length > 0) {
                showValidationErrors(errors);
                return;
            }
            
            // Aggiungi materia al registry per autocomplete futuro
            addMateriaToRegistry(macroarea, materia);
            
            // Prepara dati da salvare
            let manualeToSave;
            
            // Se l'editor JSON √® visibile, leggi da l√¨
            const jsonEditorSection = document.getElementById('jsonEditorSection');
            if (jsonEditorSection && !jsonEditorSection.classList.contains('hidden')) {
                const jsonEditorContent = document.getElementById('jsonEditor').value;
                try {
                    const parsedJson = JSON.parse(jsonEditorContent);
                    manualeToSave = {
                        ...parsedJson,
                        id: id,
                        macroarea: macroarea,
                        materia: materia,
                        subject: materia,
                        type: tipo
                    };
                    console.log('‚úÖ JSON letto dall\'editor');
                } catch (e) {
                    errors.push('JSON non valido nell\'editor: ' + e.message);
                    showValidationErrors(errors);
                    return;
                }
            } else if (currentManualeData) {
                // Nuovo manuale o sostituzione JSON
                manualeToSave = {
                    ...currentManualeData,
                    id: id,
                    macroarea: macroarea,
                    materia: materia,
                    subject: materia,
                    type: tipo
                };
            } else {
                // Modifica solo metadata (mantieni JSON originale)
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                const originalManuals = getManualsAsObject();
                const originalManual = customManuals[editingManualeId] || originalManuals[editingManualeId];
                
                manualeToSave = {
                    ...originalManual,
                    macroarea: macroarea,
                    materia: materia,
                    subject: materia,
                    type: tipo
                };
            }
            
            // Salva in localStorage
            try {
                if (!editingManualeId || !MANUAL_CATALOG[id]) {
                    // Nuovo manuale custom
                    const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                    customManuals[id] = manualeToSave;
                    localStorage.setItem('custom_manuals', JSON.stringify(customManuals));
                    console.log('‚úÖ Nuovo manuale custom salvato');
                } else {
                    // Modifica di manuale esistente
                    const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                    modifiedManuals[id] = manualeToSave;
                    localStorage.setItem('modified_manuals', JSON.stringify(modifiedManuals));
                    console.log('‚úÖ Manuale modificato salvato');
                }
                
                // Rigenera catalog entry
                regenerateCatalogEntry(id, manualeToSave);
                
                // Chiudi modal e ricarica lista
                closeManualeModal();
                loadManualiList();
                
                alert('‚úÖ Manuale salvato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore salvataggio:', error);
                alert('Errore nel salvataggio: ' + error.message);
            }
        }
        
        function regenerateCatalogEntry(id, manualeData) {
            // Genera metadata per il catalog
            const catalogEntry = {
                id: id,
                filename: `${id}.json`,
                filepath: `custom/${id}.json`,
                title: manualeData.title,
                author: manualeData.author,
                publisher: manualeData.publisher || 'N/A',
                type: manualeData.type,
                subject: manualeData.subject,
                price: manualeData.price || 0,
                pages: manualeData.pages || 0,
                edition: manualeData.edition || 'N/A',
                year: manualeData.year || 'N/A',
                chapters_count: manualeData.chapters ? manualeData.chapters.length : 0
            };
            
            // Salva nel catalog entries
            const catalogEntries = JSON.parse(localStorage.getItem('catalog_entries') || '{}');
            catalogEntries[id] = catalogEntry;
            localStorage.setItem('catalog_entries', JSON.stringify(catalogEntries));
        }
        
        // ============================================
        // CRUD MANUALI - ELIMINAZIONE
        // ============================================
        
        let deleteTargetId = null;
        
        function deleteManuale(manualeId) {
            console.log('üóëÔ∏è Richiesta eliminazione:', manualeId);
            
            // Carica dati del manuale
            const originalManuals = getManualsAsObject();
            const allManuals = { 
                ...originalManuals, 
                ...JSON.parse(localStorage.getItem('custom_manuals') || '{}'),
                ...JSON.parse(localStorage.getItem('modified_manuals') || '{}')
            };
            
            console.log(`üîç Cercando manuale da eliminare con ID: "${manualeId}"`);
            
            const manuale = allManuals[manualeId];
            if (!manuale) {
                console.error(`‚ùå Manuale "${manualeId}" non trovato`);
                alert(`Manuale "${manualeId}" non trovato nel catalogo`);
                return;
            }
            
            console.log('‚úÖ Manuale trovato per eliminazione:', manuale);
            
            deleteTargetId = manualeId;
            document.getElementById('deleteManualeName').textContent = `${manuale.title} (${manuale.author})`;
            document.getElementById('deleteManualeModal').classList.remove('hidden');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteManualeModal').classList.add('hidden');
            deleteTargetId = null;
        }
        
        function confirmDeleteManuale() {
            if (!deleteTargetId) return;
            
            console.log('üóëÔ∏è Eliminazione confermata:', deleteTargetId);
            
            try {
                // Rimuovi da custom
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                if (customManuals[deleteTargetId]) {
                    delete customManuals[deleteTargetId];
                    localStorage.setItem('custom_manuals', JSON.stringify(customManuals));
                }
                
                // Rimuovi da modified
                const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                if (modifiedManuals[deleteTargetId]) {
                    delete modifiedManuals[deleteTargetId];
                    localStorage.setItem('modified_manuals', JSON.stringify(modifiedManuals));
                }
                
                // Rimuovi da catalog entries
                const catalogEntries = JSON.parse(localStorage.getItem('catalog_entries') || '{}');
                if (catalogEntries[deleteTargetId]) {
                    delete catalogEntries[deleteTargetId];
                    localStorage.setItem('catalog_entries', JSON.stringify(catalogEntries));
                }
                
                console.log('‚úÖ Manuale eliminato');
                
                closeDeleteModal();
                loadManualiList();
                
                alert('‚úÖ Manuale eliminato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione:', error);
                alert('Errore nell\'eliminazione: ' + error.message);
            }
        }
        
        // ============================================
        // CRUD MANUALI - EXPORT/IMPORT
        // ============================================
        
        function exportCatalog() {
            console.log('üíæ Export catalog JSON...');
            
            try {
                const originalManuals = getManualsAsObject();
                
                // Merge tutti i cataloghi
                const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
                const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
                const catalogEntries = JSON.parse(localStorage.getItem('catalog_entries') || '{}');
                
                const fullCatalog = {
                    catalog_format_version: MANUAL_CATALOG.catalog_format_version || MANUAL_CATALOG.version || '1.0.0',
                    last_updated: new Date().toISOString().split('T')[0],
                    total_manuals: Object.keys(originalManuals).length + Object.keys(modifiedManuals).length + Object.keys(catalogEntries).length,
                    manuals: {
                        ...originalManuals,
                        ...modifiedManuals,
                        ...catalogEntries
                    }
                };
                
                // Download JSON
                const blob = new Blob([JSON.stringify(fullCatalog, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'manual_catalog_updated.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Catalog esportato');
                alert('‚úÖ Catalog esportato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore export:', error);
                alert('Errore nell\'export: ' + error.message);
            }
        }
        
        function exportCatalogZIP() {
            alert('üì¶ Funzionalit√† Export ZIP in fase di implementazione...\n\nPer ora usa "Export JSON" e carica manualmente i file JSON dei manuali custom.');
        }
        
        function importCatalog() {
            alert('üì• Funzionalit√† Import in fase di implementazione...\n\nPer ora aggiungi i manuali uno per uno con "Nuovo Manuale".');
        }

        // ============================================
        // CRUD FRAMEWORK - CARICAMENTO LISTA
        // ============================================
        
        let editingFrameworkId = null;
        let currentFrameworkData = null;
        
        async function loadFrameworkList() {
            console.log('üìã Caricamento lista framework...');
            
            const tbody = document.getElementById('frameworkTableBody');
            if (!tbody) {
                console.error('‚ùå Element frameworkTableBody not found!');
                return;
            }
            
            // Se FRAMEWORK_CATALOG non √® caricato, caricalo ORA
            if (!window.FRAMEWORK_CATALOG) {
                console.warn('‚ö†Ô∏è FRAMEWORK_CATALOG non caricato, carico ora...');
                try {
                    const response = await fetch('framework_catalog.json');
                    window.FRAMEWORK_CATALOG = await response.json();
                    console.log('‚úÖ FRAMEWORK_CATALOG caricato:', window.FRAMEWORK_CATALOG);
                } catch (error) {
                    console.error('‚ùå Errore caricamento FRAMEWORK_CATALOG:', error);
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-600">‚ùå Errore caricamento framework: ' + error.message + '</td></tr>';
                    return;
                }
            }
            
            console.log('üîç FRAMEWORK_CATALOG:', window.FRAMEWORK_CATALOG);
            
            // Carica framework originali + custom + modificati
            const originalFrameworks = getFrameworksAsObject();
            console.log('üì¶ Original frameworks:', Object.keys(originalFrameworks).length);
            
            const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
            const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
            
            // Merge con priorit√†: modificati > custom > originali
            const allFrameworks = {
                ...originalFrameworks,
                ...customFrameworks,
                ...modifiedFrameworks
            };
            
            console.log(`‚úÖ Framework totali: ${Object.keys(allFrameworks).length}`);
            
            // Ordina per nome
            const sortedFrameworks = Object.values(allFrameworks).sort((a, b) => 
                (a.name || '').localeCompare(b.name || '')
            );
            
            // Genera righe tabella
            tbody.innerHTML = sortedFrameworks.map(fw => {
                // Determina badge di stato
                let badge = '';
                if (modifiedFrameworks[fw.id]) {
                    badge = '<span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">üü° Modificato</span>';
                } else if (customFrameworks[fw.id]) {
                    badge = '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">üîµ Custom</span>';
                } else {
                    badge = '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">üü¢ Originale</span>';
                }
                
                const modulesCount = fw.modules_count || (fw.content?.syllabus_modules?.length) || 0;
                const profilesCount = fw.program_profiles_count || (fw.content?.program_profiles?.length) || 0;
                
                return `
                    <tr class="framework-row" data-id="${fw.id}" data-subject="${fw.subject || ''}" data-tipo="${badge.includes('Originale') ? 'originale' : (badge.includes('Modificato') ? 'modificato' : 'custom')}">
                        <td class="px-1 py-1 text-xs text-gray-900 break-words">${fw.id}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 break-words">${fw.name || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-gray-900 break-words">${fw.subject || '‚Äî'}</td>
                        <td class="px-1 py-1 text-xs text-center text-gray-900">${modulesCount}</td>
                        <td class="px-1 py-1 text-xs text-center text-gray-900">${profilesCount}</td>
                        <td class="px-1 py-1 text-xs">${badge}</td>
                        <td class="px-1 py-1 text-xs">
                            <div class="flex gap-1">
                                <button onclick="editFramework('${fw.id}')" class="text-indigo-600 hover:text-indigo-800" title="Modifica">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteFramework('${fw.id}')" class="text-red-600 hover:text-red-800" title="Elimina">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Aggiorna contatori
            const originalCount = Object.keys(originalFrameworks).length;
            const modifiedCount = Object.keys(modifiedFrameworks).length;
            const customCount = Object.keys(customFrameworks).length;
            const total = Object.keys(allFrameworks).length;
            
            document.getElementById('frameworkCount').innerHTML = `
                üìã <strong>${total}</strong> framework totali
                ‚Ä¢ ${originalCount} originali
                ‚Ä¢ ${modifiedCount} modificati
                ‚Ä¢ ${customCount} custom
            `;
        }
        
        function getFrameworksAsObject() {
            // Converti FRAMEWORK_CATALOG in oggetto per coerenza
            console.log('üîß getFrameworksAsObject called');
            console.log('üîç window.FRAMEWORK_CATALOG:', window.FRAMEWORK_CATALOG);
            
            if (!window.FRAMEWORK_CATALOG) {
                console.error('‚ùå FRAMEWORK_CATALOG is not defined!');
                return {};
            }
            
            const frameworks = {};
            if (FRAMEWORK_CATALOG.frameworks) {
                console.log('‚úÖ Found FRAMEWORK_CATALOG.frameworks:', FRAMEWORK_CATALOG.frameworks.length);
                FRAMEWORK_CATALOG.frameworks.forEach(fw => {
                    frameworks[fw.id] = fw;
                });
            } else {
                console.error('‚ùå FRAMEWORK_CATALOG.frameworks is missing!');
            }
            
            console.log('üì¶ Returning frameworks object with', Object.keys(frameworks).length, 'items');
            return frameworks;
        }
        
        function filterFramework() {
            const searchText = document.getElementById('searchFramework').value.toLowerCase();
            const filterMateria = document.getElementById('filterFrameworkMateria').value;
            const filterTipo = document.getElementById('filterFrameworkTipo').value;
            
            const rows = document.querySelectorAll('.framework-row');
            
            rows.forEach(row => {
                const id = row.dataset.id.toLowerCase();
                const subject = row.dataset.subject;
                const tipo = row.dataset.tipo;
                const text = row.textContent.toLowerCase();
                
                const matchSearch = !searchText || text.includes(searchText);
                const matchMateria = !filterMateria || subject === filterMateria;
                const matchTipo = !filterTipo || tipo === filterTipo;
                
                if (matchSearch && matchMateria && matchTipo) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // ============================================
        // CRUD FRAMEWORK - MODAL AGGIUNGI/MODIFICA
        // ============================================
        
        function openAddFrameworkModal() {
            console.log('‚ûï Apertura modal nuovo framework');
            
            editingFrameworkId = null;
            currentFrameworkData = null;
            
            document.getElementById('frameworkModalTitle').textContent = '‚ûï Nuovo Framework';
            document.getElementById('frameworkId').value = '';
            document.getElementById('frameworkId').disabled = false;
            document.getElementById('frameworkName').value = '';
            document.getElementById('frameworkSubject').value = '';
            
            // Reset upload JSON
            document.getElementById('frameworkJsonFile').value = '';
            document.getElementById('frameworkJsonFileInfo').classList.add('hidden');
            document.getElementById('frameworkPreviewSection').classList.add('hidden');
            document.getElementById('frameworkJsonEditorSection').classList.add('hidden');
            document.getElementById('frameworkValidationErrors').classList.add('hidden');
            
            // Mostra sezione upload JSON
            const step2Upload = document.querySelector('#frameworkModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.remove('hidden');
            }
            
            document.getElementById('frameworkModal').classList.remove('hidden');
        }
        
        function editFramework(frameworkId) {
            console.log('‚úèÔ∏è Modifica framework:', frameworkId);
            
            editingFrameworkId = frameworkId;
            
            // Carica dati framework
            const originalFrameworks = getFrameworksAsObject();
            const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
            const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
            
            const framework = modifiedFrameworks[frameworkId] || customFrameworks[frameworkId] || originalFrameworks[frameworkId];
            
            if (!framework) {
                alert('Framework non trovato');
                return;
            }
            
            document.getElementById('frameworkModalTitle').textContent = '‚úèÔ∏è Modifica Framework';
            document.getElementById('frameworkId').value = framework.id;
            document.getElementById('frameworkId').disabled = true;
            document.getElementById('frameworkName').value = framework.name || '';
            document.getElementById('frameworkSubject').value = framework.subject || '';
            
            // Nascondi upload JSON e mostra preview dati esistenti
            const step2Upload = document.querySelector('#frameworkModal .bg-green-50');
            if (step2Upload) {
                step2Upload.classList.add('hidden');
            }
            
            // Carica JSON completo se disponibile
            if (customFrameworks[frameworkId]) {
                // Framework custom: carica da localStorage
                currentFrameworkData = customFrameworks[frameworkId];
                showFrameworkPreview(currentFrameworkData);
                showFrameworkJsonEditor(currentFrameworkData);
            } else if (framework.filepath) {
                // Framework originale: carica da file
                fetch(framework.filepath)
                    .then(r => r.json())
                    .then(data => {
                        currentFrameworkData = data;
                        showFrameworkPreview(currentFrameworkData);
                        showFrameworkJsonEditor(currentFrameworkData);
                    })
                    .catch(err => {
                        console.error('‚ùå Errore caricamento JSON:', err);
                        // Mostra preview con dati base
                        showFrameworkPreview(framework);
                    });
            } else {
                // Nessun JSON disponibile, mostra dati base
                showFrameworkPreview(framework);
            }
            
            document.getElementById('frameworkValidationErrors').classList.add('hidden');
            document.getElementById('frameworkModal').classList.remove('hidden');
        }
        
        function closeFrameworkModal() {
            document.getElementById('frameworkModal').classList.add('hidden');
            editingFrameworkId = null;
            currentFrameworkData = null;
        }
        
        // ============================================
        // CRUD FRAMEWORK - UPLOAD E VALIDAZIONE JSON
        // ============================================
        
        async function handleFrameworkJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üìÅ Caricamento file JSON framework:', file.name);
            
            // Mostra info file
            document.getElementById('frameworkJsonFileName').textContent = file.name;
            document.getElementById('frameworkJsonFileSize').textContent = `${(file.size / 1024).toFixed(2)} KB`;
            document.getElementById('frameworkJsonFileInfo').classList.remove('hidden');
            
            try {
                const text = await file.text();
                const json = JSON.parse(text);
                
                console.log('‚úÖ JSON parsato con successo');
                
                // Valida struttura
                const errors = validateFrameworkJson(json);
                
                if (errors.length > 0) {
                    showFrameworkValidationErrors(errors);
                    currentFrameworkData = null;
                    document.getElementById('frameworkPreviewSection').classList.add('hidden');
                    return;
                }
                
                // JSON valido
                currentFrameworkData = json;
                document.getElementById('frameworkValidationErrors').classList.add('hidden');
                showFrameworkPreview(json);
                
            } catch (error) {
                console.error('‚ùå Errore parsing JSON:', error);
                showFrameworkValidationErrors(['Errore nel parsing del file JSON: ' + error.message]);
                currentFrameworkData = null;
            }
        }
        
        function validateFrameworkJson(json) {
            const errors = [];
            
            if (!json.id || typeof json.id !== 'string') {
                errors.push('Campo "id" obbligatorio (stringa)');
            }
            
            if (!json.name || typeof json.name !== 'string') {
                errors.push('Campo "name" obbligatorio (stringa)');
            }
            
            if (!json.subject || typeof json.subject !== 'string') {
                errors.push('Campo "subject" obbligatorio (stringa)');
            }
            
            // Valida content
            if (!json.content || typeof json.content !== 'object') {
                errors.push('Campo "content" obbligatorio (oggetto)');
            } else {
                if (!json.content.syllabus_modules || !Array.isArray(json.content.syllabus_modules)) {
                    errors.push('Campo "content.syllabus_modules" obbligatorio (array)');
                } else if (json.content.syllabus_modules.length === 0) {
                    errors.push('Il framework deve avere almeno un modulo');
                }
                
                if (!json.content.program_profiles || !Array.isArray(json.content.program_profiles)) {
                    errors.push('Campo "content.program_profiles" obbligatorio (array)');
                }
                
                if (!json.content.target_degrees || !Array.isArray(json.content.target_degrees)) {
                    errors.push('Campo "content.target_degrees" obbligatorio (array)');
                }
            }
            
            return errors;
        }
        
        function showFrameworkValidationErrors(errors) {
            const errorList = document.getElementById('frameworkErrorList');
            errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
            document.getElementById('frameworkValidationErrors').classList.remove('hidden');
        }
        
        function showFrameworkPreview(json) {
            const content = json.content || {};
            
            document.getElementById('frameworkPreviewName').textContent = json.name || '‚Äî';
            document.getElementById('frameworkPreviewSubject').textContent = json.subject || '‚Äî';
            document.getElementById('frameworkPreviewModules').textContent = content.syllabus_modules ? content.syllabus_modules.length : '‚Äî';
            document.getElementById('frameworkPreviewProfiles').textContent = content.program_profiles ? content.program_profiles.length : '‚Äî';
            document.getElementById('frameworkPreviewDegrees').textContent = content.target_degrees ? content.target_degrees.length : '‚Äî';
            
            document.getElementById('frameworkPreviewSection').classList.remove('hidden');
        }
        
        function showFrameworkJsonEditor(json) {
            const editor = document.getElementById('frameworkJsonEditor');
            if (editor) {
                editor.value = JSON.stringify(json, null, 2);
                document.getElementById('frameworkJsonEditorSection').classList.remove('hidden');
            }
        }
        
        // ============================================
        // CRUD FRAMEWORK - SALVATAGGIO
        // ============================================
        
        async function saveFrameworkData() {
            console.log('üíæ Salvataggio framework...');
            
            // Valida form
            const id = document.getElementById('frameworkId').value.trim();
            const name = document.getElementById('frameworkName').value.trim();
            const subject = document.getElementById('frameworkSubject').value;
            
            const errors = [];
            
            if (!id) {
                errors.push('ID framework obbligatorio');
            } else if (!/^[a-zA-Z0-9_]+$/.test(id)) {
                errors.push('ID deve contenere solo lettere, numeri e underscore');
            }
            
            if (!name) {
                errors.push('Nome framework obbligatorio');
            }
            
            if (!subject) {
                errors.push('Materia obbligatoria');
            }
            
            if (!currentFrameworkData && !editingFrameworkId) {
                errors.push('File JSON obbligatorio per nuovi framework');
            }
            
            // Controllo duplicati (solo per nuovi)
            if (!editingFrameworkId) {
                const originalFrameworks = getFrameworksAsObject();
                const allFrameworks = { 
                    ...originalFrameworks, 
                    ...JSON.parse(localStorage.getItem('custom_frameworks') || '{}'),
                    ...JSON.parse(localStorage.getItem('modified_frameworks') || '{}')
                };
                
                if (allFrameworks[id]) {
                    errors.push('ID gi√† esistente. Scegli un ID diverso.');
                }
            }
            
            if (errors.length > 0) {
                showFrameworkValidationErrors(errors);
                return;
            }
            
            // Prepara dati da salvare
            let frameworkToSave;
            
            // Se l'editor JSON √® visibile, leggi da l√¨
            const jsonEditorSection = document.getElementById('frameworkJsonEditorSection');
            if (jsonEditorSection && !jsonEditorSection.classList.contains('hidden')) {
                const jsonEditorContent = document.getElementById('frameworkJsonEditor').value;
                try {
                    const parsedJson = JSON.parse(jsonEditorContent);
                    frameworkToSave = {
                        ...parsedJson,
                        id: id,
                        name: name,
                        subject: subject
                    };
                    console.log('‚úÖ JSON letto dall\'editor');
                } catch (e) {
                    errors.push('JSON non valido nell\'editor: ' + e.message);
                    showFrameworkValidationErrors(errors);
                    return;
                }
            } else if (currentFrameworkData) {
                // Nuovo framework o sostituzione JSON
                frameworkToSave = {
                    ...currentFrameworkData,
                    id: id,
                    name: name,
                    subject: subject
                };
            } else {
                // Modifica solo metadata (mantieni JSON originale)
                const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                const originalFrameworks = getFrameworksAsObject();
                const originalFramework = customFrameworks[editingFrameworkId] || originalFrameworks[editingFrameworkId];
                
                frameworkToSave = {
                    ...originalFramework,
                    name: name,
                    subject: subject
                };
            }
            
            // Salva in localStorage
            try {
                const originalFrameworks = getFrameworksAsObject();
                
                if (!editingFrameworkId || !originalFrameworks[id]) {
                    // Nuovo framework custom
                    const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                    customFrameworks[id] = frameworkToSave;
                    localStorage.setItem('custom_frameworks', JSON.stringify(customFrameworks));
                    console.log('‚úÖ Nuovo framework custom salvato');
                } else {
                    // Modifica di framework esistente
                    const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
                    modifiedFrameworks[id] = frameworkToSave;
                    localStorage.setItem('modified_frameworks', JSON.stringify(modifiedFrameworks));
                    console.log('‚úÖ Framework modificato salvato');
                }
                
                // Chiudi modal e ricarica lista
                closeFrameworkModal();
                loadFrameworkList();
                
                alert('‚úÖ Framework salvato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore salvataggio:', error);
                alert('Errore nel salvataggio: ' + error.message);
            }
        }
        
        // ============================================
        // CRUD FRAMEWORK - ELIMINAZIONE
        // ============================================
        
        let deleteFrameworkTargetId = null;
        
        function deleteFramework(frameworkId) {
            console.log('üóëÔ∏è Richiesta eliminazione framework:', frameworkId);
            
            // Carica dati del framework
            const originalFrameworks = getFrameworksAsObject();
            const allFrameworks = { 
                ...originalFrameworks, 
                ...JSON.parse(localStorage.getItem('custom_frameworks') || '{}'),
                ...JSON.parse(localStorage.getItem('modified_frameworks') || '{}')
            };
            
            const framework = allFrameworks[frameworkId];
            if (!framework) {
                console.error(`‚ùå Framework "${frameworkId}" non trovato`);
                alert(`Framework "${frameworkId}" non trovato nel catalogo`);
                return;
            }
            
            console.log('‚úÖ Framework trovato per eliminazione:', framework);
            
            deleteFrameworkTargetId = frameworkId;
            document.getElementById('deleteFrameworkName').textContent = `${framework.name} (${framework.subject})`;
            document.getElementById('deleteFrameworkModal').classList.remove('hidden');
        }
        
        function closeDeleteFrameworkModal() {
            document.getElementById('deleteFrameworkModal').classList.add('hidden');
            deleteFrameworkTargetId = null;
        }
        
        function confirmDeleteFramework() {
            if (!deleteFrameworkTargetId) return;
            
            console.log('üóëÔ∏è Eliminazione confermata:', deleteFrameworkTargetId);
            
            try {
                // Rimuovi da custom
                const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                if (customFrameworks[deleteFrameworkTargetId]) {
                    delete customFrameworks[deleteFrameworkTargetId];
                    localStorage.setItem('custom_frameworks', JSON.stringify(customFrameworks));
                }
                
                // Rimuovi da modified
                const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
                if (modifiedFrameworks[deleteFrameworkTargetId]) {
                    delete modifiedFrameworks[deleteFrameworkTargetId];
                    localStorage.setItem('modified_frameworks', JSON.stringify(modifiedFrameworks));
                }
                
                console.log('‚úÖ Framework eliminato');
                
                closeDeleteFrameworkModal();
                loadFrameworkList();
                
                alert('‚úÖ Framework eliminato con successo!');
                
            } catch (error) {
                console.error('‚ùå Errore eliminazione:', error);
                alert('Errore nell\'eliminazione: ' + error.message);
            }
        }
        
        // ============================================
        // CRUD FRAMEWORK - EXPORT/IMPORT
        // ============================================
        
        function exportFrameworkCatalog() {
            console.log('üíæ Export framework catalog JSON...');
            
            try {
                const originalFrameworks = getFrameworksAsObject();
                
                // Merge tutti i cataloghi
                const customFrameworks = JSON.parse(localStorage.getItem('custom_frameworks') || '{}');
                const modifiedFrameworks = JSON.parse(localStorage.getItem('modified_frameworks') || '{}');
                
                const fullCatalog = {
                    version: '1.0.0',
                    last_updated: new Date().toISOString().split('T')[0],
                    total_frameworks: Object.keys({ ...originalFrameworks, ...modifiedFrameworks, ...customFrameworks }).length,
                    frameworks: Object.values({
                        ...originalFrameworks,
                        ...modifiedFrameworks,
                        ...customFrameworks
                    })
                };
                
                // Crea file JSON
                const blob = new Blob([JSON.stringify(fullCatalog, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `framework_catalog_updated_${fullCatalog.last_updated}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Export completato');
                
            } catch (error) {
                console.error('‚ùå Errore export:', error);
                alert('Errore nell\'export: ' + error.message);
            }
        }
        
        function exportFrameworkZIP() {
            alert('üì¶ Funzionalit√† Export ZIP in fase di implementazione...\n\nPer ora usa "Export JSON" e carica manualmente i file JSON dei framework custom.');
        }
        
        function importFrameworkCatalog() {
            alert('üì• Funzionalit√† Import in fase di implementazione...\n\nPer ora aggiungi i framework uno per uno con "Nuovo Framework".');
        }

        // Gestione file
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').textContent = file.name;

            if (file.type === 'application/pdf') {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let text = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        text += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    
                    fileContent = text;
                    document.getElementById('testoInput').value = text;
                } catch (error) {
                    showError('Errore nella lettura del PDF: ' + error.message);
                }
            } else if (file.type === 'text/plain') {
                try {
                    const text = await file.text();
                    fileContent = text;
                    document.getElementById('testoInput').value = text;
                } catch (error) {
                    showError('Errore nella lettura del file: ' + error.message);
                }
            } else {
                showError('Formato file non supportato. Usa PDF o TXT.');
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorMessage').classList.add('hidden');
            }, 5000);
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        // Analisi principale
        async function avviaAnalisi() {
            // Verifica che almeno una chiave API sia configurata
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const apiKeyOpenAI = localStorage.getItem('openai_api_key');
            const apiKeyPerplexity = localStorage.getItem('perplexity_api_key');
            
            // Per OpenAI: permetti uso anche senza chiave (user√† quella su Netlify)
            // Per Perplexity: richiedi sempre la chiave
            if (provider === 'perplexity' && !apiKeyPerplexity) {
                showError('Chiave API Perplexity non configurata. Vai in Impostazioni.');
                return;
            }

            const contesto = document.getElementById('contestoSelect').value;
            let manuale = document.getElementById('manualeSelect').value;
            const cfu = document.getElementById('cfuInput').value;
            const ore = document.getElementById('oreInput').value;
            const testo = document.getElementById('testoInput').value.trim();
            const tipoAnalisi = document.querySelector('input[name="tipoAnalisi"]:checked').value;
            
            // Se "Altro manuale", usa il nome personalizzato
            let manualeNomePersonalizzato = null;
            if (manuale === 'Altro') {
                manualeNomePersonalizzato = document.getElementById('altroManualeNome').value.trim();
                if (!manualeNomePersonalizzato) {
                    showError('Specifica il nome del manuale adottato');
                    return;
                }
            }
            
            // Raccogli manuali alternativi
            // Raccogli manuali alternativi selezionati (checkbox dinamici con id che inizia per "alt")
            const manualiAlternativi = [];
            document.querySelectorAll('input[type="checkbox"][id^="alt"]').forEach(checkbox => {
                if (checkbox.checked && checkbox.value && checkbox.value !== manuale) {
                    manualiAlternativi.push(checkbox.value);
                    console.log(`‚úÖ Manuale alternativo selezionato: ${checkbox.value}`);
                }
            });

            if (!contesto || !manuale) {
                showError('Seleziona contesto didattico e manuale adottato');
                return;
            }
            
            // Verifica che sia stato selezionato un framework
            if (!CURRENT_FRAMEWORK) {
                showError('Seleziona prima una materia e un framework specifico');
                return;
            }
            
            // Estrai il nome del framework dal catalogo o usa un fallback
            const frameworkInfo = FRAMEWORK_CATALOG?.frameworks?.find(f => f.filepath === window.lastFrameworkPath);
            const frameworkName = frameworkInfo ? frameworkInfo.name : 'del corso';
            const materiaName = frameworkInfo ? frameworkInfo.subject : 'la materia selezionata';
            
            console.log('üìö Framework selezionato:', frameworkName);
            console.log('üìñ Materia:', materiaName);

            if (!testo) {
                showError('Carica un file o incolla il testo del programma');
                return;
            }

            if (testo.length < 100) {
                showError('Il testo del programma √® troppo breve (minimo 100 caratteri)');
                return;
            }

            document.getElementById('btnAnalizza').disabled = true;
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            try {
                // Fase 0: Analisi Preliminare (Quadro Generale + Profilo Pedagogico + Allineamento Classe + Criteri Disciplinari)
                updateLoadingText('Fase 0/5: Analisi preliminare del programma...');
                
                // Prepara dati framework per Fase 0
                const fw0 = CURRENT_FRAMEWORK;
                const fw0Content = fw0?.content || {};
                const moduliFW0 = (fw0Content.syllabus_modules || []).map((mod, idx) => 
                    `   - MOD-${String(idx + 1).padStart(2, '0')} ${mod.name}`
                ).join('\n');
                
                // Trova il profilo specifico per la classe di laurea selezionata
                const profileFW0 = (fw0Content.program_profiles || []).find(p => 
                    contesto && p.name && (p.name.includes(contesto) || contesto.includes(p.name.split(' ')[0]))
                );
                const priorityModulesText = profileFW0?.priority_modules || 
                    'Non disponibili per questa classe di laurea. Usa le informazioni generali del framework.';
                const hasProgramProfiles = fw0Content.program_profiles && fw0Content.program_profiles.length > 0;
                
                // Verifica evaluation_criteria
                const hasEvaluationCriteria = fw0Content.evaluation_criteria && 
                    typeof fw0Content.evaluation_criteria === 'object' &&
                    Object.keys(fw0Content.evaluation_criteria).length > 0;
                
                let evaluationCriteriaPrompt0 = '';
                if (hasEvaluationCriteria) {
                    evaluationCriteriaPrompt0 = `
COMPITO ‚Äî PARTE 4: CRITERI DI VALUTAZIONE DISCIPLINARI
Il framework di questa materia definisce criteri di valutazione specifici.
Per CIASCUN criterio, posiziona il docente basandoti ESCLUSIVAMENTE 
sulle evidenze trovate nel programma.

CRITERI:
${Object.entries(fw0Content.evaluation_criteria).map(([key, value]) => 
  `- ${key}: ${value}`
).join('\n')}

Per ogni criterio genera un oggetto con:
- "criterio": nome del criterio
- "indicazione_framework": cosa dice il framework di cercare
- "posizione_docente": dove si posiziona questo docente
- "evidenze": citazioni o riferimenti specifici dal programma
- "confidenza": "alta" o "media" o "bassa"
`;
                }
                
                let fase0;
                try {
                    const analisiPreliminare = await callLLM(`Sei un esperto di didattica universitaria e analisi curricolare.

IMPORTANTE: Rispondi ESCLUSIVAMENTE con un oggetto JSON valido. Non aggiungere testo prima o dopo il JSON.
Usa SEMPRE virgolette doppie per le stringhe. Non usare apici singoli.
Evita caratteri speciali non escapati nelle stringhe.

PROGRAMMA DIDATTICO:
${testo.substring(0, 8000)}

FRAMEWORK DELLA MATERIA:
- Nome: ${frameworkName}
- Materia: ${materiaName}
- Strategia di contesto: ${fw0.context_strategy || 'Non disponibile'}
- Moduli del syllabus:
${moduliFW0}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

${hasProgramProfiles ? `
PRIORITA SPECIFICHE PER LA CLASSE ${contesto}:
${priorityModulesText}
` : ''}

COMPITO ‚Äî PARTE 1: QUADRO GENERALE
Genera un quadro sintetico del programma:
- Tipologia del corso (1 riga)
- Distribuzione tematica percentuale rispetto ai moduli del framework 
  (quali moduli pesano di piu nel programma?)
- Livello di complessita (base/intermedio/avanzato)
- Sintesi in 2-3 righe

COMPITO ‚Äî PARTE 2: PROFILO PEDAGOGICO
Analizza il profilo pedagogico del docente:
- Approccio (teorico/applicativo/misto)
- Livello (base/intermedio/avanzato)
- Stile (classico/moderno/innovativo)
- Orientamento (disciplinare puro/interdisciplinare/misto)
- Enfasi particolari (3-5 temi su cui il docente insiste)
- Metodologia didattica (come insegna, come valuta)

COMPITO ‚Äî PARTE 3: ALLINEAMENTO CON LA CLASSE DI LAUREA
Usando le priorita specifiche della classe di laurea fornite sopra,
genera una tabella di allineamento.
Per ogni priorita indicata nel program_profile:
- La priorita e soddisfatta dal programma? (si/parzialmente/no)
- Evidenza specifica dal programma
- Valutazione (Perfetto allineamento / Buon allineamento / 
  Allineamento parziale / Disallineamento)

Se le priorita per questa classe non sono disponibili, 
analizza l'allineamento in modo generico rispetto alla context_strategy.
${evaluationCriteriaPrompt0}
Genera un JSON con questa struttura esatta:

{
  "quadro_generale": {
    "tipologia": "descrizione breve del tipo di corso (max 250 caratteri)",
    "distribuzione_tematica": [
      {"area": "nome area/modulo", "percentuale": 40}
    ],
    "livello_complessita": "base o intermedio o avanzato",
    "note": "osservazioni generali (max 400 caratteri)"
  },
  
  "profilo_pedagogico": {
    "approccio": "teorico o applicativo o sperimentale o interdisciplinare o misto",
    "livello": "base o intermedio o avanzato",
    "enfasi": ["argomento1", "argomento2", "argomento3"],
    "stile": "classico o moderno o innovativo o tradizionale",
    "orientamento": "puro o applicato o misto",
    "metodologia": "come insegna e come valuta (max 300 caratteri)",
    "note": "caratteristiche distintive (max 300 caratteri)"
  },
  
  "allineamento_classe": {
    "classe": "${contesto}",
    "priorita_classe": "testo sintetico delle priorita dalla classe",
    "valutazioni": [
      {
        "priorita": "Nome della priorita",
        "soddisfatta": "si o parzialmente o no",
        "evidenza": "Citazione o riferimento specifico dal programma",
        "valutazione": "Perfetto allineamento o Buon allineamento o Allineamento parziale o Disallineamento"
      }
    ],
    "allineamento_complessivo": "Alto o Medio-Alto o Medio o Medio-Basso o Basso"
  }${hasEvaluationCriteria ? `,
  
  "criteri_disciplinari": [
    {
      "criterio": "nome del criterio",
      "indicazione_framework": "cosa dice il framework",
      "posizione_docente": "dove si posiziona il docente",
      "evidenze": "citazioni dal programma",
      "confidenza": "alta o media o bassa"
    }
  ]` : ''}
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`, 0.1);

                    console.log('üìù Risposta Fase 0 (lunghezza):', analisiPreliminare.length);
                    fase0 = JSON.parse(sanitizeJSON(analisiPreliminare));
                    
                    // Salva fase 0 per uso successivo
                    window.currentAnalisiPreliminare = fase0;
                    
                    console.log('‚úÖ Fase 0 completata:', fase0);
                } catch (error) {
                    console.error('‚ùå ERRORE Fase 0:', error.message);
                    throw new Error('Fase 0 fallita: ' + error.message);
                }

                // Fase 0b: Analisi Avanzata - Profilo Docente (SOLO se Analisi Avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Fase 0b/5: Analisi avanzata profilo docente...');
                    
                    try {
                        const profiloDocentePrompt = `Sei un assistente strategico per promotori editoriali.

ANALISI PRELIMINARE GIA' EFFETTUATA:
${JSON.stringify(fase0, null, 2)}

PROGRAMMA (per contesto):
${testo.substring(0, 5000)}

CONTESTO:
- Materia: ${materiaName}
- Classe di Laurea: ${contesto}

‚ö†Ô∏è REGOLA DI SPECIFICITA' OBBLIGATORIA:
Ogni affermazione DEVE contenere almeno UNO di questi elementi:
1. Riferimento TESTUALE a qualcosa di specifico trovato nel programma
   (argomento, metodologia, formulazione particolare)
2. Dato CONCRETO (distribuzione tematica, peso CFU, 
   numero ore dedicate a un modulo) ‚Äî solo se presente nel programma
3. INFERENZA non ovvia che collega due elementi del programma

‚ùå ESEMPI DI COSA NON SCRIVERE (troppo generico):
- "Importanza dell'integrazione tra teoria e pratica"
- "Supporto a metodologie didattiche innovative"
- "Focus su applicazioni biologiche della chimica"

‚úÖ ESEMPI DI COSA SCRIVERE (specifico):
- "Il docente dedica una porzione significativa del programma agli equilibri chimici collegandoli esplicitamente ai processi biologici ‚Äî questo peso e' superiore alla media per L-13 e suggerisce interesse personale per la bioinorganica"
- "La menzione esplicita del Team Based Learning E del coteaching (non solo una delle due) indica un docente che ha investito nella formazione pedagogica, non uno che usa TBL come etichetta"

Per "Leve Potenziali" e "Possibili Resistenze":
- Specifica PERCHE' funzionerebbe con QUESTO docente (non in generale)
- Indica QUALE elemento del programma te lo fa pensare
- Per resistenze: indica COME si manifesterebbe nel colloquio

IMPORTANTE: 
- NON inventare dati numerici
- NON usare punteggi, percentuali, frazioni (es. 95/100, 240/270) o numeri tecnici nelle descrizioni ‚Äî traduci TUTTO in linguaggio commerciale qualitativo (es. "ottima corrispondenza", "copre quasi tutto il programma")
- Usa linguaggio qualitativo: "potrebbe", "probabilmente", "tendenzialmente"
- Basa tutto su cio' che emerge dal programma e dall'analisi preliminare

Genera un JSON con questa struttura:

{
  "profilo_docente_insights": {
    "tipo_docente": "Tradizionalista / Innovatore / Pragmatico / Accademico (basato su stile e approccio identificati)",
    "sensibilita_chiave": "Cosa sembra importante per questo docente (basato su enfasi e orientamento) - DEVE includere riferimento specifico al programma",
    "approccio_consigliato": "Come presentare un manuale alternativo - DEVE riferirsi a caratteristiche specifiche identificate nel programma",
    "leve_potenziali": [
      "leva1 CON spiegazione del perche' funzionerebbe con QUESTO docente e quale elemento del programma lo suggerisce",
      "leva2 con stessa struttura"
    ],
    "possibili_resistenze": [
      "resistenza1 CON indicazione di quale comportamento/scelta del docente la suggerisce e come si manifesterebbe",
      "resistenza2 con stessa struttura"
    ],
    "argomenti_rilevanti": ["tipo di contenuto specifico enfatizzato nel programma", "aspetto distintivo del programma"]
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                        const profiloDocenteResponse = await callLLM(profiloDocentePrompt, 0.2);
                        const profiloDocenteObj = JSON.parse(sanitizeJSON(profiloDocenteResponse));
                        
                        // Aggiungi al fase0
                        fase0.profilo_docente_insights = profiloDocenteObj.profilo_docente_insights;
                        console.log('‚úÖ Fase 0b (Avanzata) completata:', profiloDocenteObj);
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Fase 0b (Avanzata) fallita, continuo comunque:', error.message);
                        // Non blocco l'analisi se questa fase fallisce
                    }
                }

                // Fase 0.5: Analisi Motivazioni Scelta Manuale (AVANZATA)
                updateLoadingText('Fase 0.5/5: Logica della scelta editoriale...');
                
                let motivazioniScelta = null;
                try {
                    // Recupera info sul manuale adottato dal catalogo
                    const manualeId = manuale === 'Altro' ? manualeNomePersonalizzato : manuale;
                    
                    // Cerca nel catalogo dei manuali
                    const manualeAdottatoObj = MANUAL_CATALOG?.manuals 
                        ? Object.values(MANUAL_CATALOG.manuals).find(m => m.id === manualeId)
                        : null;
                    
                    // Se non trovato, usa valori di default
                    const manualeInfo = manualeAdottatoObj || {
                        title: manualeId,
                        author: 'Non specificato',
                        publisher: 'Non specificato',
                        pages: 0,
                        price: 0,
                        chapters: []
                    };
                    
                    console.log('üîç FASE 0.5 AVANZATA - Manuale ID:', manualeId);
                    console.log('üîç FASE 0.5 AVANZATA - Manuale Info:', manualeInfo);
                    console.log('üîç FASE 0.5 AVANZATA - Manuali Alternativi:', manualiAlternativi);
                    
                    // Carica indice completo del manuale principale
                    let indiceManualePrincipale = 'Indice non disponibile';
                    if (manualeAdottatoObj && manualeAdottatoObj.filepath) {
                        try {
                            const manualeData = await fetch(manualeAdottatoObj.filepath).then(r => r.json());
                            if (manualeData.chapters && manualeData.chapters.length > 0) {
                                indiceManualePrincipale = manualeData.chapters.map((cap, i) => 
                                    `${i+1}. ${cap.title || cap}`
                                ).join('\n');
                                console.log(`‚úÖ Indice manuale principale caricato (${manualeData.chapters.length} capitoli)`);
                            }
                        } catch (err) {
                            console.warn('‚ö†Ô∏è Errore caricamento indice manuale principale:', err);
                        }
                    }
                    
                    // Carica info complete sui manuali alternativi (con indici)
                    const manualiAlternativiInfo = [];
                    for (const altId of manualiAlternativi) {
                        const altObj = MANUAL_CATALOG?.manuals 
                            ? Object.values(MANUAL_CATALOG.manuals).find(m => m.id === altId)
                            : null;
                        
                        if (altObj) {
                            const altInfo = {
                                id: altId,
                                title: altObj.title,
                                author: altObj.author,
                                publisher: altObj.publisher,
                                pages: altObj.pages,
                                price: altObj.price,
                                chapters: []
                            };
                            
                            // Carica indice del manuale alternativo
                            if (altObj.filepath) {
                                try {
                                    const altData = await fetch(altObj.filepath).then(r => r.json());
                                    if (altData.chapters && altData.chapters.length > 0) {
                                        altInfo.chapters = altData.chapters.map((cap, i) => 
                                            `${i+1}. ${cap.title || cap}`
                                        );
                                        console.log(`‚úÖ Indice alternativo "${altId}" caricato (${altData.chapters.length} capitoli)`);
                                    }
                                } catch (err) {
                                    console.warn(`‚ö†Ô∏è Errore caricamento indice alternativo "${altId}":`, err);
                                }
                            }
                            
                            manualiAlternativiInfo.push(altInfo);
                        }
                    }
                    
                    console.log('üìö Manuali alternativi con indici:', manualiAlternativiInfo.length);
                    
                    // Costruisci sezione manuali alternativi per il prompt
                    let manualiAlternativiSection = '';
                    if (manualiAlternativiInfo.length > 0) {
                        manualiAlternativiSection = `
MANUALI ALTERNATIVI IN BIBLIOGRAFIA:
${manualiAlternativiInfo.map((alt, idx) => `
**Alternativo ${idx+1}**:
- Titolo: ${alt.title}
- Autore: ${alt.author}
- Editore: ${alt.publisher}
- Pagine: ${alt.pages}
- Prezzo: ‚Ç¨${alt.price}
- INDICE:
${alt.chapters.length > 0 ? alt.chapters.map(cap => `  ${cap}`).join('\n') : '  Indice non disponibile'}
`).join('\n')}`;
                    } else {
                        manualiAlternativiSection = 'NESSUN MANUALE ALTERNATIVO IN BIBLIOGRAFIA';
                    }
                    
                    const motivazioniPrompt = `Sei un esperto di analisi editoriale universitaria e strategie commerciali per case editrici.

PROGRAMMA DIDATTICO:
${testo.substring(0, 6000)}

ANALISI PRELIMINARE GI√Ä EFFETTUATA:
${JSON.stringify(fase0, null, 2)}

MANUALE PRINCIPALE ADOTTATO:
- Titolo: ${manualeInfo.title}
- Autore: ${manualeInfo.author}
- Editore: ${manualeInfo.publisher}
- Pagine: ${manualeInfo.pages}
- Prezzo: ‚Ç¨${manualeInfo.price}

INDICE MANUALE PRINCIPALE:
${indiceManualePrincipale}

${manualiAlternativiSection}

CONTESTO:
- Materia: ${materiaName}
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}

---

## COMPITO: Analisi Strategica in 3 Parti

### PARTE 1: Perch√© Ha Scelto il Manuale Principale?

Analizza i **fattori decisivi** (3-5 motivazioni con peso alto/medio/basso ed evidenza concisa).
Identifica la **natura della scelta**: convinta | ereditata | compromesso
Elenca le **3 priorit√† TOP** del docente.

### PARTE 2: Relazione tra Testi in Bibliografia

${manualiAlternativiInfo.length > 0 ? `
**IMPORTANTE**: Hai gli INDICI completi. Usali per analisi precise!

Per OGNI manuale alternativo:
- **Ruolo**: approfondimento | semplificazione | esercizi | modulo_specifico | alternativa_studenti | riferimento_generale
- **Cosa rivela**: Perch√© √® stato aggiunto? Quale GAP compensa? (confronta indici)

**Analisi Combinazione**: Perch√© il docente usa QUESTA combinazione di testi?

**Cosa Verificare con il Docente**: Suggerimento strategico per il promotore su COSA INDAGARE nel colloquio con il docente.
NON formulare una domanda, ma indicare COSA il promotore dovrebbe verificare/investigare.
Esempio: "Verificare con il docente quali capitoli di X sono effettivamente utilizzati in aula e per quali argomenti. Se confermato uso sistematico, proporre manuale Zanichelli che unifichi principale + alternativo, evidenziando risparmio per studenti."
` : `
**NOTA**: Non ci sono alternativi. Salta questa sezione.
`}

### PARTE 3: Profilo Decisionale del Docente

- Cosa cerca (3 esigenze)
- Cosa evita (2 caratteristiche sgradite)
- Sensibilit√† prezzo: alta | media | bassa
- Familiarit√† Zanichelli: alta | media | bassa | nulla (in base editore attuale)
- Apertura cambio principale: alta | media | bassa
- Apertura integrazione alternativo: alta | media | bassa

---

## LINEE GUIDA:
‚úÖ USA linguaggio qualitativo ("probabilmente", "sembra")
‚úÖ BASA tutto su programma, indici, analisi preliminare
‚úÖ CONFRONTA indici per gap precisi
‚ùå NO dati numerici inventati
‚ùå NO affermazioni categoriche

---

FORMATO OUTPUT (JSON):
{
  "scelta_manuale_principale": {
    "motivazioni": [
      {
        "fattore": "string (max 100 caratteri)",
        "peso": "alto|medio|basso",
        "evidenza": "string (max 200 caratteri)"
      }
    ],
    "natura_scelta": {
      "tipo": "convinta|ereditata|compromesso",
      "confidenza": "alta|media|bassa",
      "spiegazione": "string (max 250 caratteri)"
    },
    "priorita_docente": ["string", "string", "string"]
  },
  "relazione_testi_bibliografia": {
    "testi_alternativi_presenti": ${manualiAlternativiInfo.length > 0 ? 'true' : 'false'},
    "analisi_combinazione": ${manualiAlternativiInfo.length > 0 ? '"string (max 500 caratteri)"' : 'null'},
    "dettaglio_alternativi": ${manualiAlternativiInfo.length > 0 ? `[
      {
        "titolo": "string",
        "autore": "string",
        "ruolo": "approfondimento|semplificazione|esercizi|modulo_specifico|alternativa_studenti|riferimento_generale",
        "cosa_rivela": "string (max 250 caratteri)"
      }
    ]` : '[]'},
    "domanda_chiave": ${manualiAlternativiInfo.length > 0 ? '"Suggerimento strategico: cosa verificare/indagare con il docente (max 300 caratteri)"' : 'null'}
  },
  "profilo_decisionale": {
    "cosa_cerca": ["string", "string", "string"],
    "cosa_evita": ["string", "string"],
    "sensibilita_prezzo": "alta|media|bassa",
    "familiarita_zanichelli": "alta|media|bassa|nulla",
    "apertura_cambio_principale": "alta|media|bassa",
    "apertura_integrazione_alternativo": "alta|media|bassa"
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                    const motivazioniResponse = await callLLM(motivazioniPrompt, 0.3);
                    console.log('üì• FASE 0.5 AVANZATA RAW RESPONSE (primi 300 char):', motivazioniResponse.substring(0, 300));
                    
                    const sanitizedResponse = sanitizeJSON(motivazioniResponse);
                    motivazioniScelta = JSON.parse(sanitizedResponse);
                    
                    // Salva per uso in FASE 5.5 e per il report
                    window.currentMotivazioniScelta = motivazioniScelta;
                    
                    console.log('‚úÖ Fase 0.5 Avanzata (Logica Scelta Editoriale) completata:', motivazioniScelta);
                } catch (error) {
                    console.error('‚ùå FASE 0.5 AVANZATA ERROR:', error);
                    console.warn('‚ö†Ô∏è Fase 0.5 Avanzata (Logica Scelta Editoriale) fallita, continuo comunque:', error.message);
                    // Non blocco l'analisi se questa fase fallisce
                }

                // Fase 1: Estrai metadata
                updateLoadingText('Fase 1/5: Estrazione metadata...');
                
                let metadataObj;
                try {
                    const metadata = await callLLM(`Estrai i metadati da questo programma universitario di ${materiaName}.

IMPORTANTE: Rispondi ESCLUSIVAMENTE con un oggetto JSON valido.
Usa SEMPRE virgolette doppie, non apici singoli.
Se un campo non √® presente, usa stringa vuota "".

TESTO DEL PROGRAMMA:
${testo.substring(0, 2000)}

Estrai questi campi e rispondi SOLO con questo JSON:

{
  "universita": "nome universita (senza accenti nei nomi campo)",
  "corso_laurea_nome": "nome corso di laurea",
  "denominazione_corso": "nome insegnamento",
  "docente": "nome docente"
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`, 0.1);

                    console.log('üìù Risposta Fase 1 (lunghezza):', metadata.length);
                    metadataObj = JSON.parse(sanitizeJSON(metadata));
                    console.log('‚úÖ Fase 1 completata:', metadataObj);
                } catch (error) {
                    console.error('‚ùå ERRORE Fase 1:', error.message);
                    throw new Error('Fase 1 fallita: ' + error.message);
                }

                // Fase 2: Analizza programma (TEMPERATURE ABBASSATA A 0.1 per massima coerenza)
                updateLoadingText('Fase 2/5: Valutazione programma (5 dimensioni)...');
                
                // Costruzione dinamica del prompt basato sul framework caricato
                const frameworkData = CURRENT_FRAMEWORK;
                if (!frameworkData || !frameworkData.content) {
                    throw new Error('Framework non caricato. Seleziona prima un framework valido.');
                }
                const moduliList = frameworkData.content.syllabus_modules.map((mod, idx) => {
                    const modNum = String(idx + 1).padStart(2, '0');
                    const keyConcepts = mod.key_concepts.map(k => typeof k === 'string' ? k : k.concetto).join(', ');
                    return `   MOD-${modNum} ${mod.name} (0-13): ${keyConcepts}`;
                }).join('\n');
                
                const profilesList = frameworkData.content.program_profiles.map(prof => {
                    return `   - ${prof.name}: ${prof.priority_modules}`;
                }).join('\n');
                
                // Genera evaluation_criteria se esistono
                let evaluationCriteriaText = '';
                if (frameworkData.content.evaluation_criteria) {
                    const criteriaEntries = Object.entries(frameworkData.content.evaluation_criteria);
                    if (criteriaEntries.length > 0) {
                        evaluationCriteriaText = '\nCRITERI DI VALUTAZIONE SPECIFICI PER ' + materiaName.toUpperCase() + ':\n' +
                            criteriaEntries.map(([key, value]) => `   ‚Ä¢ ${value}`).join('\n') + '\n';
                        console.log('‚úÖ FASE 2: Inclusi ' + criteriaEntries.length + ' evaluation_criteria per ' + materiaName);
                    }
                } else {
                    console.log('‚ÑπÔ∏è FASE 2: Nessun evaluation_criteria per ' + materiaName);
                }
                
                const valutazione = await callLLM( `Analizza questo programma universitario di ${materiaName} secondo il FRAMEWORK DI VALUTAZIONE STRUTTURATO.

CONTESTO:
- Materia: ${materiaName}
- Framework: ${frameworkName}
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

TESTO PROGRAMMA:
${testo}

FRAMEWORK DI VALUTAZIONE (270 punti totali):

1. OBIETTIVI FORMATIVI (max 40 punti):
   - Completezza (0-10): Quanto sono completi e articolati
   - Chiarezza e Misurabilit√† (0-10): Quanto sono espliciti e misurabili
   - Coerenza con standard accademici (0-10): Allineamento con standard nazionali/internazionali
   - Interdisciplinarit√† (0-10): Collegamenti con altre discipline

2. CONTENUTI PROGRAMMATICI (max 130 punti):
   Valuta la copertura dei MODULI del framework ${frameworkName} basandoti sulle PRIORIT√Ä per ${contesto}:
   
${moduliList}
   
   PRIORIT√Ä SPECIFICHE PER CLASSE DI LAUREA:
${profilesList}
${evaluationCriteriaText}   
   Organizzazione didattica e materiale (0-13): Qualit√† supporti, esercizi, esempi

3. METODOLOGIA DIDATTICA (max 40 punti):
   - Didattica attiva (0-10): Esercizi, problem solving, casi studio
   - Materiali didattici (0-10): Variet√† e qualit√† supporti
   - Valutazione e feedback (0-10): Modalit√† valutazione chiare
   - Supporto allo studente (0-10): Risorse di supporto

4. ALLINEAMENTO CURRICULUM (max 30 punti):
   - Coerenza con altri moduli (0-10): Integrazione con altri insegnamenti
   - Progressione didattica (0-10): Sequenza logica argomenti
   - Flessibilit√† e personalizzazione (0-10): Adattabilit√† percorsi

5. RISULTATI ATTESI (max 30 punti):
   - Competenze tecnico-scientifiche (0-10): Solide basi teoriche
   - Competenze trasversali (0-10): Comunicazione, problem solving
   - Preparazione professionale (0-10): Applicabilit√† professionale

GIUDIZI QUALITATIVI per ogni dimensione:
- Obiettivi: Eccellente / Buono / Sufficiente / Carente
- Contenuti: Molto completo / Completo / Parziale / Limitato
- Metodologia: Innovativa / Tradizionale efficace / Basilare / Assente
- Allineamento: Perfettamente allineato / Allineato / Parzialmente allineato / Non allineato
- Risultati: Chiaramente definiti / Definiti / Vaghi / Non specificati

${evaluationCriteriaText ? `
‚ö†Ô∏è IMPORTANTE: Rispondi ai CRITERI DI VALUTAZIONE SPECIFICI nel campo "analisi_criteri":
${evaluationCriteriaText}` : ''}

Rispondi SOLO con un JSON valido:
{
  "obiettivi": {"punteggio": numero_su_40, "giudizio": "...", "note": "..."},
  "contenuti": {"punteggio": numero_su_130, "giudizio": "...", "note": "...", "argomenti_principali": ["..."], "moduli_coperti": ["MOD-01", "MOD-05", ...]},
  "metodologia": {"punteggio": numero_su_40, "giudizio": "...", "note": "..."},
  "allineamento": {"punteggio": numero_su_30, "giudizio": "...", "note": "..."},
  "risultati": {"punteggio": numero_su_30, "giudizio": "...", "note": "..."},${evaluationCriteriaText ? `
  "analisi_criteri": {
    "growth_models": "risposta concisa al criterio growth_models",
    "macro_models_included": "risposta concisa al criterio macro_models_included",
    "macro_sequence": "risposta concisa al criterio macro_sequence",
    "micro_models_focus": "risposta concisa al criterio micro_models_focus",
    "school_of_thought": "risposta concisa al criterio school_of_thought"
  },` : ''}
  "sintesi": "sintesi generale considerando le priorit√† specifiche per ${contesto}"
}`, 0.1);

                const valutazioneObj = JSON.parse(sanitizeJSON(valutazione));
                const totale = valutazioneObj.obiettivi.punteggio + valutazioneObj.contenuti.punteggio + 
                               valutazioneObj.metodologia.punteggio + valutazioneObj.allineamento.punteggio + 
                               valutazioneObj.risultati.punteggio;

                // Fase 2b: Analisi Avanzata - Insights per Adozione (SOLO se Analisi Avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Fase 2b/5: Analisi avanzata insights adozione...');
                    
                    try {
                        const insightsPrompt = `Basandoti ESCLUSIVAMENTE sulla valutazione del programma gia' effettuata, genera insights per un promotore editoriale.

CONTESTO GIA' ANALIZZATO (NON ripetere queste informazioni):
- Profilo docente: ${fase0?.profilo_docente_insights?.tipo_docente || 'N/D'} ‚Äî ${fase0?.profilo_docente_insights?.sensibilita_chiave?.substring(0, 150) || 'N/D'}
- Approccio pedagogico: ${fase0?.profilo_pedagogico?.approccio || 'N/D'} (${fase0?.profilo_pedagogico?.stile || 'N/D'})
- Orientamento: ${fase0?.profilo_pedagogico?.orientamento || 'N/D'}
- Distribuzione tematica: ${JSON.stringify(fase0?.quadro_generale?.distribuzione_tematica || [])}
${motivazioniScelta ? `- Logica scelta editoriale: GIA' ANALIZZATA (il promotore conosce le motivazioni del docente)` : ''}

VALUTAZIONE PROGRAMMA GIA' EFFETTUATA:
${JSON.stringify(valutazioneObj, null, 2)}

${valutazioneObj.analisi_criteri ? `
CRITERI SPECIFICI IDENTIFICATI:
${JSON.stringify(valutazioneObj.analisi_criteri, null, 2)}
` : ''}

‚ö†Ô∏è REGOLA ANTI-RIDONDANZA CRITICA:
Il promotore ha GIA' letto nel report:
1. Il quadro generale del programma (distribuzione tematica, complessita')
2. Il profilo del docente (tipo, sensibilita', approccio consigliato)
3. Le motivazioni della scelta editoriale attuale
NON ripetere NESSUNA di queste informazioni.
Il tuo compito e' AGGIUNGERE SOLO insights COMMERCIALI che NON sono ancora nel report.

‚ö†Ô∏è REGOLA DI SPECIFICITA' per "Opportunita' Manuale":
NON descrivere il manuale ideale generico.
Descrivi ESATTAMENTE cosa manca nell'ecosistema didattico attuale 
di questo docente (manuale + alternativi + dispense + metodologia) 
che un prodotto Zanichelli specifico potrebbe colmare.

‚úÖ FAI NOMI di manuali Zanichelli dal catalogo disponibile.

CATALOGO ZANICHELLI DISPONIBILE (usa questi nomi):
${MANUAL_CATALOG && MANUAL_CATALOG.manuals ? 
  MANUAL_CATALOG.manuals
    .filter(m => m.publisher === 'Zanichelli' || m.type === 'zanichelli')
    .map(m => '- ' + m.title + (m.author ? ' (' + m.author + ')' : ''))
    .join('\n')
  : 'Catalogo non disponibile'}

IMPORTANTE:
- NON inventare dati numerici (ore, percentuali precise, costi)
- NON usare punteggi, percentuali, frazioni (es. 95/100, 240/270) o numeri tecnici nelle descrizioni ‚Äî traduci TUTTO in linguaggio commerciale qualitativo
- Basa tutto SOLO sulla valutazione gia' fatta
- Usa linguaggio qualitativo: "potrebbe", "tendenzialmente", "in generale"
- NON fare affermazioni categoriche senza evidenza dal programma

Per "Punti Forza Programma" e "Aspetti Migliorabili":
NON riformulare cio' che e' gia' nella Fase 1 o nel profilo docente.
Concentrati SOLO su implicazioni COMMERCIALI:
- Quali punti di forza rendono PIU' FACILE proporre Zanichelli?
- Quali aspetti migliorabili creano OPPORTUNITA' per un manuale diverso?
- Quali caratteristiche LIMITANO le possibilita' di cambio?

Genera un JSON con questa struttura:

{
  "insights_adozione": {
    "punti_forza_programma": [
      "forza1 commercialmente rilevante (es: 'Metodologia TBL facilita dimostrazione valore aggiunto Zanichelli')",
      "forza2 con stesso formato"
    ],
    "aspetti_migliorabili": [
      "aspetto1 che crea opportunita' (es: 'Gap termochimica apre spazio per proposta Bertini')",
      "aspetto2 con stesso formato"
    ],
    "opportunita_manuale": "Descrizione SPECIFICA (150-200 parole) con NOMI di manuali Zanichelli che risolvono gap identificati. Esempio: 'Il docente compensa lacune di Arnesano sulla termochimica usando Kotz come approfondimento ‚Äî Bertini struttura, propriet√† e trasformazioni coprirebbe entrambe le esigenze in un unico volume...'"
  }${valutazioneObj.analisi_criteri ? `,
  "analisi_criteri_approfondita": {
    "implicazioni_didattiche": "Analisi (200-300 parole) di cosa significano i criteri identificati per la scelta del manuale. Es: se programma e' Keynesiano, quale tipo di manuale serve? Se sequenza e' Breve->Lungo, cosa cercare?",
    "compatibilita_manuale_ideale": "Descrizione del manuale ideale che rispetta questi criteri CON NOMI specifici di manuali Zanichelli"
  }` : ''}
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                        const insightsResponse = await callLLM(insightsPrompt, 0.2);
                        const insightsObj = JSON.parse(sanitizeJSON(insightsResponse));
                        
                        // Aggiungi a valutazioneObj
                        valutazioneObj.insights_adozione = insightsObj.insights_adozione;
                        if (insightsObj.analisi_criteri_approfondita) {
                            valutazioneObj.analisi_criteri_approfondita = insightsObj.analisi_criteri_approfondita;
                        }
                        console.log('‚úÖ Fase 2b (Avanzata) completata');
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Fase 2b (Avanzata) fallita, continuo comunque:', error.message);
                    }
                }

                // Fase 3: Gap analysis vs manuale adottato (TEMPERATURE ABBASSATA A 0.1)
                updateLoadingText('Fase 3/5: Analisi gap con manuale adottato...');
                const manualeInfo = MANUALI_DB[manuale] || {};
                
                // Carica indice completo del manuale adottato (se presente nel catalogo)
                let indiceManualeAdottato = '';
                try {
                    console.log(`üîç Ricerca manuale adottato nel MANUAL_CATALOG: "${manuale}"`);
                    // Ricerca pi√π precisa: priorit√† a ID esatto, poi match parziali pi√π stringenti
                    const catalogEntryAdottato = MANUAL_CATALOG.manuals.find(m => m.id === manuale) ||
                        MANUAL_CATALOG.manuals.find(m => {
                            const manualeWords = manuale.toLowerCase().split(/[_\s-]+/);
                            const titleWords = m.title.toLowerCase().split(/[_\s-]+/);
                            const authorWords = (m.author || '').toLowerCase().split(/[_\s-]+/);
                            // Match se almeno 2 parole del manuale appaiono nel titolo o 1 parola nel titolo + 1 nell'autore
                            const titleMatches = manualeWords.filter(w => w.length > 2 && titleWords.some(tw => tw.includes(w) || w.includes(tw)));
                            const authorMatches = manualeWords.filter(w => w.length > 2 && authorWords.some(aw => aw.includes(w) || w.includes(aw)));
                            return titleMatches.length >= 2 || (titleMatches.length >= 1 && authorMatches.length >= 1);
                        });
                    
                    if (catalogEntryAdottato && catalogEntryAdottato.filepath) {
                        console.log(`‚úÖ Manuale adottato trovato nel catalog: ${catalogEntryAdottato.title}`);
                        const manualeAdottatoData = await fetch(catalogEntryAdottato.filepath).then(r => r.json());
                        if (manualeAdottatoData.chapters && manualeAdottatoData.chapters.length > 0) {
                            indiceManualeAdottato = '\n\nINDICE COMPLETO DEL MANUALE ADOTTATO:\n' + manualeAdottatoData.chapters.map(ch => 
                                `   ${ch.number}. ${ch.title}`
                            ).join('\n');
                            console.log(`‚úÖ Indice manuale adottato caricato (${manualeAdottatoData.chapters.length} capitoli)`);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è Manuale adottato "${manuale}" non trovato nel MANUAL_CATALOG`);
                    }
                } catch (err) {
                    console.warn(`‚ö†Ô∏è Impossibile caricare indice del manuale adottato:`, err.message);
                }
                
                // Costruzione dinamica del prompt basato sul framework caricato
                const frameworkData3 = CURRENT_FRAMEWORK;
                if (!frameworkData3 || !frameworkData3.content) {
                    throw new Error('Framework non caricato. Seleziona prima un framework valido.');
                }
                const moduliList3 = frameworkData3.content.syllabus_modules.map((mod, idx) => {
                    const modNum = String(idx + 1).padStart(2, '0');
                    return `   - MOD-${modNum} ${mod.name}`;
                }).join('\n');
                
                const profilesList3 = frameworkData3.content.program_profiles.map(prof => {
                    return `   - ${prof.name}: ${prof.priority_modules}`;
                }).join('\n');
                
                // Genera evaluation_criteria se esistono (Fase 3)
                let evaluationCriteriaText3 = '';
                if (frameworkData3.content.evaluation_criteria) {
                    const criteriaEntries = Object.entries(frameworkData3.content.evaluation_criteria);
                    if (criteriaEntries.length > 0) {
                        evaluationCriteriaText3 = '\nCRITERI DI VALUTAZIONE SPECIFICI PER ' + materiaName.toUpperCase() + ':\n' +
                            criteriaEntries.map(([key, value]) => `   ‚Ä¢ ${value}`).join('\n') + '\n';
                        console.log('‚úÖ FASE 3: Inclusi ' + criteriaEntries.length + ' evaluation_criteria per ' + materiaName);
                    }
                } else {
                    console.log('‚ÑπÔ∏è FASE 3: Nessun evaluation_criteria per ' + materiaName);
                }
                
                // Prompt diverso per Base vs Avanzata
                const istruzioniDettaglio = tipoAnalisi === 'avanzata' ? `
MODALIT√Ä ANALISI AVANZATA:
- Per ogni punto di forza/debolezza, fornisci una spiegazione dettagliata (1-2 frasi) con esempi concreti dal contenuto del manuale
- Nel campo "note", scrivi un'analisi dettagliata (100-150 parole) che spieghi:
  * Come il manuale tratta gli argomenti chiave del programma
  * Limitazioni specifiche con esempi concreti
  * Conseguenze per gli studenti
- Usa linguaggio descrittivo e professionale, evita percentuali generiche` : `
MODALIT√Ä ANALISI BASE:
- Punti di forza/debolezza sintetici (1 frase ciascuno)
- Note concise (50-100 parole)`;
                
                const gapManuale = await callLLM( `Valuta il manuale "${manuale}" (${manualeInfo.editore || ''}) rispetto a questo programma di ${materiaName} usando il FRAMEWORK DI VALUTAZIONE MANUALI.${istruzioniDettaglio}

MATERIA: ${materiaName}
FRAMEWORK: ${frameworkName}

PROGRAMMA:
${testo}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

MANUALE ADOTTATO: ${manuale}
EDITORE: ${manualeInfo.editore || 'N/D'}${indiceManualeAdottato}

CARATTERISTICHE MANUALE:
${JSON.stringify(manualeInfo.caratteristiche || [])}

FRAMEWORK VALUTAZIONE MANUALI (270 punti):
Valuta il manuale su 5 criteri principali considerando le PRIORIT√Ä per ${contesto}:

1. OBIETTIVI FORMATIVI (max 40):
   - Completezza, Chiarezza, Coerenza standard, Interdisciplinarit√†

2. CONTENUTI PROGRAMMATICI (max 130):
   Valuta copertura dei MODULI del framework ${frameworkName} rispetto al programma:
${moduliList3}
   
   PRIORIT√Ä SPECIFICHE PER CLASSE DI LAUREA:
${profilesList3}
${evaluationCriteriaText3}

3. METODOLOGIA DIDATTICA (max 40):
   - Didattica attiva, Materiali, Valutazione, Supporto studente

4. ALLINEAMENTO CURRICULUM (max 30):
   - Coerenza moduli, Progressione, Flessibilit√†

5. RISULTATI ATTESI (max 30):
   - Competenze tecnico-scientifiche, trasversali, preparazione professionale

ANALISI DETTAGLIATA:
1. Argomenti del programma COPERTI dal manuale
2. Argomenti del programma NON COPERTI (gap) - CRITICI per ${contesto}
3. Argomenti del manuale ECCEDENTI rispetto al programma
4. PUNTI DI FORZA del manuale per questo programma
5. PUNTI DI DEBOLEZZA del manuale per questo programma

${evaluationCriteriaText3 ? `
‚ö†Ô∏è IMPORTANTE: Valuta la COMPATIBILIT√Ä del manuale rispetto ai CRITERI SPECIFICI identificati nel programma:
- Confronta la scuola di pensiero del programma con quella del manuale
- Confronta la sequenza didattica (breve/lungo periodo)
- Confronta il livello di formalizzazione matematica
- Identifica eventuali INCOMPATIBILIT√Ä FILOSOFICHE O DIDATTICHE
` : ''}

Rispondi SOLO con un JSON valido:
{
  "coperti": ["arg1", "arg2"],
  "gap": ["arg_mancante1", "arg_mancante2"],
  "eccedenti": ["arg_extra1"],
  "punti_forza": ["forza1", "forza2", "forza3"],
  "punti_debolezza": ["debolezza1", "debolezza2"],
  "copertura_percentuale": numero,
  "compatibilita": "Alta/Media/Bassa",
  "punteggio_framework": numero_su_270,${evaluationCriteriaText3 ? `
  "compatibilita_criteri": {
    "scuola_pensiero_programma": "identificata dal programma",
    "scuola_pensiero_manuale": "identificata nel manuale",
    "allineamento_filosofico": "Alta/Media/Bassa con spiegazione",
    "sequenza_programma": "identificata dal programma",
    "sequenza_manuale": "identificata nel manuale",
    "allineamento_didattico": "Alta/Media/Bassa con spiegazione",
    "note_compatibilita": "analisi dettagliata delle compatibilit√†/incompatibilit√†"
  },` : ''}
  "note": "commento dettagliato sulla compatibilit√† considerando le priorit√† ${contesto}",
  "copertura_moduli": [
    {
      "modulo_framework": "Nome del modulo dal framework",
      "capitoli_manuale": "Capitoli corrispondenti dal manuale (es. Cap. 2, Cap. 3)",
      "copertura": "OTTIMA|BUONA|PARZIALE|ASSENTE",
      "nota": "Solo se non OTTIMA: cosa manca o √® insufficiente (max 100 caratteri)"
    }
  ]
}

REGOLE per "copertura_moduli":
- Genera UNA RIGA per OGNI modulo del framework (${frameworkData3.content.syllabus_modules.length} moduli totali)
- OTTIMA: il manuale tratta tutti i core_contents del modulo in modo completo
- BUONA: il manuale copre i contenuti principali ma manca qualche aspetto
- PARZIALE: il manuale tocca l'argomento ma in modo superficiale o incompleto
- ASSENTE: il manuale non tratta l'argomento
- Basa l'analisi ESCLUSIVAMENTE sul confronto tra indice del manuale e core_contents/key_concepts di ogni modulo
- NON ipotizzare contenuti non evidenti dall'indice`, 0.1);

                const gapManualeObj = JSON.parse(sanitizeJSON(gapManuale));

                // Fase 3c: Analisi Avanzata - Insights Adozione Gap (SOLO se Analisi Avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Fase 3c/5: Analisi avanzata impatto gap...');
                    
                    try {
                        const gapInsightsPrompt = `Sei un analista di impatto per promotori editoriali.

Il promotore ha GIA' LETTO queste sezioni del report:
- Profilo docente: ${fase0?.profilo_docente_insights?.tipo_docente || 'N/D'} ‚Äî ${fase0?.profilo_docente_insights?.sensibilita_chiave?.substring(0, 150) || 'N/D'}
- Scelta editoriale: ${motivazioniScelta ? 'analizzata' : 'non disponibile'}
- Valutazione programma: ${valutazioneObj ? totale + '/270' : 'N/D'}
- Insights adozione: ${valutazioneObj?.insights_adozione ? 'GIA analizzati ‚Äî punti forza e aspetti migliorabili COMMERCIALI gia nel report' : 'non disponibili'}
${valutazioneObj?.insights_adozione?.opportunita_manuale ? `- Opportunita manuale gia identificata: "${valutazioneObj.insights_adozione.opportunita_manuale.substring(0, 200)}..."` : ''}

‚ö†Ô∏è REGOLA ANTI-RIDONDANZA CRITICA:
Il promotore CONOSCE GIA':
- I gap del manuale (li hai sotto) ‚Äî NON rielencarli
- Il profilo del docente ‚Äî NON ridescriverlo
- I punteggi di valutazione ‚Äî NON ripeterli
- Le opportunita commerciali e i punti forza ‚Äî NON riformularli
Se una informazione e' gia' nel report, NON la devi ripetere in nessuna forma.

TU DEVI AGGIUNGERE SOLO informazioni NUOVE:
1. L'IMPATTO PRATICO di ogni gap: cosa deve fare il docente per compensare?
2. Il COSTO DELL'INAZIONE: cosa succede se il docente non cambia manuale?
3. I BENEFICI CONCRETI del cambio: non generici, specifici per QUESTO programma

ANALISI GAP GIA' EFFETTUATA:
- Manuale analizzato: ${manuale}
- Gap identificati: ${JSON.stringify(gapManualeObj.gap || [])}
- Punti debolezza: ${JSON.stringify(gapManualeObj.punti_debolezza || [])}
- Compatibilita': ${gapManualeObj.compatibilita}
- Copertura: ${gapManualeObj.copertura_percentuale}%

${gapManualeObj.compatibilita_criteri ? `
INCOMPATIBILITA' CRITERI SPECIFICI:
${JSON.stringify(gapManualeObj.compatibilita_criteri, null, 2)}
` : ''}

IMPORTANTE:
- NON inventare dati numerici (ore, percentuali precise, costi)
- NON usare punteggi, percentuali, frazioni (es. 95/100, 240/270) o numeri tecnici nelle descrizioni ‚Äî traduci TUTTO in linguaggio commerciale qualitativo
- NON riformulare i gap ‚Äî il promotore li conosce gia'
- Concentrati SOLO su impatto pratico e conseguenze concrete
- Sii specifico: "il docente dovra' preparare dispense su X" non "il docente avra' difficolta'"

Genera un JSON con questa struttura:

{
  "analisi_impatto_adozione": {
    "gap_critici_insegnamento": [
      {
        "gap": "gap identificato dall'analisi (breve, max 10 parole)",
        "possibile_impatto_docente": "Cosa il docente potrebbe dover fare concretamente per compensare questo gap (es: preparare dispense, cercare materiale esterno, dedicare ore extra)",
        "possibile_impatto_studenti": "Come questo gap potrebbe influenzare la preparazione degli studenti in modo specifico"
      }
    ],
    "costo_inazione": "Cosa succede se il docente NON cambia manuale? Descrizione concreta (100-150 parole) delle conseguenze pratiche per docente e studenti",
    "benefici_potenziali_cambio": "Cosa migliorerebbe CONCRETAMENTE con un manuale piu' allineato (100-150 parole) ‚Äî NON ripetere i gap, descrivi i benefici positivi"
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                        const gapInsightsResponse = await callLLM(gapInsightsPrompt, 0.2);
                        const gapInsightsObj = JSON.parse(sanitizeJSON(gapInsightsResponse));
                        
                        // Aggiungi a gapManualeObj
                        gapManualeObj.analisi_impatto_adozione = gapInsightsObj.analisi_impatto_adozione;
                        console.log('‚úÖ Fase 3c (Avanzata) completata');
                        
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Fase 3c (Avanzata) fallita, continuo comunque:', error.message);
                    }
                }

                // Fase 3b: Analisi gap manuali alternativi (se presenti)
                const gapAlternativi = [];
                if (manualiAlternativi.length > 0) {
                    updateLoadingText(`Fase 3b/4: Analisi ${manualiAlternativi.length} manuali alternativi...`);
                    
                    for (const manualeAlt of manualiAlternativi) {
                        console.log(`üîç Elaborazione manuale alternativo: "${manualeAlt}"`);
                        const manualeInfo = MANUALI_DB[manualeAlt] || {};
                        
                        // Carica indice completo del manuale alternativo dal JSON
                        let indiceManuale = '';
                        try {
                            console.log(`üìö Ricerca nel MANUAL_CATALOG per ID: "${manualeAlt}"`);
                            const catalogEntry = MANUAL_CATALOG.manuals.find(m => m.id === manualeAlt);
                            
                            if (!catalogEntry) {
                                console.warn(`‚ùå Manuale "${manualeAlt}" NON trovato nel MANUAL_CATALOG`);
                                console.log(`üìã Manuali disponibili:`, MANUAL_CATALOG.manuals.map(m => m.id).join(', '));
                            } else {
                                console.log(`‚úÖ Trovato nel catalog:`, catalogEntry.title, `- filepath: ${catalogEntry.filepath}`);
                                
                                if (catalogEntry.filepath) {
                                    console.log(`üîÑ Caricamento file JSON: ${catalogEntry.filepath}`);
                                    const manualeData = await fetch(catalogEntry.filepath).then(r => r.json());
                                    console.log(`üìñ File caricato, capitoli trovati: ${manualeData.chapters?.length || 0}`);
                                    
                                    if (manualeData.chapters && manualeData.chapters.length > 0) {
                                        // Include TUTTI i capitoli (non limitare a 15)
                                        indiceManuale = '\n   INDICE:\n' + manualeData.chapters.map(ch => 
                                            `   ${ch.number}. ${ch.title}`
                                        ).join('\n');
                                        console.log(`‚úÖ Indice generato (${manualeData.chapters.length} capitoli)`);
                                    }
                                }
                            }
                        } catch (err) {
                            console.error(`‚ö†Ô∏è Errore caricamento indice di ${manualeAlt}:`, err);
                        }
                        
                        const gapAlt = await callLLM(`Valuta il manuale "${manualeAlt}" (${manualeInfo.editore || ''}) rispetto a questo programma di ${materiaName} usando il FRAMEWORK DI VALUTAZIONE MANUALI.${istruzioniDettaglio}

MATERIA: ${materiaName}
FRAMEWORK: ${frameworkName}

PROGRAMMA:
${testo}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

MANUALE ALTERNATIVO: ${manualeAlt}
EDITORE: ${manualeInfo.editore || 'N/D'}${indiceManuale}

CARATTERISTICHE MANUALE:
${JSON.stringify(manualeInfo.caratteristiche || [])}

FRAMEWORK VALUTAZIONE MANUALI (270 punti):
Valuta il manuale su 5 criteri principali considerando le PRIORIT√Ä per ${contesto}:

1. OBIETTIVI FORMATIVI (max 40):
   - Completezza, Chiarezza, Coerenza standard, Interdisciplinarit√†

2. CONTENUTI PROGRAMMATICI (max 130):
   Valuta copertura dei MODULI del framework ${frameworkName} rispetto al programma:
${moduliList3}
   
   PRIORIT√Ä SPECIFICHE PER CLASSE DI LAUREA:
${profilesList3}
${evaluationCriteriaText3}

3. METODOLOGIA DIDATTICA (max 40):
   - Didattica attiva, Materiali, Valutazione, Supporto studente

4. ALLINEAMENTO CURRICULUM (max 30):
   - Coerenza moduli, Progressione, Flessibilit√†

5. RISULTATI ATTESI (max 30):
   - Competenze tecnico-scientifiche, trasversali, preparazione professionale

ANALISI DETTAGLIATA:
1. Argomenti del programma COPERTI dal manuale
2. Argomenti del programma NON COPERTI (gap) - CRITICI per ${contesto}
3. Argomenti del manuale ECCEDENTI rispetto al programma
4. PUNTI DI FORZA del manuale per questo programma
5. PUNTI DI DEBOLEZZA del manuale per questo programma

${evaluationCriteriaText3 ? `
‚ö†Ô∏è IMPORTANTE: Valuta la COMPATIBILIT√Ä del manuale rispetto ai CRITERI SPECIFICI identificati nel programma:
- Confronta la scuola di pensiero del programma con quella del manuale
- Confronta la sequenza didattica (breve/lungo periodo)
- Confronta il livello di formalizzazione matematica
` : ''}

Rispondi SOLO con un JSON valido:
{
  "manuale": "${manualeAlt}",
  "coperti": ["arg1", "arg2"],
  "gap": ["arg_mancante1", "arg_mancante2"],
  "eccedenti": ["arg_extra1"],
  "punti_forza": ["forza1", "forza2", "forza3"],
  "punti_debolezza": ["debolezza1", "debolezza2"],
  "copertura_percentuale": numero,
  "compatibilita": "Alta/Media/Bassa",
  "punteggio_framework": numero_su_270,${evaluationCriteriaText3 ? `
  "compatibilita_criteri": {
    "scuola_pensiero_manuale": "identificata",
    "allineamento_filosofico": "Alta/Media/Bassa",
    "note": "breve nota compatibilit√†"
  },` : ''}
  "note": "commento dettagliato sulla compatibilit√† considerando le priorit√† ${contesto}"
}`, 0.1);

                        try {
                            console.log(`Risposta GPT per ${manualeAlt}:`, gapAlt);
                            const gapAltObj = JSON.parse(sanitizeJSON(gapAlt));
                            console.log(`JSON parsed per ${manualeAlt}:`, gapAltObj);
                            gapAlternativi.push(gapAltObj);
                        } catch (e) {
                            console.error(`Errore parsing gap ${manualeAlt}:`, e);
                            console.error(`Risposta raw:`, gapAlt);
                        }
                    }
                }

                // Funzione per mostrare UI di selezione manuali
                const mostraSelezioneManualiFn = (manuali, materia, cfu, classe) => {
                    return new Promise((resolve) => {
                        // Crea overlay modal
                        const overlay = document.createElement('div');
                        overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
                        
                        // Crea modal
                        const modal = document.createElement('div');
                        modal.className = 'bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col';
                        modal.style.cssText = 'background: white; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;';
                        
                        // Header
                        const header = document.createElement('div');
                        header.className = 'p-6 border-b border-gray-200';
                        header.innerHTML = `
                            <h3 class="text-xl font-bold text-gray-900 mb-2">üìö Selezione Manuali Zanichelli</h3>
                            <p class="text-sm text-gray-600">
                                Ho trovato <strong>${manuali.length} manuali</strong> Zanichelli per ${materia}.<br>
                                Seleziona quali valutare (massimo 5, consigliato 3-5):
                            </p>
                        `;
                        
                        // Body (scrollable)
                        const body = document.createElement('div');
                        body.className = 'p-6 overflow-y-auto flex-1';
                        body.style.cssText = 'overflow-y: auto; flex: 1;';
                        
                        // Lista manuali con checkbox
                        const checkboxes = [];
                        manuali.forEach((manuale, idx) => {
                            const item = document.createElement('div');
                            item.className = 'flex items-start p-3 hover:bg-gray-50 rounded-lg transition mb-2';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `manual-${idx}`;
                            checkbox.className = 'mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500';
                            checkbox.dataset.manualId = manuale.id;
                            checkboxes.push(checkbox);
                            
                            const label = document.createElement('label');
                            label.htmlFor = `manual-${idx}`;
                            label.className = 'ml-3 flex-1 cursor-pointer';
                            label.innerHTML = `
                                <div class="font-medium text-gray-900">${manuale.author} - ${manuale.title}</div>
                                <div class="text-sm text-gray-500">${manuale.chapters_count || 0} capitoli</div>
                            `;
                            
                            item.appendChild(checkbox);
                            item.appendChild(label);
                            body.appendChild(item);
                        });
                        
                        // Footer
                        const footer = document.createElement('div');
                        footer.className = 'p-6 border-t border-gray-200 bg-gray-50';
                        
                        const counter = document.createElement('div');
                        counter.className = 'text-sm text-gray-600 mb-3';
                        counter.id = 'selection-counter';
                        counter.textContent = 'Selezionati: 0 / 5';
                        
                        const buttonsContainer = document.createElement('div');
                        buttonsContainer.className = 'flex justify-between items-center';
                        
                        // Pulsante "Seleziona tutti" / "Deseleziona tutti"
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition';
                        toggleBtn.textContent = 'Seleziona tutti';
                        
                        // Pulsante "Procedi"
                        const proceedBtn = document.createElement('button');
                        proceedBtn.className = 'px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed';
                        proceedBtn.textContent = 'Procedi con Analisi ‚Üí';
                        proceedBtn.disabled = true;
                        
                        // Logica counter e validazione
                        const updateCounter = () => {
                            const selected = checkboxes.filter(cb => cb.checked).length;
                            counter.textContent = `Selezionati: ${selected} / 5`;
                            proceedBtn.disabled = selected === 0 || selected > 5;
                            
                            // Disabilita checkbox se gi√† 5 selezionati
                            if (selected >= 5) {
                                checkboxes.forEach(cb => {
                                    if (!cb.checked) cb.disabled = true;
                                });
                            } else {
                                checkboxes.forEach(cb => cb.disabled = false);
                            }
                        };
                        
                        checkboxes.forEach(cb => cb.addEventListener('change', updateCounter));
                        
                        // Toggle all/none
                        toggleBtn.addEventListener('click', () => {
                            const allChecked = checkboxes.every(cb => cb.checked);
                            if (allChecked) {
                                checkboxes.forEach(cb => cb.checked = false);
                                toggleBtn.textContent = 'Seleziona tutti';
                            } else {
                                // Seleziona i primi 5
                                checkboxes.forEach((cb, idx) => cb.checked = idx < 5);
                                toggleBtn.textContent = 'Deseleziona tutti';
                            }
                            updateCounter();
                        });
                        
                        // Procedi con selezione
                        proceedBtn.addEventListener('click', () => {
                            const selectedIds = checkboxes
                                .filter(cb => cb.checked)
                                .map(cb => cb.dataset.manualId);
                            
                            const selectedManuali = manuali.filter(m => selectedIds.includes(m.id));
                            
                            document.body.removeChild(overlay);
                            resolve(selectedManuali);
                        });
                        
                        buttonsContainer.appendChild(toggleBtn);
                        buttonsContainer.appendChild(proceedBtn);
                        footer.appendChild(counter);
                        footer.appendChild(buttonsContainer);
                        
                        modal.appendChild(header);
                        modal.appendChild(body);
                        modal.appendChild(footer);
                        overlay.appendChild(modal);
                        document.body.appendChild(overlay);
                    });
                };

                // Fase 4: Valutazione Manuali Zanichelli (DINAMICA)
                updateLoadingText('Fase 4/5: Valutazione manuali consigliati...');
                
                // Filtra manuali Zanichelli per la materia corrente
                const manualiZanichelliPerMateria = Object.values(MANUAL_CATALOG.manuals).filter(m => 
                    m.type === 'zanichelli' && m.subject === materiaName
                );
                
                console.log(`üìö Trovati ${manualiZanichelliPerMateria.length} manuali Zanichelli per ${materiaName}`);
                
                let zanichelliObj = null;
                
                if (manualiZanichelliPerMateria.length === 0) {
                    console.warn('‚ö†Ô∏è Nessun manuale Zanichelli trovato per questa materia');
                    zanichelliObj = {
                        manuali: [],
                        nota: `Nessun manuale Zanichelli disponibile nel catalogo per ${materiaName}`
                    };
                } else {
                    // FASE 4a: Selezione manuali (manuale se >5, automatica se ‚â§5)
                    let manualiSelezionati = manualiZanichelliPerMateria;
                    let selectionNote = '';
                    
                    if (manualiZanichelliPerMateria.length > 5) {
                        console.log(`üìö Selezione manuale necessaria: ${manualiZanichelliPerMateria.length} manuali disponibili`);
                        
                        // Aggiorna UI per indicare attesa selezione
                        updateLoadingText('‚è∏Ô∏è Attendo selezione manuali...');
                        
                        // Mostra UI di selezione e attendi la scelta dell'utente
                        manualiSelezionati = await mostraSelezioneManualiFn(manualiZanichelliPerMateria, materiaName, cfu, contesto);
                        
                        // Riprendi loading normale
                        updateLoadingText('Fase 4/5: Valutazione manuali selezionati...');
                        
                        // Crea nota per l'utente
                        selectionNote = `‚ÑπÔ∏è SELEZIONE MANUALI: Hai selezionato i seguenti ${manualiSelezionati.length} volumi Zanichelli per la valutazione dettagliata (su ${manualiZanichelliPerMateria.length} disponibili nel catalogo):

${manualiSelezionati.map((m, idx) => `${idx + 1}. ${m.author} - ${m.title} (${m.chapters_count || 0} capitoli)`).join('\n')}`;
                        
                    } else {
                        console.log(`üìö Valutazione automatica: ${manualiZanichelliPerMateria.length} manuali (tutti disponibili)`);
                        manualiSelezionati = manualiZanichelliPerMateria;
                    }
                    
                    // Carica indici completi dei manuali Zanichelli selezionati
                    const manualiConIndici = [];
                    for (const manuale of manualiSelezionati) {
                        let indice = '';
                        try {
                            const manualeData = await fetch(manuale.filepath).then(r => r.json());
                            if (manualeData.chapters && manualeData.chapters.length > 0) {
                                // Include TUTTI i capitoli
                                indice = '\n   INDICE:\n' + manualeData.chapters.map(ch => 
                                    `   ${ch.number}. ${ch.title}`
                                ).join('\n');
                                console.log(`‚úÖ Indice Zanichelli caricato: ${manuale.title} (${manualeData.chapters.length} capitoli)`);
                            }
                        } catch (err) {
                            console.warn(`‚ö†Ô∏è Impossibile caricare indice di ${manuale.title}:`, err.message);
                        }
                        manualiConIndici.push({
                            info: `${manuale.author} - ${manuale.title} (${manuale.pages} pag, ‚Ç¨${manuale.price || 'N/D'})`,
                            indice: indice
                        });
                    }
                    
                    // Genera valutazione dinamica per i manuali Zanichelli
                    const manualiInfo = manualiConIndici.map((m, idx) => 
                        `${idx + 1}. ${m.info}${m.indice}`
                    ).join('\n');
                    
                    const zanichelliPrompt = `Sei un esperto valutatore di manuali universitari.

Valuta la compatibilit√† dei seguenti manuali Zanichelli con questo programma di ${materiaName}:

MANUALI ZANICHELLI DISPONIBILI:
${manualiInfo}

PROGRAMMA DEL CORSO:
${testo}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}
- Framework: ${frameworkName}

PROFILO PEDAGOGICO (Fase 0):
- Approccio: ${fase0.profilo_pedagogico.approccio}
- Livello: ${fase0.profilo_pedagogico.livello}
- Enfasi: ${fase0.profilo_pedagogico.enfasi.join(', ')}

BIBLIOGRAFIA ADOTTATA:
${Array.isArray(manuale) ? manuale.join(' + ') : manuale}

${evaluationCriteriaText3 ? `
ANALISI CRITERI SPECIFICI DEL PROGRAMMA (dalla Fase 2):
${JSON.stringify(valutazioneObj.analisi_criteri || {}, null, 2)}

‚ö†Ô∏è USA QUESTI CRITERI PER LA RACCOMANDAZIONE:
Nella valutazione dei manuali Zanichelli, considera:
- Scuola di pensiero del programma vs scuola del manuale
- Sequenza didattica del programma vs sequenza del manuale
- Livello di formalizzazione richiesto vs livello del manuale
- Modelli trattati nel programma vs modelli nel manuale
` : ''}

COMPITO:
Ordina i manuali Zanichelli per compatibilit√† con questo programma specifico.
Per ogni manuale, valuta:

1. COMPATIBILIT√Ä CON IL PROGRAMMA (0-100 punti):
   - Copertura degli argomenti del programma
   - Allineamento con il profilo pedagogico del docente
   - Adeguatezza al livello del corso

2. PUNTI DI FORZA:
   - Aspetti distintivi del manuale
   - Quando √® particolarmente adatto

3. GAP (se presenti):
   - Argomenti del programma non coperti
   - Limitazioni rispetto alle esigenze del corso

4. RACCOMANDAZIONE:
   - "RACCOMANDATO" per il manuale pi√π compatibile
   - "ALTERNATIVA" per gli altri manuali

5. CONFRONTO CON BIBLIOGRAFIA ADOTTATA:
   - Come il manuale Zanichelli si confronta con quello attualmente adottato
   - Vantaggi specifici

Rispondi SOLO con un JSON valido:
{
  "manuali": [
    {
      "nome": "nome completo manuale",
      "autore": "autore",
      "compatibilita": numero_0_100,
      "punti_forza": ["forza1", "forza2", "forza3"],
      "gap": ["gap1", "gap2"] oppure [],
      "quando_preferirlo": "descrizione contesto ideale",
      "confronto_bibliografia": "confronto con manuale adottato",${evaluationCriteriaText3 ? `
      "compatibilita_criteri": "analisi compatibilit√† con scuola pensiero/sequenza/formalizzazione programma",` : ''}
      "raccomandazione": "RACCOMANDATO|ALTERNATIVA"
    }
  ],
  "sintesi": "sintesi generale della valutazione"
}`;

                    try {
                        const zanichelliResponse = await callLLM(zanichelliPrompt, 0.2);
                        zanichelliObj = JSON.parse(sanitizeJSON(zanichelliResponse));
                        
                        // Aggiungi nota selezione se presente
                        if (selectionNote) {
                            zanichelliObj.selection_note = selectionNote;
                        }
                        
                        console.log('‚úÖ Valutazione Zanichelli completata:', zanichelliObj);
                        
                        // Fase 4b: Analisi Avanzata - Strategia Adozione (SOLO se Analisi Avanzata E ci sono manuali)
                        if (tipoAnalisi === 'avanzata' && zanichelliObj.manuali && zanichelliObj.manuali.length > 0) {
                            updateLoadingText('Fase 4b/5: Strategia adozione avanzata...');
                            
                            try {
                                const strategiaPrompt = `Basandoti ESCLUSIVAMENTE sulla valutazione Zanichelli gi√† effettuata, genera una GUIDA AL COLLOQUIO per un promotore editoriale.

‚ö†Ô∏è CONTESTO GIA' NEL REPORT (NON ripetere):
- Profilo docente: ${fase0?.profilo_docente_insights?.tipo_docente || 'N/D'} ‚Äî ${fase0?.profilo_docente_insights?.sensibilita_chiave?.substring(0, 150) || 'N/D'}
- Approccio consigliato per questo docente: ${fase0?.profilo_docente_insights?.approccio_consigliato?.substring(0, 150) || 'N/D'}
- Leve potenziali: ${JSON.stringify(fase0?.profilo_docente_insights?.leve_potenziali || [])}
- Gap del manuale attuale: GIA nel report (NON ripetere)
- Confronto Zanichelli vs Adottato: GIA nel report nella sezione Confronto Strutturato (NON ripetere)
- Gap risolti e NON risolti da Zanichelli: GIA nel report (NON ripetere)

REGOLA ANTI-RIDONDANZA CRITICA: Il report contiene GIA':
- Confronto criterio per criterio tra Zanichelli e manuale adottato
- Gap risolti e NON risolti da Zanichelli
- Vantaggi e alternative Zanichelli
TU devi AGGIUNGERE SOLO informazioni OPERATIVE per il colloquio:
1. Le obiezioni SPECIFICHE di questo docente e come rispondere
2. Note colloquio PRATICHE (guida step-by-step)

VALUTAZIONE ZANICHELLI GI√Ä EFFETTUATA:
${JSON.stringify(zanichelliObj, null, 2)}

MANUALE ATTUALMENTE ADOTTATO: ${manuale}

IMPORTANTE:
- NON inventare dati (prezzi, percentuali precise, ore esatte)
- NON usare punteggi, percentuali, frazioni (es. 95/100, 240/270) o numeri tecnici nelle descrizioni ‚Äî traduci TUTTO in linguaggio commerciale qualitativo (es. "ottima corrispondenza", "copre la grande maggioranza del programma")
- NON ripetere gap, vantaggi, confronti ‚Äî sono GIA nel report
- Focus ESCLUSIVO su: obiezioni specifiche di QUESTO docente + guida pratica al colloquio

Genera un JSON con questa struttura:

{
  "strategia_adozione": {
    "manuale_primario": {
      "nome": "nome del manuale RACCOMANDATO dalla valutazione",
      "possibili_obiezioni": [
        {
          "obiezione": "obiezione realistica che QUESTO docente potrebbe sollevare (basata sul suo profilo e tipo)",
          "risposta": "risposta persuasiva e specifica basata su evidenze dall'analisi"
        },
        {
          "obiezione": "seconda obiezione specifica per questo contesto",
          "risposta": "risposta concreta"
        },
        {
          "obiezione": "terza obiezione se rilevante",
          "risposta": "risposta"
        }
      ]
    },
    "note_colloquio": "GUIDA PRATICA in 5 punti (max 150 parole totali): 1) Come aprire la conversazione con questo tipo di docente, 2) Cosa mostrare prima del manuale, 3) Quale domanda fare per coinvolgere, 4) Come gestire il silenzio/dubbio, 5) Come chiudere e proporre prova"
  }
}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                                const strategiaResponse = await callLLM(strategiaPrompt, 0.2);
                                const strategiaObj = JSON.parse(sanitizeJSON(strategiaResponse));
                                
                                // Aggiungi a zanichelliObj
                                zanichelliObj.strategia_adozione = strategiaObj.strategia_adozione;
                                console.log('‚úÖ Fase 4b (Avanzata) completata');
                                
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Fase 4b (Avanzata) fallita, continuo comunque:', error.message);
                            }
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Errore valutazione Zanichelli:', error);
                        zanichelliObj = {
                            manuali: [],
                            errore: error.message,
                            nota: 'Impossibile completare la valutazione Zanichelli'
                        };
                    }
                }
                
                /* VECCHIA FASE 4 - DISABILITATA
                // Fase 4: Valutazione Zanichelli (TEMPERATURE ABBASSATA A 0.1)
                updateLoadingText('Fase 4/5: Valutazione compatibilit√† Zanichelli...');
                
                // Verifica se il manuale adottato √® Zanichelli
                const manualiZanichelli = ['McMurryBiologico', 'Hart', 'McMurryFondamenti'];
                const isZanichelliAdottato = manualiZanichelli.includes(manuale);
                
                // Istruzioni per modalit√† avanzata Zanichelli
                const istruzioniZanichelli = tipoAnalisi === 'avanzata' ? `
MODALIT√Ä ANALISI AVANZATA:
- Per ogni punto di forza, fornisci spiegazione dettagliata (1-2 frasi) con esempi concreti di come il manuale tratta gli argomenti
- Per ogni gap, spiega le conseguenze per gli studenti
- Nel campo "quando_preferirlo", scrivi un paragrafo dettagliato (80-100 parole) che spieghi:
  * Caratteristiche del corso ideale (CFU, obiettivi, contesto)
  * Tipologia di studenti pi√π adatta
  * Vantaggi specifici per quel contesto
- Nel campo "confronto_bibliografia", scrivi un'analisi dettagliata (100-120 parole) che confronti:
  * Come il manuale Zanichelli risolve le limitazioni del manuale adottato
  * Esempi concreti di argomenti trattati meglio
- Usa linguaggio descrittivo e argomentazioni commerciali esplicite` : `
MODALIT√Ä ANALISI BASE:
- Punti di forza/gap sintetici (1 frase ciascuno)
- Quando preferirlo: descrizione breve (50 parole)
- Confronto bibliografia: sintesi concisa (50-100 parole)`;
                
                const zanichelli = await callLLM( `Valuta la compatibilit√† di TUTTI E 3 i manuali Zanichelli di Chimica Organica con questo programma:${istruzioniZanichelli}

1. Hart - Fondamenti di chimica organica (520 pag, ‚Ç¨65, livello base)
2. McMurry - Fondamenti di chimica organica (536 pag, ‚Ç¨67.50, livello intermedio)  
3. McMurry - Chimica organica: approccio biologico (896 pag, ‚Ç¨101.40, livello avanzato con focus bio)

Programma:
${testo.substring(0, 2000)}

Contesto: ${contesto}
Bibliografia adottata: ${Array.isArray(manuale) ? manuale.join(' + ') : manuale}

${isZanichelliAdottato ? `
IMPORTANTE: Il manuale attualmente adottato √à GI√Ä ZANICHELLI (${manuale}).
Devi valutare se:
- MANTENERE il manuale attuale (se √® ottimale)
- UPGRADE a un altro Zanichelli (se ce n'√® uno migliore)
- DOWNGRADE a un altro Zanichelli (se il programma √® pi√π semplice)

Nel campo "raccomandazione" usa: "MANTENERE", "UPGRADE", o "DOWNGRADE".
` : `
IMPORTANTE: Il manuale attualmente adottato NON √à ZANICHELLI (${manuale}).
Stai raccomandando un NUOVO manuale Zanichelli per sostituire quello attuale.

Nel campo "raccomandazione" usa SEMPRE:
- "RACCOMANDATO" per il manuale pi√π compatibile
- "ALTERNATIVA" per gli altri due manuali

NON usare MAI "MANTENERE" perch√© il docente non usa attualmente Zanichelli.
`}

CRITERI DI VALUTAZIONE:
1. Compatibilit√† con il programma (copertura argomenti)
2. Adeguatezza al livello del corso (un manuale troppo completo per un programma breve √® uno SVANTAGGIO!)
3. Rapporto qualit√†/prezzo (Hart ‚Ç¨65 vs McMurry ‚Ç¨90-100)
4. Accessibilit√† per gli studenti (520 pag vs 896 pag)

Raccomanda il manuale con il MIGLIOR EQUILIBRIO tra questi fattori, non necessariamente il pi√π completo.

IMPORTANTE SU HART:
Hart √® il manuale pi√π SINTETICO (‚Ç¨65, 520 pag) ed ECONOMICO.
Raccomandalo quando:
- Programma < 6 CFU o essenziale (solo reazioni base)
- Nessuna enfasi particolare su biomolecole
- Studenti con difficolt√† in chimica (sintesi = vantaggio)
- Budget limitato
NON penalizzarlo solo perch√© √® pi√π breve! La SINTESI pu√≤ essere un VANTAGGIO.

Ordina i 3 manuali per compatibilit√† (dal pi√π al meno compatibile) e fornisci per ognuno:
- Punteggio compatibilit√† (0-100)
- Punti di forza specifici
- Gap specifici (se presenti)
- Quando preferirlo (contesto ideale)
- Confronto con bibliografia adottata
- Raccomandazione (MANTENERE/UPGRADE/DOWNGRADE/RACCOMANDATO)

Rispondi SOLO con un JSON valido:
{
  "raccomandato": {
    "titolo": "Nome manuale pi√π compatibile",
    "punteggio": numero,
    "compatibilita": "Alta/Media/Bassa",
    "raccomandazione": "MANTENERE/UPGRADE/DOWNGRADE/RACCOMANDATO",
    "punti_forza": ["punto1", "punto2"],
    "gap": ["gap1", "gap2"],
    "quando_preferirlo": "descrizione contesto ideale",
    "confronto_bibliografia": "confronto con bibliografia adottata",
    "prezzo": "‚Ç¨XX"
  },
  "alternative": [
    {
      "titolo": "Seconda scelta",
      "punteggio": numero,
      "compatibilita": "Alta/Media/Bassa",
      "raccomandazione": "MANTENERE/UPGRADE/DOWNGRADE/ALTERNATIVA", 
      "punti_forza": ["punto1", "punto2"],
      "gap": ["gap1", "gap2"],
      "quando_preferirlo": "descrizione",
      "confronto_bibliografia": "confronto",
      "prezzo": "‚Ç¨XX"
    },
    {
      "titolo": "Terza scelta",
      "punteggio": numero,
      "compatibilita": "Alta/Media/Bassa",
      "raccomandazione": "MANTENERE/UPGRADE/DOWNGRADE/ALTERNATIVA",
      "punti_forza": ["punto1", "punto2"], 
      "gap": ["gap1", "gap2"],
      "quando_preferirlo": "descrizione",
      "confronto_bibliografia": "confronto",
      "prezzo": "‚Ç¨XX"
    }
  ],
  "raccomandazioni_generali": ["racc1", "racc2"]
}`, 0.1);

                const zanichelliObj = JSON.parse(sanitizeJSON(zanichelli));
                */  // FINE VECCHIA FASE 4 - DISABILITATA
                
                // Crea risultato
                currentProgramma = {
                    id: Date.now(),
                    ...metadataObj,
                    framework_name: frameworkName, // Nome del framework selezionato
                    materia: materiaName, // Nome della materia
                    contesto: contesto,
                    manuale_adottato: manuale === 'Altro' ? manualeNomePersonalizzato : manuale,
                    manuale_adottato_tipo: manuale, // 'Altro' o nome manuale standard
                    manuali_alternativi: manualiAlternativi,
                    cfu: cfu || null,
                    ore: ore || null,
                    analisi_preliminare: fase0, // Fase 0: Quadro Generale + Profilo Pedagogico
                    motivazioni_scelta: motivazioniScelta, // Fase 0.5: Motivazioni Scelta Manuale
                    punteggi: {
                        obiettivi: valutazioneObj.obiettivi.punteggio,
                        contenuti: valutazioneObj.contenuti.punteggio,
                        metodologia: valutazioneObj.metodologia.punteggio,
                        allineamento: valutazioneObj.allineamento.punteggio,
                        risultati: valutazioneObj.risultati.punteggio,
                        totale: totale
                    },
                    valutazione: valutazioneObj,
                    gap_manuale: gapManualeObj,
                    gap_alternativi: gapAlternativi,
                    zanichelli: zanichelliObj,
                    tipo_analisi: tipoAnalisi,
                    created_at: new Date().toISOString()
                };

                // Salva nello storico (verr√† aggiornato dopo FASE 5.5 se necessario)
                saveToStorico(currentProgramma);

                // ‚è∏Ô∏è NON mostrare risultati qui - attendi FASE 5.5
                // mostraRisultati(currentProgramma); // SPOSTATO DOPO FASE 5.5
                
                // ============================================
                // FASE 5.5: ANALISI STRATEGICA ZANICHELLI (OPZIONALE)
                // ============================================
                // üîß SWITCH ON/OFF: Cambia true/false per attivare/disattivare
                const ENABLE_STRATEGIC_ANALYSIS = true;
                
                // ============================================
                // CONTROLLO: Zanichelli in bibliografia?
                // ============================================
                // DEBUG: Verifica MANUAL_CATALOG
                console.log('üîç DEBUG MANUAL_CATALOG:', {
                    exists: !!MANUAL_CATALOG,
                    hasManualsField: !!MANUAL_CATALOG?.manuals,
                    isArray: Array.isArray(MANUAL_CATALOG?.manuals),
                    count: MANUAL_CATALOG?.manuals?.length || 0,
                    first3: MANUAL_CATALOG?.manuals?.slice(0, 3).map(m => ({id: m.id, publisher: m.publisher, type: m.type}))
                });
                
                // Verifica se Zanichelli √® presente come principale o alternativo
                // Usa MANUAL_CATALOG invece di MANUALI_DB per avere tutti i manuali
                const manualeAdottatoEntry = MANUAL_CATALOG?.manuals?.find(m => m.id === currentProgramma.manuale_adottato_tipo);
                
                console.log('üîç DEBUG Ricerca Principale:', {
                    cercato: currentProgramma.manuale_adottato_tipo,
                    trovato: !!manualeAdottatoEntry,
                    entry: manualeAdottatoEntry
                });
                
                const isZanichelliPrincipale = manualeAdottatoEntry?.publisher === 'Zanichelli' || manualeAdottatoEntry?.type === 'zanichelli';
                
                const zanichelliAlternativi = (currentProgramma.gap_alternativi || []).filter(alt => {
                    const altEntry = MANUAL_CATALOG?.manuals?.find(m => m.id === alt.manuale);
                    return altEntry?.publisher === 'Zanichelli' || altEntry?.type === 'zanichelli';
                });
                const hasZanichelliAlternativo = zanichelliAlternativi.length > 0;
                
                const zanichelliInBibliografia = isZanichelliPrincipale || hasZanichelliAlternativo;
                
                console.log('üìö Check Zanichelli:', {
                    principale: isZanichelliPrincipale,
                    alternativi: zanichelliAlternativi.length,
                    inBibliografia: zanichelliInBibliografia,
                    manuale_tipo: currentProgramma.manuale_adottato_tipo,
                    manuale_entry: manualeAdottatoEntry,
                    publisher: manualeAdottatoEntry?.publisher,
                    type: manualeAdottatoEntry?.type
                });
                
                console.log('üîç Condizioni FASE 5.5:', {
                    ENABLE_STRATEGIC_ANALYSIS: ENABLE_STRATEGIC_ANALYSIS,
                    tipoAnalisi: tipoAnalisi,
                    zanichelliInBibliografia: zanichelliInBibliografia,
                    tutteOK: (ENABLE_STRATEGIC_ANALYSIS && tipoAnalisi === 'avanzata' && zanichelliInBibliografia)
                });
                
                // ATTIVA ANALISI STRATEGICA sempre per Analisi Avanzata
                if (ENABLE_STRATEGIC_ANALYSIS && tipoAnalisi === 'avanzata') {
                    try {
                        console.log('üéØ FASE 5.5: Analisi Strategica Zanichelli - AVVIO');
                        if (zanichelliInBibliografia) {
                            console.log('‚úÖ Zanichelli trovato in bibliografia ‚Üí Analisi strategica di difesa/conversione');
                        } else {
                            console.log('‚úÖ Zanichelli NON in bibliografia ‚Üí Analisi strategica di penetrazione');
                        }
                        updateLoadingText('Fase 5.5/5: Analisi strategica finale...');
                        
                        console.log('üîÑ Chiamando generaAnalisiStrategica...');
                        await generaAnalisiStrategica(currentProgramma);
                        console.log('‚úÖ generaAnalisiStrategica completata');
                        
                        // AGGIORNA lo storico con l'analisi strategica
                        console.log('üíæ Aggiorno storico con analisi strategica');
                        saveToStorico(currentProgramma);
                        
                        console.log('‚úÖ FASE 5.5: Analisi Strategica completata', {
                            hasAnalisiStrategica: !!currentProgramma.analisi_strategica,
                            scenario: currentProgramma.analisi_strategica?.scenario
                        });
                    } catch (error) {
                        console.error('‚ö†Ô∏è FASE 5.5: Errore (non bloccante):', error);
                        console.error('Stack trace:', error.stack);
                        // Non blocca: mostra comunque il report
                    }
                } else {
                    console.log('‚ÑπÔ∏è FASE 5.5: Saltata (Analisi Base o FASE 5.5 disabilitata)');
                }
                
                // ============================================
                // MOSTRA RISULTATI FINALI (dopo FASE 5.5 se Avanzata)
                // ============================================
                
                // Raccomandazione Zanichelli con Confronto (solo per analisi avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Generazione raccomandazione Zanichelli con confronto...');
                    try {
                        const raccomandazione = await generaRaccomandazioneZanichelli(currentProgramma);
                        if (raccomandazione) {
                            currentProgramma.raccomandazione_zanichelli = raccomandazione;
                            saveToStorico(currentProgramma);
                            console.log('‚úÖ Raccomandazione Zanichelli con confronto generata');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Raccomandazione Zanichelli fallita, continuo comunque:', error.message);
                    }
                }
                
                // Executive Summary (solo per analisi avanzata)
                if (tipoAnalisi === 'avanzata') {
                    updateLoadingText('Fase finale: Generazione executive summary...');
                    try {
                        const executiveSummary = await generaExecutiveSummary(currentProgramma);
                        if (executiveSummary) {
                            currentProgramma.executive_summary = executiveSummary;
                            saveToStorico(currentProgramma);
                            console.log('‚úÖ Executive Summary aggiunto al report');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Executive Summary fallito, continuo comunque:', error.message);
                    }
                }
                
                console.log('üìä DEBUG prima di mostraRisultati:', {
                    hasAnalisiStrategica: !!currentProgramma.analisi_strategica,
                    analisiStrategica: currentProgramma.analisi_strategica,
                    hasExecutiveSummary: !!currentProgramma.executive_summary
                });
                mostraRisultati(currentProgramma);
                // ============================================
                // FINE FASE 5.5
                // ============================================

            } catch (error) {
                showError('Errore durante l\'analisi: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('btnAnalizza').disabled = false;
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }

        // Funzione per sanitizzare JSON da risposte GPT-4
        function sanitizeJSON(text) {
            // Rimuovi markdown code blocks
            text = text.replace(/```json|```/g, '').trim();
            
            // Rimuovi eventuali testi prima/dopo il JSON
            // Cerca il primo { e l'ultimo }
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            
            if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                text = text.substring(firstBrace, lastBrace + 1);
            }
            
            // Prova prima il parsing diretto
            try {
                JSON.parse(text);
                return text; // Se funziona, ritorna cos√¨ com'√®
            } catch (e) {
                // Se fallisce, prova a riparare il JSON
                console.log('‚ö†Ô∏è JSON non valido, tento riparazione:', e.message);
                console.log('üìÑ Primi 500 caratteri:', text.substring(0, 500));
                
                // Strategia 1: Rimuovi caratteri di controllo
                let fixed = text
                    .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Rimuovi caratteri di controllo
                    .replace(/\n/g, ' ') // Sostituisci newline con spazio
                    .replace(/\r/g, ' ') // Sostituisci carriage return
                    .replace(/\t/g, ' '); // Sostituisci tab
                
                // Strategia 2: Fixa virgole mancanti o extra
                fixed = fixed
                    .replace(/,\s*([}\]])/g, '$1') // Rimuovi virgole prima di } o ]
                    .replace(/([}\]])\s*([^,}\]])/g, '$1,$2'); // Aggiungi virgole mancanti
                
                // Strategia 3: Fixa apici non escaped
                fixed = fixed.replace(/"([^"\\]*(?:\\.[^"\\]*)*)"/g, (match, content) => {
                    // Escape caratteri speciali dentro le stringhe
                    let sanitized = content
                        .replace(/\\/g, '\\\\')  // Escape backslash
                        .replace(/"/g, '\\"')    // Escape quote
                        .replace(/\n/g, '\\n')   // Escape newline
                        .replace(/\r/g, '\\r')   // Escape carriage return
                        .replace(/\t/g, '\\t');  // Escape tab
                    return '"' + sanitized + '"';
                });
                
                // Verifica se ora funziona
                try {
                    JSON.parse(fixed);
                    console.log('‚úÖ JSON riparato con successo!');
                    return fixed;
                } catch (e2) {
                    console.error('‚ùå Impossibile riparare il JSON:', e2.message);
                    console.error('üìÑ JSON originale (primi 800 caratteri):', text.substring(0, 800));
                    console.error('üîß JSON riparato (primi 800 caratteri):', fixed.substring(0, 800));
                    
                    // Ultimo tentativo: prova con json-repair library logic
                    // (implementazione manuale di fix comuni)
                    try {
                        // Strategia 4: Aggiungi virgolette mancanti alle chiavi
                        let lastFix = fixed.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                        JSON.parse(lastFix);
                        console.log('‚úÖ JSON riparato con fix chiavi!');
                        return lastFix;
                    } catch (e3) {
                        console.error('‚ùå Tutti i tentativi di riparazione falliti');
                        throw new Error('JSON non valido anche dopo sanitizzazione: ' + e2.message);
                    }
                }
            }
        }

        // Chiamata LLM Unificata (tutti i provider) con Retry Automatico
        async function callLLM(prompt, temperature, maxRetries = 3) {
            const providerKey = localStorage.getItem('ai_provider') || 'openai';
            const provider = LLM_PROVIDERS[providerKey];
            
            if (!provider) {
                throw new Error(`Provider '${providerKey}' non trovato`);
            }
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ü§ñ Tentativo ${attempt}/${maxRetries} con ${provider.name}...`);
                    
                    const response = await callProvider(providerKey, prompt, temperature);
                    
                    // Verifica che la risposta non sia vuota
                    if (!response || response.trim().length === 0) {
                        throw new Error('Risposta vuota dal LLM');
                    }
                    
                    console.log(`‚úÖ Risposta ricevuta (${response.length} caratteri)`);
                    return response;
                    
                } catch (error) {
                    console.error(`‚ùå Tentativo ${attempt} fallito:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw new Error(`Chiamata LLM fallita dopo ${maxRetries} tentativi: ${error.message}`);
                    }
                    
                    // Backoff esponenziale
                    const waitTime = Math.pow(2, attempt) * 1000;
                    console.log(`‚è≥ Attendo ${waitTime/1000}s prima di riprovare...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }
        
        async function callProvider(providerKey, prompt, temperature) {
            const provider = LLM_PROVIDERS[providerKey];
            const apiKey = localStorage.getItem(`${providerKey}_api_key`);
            const model = localStorage.getItem(`${providerKey}_model`) || provider.models[0].id;
            
            if (!apiKey) {
                throw new Error(`Chiave API ${provider.name} non configurata. Vai in Impostazioni.`);
            }
            
            console.log(`üîë Uso ${provider.name} - Modello: ${model}`);
            
            // Verifica se siamo su Netlify o in locale
            const isNetlify = window.location.hostname.includes('netlify.app');
            
            // Provider che supportano direttamente OpenAI API format
            const openaiCompatible = ['openai', 'xai', 'deepseek', 'meta', 'mistral', 'perplexity'];
            
            if (openaiCompatible.includes(providerKey)) {
                return await callOpenAICompatible(provider, apiKey, model, prompt, temperature, isNetlify, providerKey);
            } else if (providerKey === 'anthropic') {
                return await callAnthropic(provider, apiKey, model, prompt, temperature);
            } else if (providerKey === 'google') {
                return await callGoogle(provider, apiKey, model, prompt, temperature);
            } else if (providerKey === 'cohere') {
                return await callCohere(provider, apiKey, model, prompt, temperature);
            } else {
                throw new Error(`Provider ${providerKey} non implementato`);
            }
        }
        
        async function callOpenAICompatible(provider, apiKey, model, prompt, temperature, isNetlify, providerKey) {
            let endpoint = provider.endpoint;
            let headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };
            
            let body = {
                model: model,
                messages: [{role: 'user', content: prompt}],
                temperature: temperature,
                max_tokens: 16000
            };
            
            // OpenAI: chiamata diretta (CORS supportato da api.openai.com)
            if (providerKey === 'openai') {
                if (isNetlify) {
                    console.log('üì° Ambiente Netlify: chiamata diretta a OpenAI API (no proxy)');
                } else {
                    console.log('üè† Ambiente locale/sandbox: chiamata diretta a OpenAI API');
                }
            }
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `Errore API ${provider.name}: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content.trim();
        }
        
        async function callAnthropic(provider, apiKey, model, prompt, temperature) {
            const response = await fetch(provider.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: temperature,
                    max_tokens: 16000
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `Errore API ${provider.name}: ${response.status}`);
            }
            
            const data = await response.json();
            return data.content[0].text.trim();
        }
        
        async function callGoogle(provider, apiKey, model, prompt, temperature) {
            const endpoint = `${provider.endpoint}${model}:generateContent?key=${apiKey}`;
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{parts: [{text: prompt}]}],
                    generationConfig: {
                        temperature: temperature,
                        maxOutputTokens: 16000
                    }
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `Errore API ${provider.name}: ${response.status}`);
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text.trim();
        }
        
        async function callCohere(provider, apiKey, model, prompt, temperature) {
            const response = await fetch(provider.endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    message: prompt,
                    temperature: temperature,
                    max_tokens: 16000
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `Errore API ${provider.name}: ${response.status}`);
            }
            
            const data = await response.json();
            return data.text.trim();
        }
        
        
        // Mostra risultati (continua nel prossimo blocco...)
        // ============================================
        // FASE 5.5: ANALISI STRATEGICA ZANICHELLI
        // ============================================
        
        async function generaAnalisiStrategica(prog) {
            console.log('üéØ Genera Analisi Strategica - Inizio');
            
            // Identifica scenario - USA MANUAL_CATALOG invece di MANUALI_DB
            const manualeAdottato = prog.manuale_adottato;
            const manualeAdottatoEntry = MANUAL_CATALOG?.manuals?.find(m => m.id === prog.manuale_adottato_tipo);
            const isZanichelliPrincipale = manualeAdottatoEntry?.publisher === 'Zanichelli' || manualeAdottatoEntry?.type === 'zanichelli';
            
            console.log('üìä Scenario Detection:', {
                manuale: manualeAdottato,
                publisher: manualeAdottatoEntry?.publisher,
                type: manualeAdottatoEntry?.type,
                isZanichelli: isZanichelliPrincipale
            });
            
            // Identifica Zanichelli tra alternativi - USA MANUAL_CATALOG
            const zanichelliAlternativi = (prog.gap_alternativi || []).filter(alt => {
                const altEntry = MANUAL_CATALOG?.manuals?.find(m => m.id === alt.manuale);
                return altEntry?.publisher === 'Zanichelli' || altEntry?.type === 'zanichelli';
            });
            
            const hasZanichelliAlternativo = zanichelliAlternativi.length > 0;
            
            console.log('üìö Zanichelli alternativi:', zanichelliAlternativi.length);
            
            let promptStrategia = '';
            let scenario = '';
            
            if (isZanichelliPrincipale) {
                // ==========================================
                // SCENARIO 1: Zanichelli PRINCIPALE
                // ==========================================
                scenario = 'zanichelli_principale';
                console.log('‚úÖ SCENARIO 1: Zanichelli √® il manuale principale');
                
                // Prepara dati competitor alternativi - USA MANUAL_CATALOG
                const competitorAlternativi = (prog.gap_alternativi || []).filter(alt => {
                    const altEntry = MANUAL_CATALOG?.manuals?.find(m => m.id === alt.manuale);
                    return !(altEntry?.publisher === 'Zanichelli' || altEntry?.type === 'zanichelli');
                });
                
                // CALCOLA competitor con punteggio MASSIMO
                let competitorMigliore = null;
                let punteggioMassimoCompetitor = prog.gap_manuale.punteggio_framework || 0;
                
                if (competitorAlternativi.length > 0) {
                    competitorMigliore = competitorAlternativi.reduce((max, curr) => {
                        const punteggioMax = max.punteggio_framework || 0;
                        const punteggioCurr = curr.punteggio_framework || 0;
                        return punteggioCurr > punteggioMax ? curr : max;
                    });
                    punteggioMassimoCompetitor = competitorMigliore.punteggio_framework || 0;
                }
                
                const haCompetitorSuperiore = punteggioMassimoCompetitor > (prog.gap_manuale.punteggio_framework || 0);
                
                console.log('üìä Competitor Analysis:', {
                    punteggioZanichelli: prog.gap_manuale.punteggio_framework,
                    competitorMigliore: competitorMigliore?.manuale,
                    punteggioCompetitorMigliore: punteggioMassimoCompetitor,
                    haCompetitorSuperiore: haCompetitorSuperiore
                });
                
                promptStrategia = `Sei un consulente strategico per promotori editoriali Zanichelli.

‚ö†Ô∏è CONTESTO GIA' NEL REPORT (il promotore ha GIA' letto tutto questo ‚Äî NON ripetere):
- Profilo docente: ${prog.analisi_preliminare?.profilo_docente_insights?.tipo_docente || 'N/D'}
- Sensibilita: ${prog.analisi_preliminare?.profilo_docente_insights?.sensibilita_chiave?.substring(0, 150) || 'N/D'}
- Valutazione programma: ${prog.punteggi?.totale || 'N/D'}/270
- Gap manuale gia analizzati (NON rielencare)
- Insights adozione commerciali: ${prog.valutazione?.insights_adozione ? 'GIA nel report' : 'non presenti'}
- Impatto gap: ${prog.gap_manuale?.analisi_impatto_adozione ? 'GIA nel report' : 'non presente'}
${prog.zanichelli?.strategia_adozione ? `- Strategia adozione Zanichelli: GIA nel report con argomenti chiave e note colloquio` : ''}

REGOLA ANTI-RIDONDANZA: NON ripetere gap, profilo docente, insights, impatto.
Il tuo output deve contenere SOLO informazioni strategiche NUOVE su conferma/upgrade/difesa.

SCENARIO: Il docente ha GI√Ä ADOTTATO il manuale Zanichelli "${manualeAdottato}" come testo PRINCIPALE.

‚ö†Ô∏è IMPORTANTE: 
- Il manuale "${manualeAdottato}" √® GI√Ä IN USO dal docente
- NON puoi suggerire "${manualeAdottato}" come alternativa (√® gi√† adottato!)
- Devi CONFERMARE questa scelta O suggerire UPGRADE a ALTRO Zanichelli (NON McMurry stesso!)

MANUALE ZANICHELLI ATTUALMENTE ADOTTATO:
- Nome: ${manualeAdottato}
- Punteggio Framework: ${prog.gap_manuale.punteggio_framework}/270
- Copertura: ${prog.gap_manuale.copertura_percentuale}%
- Gap identificati: ${JSON.stringify(prog.gap_manuale.gap || [])}
- Punti di forza: ${JSON.stringify(prog.gap_manuale.punti_forza || [])}
- Punti di debolezza: ${JSON.stringify(prog.gap_manuale.punti_debolezza || [])}

ALTRI MANUALI ZANICHELLI DISPONIBILI NEL CATALOGO (per eventuale upgrade):
${JSON.stringify(prog.zanichelli?.manuali || [], null, 2)}

COMPETITOR ALTERNATIVI CHE IL DOCENTE STA VALUTANDO:
${JSON.stringify(competitorAlternativi, null, 2)}

‚ö†Ô∏è ATTENZIONE - COMPETITOR PI√ô FORTE:
${haCompetitorSuperiore ? `
- Il competitor "${competitorMigliore?.manuale}" ha un punteggio SUPERIORE (${punteggioMassimoCompetitor}/270 vs ${prog.gap_manuale.punteggio_framework}/270)
- DIFFERENZA: ${punteggioMassimoCompetitor - prog.gap_manuale.punteggio_framework} punti a favore del competitor
- Il promotore deve DIFENDERE la scelta di "${manualeAdottato}" nonostante il punteggio inferiore
- Focus su: punti di forza qualitativi, gap risolti, approccio didattico, supporto Zanichelli
` : `
- NESSUN competitor ha punteggio superiore a "${manualeAdottato}"
- Il punteggio di "${manualeAdottato}" (${prog.gap_manuale.punteggio_framework}/270) √® il migliore tra tutti
- Questo rafforza la scelta attuale
`}

COMPITO DEL PROMOTORE:
Analizza questa situazione e rispondi a 3 domande critiche:

1. Il Zanichelli "${manualeAdottato}" ADOTTATO √® la scelta OTTIMALE tra i Zanichelli disponibili?
   - Confronta "${manualeAdottato}" con gli ALTRI Zanichelli del catalogo (NON con s√© stesso!)
   - Esiste un ALTRO Zanichelli (diverso da "${manualeAdottato}") con compatibilit√† superiore?
   - Se s√¨, quali vantaggi offre l'UPGRADE?

2. Come DIFENDERE la scelta di "${manualeAdottato}" rispetto ai competitor alternativi?
   - Qualche competitor (Brown, Bruice, etc.) ha punteggio superiore?
   - Come giustificare la scelta attuale di Zanichelli?
   - Quali sono i punti di forza unici del "${manualeAdottato}" rispetto ai competitor?

3. RACCOMANDAZIONE FINALE: CONFERMARE "${manualeAdottato}" o suggerire UPGRADE a ALTRO Zanichelli?
   - Se "${manualeAdottato}" √® ottimale: CONFERMA scelta attuale
   - Se esiste altro Zanichelli superiore: SUGGERISCI UPGRADE (specifica quale, NON "${manualeAdottato}"!)
   - Se competitor sono superiori: DIFENDI "${manualeAdottato}" con argomenti forti

‚ö†Ô∏è REGOLA LINGUAGGIO PROMOTORE: Nei campi di TESTO (motivazione, raccomandazione, pitch, argomenti), NON usare punteggi numerici, percentuali o frazioni (es. 95/100, 240/270). Traduci in linguaggio commerciale qualitativo (es. "ottima corrispondenza col programma", "copre quasi tutto il corso"). I campi numerici del JSON (compatibilita_superiore, punteggio_competitor) POSSONO contenere numeri.

Rispondi SOLO con un JSON valido:
{
  "scenario": "zanichelli_principale",
  "analisi_scelta_attuale": {
    "zanichelli_adottato_ottimale": true/false,
    "motivazione": "spiegazione dettagliata (100-150 parole)",
    "punti_forza_scelta": ["forza1", "forza2", "forza3"]
  },
  "confronto_altri_zanichelli": {
    "esiste_zanichelli_migliore": true/false,
    "nome": "nome se esiste, altrimenti null",
    "compatibilita_superiore": numero o null,
    "vantaggi_upgrade": ["vantaggio1", "vantaggio2"] o [],
    "quando_consigliare_upgrade": "descrizione contesto (50-100 parole) o null",
    "argomenti_chiave_upgrade": ["argomento1", "argomento2"] o []
  },
  "confronto_competitor": {
    "competitor_superiore_esiste": true/false,
    "nome_competitor": "nome se esiste, altrimenti null",
    "punteggio_competitor": numero o null,
    "gap_zanichelli_vs_competitor": ["gap1", "gap2"] o [],
    "difesa_zanichelli": {
      "punti_forza_unici": ["forza1", "forza2", "forza3"],
      "quando_zanichelli_preferibile": "descrizione (100 parole)",
      "argomenti_risposta": ["argomento1", "argomento2", "argomento3"]
    }
  },
  "raccomandazione_finale": "Testo raccomandazione strategica (150-200 parole) per il promotore",
  "pitch": {
    "primo_contatto": "Pitch per docente NON conosciuto. Tono professionale, presentazione breve, aggancio specifico al programma analizzato. Max 4 righe. Deve contenere un riferimento concreto a un elemento del programma o del manuale.",
    "docente_conosciuto": "Pitch per docente GIA' conosciuto. Tono diretto e collegiale, niente presentazioni, va dritto al punto con riferimento specifico a un gap o opportunita' emersa dall'analisi. Max 3 righe."
  }
}`;

            } else if (hasZanichelliAlternativo) {
                // ==========================================
                // SCENARIO 2: Competitor PRINCIPALE + Zanichelli ALTERNATIVO
                // ==========================================
                scenario = 'opportunita_conversione';
                console.log('‚úÖ SCENARIO 2: Competitor principale, Zanichelli tra alternativi');
                
                // Prendi il Zanichelli alternativo con punteggio PI√ô ALTO
                const zanichelliAlt = zanichelliAlternativi.reduce((max, curr) => {
                    const punteggioMax = max.punteggio_framework || 0;
                    const punteggioCurr = curr.punteggio_framework || 0;
                    return punteggioCurr > punteggioMax ? curr : max;
                });
                
                const punteggioCompetitor = prog.gap_manuale.punteggio_framework || 0;
                const punteggioZanichelliAlt = zanichelliAlt.punteggio_framework || 0;
                const differenzaPunteggio = punteggioZanichelliAlt - punteggioCompetitor;
                
                console.log('üìä Scenario 2 Analysis:', {
                    competitor: manualeAdottato,
                    punteggioCompetitor: punteggioCompetitor,
                    zanichelliAlt: zanichelliAlt.manuale,
                    punteggioZanichelliAlt: punteggioZanichelliAlt,
                    differenza: differenzaPunteggio
                });
                
                promptStrategia = `Sei un consulente strategico per promotori editoriali Zanichelli.

‚ö†Ô∏è CONTESTO GIA' NEL REPORT (il promotore ha GIA' letto tutto questo ‚Äî NON ripetere):
- Profilo docente: ${prog.analisi_preliminare?.profilo_docente_insights?.tipo_docente || 'N/D'}
- Sensibilita: ${prog.analisi_preliminare?.profilo_docente_insights?.sensibilita_chiave?.substring(0, 150) || 'N/D'}
- Valutazione programma: ${prog.punteggi?.totale || 'N/D'}/270
- Gap manuale gia analizzati dettagliatamente (NON rielencare uno per uno)
- Insights adozione commerciali: ${prog.valutazione?.insights_adozione ? 'GIA nel report' : 'non presenti'}
- Impatto gap: ${prog.gap_manuale?.analisi_impatto_adozione ? 'GIA nel report' : 'non presente'}
${prog.zanichelli?.strategia_adozione ? `- Strategia adozione Zanichelli: GIA nel report` : ''}

REGOLA ANTI-RIDONDANZA: NON ripetere gap, profilo docente, insights, impatto.
Il tuo output deve contenere SOLO la strategia di CONVERSIONE dal competitor a Zanichelli.

SCENARIO: Il docente ha ADOTTATO un manuale COMPETITOR, ma ha considerato un manuale Zanichelli come alternativo.

MANUALE COMPETITOR ADOTTATO:
- Nome: ${manualeAdottato}
- Editore: ${manualeAdottatoEntry?.publisher || 'Competitor'}
- Punteggio Framework: ${prog.gap_manuale.punteggio_framework}/270
- Copertura: ${prog.gap_manuale.copertura_percentuale}%
- Gap identificati: ${JSON.stringify(prog.gap_manuale.gap || [])}
- Punti di debolezza: ${JSON.stringify(prog.gap_manuale.punti_debolezza || [])}

MANUALE ZANICHELLI ALTERNATIVO (con punteggio PI√ô ALTO tra gli alternativi):
- Nome: ${zanichelliAlt.manuale}
- Punteggio Framework: ${zanichelliAlt.punteggio_framework}/270
- Copertura: ${zanichelliAlt.copertura_percentuale}%
- Gap: ${JSON.stringify(zanichelliAlt.gap || [])}
- Punti di forza: ${JSON.stringify(zanichelliAlt.punti_forza || [])}

‚ö†Ô∏è CONFRONTO DIRETTO:
- Punteggio Competitor: ${punteggioCompetitor}/270
- Punteggio Zanichelli Alt: ${punteggioZanichelliAlt}/270
- DIFFERENZA: ${differenzaPunteggio > 0 ? '+' : ''}${differenzaPunteggio} punti ${differenzaPunteggio > 0 ? 'a favore di Zanichelli ‚úÖ' : 'a favore del Competitor ‚ö†Ô∏è'}

ALTRI MANUALI ZANICHELLI DISPONIBILI (Catalogo):
${JSON.stringify(prog.zanichelli?.manuali || [], null, 2)}

COMPITO:
Analizza l'opportunit√† di CONVERSIONE dal competitor a Zanichelli.

IMPORTANTE: 
- Se il Zanichelli alternativo √® INFERIORE al competitor, NON insistere su di esso
- Valuta se esistono ALTRI Zanichelli nel catalogo con compatibilit√† SUPERIORE al competitor
- La raccomandazione deve essere CHIARA: quale Zanichelli proporre (alternativo o altro dal catalogo)

‚ö†Ô∏è REGOLA LINGUAGGIO PROMOTORE: Nei campi di TESTO (vantaggi, argomenti_chiave, pitch, raccomandazione), NON usare punteggi numerici, percentuali o frazioni (es. 95/100, 240/270). Traduci in linguaggio commerciale qualitativo (es. "ottima corrispondenza col programma", "copre quasi tutto il corso"). I campi numerici del JSON (compatibilita, punteggio_framework, differenza_punteggio) POSSONO contenere numeri.

Rispondi a 4 domande critiche:

1. Il manuale Zanichelli alternativo √® SUPERIORE al competitor adottato?
   - Confronta i punteggi framework
   - Confronta gap e copertura
   - Analisi oggettiva

2. Quali GAP del competitor il Zanichelli alternativo RISOLVE?
   - Gap critici risolti
   - Vantaggi concreti per studenti/docente

3. ESISTE un Zanichelli MIGLIORE nel catalogo?
   - Confronta con gli altri Zanichelli disponibili
   - Identifica quello con compatibilit√† pi√π alta
   - Se esiste un Zanichelli superiore al competitor, RACCOMANDA QUELLO

4. Come CONVINCERE il docente?
   - Se Zanichelli alternativo √® superiore: proponi QUELLO
   - Se un altro Zanichelli √® superiore: proponi QUELLO (non l'alternativo)
   - Argomenti chiave basati sui dati
   - Gestione obiezioni

Rispondi SOLO con un JSON valido:
{
  "scenario": "opportunita_conversione",
  "zanichelli_alternativo_superiore": true/false,
  "differenza_punteggio_alternativo": numero (punti Zanichelli alt - Competitor),
  "zanichelli_migliore_disponibile": {
    "esiste": true/false,
    "nome": "nome se esiste, altrimenti null",
    "compatibilita": numero o null,
    "punteggio_framework": numero o null,
    "superiore_a_competitor": true/false,
    "superiore_a_alternativo": true/false,
    "vantaggi": ["vantaggio1 vs competitor", "vantaggio2 vs competitor"]
  },
  "gap_risolti_da_zanichelli": [
    {
      "gap": "nome gap del competitor",
      "come_zanichelli_risolve": "spiegazione (50 parole)"
    }
  ],
  "vantaggi_zanichelli": ["vantaggio1", "vantaggio2", "vantaggio3"],
  "pitch_conversione": {
    "argomenti_chiave": [
      "argomento1 specifico con dati (quale Zanichelli proporre)",
      "argomento2 specifico con dati (perch√© √® superiore)",
      "argomento3 specifico con dati (benefici concreti)"
    ],
    "confronto_diretto": "Descrizione confronto: quale Zanichelli proporre (alternativo o migliore del catalogo) vs Competitor (150-200 parole) con dati concreti",
    "obiezioni_probabili": [
      {
        "obiezione": "obiezione realistica docente",
        "risposta": "risposta basata su dati analisi"
      }
    ],
    "pitch_breve_primo_contatto": "Pitch BREVE (max 4 righe) per docente NON conosciuto. Tono professionale, presentazione breve, aggancio specifico al programma e ai gap del competitor. Deve contenere un riferimento concreto al programma.",
    "pitch_breve_docente_conosciuto": "Pitch BREVE (max 3 righe) per docente GIA' conosciuto. Tono diretto e collegiale, niente presentazioni, va dritto al punto con riferimento specifico al gap del competitor e al vantaggio Zanichelli."
  },
  "raccomandazione_finale": "Strategia CHIARA per promotore (200-250 parole): \n- SE Zanichelli alternativo √® superiore: proponi QUELLO\n- SE esiste altro Zanichelli migliore: proponi QUELLO (es. McMurry invece di Solomons)\n- SPECIFICA quale Zanichelli proporre e perch√©\n- Come presentare il cambio, tono da usare, cosa enfatizzare"
}`;

            } else {
                // ==========================================
                // SCENARIO 3: Competitor principale, NO Zanichelli in bibliografia
                // ==========================================
                scenario = 'nessun_zanichelli';
                console.log('‚úÖ SCENARIO 3: Nessun Zanichelli in bibliografia ‚Üí Strategia di penetrazione');
                
                // Usa i manuali Zanichelli gi√† valutati nella FASE 4
                const manualiZanichelliValutati = prog.zanichelli?.manuali || [];
                
                promptStrategia = `Sei un consulente strategico per promotori editoriali Zanichelli.

‚ö†Ô∏è CONTESTO GIA' NEL REPORT (il promotore ha GIA' letto tutto questo ‚Äî NON ripetere):
- Profilo docente: ${prog.analisi_preliminare?.profilo_docente_insights?.tipo_docente || 'N/D'}
- Sensibilita: ${prog.analisi_preliminare?.profilo_docente_insights?.sensibilita_chiave?.substring(0, 150) || 'N/D'}
- Valutazione programma: ${prog.punteggi?.totale || 'N/D'}/270
- Gap manuale gia analizzati dettagliatamente (NON rielencare uno per uno)
- Insights adozione commerciali: ${prog.valutazione?.insights_adozione ? 'GIA nel report' : 'non presenti'}
- Impatto gap: ${prog.gap_manuale?.analisi_impatto_adozione ? 'GIA nel report' : 'non presente'}

REGOLA ANTI-RIDONDANZA: NON ripetere gap, profilo docente, insights, impatto.
Il tuo output deve contenere SOLO la strategia di PENETRAZIONE per proporre Zanichelli.

SCENARIO: Il docente usa un manuale COMPETITOR (NON Zanichelli) e NON ha Zanichelli nemmeno tra gli alternativi.
Questo √® un'opportunit√† di PENETRAZIONE di mercato.

MANUALE COMPETITOR ATTUALMENTE ADOTTATO:
- Nome: ${manualeAdottato}
- Punteggio Framework: ${prog.gap_manuale.punteggio_framework}/270
- Copertura: ${prog.gap_manuale.copertura_percentuale}%
- Gap identificati: ${JSON.stringify(prog.gap_manuale.gap || [])}
- Punti di forza: ${JSON.stringify(prog.gap_manuale.punti_forza || [])}

MANUALI ZANICHELLI VALUTATI (dalla FASE 4):
${JSON.stringify(manualiZanichelliValutati, null, 2)}

COMPITO:
Genera una strategia di PENETRAZIONE per proporre Zanichelli al docente.

‚ö†Ô∏è REGOLA LINGUAGGIO PROMOTORE: Nei campi di TESTO (vantaggi, argomenti_chiave, pitch, confronto_diretto), NON usare punteggi numerici, percentuali o frazioni (es. 95/100, 240/270). Traduci in linguaggio commerciale qualitativo (es. "ottima corrispondenza col programma", "copre quasi tutto il corso"). I campi numerici del JSON (compatibilita, punteggio_framework, differenza_punteggio) POSSONO contenere numeri.

Rispondi a 3 domande critiche:

1. Quale Zanichelli √® il MIGLIORE per questo programma?
   - Identifica il Zanichelli con compatibilit√† pi√π alta
   - Confronta con il competitor attuale
   - Analisi gap risolti

2. Quali GAP del competitor Zanichelli RISOLVE?
   - Gap critici risolti dal Zanichelli raccomandato
   - Vantaggi concreti per studenti/docente
   - Miglioramenti nella copertura del programma

3. Come PROPORRE Zanichelli per la prima volta?
   - Argomenti chiave per primo contatto
   - Enfasi su gap risolti e miglioramenti
   - Gestione obiezioni tipiche ("Uso gi√† X da anni", "Studenti si trovano bene")

Rispondi SOLO con un JSON valido:
{
  "scenario": "penetrazione_mercato",
  "zanichelli_raccomandato": {
    "nome": "nome manuale Zanichelli migliore",
    "autore": "autore del manuale",
    "editore": "Zanichelli",
    "compatibilita": numero/100,
    "punteggio_framework": numero/270,
    "superiore_a_competitor": true/false,
    "differenza_punteggio": numero (Zanichelli - Competitor)
  },
  "gap_risolti_da_zanichelli": [
    {
      "gap": "nome gap del competitor",
      "come_zanichelli_risolve": "spiegazione dettagliata (80-100 parole)"
    }
  ],
  "vantaggi_zanichelli": ["vantaggio1 concreto", "vantaggio2 concreto", "vantaggio3 concreto"],
  "pitch_primo_contatto": {
    "apertura": "Frase di apertura strategica (50 parole) - come presentarsi e introdurre Zanichelli",
    "argomenti_chiave": [
      "argomento1 specifico con dati",
      "argomento2 specifico con dati",
      "argomento3 specifico con dati"
    ],
    "confronto_diretto": "Confronto Zanichelli raccomandato vs Competitor attuale (150-200 parole) con dati concreti",
    "obiezioni_probabili": [
      {
        "obiezione": "Uso gi√† ${manualeAdottato} da anni",
        "risposta": "risposta basata su gap e miglioramenti"
      },
      {
        "obiezione": "Gli studenti si trovano bene con il manuale attuale",
        "risposta": "risposta basata su benefici concreti per studenti"
      }
    ],
    "pitch_breve_primo_contatto": "Pitch BREVE (max 4 righe) per docente NON conosciuto. Tono professionale, presentazione breve, aggancio specifico al programma e ai gap del manuale attuale. Deve contenere un riferimento concreto al programma analizzato.",
    "pitch_breve_docente_conosciuto": "Pitch BREVE (max 3 righe) per docente GIA' conosciuto. Tono diretto e collegiale, niente presentazioni, va dritto al punto con riferimento specifico a un gap del manuale attuale che Zanichelli risolve."
  },
  "raccomandazione_finale": "Strategia completa per promotore (250 parole): quale Zanichelli proporre, come presentarlo, su cosa insistere, come gestire resistenze"
}`;
            }
            
            // Chiamata LLM
            console.log('ü§ñ Chiamo LLM per analisi strategica...', { scenario, promptLength: promptStrategia.length });
            const strategiaResponse = await callLLM(promptStrategia, 0.2);
            console.log('üì• Risposta LLM ricevuta:', { length: strategiaResponse.length, preview: strategiaResponse.substring(0, 200) });
            
            const strategiaObj = JSON.parse(sanitizeJSON(strategiaResponse));
            console.log('‚úÖ Strategia generata e parsed:', strategiaObj);
            
            // SALVA la strategia in prog per visualizzazione futura (es. storico)
            prog.analisi_strategica = {
                scenario: scenario,
                strategia: strategiaObj,
                generata_il: new Date().toISOString()
            };
            
            console.log('üíæ Strategia salvata in prog.analisi_strategica:', {
                hasAnalisiStrategica: !!prog.analisi_strategica,
                scenario: prog.analisi_strategica?.scenario
            });
            
            // Sezione strategica consolidata: i dati restano in prog.analisi_strategica
            // ma il rendering √® stato rimosso (consolidato in Sez 5 + Strategia Adozione)
            console.log('üìä Dati strategici salvati (rendering consolidato in Sez 5)');
        }
        
        // ============================================
        // SPECIFICA C: Raccomandazione Zanichelli con Confronto Criterio per Criterio
        // ============================================
        async function generaRaccomandazioneZanichelli(prog) {
            console.log('üìä Genera Raccomandazione Zanichelli con Confronto');
            
            try {
                const manualeAdottato = prog.manuale_adottato || 'Non specificato';
                const manualiZanichelli = prog.zanichelli?.manuali || [];
                const prioritaClasse = prog.analisi_preliminare?.allineamento_classe?.priorita_classe || 'Non disponibili';
                const criteriDisciplinari = prog.analisi_preliminare?.criteri_disciplinari || [];
                const hasEvalCriteria = criteriDisciplinari.length > 0;
                
                const raccomandazionePrompt = `Sei un consulente strategico per promotori editoriali Zanichelli.

CONTESTO: Il promotore ha GIA letto:
- Profilo pedagogico e allineamento con la classe (Sezione 1)
- Logica della scelta editoriale del docente (Sezione 2)
- Analisi del programma con punteggio (Sezione 3)
- Gap analysis del manuale adottato con tabella modulo per modulo (Sezione 4)

NON ripetere informazioni gia nel report. Concentrati SOLO sul confronto e sulla raccomandazione.

MANUALE ADOTTATO:
- Nome: ${manualeAdottato}
- Gap: ${JSON.stringify(prog.gap_manuale?.gap || [])}
- Punti debolezza: ${JSON.stringify(prog.gap_manuale?.punti_debolezza || [])}
- Copertura moduli: ${JSON.stringify(prog.gap_manuale?.copertura_moduli?.filter(m => m.copertura !== 'OTTIMA').map(m => m.modulo_framework + ': ' + m.copertura) || [])}

MANUALI ZANICHELLI DISPONIBILI:
${JSON.stringify(manualiZanichelli, null, 2)}

PRIORITA CLASSE DI LAUREA: ${prioritaClasse}
${hasEvalCriteria ? `CRITERI DISCIPLINARI: ${JSON.stringify(criteriDisciplinari, null, 2)}` : ''}

COMPITO:
Identifica il manuale Zanichelli piu adatto e genera un confronto strutturato con il manuale adottato.

REGOLA LINGUAGGIO: Nei campi di TESTO, NON usare punteggi numerici o percentuali.
I campi numerici del JSON (compatibilita) POSSONO contenere numeri.

FORMATO OUTPUT (JSON):
{
  "zanichelli_raccomandato": {
    "titolo": "titolo manuale",
    "autore": "autore",
    "compatibilita": numero_0_100,
    "motivazione_in_una_frase": "perche questo e il migliore per questo programma"
  },
  "confronto_per_criterio": [
    {
      "criterio": "Nome del criterio di confronto",
      "manuale_adottato": "Valutazione sintetica (max 80 caratteri)",
      "zanichelli": "Valutazione sintetica (max 80 caratteri)",
      "vantaggio": "zanichelli o adottato o equivalente"
    }
  ],
  "gap_risolti_da_zanichelli": [
    {
      "gap": "Nome del gap",
      "come_risolve": "Spiegazione concisa (max 150 caratteri)"
    }
  ],
  "gap_NON_risolti": [
    "Gap che Zanichelli non risolve (onesta commerciale)"
  ],
  "alternative_zanichelli": [
    {
      "titolo": "titolo alternativo",
      "autore": "autore alternativo",
      "compatibilita": numero_0_100,
      "quando_preferirlo": "In una frase",
      "differenza_dal_raccomandato": "In una frase"
    }
  ]
}

I criteri di confronto devono includere ALMENO:
1. Copertura moduli prioritari per la classe di laurea
2. Approccio didattico e livello
3. Qualita del materiale (esercizi, esempi, apparato iconografico)
4. Aggiornamento contenuti
${hasEvalCriteria ? '5. Allineamento con i criteri disciplinari del framework' : ''}

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                const raccomandazioneResponse = await callLLM(raccomandazionePrompt, 0.2);
                const raccomandazioneObj = JSON.parse(sanitizeJSON(raccomandazioneResponse));
                
                console.log('‚úÖ Raccomandazione Zanichelli generata:', raccomandazioneObj);
                return raccomandazioneObj;
                
            } catch (error) {
                console.error('‚ùå Errore generazione Raccomandazione Zanichelli:', error);
                return null;
            }
        }
        
        // ============================================
        // EXECUTIVE SUMMARY - Generazione sommario ultra-compatto
        // ============================================
        async function generaExecutiveSummary(prog) {
            console.log('üìã Genera Executive Summary');
            
            try {
                // Estrai raccomandazione Zanichelli
                let zanichelliRaccomandato = 'Non disponibile';
                let compatibilita = 0;
                
                if (prog.zanichelli && prog.zanichelli.manuali && prog.zanichelli.manuali.length > 0) {
                    const primario = prog.zanichelli.manuali[0];
                    const titoloPrimario = primario.title || primario.titolo || primario.nome || 'Non specificato';
                    const autorePrimario = primario.author || primario.autore || '';
                    zanichelliRaccomandato = autorePrimario ? `${autorePrimario} - ${titoloPrimario}` : titoloPrimario;
                    compatibilita = primario.compatibilita || 0;
                }
                
                // Estrai info da analisi strategica se disponibile
                let infoStrategica = '';
                if (prog.analisi_strategica && prog.analisi_strategica.strategia) {
                    const strat = prog.analisi_strategica.strategia;
                    if (strat.raccomandazione_finale) {
                        infoStrategica = `\nRACCOMANDAZIONE STRATEGICA GIA' GENERATA:\n${strat.raccomandazione_finale}`;
                    }
                    if (strat.zanichelli_raccomandato && strat.zanichelli_raccomandato.nome) {
                        const nomeStrat = strat.zanichelli_raccomandato.nome;
                        const autoreStrat = strat.zanichelli_raccomandato.autore || '';
                        zanichelliRaccomandato = autoreStrat ? `${autoreStrat} - ${nomeStrat}` : nomeStrat;
                        compatibilita = strat.zanichelli_raccomandato.compatibilita || compatibilita;
                    }
                }
                
                const summaryPrompt = `Sei un assistente strategico per un promotore editoriale universitario.

Hai a disposizione l'analisi completa di un programma didattico:

FASE 0 (Profilo Preliminare):
${JSON.stringify(prog.analisi_preliminare, null, 2)}

FASE 0.5 (Scelta Editoriale):
${JSON.stringify(prog.motivazioni_scelta, null, 2)}

FASE 2 (Gap Analysis):
- Manuale adottato: ${prog.manuale_adottato}
- Gap identificati: ${JSON.stringify(prog.gap_manuale?.gap || [])}
- Punti debolezza: ${JSON.stringify(prog.gap_manuale?.punti_debolezza || [])}

RACCOMANDAZIONE ZANICHELLI:
- Titolo: ${zanichelliRaccomandato}
- Compatibilita': ${compatibilita}/100
${infoStrategica}

Il promotore sta per entrare nell'ufficio del docente. 
Ha 30 SECONDI per leggere questo sommario.

Genera un executive summary con ESATTAMENTE questi 6 campi, 
ciascuno di MASSIMO 1 riga (max 100 caratteri):

FORMATO OUTPUT (JSON):
{
  "docente_in_breve": "Tipo docente (innovatore/conservatore/...), tratto distintivo principale basato sul programma",
  "situazione_attuale": "Manuale X, punto debole principale, come compensa",
  "opportunita": "Cosa proporre e perche' in una frase",
  "zanichelli_raccomandato": "${zanichelliRaccomandato} ‚Äî ${getCompatibilitaLabel(compatibilita)}",
  "approccio_colloquio": "Come aprire e quale tono usare con QUESTO docente",
  "attenzione": "L'unica cosa da NON fare/dire con questo docente"
}

Sii TELEGRAFICAMENTE sintetico. 
Ogni parola in piu' e' una parola che il promotore non legge.
NON usare frasi generiche. Ogni campo deve essere specifico per QUESTO programma.
NON usare punteggi numerici, percentuali o frazioni (es. 95/100). Usa linguaggio commerciale qualitativo.

RISPONDI SOLO CON IL JSON, NIENT'ALTRO.`;

                const summaryResponse = await callLLM(summaryPrompt, 0.1);
                const summaryObj = JSON.parse(sanitizeJSON(summaryResponse));
                
                console.log('‚úÖ Executive Summary generato:', summaryObj);
                return summaryObj;
                
            } catch (error) {
                console.error('‚ùå Errore generazione Executive Summary:', error);
                return null;
            }
        }

        // === HELPER GLOBALI: Traduzione numeri tecnici in linguaggio promotore ===
        const getPunteggioColor = (p, max) => {
            const perc = (p / max) * 100;
            return perc >= 80 ? 'text-green-600' : perc >= 60 ? 'text-yellow-600' : 'text-red-600';
        };

        const getPunteggioLabel = (p, max) => {
            const perc = (p / max) * 100;
            return perc >= 80 ? 'Ottimo' : perc >= 60 ? 'Buono' : perc >= 40 ? 'Sufficiente' : 'Insufficiente';
        };

        const getCompatibilitaColor = (comp) => {
            return comp === 'Alta' ? 'text-green-600' : comp === 'Media' ? 'text-yellow-600' : 'text-red-600';
        };

        const getCompatibilitaLabel = (valore) => {
            if (valore >= 90) return 'Eccellente corrispondenza con il programma';
            if (valore >= 80) return 'Ottima corrispondenza con il programma';
            if (valore >= 70) return 'Buona corrispondenza con il programma';
            if (valore >= 60) return 'Discreta corrispondenza';
            return 'Corrispondenza parziale';
        };

        const getCompatibilitaBadgeColor = (valore) => {
            if (valore >= 80) return 'bg-green-100 text-green-800';
            if (valore >= 60) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        };

        const getCoperturaProgrammaLabel = (punteggio, max) => {
            const perc = (punteggio / max) * 100;
            if (perc >= 90) return 'Copre praticamente tutto il programma';
            if (perc >= 80) return 'Copre la grande maggioranza del programma';
            if (perc >= 70) return 'Copre buona parte del programma';
            if (perc >= 60) return 'Copre una parte significativa del programma';
            return 'Copertura parziale del programma';
        };

        const getDifferenzaLabel = (diff) => {
            const abs = Math.abs(diff);
            if (diff > 0) {
                if (abs >= 40) return 'Nettamente migliore del manuale attuale';
                if (abs >= 20) return 'Significativamente migliore del manuale attuale';
                if (abs >= 10) return 'Migliore del manuale attuale';
                return 'Leggermente migliore del manuale attuale';
            } else {
                if (abs >= 20) return 'Il manuale attuale ha una copertura superiore, ma Zanichelli offre vantaggi qualitativi';
                if (abs >= 10) return 'Copertura simile al manuale attuale, con differenze qualitative';
                return 'Copertura paragonabile al manuale attuale';
            }
        };

        // Funzione helper per generare HTML della sezione strategica
        function renderAnalisiStrategica(strategia, scenario) {
            console.log('üé® Render Analisi Strategica:', scenario);
            
            let html = '';
            
            if (scenario === 'zanichelli_principale') {
                // ==========================================
                // HTML SCENARIO 1: Zanichelli Principale
                // ==========================================
                html = `
                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-l-4 border-indigo-600 p-6 mt-6 rounded-r-lg shadow-md">
                    <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üéØ</span>
                        Analisi Strategica Zanichelli
                    </h3>
                    
                    <!-- Analisi Scelta Attuale -->
                    <div class="bg-white rounded-lg p-5 mb-4 shadow-sm">
                        <h4 class="font-bold text-lg text-indigo-800 mb-3 flex items-center">
                            ${strategia.analisi_scelta_attuale.zanichelli_adottato_ottimale ? 
                                '<span class="text-green-600 mr-2">‚úÖ</span>Conferma Scelta' : 
                                '<span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>Analisi Scelta'}
                        </h4>
                        <p class="text-gray-700 mb-3">${strategia.analisi_scelta_attuale.motivazione}</p>
                        
                        ${strategia.analisi_scelta_attuale.punti_forza_scelta && strategia.analisi_scelta_attuale.punti_forza_scelta.length > 0 ? `
                            <div class="mt-3">
                                <p class="font-semibold text-gray-800 mb-2">üí™ Punti di Forza:</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    ${strategia.analisi_scelta_attuale.punti_forza_scelta.map(f => `<li class="text-gray-700">${f}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Confronto Altri Zanichelli -->
                    ${strategia.confronto_altri_zanichelli.esiste_zanichelli_migliore ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-lg text-yellow-800 mb-3 flex items-center">
                                <span class="mr-2">‚ö†Ô∏è</span>Alternativa Zanichelli Migliore Disponibile
                            </h4>
                            <div class="bg-white rounded p-4 mb-3">
                                <p class="font-bold text-lg text-yellow-900">üìó ${strategia.confronto_altri_zanichelli.nome}</p>
                                ${strategia.confronto_altri_zanichelli.compatibilita_superiore ? 
                                    `<p class="text-sm text-yellow-700 mt-1">${getCompatibilitaLabel(strategia.confronto_altri_zanichelli.compatibilita_superiore || 0)}</p>` : ''}
                            </div>
                            
                            ${strategia.confronto_altri_zanichelli.vantaggi_upgrade && strategia.confronto_altri_zanichelli.vantaggi_upgrade.length > 0 ? `
                                <div class="mb-3">
                                    <p class="font-semibold text-gray-800 mb-2">‚ú® Vantaggi Upgrade:</p>
                                    <ul class="list-disc ml-5 space-y-1">
                                        ${strategia.confronto_altri_zanichelli.vantaggi_upgrade.map(v => `<li class="text-gray-700">${v}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${strategia.confronto_altri_zanichelli.quando_consigliare_upgrade ? `
                                <div class="bg-yellow-100 rounded p-3 mt-3">
                                    <p class="font-semibold text-yellow-900 mb-1">üí° Quando Consigliare Upgrade:</p>
                                    <p class="text-gray-700 text-sm">${strategia.confronto_altri_zanichelli.quando_consigliare_upgrade}</p>
                                </div>
                            ` : ''}
                            
                            ${strategia.confronto_altri_zanichelli.argomenti_chiave_upgrade && strategia.confronto_altri_zanichelli.argomenti_chiave_upgrade.length > 0 ? `
                                <div class="mt-3">
                                    <p class="font-semibold text-gray-800 mb-2">üéØ Argomenti Chiave:</p>
                                    <ul class="list-disc ml-5 space-y-1">
                                        ${strategia.confronto_altri_zanichelli.argomenti_chiave_upgrade.map(a => `<li class="text-gray-700">${a}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Confronto Competitor -->
                    ${strategia.confronto_competitor.competitor_superiore_esiste ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-lg text-red-800 mb-3 flex items-center">
                                <span class="mr-2">üö®</span>Competitor Superiore Rilevato
                            </h4>
                            <div class="bg-white rounded p-4 mb-3">
                                <p class="font-bold text-lg text-red-900">üìï ${strategia.confronto_competitor.nome_competitor}</p>
                                ${strategia.confronto_competitor.punteggio_competitor ? 
                                    `<p class="text-sm text-red-700 mt-1">Copertura: ${getCoperturaProgrammaLabel(strategia.confronto_competitor.punteggio_competitor || 0, 270)}</p>` : ''}
                            </div>
                            
                            ${strategia.confronto_competitor.gap_zanichelli_vs_competitor && strategia.confronto_competitor.gap_zanichelli_vs_competitor.length > 0 ? `
                                <div class="mb-3">
                                    <p class="font-semibold text-gray-800 mb-2">‚ö†Ô∏è Gap Zanichelli vs Competitor:</p>
                                    <ul class="list-disc ml-5 space-y-1">
                                        ${strategia.confronto_competitor.gap_zanichelli_vs_competitor.map(g => `<li class="text-gray-700">${g}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="bg-green-50 border border-green-200 rounded p-4 mt-3">
                                <p class="font-semibold text-green-900 mb-2">üõ°Ô∏è Come Difendere Zanichelli:</p>
                                
                                ${strategia.confronto_competitor.difesa_zanichelli.punti_forza_unici && strategia.confronto_competitor.difesa_zanichelli.punti_forza_unici.length > 0 ? `
                                    <div class="mb-3">
                                        <p class="font-semibold text-gray-800 mb-1">üí™ Punti di Forza Unici:</p>
                                        <ul class="list-disc ml-5 space-y-1">
                                            ${strategia.confronto_competitor.difesa_zanichelli.punti_forza_unici.map(f => `<li class="text-gray-700 text-sm">${f}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${strategia.confronto_competitor.difesa_zanichelli.quando_zanichelli_preferibile ? `
                                    <div class="mb-3">
                                        <p class="font-semibold text-gray-800 mb-1">‚úÖ Quando Zanichelli √® Preferibile:</p>
                                        <p class="text-gray-700 text-sm">${strategia.confronto_competitor.difesa_zanichelli.quando_zanichelli_preferibile}</p>
                                    </div>
                                ` : ''}
                                
                                ${strategia.confronto_competitor.difesa_zanichelli.argomenti_risposta && strategia.confronto_competitor.difesa_zanichelli.argomenti_risposta.length > 0 ? `
                                    <div>
                                        <p class="font-semibold text-gray-800 mb-1">üéØ Argomenti di Risposta:</p>
                                        <ul class="list-disc ml-5 space-y-1">
                                            ${strategia.confronto_competitor.difesa_zanichelli.argomenti_risposta.map(a => `<li class="text-gray-700 text-sm">${a}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Raccomandazione Finale -->
                    <div class="bg-indigo-100 border border-indigo-300 rounded-lg p-5">
                        <h4 class="font-bold text-lg text-indigo-900 mb-3 flex items-center">
                            <span class="mr-2">üìå</span>Raccomandazione Finale
                        </h4>
                        <p class="text-gray-800 leading-relaxed">${strategia.raccomandazione_finale}</p>
                    </div>
                    
                    <!-- Doppia Variante Pitch -->
                    ${strategia.pitch ? `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-5 mt-4 rounded-r-lg">
                        <h4 class="font-bold text-lg text-blue-900 mb-4 flex items-center">
                            <span class="mr-2">üí¨</span>Pitch di Apertura
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-lg p-4 border border-blue-200 shadow-sm">
                                <p class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-1">üìß</span> Primo Contatto
                                </p>
                                <p class="text-sm text-gray-700 italic leading-relaxed">"${strategia.pitch.primo_contatto}"</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-blue-200 shadow-sm">
                                <p class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-1">ü§ù</span> Docente Conosciuto
                                </p>
                                <p class="text-sm text-gray-700 italic leading-relaxed">"${strategia.pitch.docente_conosciuto}"</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                `;
                
            } else if (scenario === 'opportunita_conversione') {
                // ==========================================
                // HTML SCENARIO 2: Opportunit√† Conversione
                // ==========================================
                html = `
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-600 p-6 mt-6 rounded-r-lg shadow-md">
                    <h3 class="text-xl font-bold text-green-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üéØ</span>
                        Opportunit√† di Conversione a Zanichelli
                    </h3>
                    
                    <!-- Superiorit√† Zanichelli -->
                    <div class="bg-white rounded-lg p-5 mb-4 shadow-sm">
                        <h4 class="font-bold text-lg ${strategia.zanichelli_superiore ? 'text-green-700' : 'text-gray-700'} mb-3 flex items-center">
                            <span class="mr-2">${strategia.zanichelli_superiore ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                            ${strategia.zanichelli_superiore ? 'Zanichelli √à Superiore al Competitor' : 'Analisi Comparativa'}
                        </h4>
                        
                        ${strategia.differenza_punteggio ? `
                            <div class="bg-green-50 rounded p-4 mb-3">
                                <p class="text-lg font-bold ${strategia.differenza_punteggio > 0 ? 'text-green-700' : 'text-gray-700'}">
                                    ${getDifferenzaLabel(strategia.differenza_punteggio)}
                                    ${strategia.differenza_punteggio > 0 ? 'üéâ' : ''}
                                </p>
                            </div>
                        ` : ''}
                        
                        ${strategia.vantaggi_zanichelli && strategia.vantaggi_zanichelli.length > 0 ? `
                            <div class="mt-3">
                                <p class="font-semibold text-gray-800 mb-2">‚ú® Vantaggi Zanichelli:</p>
                                <ul class="list-disc ml-5 space-y-1">
                                    ${strategia.vantaggi_zanichelli.map(v => `<li class="text-gray-700">${v}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Gap Risolti -->
                    ${strategia.gap_risolti_da_zanichelli && strategia.gap_risolti_da_zanichelli.length > 0 ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-lg text-blue-800 mb-3 flex items-center">
                                <span class="mr-2">üîß</span>Gap del Competitor Risolti da Zanichelli
                            </h4>
                            <div class="space-y-3">
                                ${strategia.gap_risolti_da_zanichelli.map(g => `
                                    <div class="bg-white rounded p-4">
                                        <p class="font-semibold text-blue-900 mb-1">‚ö†Ô∏è ${g.gap}</p>
                                        <p class="text-gray-700 text-sm">‚úÖ ${g.come_zanichelli_risolve}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Pitch di Conversione -->
                    ${strategia.pitch_conversione ? `
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-300 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-lg text-yellow-900 mb-3 flex items-center">
                                <span class="mr-2">üí°</span>Pitch di Conversione
                            </h4>
                            
                            ${strategia.pitch_conversione.argomenti_chiave && strategia.pitch_conversione.argomenti_chiave.length > 0 ? `
                                <div class="mb-4">
                                    <p class="font-semibold text-gray-800 mb-2">üéØ Argomenti Chiave per il Docente:</p>
                                    <ol class="list-decimal ml-5 space-y-2">
                                        ${strategia.pitch_conversione.argomenti_chiave.map(a => `<li class="text-gray-700 font-medium">${a}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            
                            ${strategia.pitch_conversione.confronto_diretto ? `
                                <div class="bg-white rounded p-4 mb-4">
                                    <p class="font-semibold text-gray-800 mb-2">üìä Confronto Diretto:</p>
                                    <p class="text-gray-700 leading-relaxed">${strategia.pitch_conversione.confronto_diretto}</p>
                                </div>
                            ` : ''}
                            
                            ${strategia.pitch_conversione.obiezioni_probabili && strategia.pitch_conversione.obiezioni_probabili.length > 0 ? `
                                <div class="bg-yellow-100 rounded p-4">
                                    <p class="font-semibold text-gray-800 mb-3">‚ö†Ô∏è Possibili Obiezioni e Risposte:</p>
                                    <div class="space-y-3">
                                        ${strategia.pitch_conversione.obiezioni_probabili.map(o => `
                                            <div class="bg-white rounded p-3">
                                                <p class="font-semibold text-red-700 mb-1">‚ùì "${o.obiezione}"</p>
                                                <p class="text-gray-700 text-sm">üí¨ <strong>Risposta:</strong> ${o.risposta}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Raccomandazione Finale -->
                    <div class="bg-green-100 border border-green-300 rounded-lg p-5">
                        <h4 class="font-bold text-lg text-green-900 mb-3 flex items-center">
                            <span class="mr-2">üìå</span>Strategia per il Promotore
                        </h4>
                        <p class="text-gray-800 leading-relaxed">${strategia.raccomandazione_finale}</p>
                    </div>
                    
                    <!-- Doppia Variante Pitch -->
                    ${(strategia.pitch_conversione?.pitch_breve_primo_contatto || strategia.pitch?.primo_contatto) ? `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-5 mt-4 rounded-r-lg">
                        <h4 class="font-bold text-lg text-blue-900 mb-4 flex items-center">
                            <span class="mr-2">üí¨</span>Pitch di Apertura
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-lg p-4 border border-blue-200 shadow-sm">
                                <p class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-1">üìß</span> Primo Contatto
                                </p>
                                <p class="text-sm text-gray-700 italic leading-relaxed">"${strategia.pitch_conversione?.pitch_breve_primo_contatto || strategia.pitch?.primo_contatto || ''}"</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-blue-200 shadow-sm">
                                <p class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-1">ü§ù</span> Docente Conosciuto
                                </p>
                                <p class="text-sm text-gray-700 italic leading-relaxed">"${strategia.pitch_conversione?.pitch_breve_docente_conosciuto || strategia.pitch?.docente_conosciuto || ''}"</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                `;
            } else if (scenario === 'nessun_zanichelli') {
                // ==========================================
                // HTML SCENARIO 3: Penetrazione Mercato
                // ==========================================
                html = `
                <div class="bg-gradient-to-br from-green-50 to-teal-50 border-2 border-green-400 rounded-lg p-6 mt-6">
                    <h3 class="text-2xl font-bold text-green-900 mb-4 flex items-center">
                        <span class="mr-3">üöÄ</span>Strategia di Penetrazione Mercato
                    </h3>
                    <p class="text-green-800 mb-4 font-medium">
                        <strong>Scenario:</strong> Nessun Zanichelli in bibliografia ‚Üí Opportunit√† di proporre Zanichelli per la prima volta
                    </p>
                    
                    <!-- Zanichelli Raccomandato -->
                    ${strategia.zanichelli_raccomandato ? `
                        <div class="bg-white border border-green-300 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-xl text-green-900 mb-3 flex items-center">
                                <span class="mr-2">‚≠ê</span>Zanichelli Raccomandato
                            </h4>
                            <div class="space-y-2">
                                <p class="text-lg font-bold text-gray-900">
                                    ${strategia.zanichelli_raccomandato.nome}${strategia.zanichelli_raccomandato.autore ? ` - ${strategia.zanichelli_raccomandato.autore}` : ''}${strategia.zanichelli_raccomandato.editore ? ` (${strategia.zanichelli_raccomandato.editore})` : ''}
                                </p>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div class="bg-green-100 rounded p-3">
                                        <p class="text-xs text-green-700 mb-1">Corrispondenza con il Programma</p>
                                        <p class="text-lg font-bold text-green-900">${getCompatibilitaLabel(strategia.zanichelli_raccomandato.compatibilita || 0)}</p>
                                    </div>
                                    <div class="bg-green-100 rounded p-3">
                                        <p class="text-xs text-green-700 mb-1">Copertura Argomenti</p>
                                        <p class="text-lg font-bold text-green-900">${getCoperturaProgrammaLabel(strategia.zanichelli_raccomandato.punteggio_framework || 0, 270)}</p>
                                    </div>
                                </div>
                                ${strategia.zanichelli_raccomandato.superiore_a_competitor ? `
                                    <div class="bg-green-50 border-l-4 border-green-500 p-3 mt-3">
                                        <p class="text-green-800 font-semibold">
                                            ‚úÖ ${getDifferenzaLabel(strategia.zanichelli_raccomandato.differenza_punteggio || 0)}
                                        </p>
                                    </div>
                                ` : `
                                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mt-3">
                                        <p class="text-yellow-800 font-semibold">
                                            ${getDifferenzaLabel(strategia.zanichelli_raccomandato.differenza_punteggio || 0)}
                                        </p>
                                    </div>
                                `}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Gap Risolti -->
                    ${strategia.gap_risolti_da_zanichelli && strategia.gap_risolti_da_zanichelli.length > 0 ? `
                        <div class="bg-white border border-green-300 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-lg text-green-900 mb-3 flex items-center">
                                <span class="mr-2">üîß</span>Gap del Competitor Risolti da Zanichelli
                            </h4>
                            <div class="space-y-3">
                                ${strategia.gap_risolti_da_zanichelli.map(g => `
                                    <div class="bg-green-50 rounded p-4 border-l-4 border-green-500">
                                        <p class="font-semibold text-green-900 mb-2">üìå ${g.gap}</p>
                                        <p class="text-gray-700 leading-relaxed">${g.come_zanichelli_risolve}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Vantaggi Zanichelli -->
                    ${strategia.vantaggi_zanichelli && strategia.vantaggi_zanichelli.length > 0 ? `
                        <div class="bg-white border border-green-300 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-lg text-green-900 mb-3 flex items-center">
                                <span class="mr-2">üéØ</span>Vantaggi Chiave Zanichelli
                            </h4>
                            <ul class="space-y-2">
                                ${strategia.vantaggi_zanichelli.map(v => `
                                    <li class="flex items-start">
                                        <span class="text-green-600 mr-2 font-bold text-xl">‚úì</span>
                                        <span class="text-gray-700 font-medium">${v}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <!-- Pitch Primo Contatto -->
                    ${strategia.pitch_primo_contatto ? `
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-300 rounded-lg p-5 mb-4">
                            <h4 class="font-bold text-lg text-blue-900 mb-3 flex items-center">
                                <span class="mr-2">üí¨</span>Pitch per Primo Contatto
                            </h4>
                            
                            ${strategia.pitch_primo_contatto.apertura ? `
                                <div class="bg-white rounded p-4 mb-4">
                                    <p class="font-semibold text-gray-800 mb-2">üé§ Apertura:</p>
                                    <p class="text-gray-700 leading-relaxed italic">"${strategia.pitch_primo_contatto.apertura}"</p>
                                </div>
                            ` : ''}
                            
                            ${strategia.pitch_primo_contatto.argomenti_chiave && strategia.pitch_primo_contatto.argomenti_chiave.length > 0 ? `
                                <div class="mb-4">
                                    <p class="font-semibold text-gray-800 mb-2">üéØ Argomenti Chiave:</p>
                                    <ol class="list-decimal ml-5 space-y-2">
                                        ${strategia.pitch_primo_contatto.argomenti_chiave.map(a => `<li class="text-gray-700 font-medium">${a}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            
                            ${strategia.pitch_primo_contatto.confronto_diretto ? `
                                <div class="bg-white rounded p-4 mb-4">
                                    <p class="font-semibold text-gray-800 mb-2">üìä Confronto Diretto:</p>
                                    <p class="text-gray-700 leading-relaxed">${strategia.pitch_primo_contatto.confronto_diretto}</p>
                                </div>
                            ` : ''}
                            
                            ${strategia.pitch_primo_contatto.obiezioni_probabili && strategia.pitch_primo_contatto.obiezioni_probabili.length > 0 ? `
                                <div class="bg-blue-100 rounded p-4">
                                    <p class="font-semibold text-gray-800 mb-3">‚ö†Ô∏è Possibili Obiezioni e Risposte:</p>
                                    <div class="space-y-3">
                                        ${strategia.pitch_primo_contatto.obiezioni_probabili.map(o => `
                                            <div class="bg-white rounded p-3">
                                                <p class="font-semibold text-red-700 mb-1">‚ùì "${o.obiezione}"</p>
                                                <p class="text-green-700 mt-2">üí° <strong>Risposta:</strong> ${o.risposta}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Raccomandazione Finale -->
                    ${strategia.raccomandazione_finale ? `
                        <div class="bg-green-100 border-2 border-green-500 rounded-lg p-5">
                            <h4 class="font-bold text-lg text-green-900 mb-3 flex items-center">
                                <span class="mr-2">üìù</span>Strategia Completa per il Promotore
                            </h4>
                            <p class="text-gray-800 leading-relaxed whitespace-pre-line">${strategia.raccomandazione_finale}</p>
                        </div>
                    ` : ''}
                    
                    <!-- Doppia Variante Pitch -->
                    ${(strategia.pitch_primo_contatto?.pitch_breve_primo_contatto || strategia.pitch?.primo_contatto) ? `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-5 mt-4 rounded-r-lg">
                        <h4 class="font-bold text-lg text-blue-900 mb-4 flex items-center">
                            <span class="mr-2">üí¨</span>Pitch di Apertura
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-lg p-4 border border-blue-200 shadow-sm">
                                <p class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-1">üìß</span> Primo Contatto
                                </p>
                                <p class="text-sm text-gray-700 italic leading-relaxed">"${strategia.pitch_primo_contatto?.pitch_breve_primo_contatto || strategia.pitch?.primo_contatto || ''}"</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-blue-200 shadow-sm">
                                <p class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-1">ü§ù</span> Docente Conosciuto
                                </p>
                                <p class="text-sm text-gray-700 italic leading-relaxed">"${strategia.pitch_primo_contatto?.pitch_breve_docente_conosciuto || strategia.pitch?.docente_conosciuto || ''}"</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                `;
            }
            
            return html;
        }
        
        // Funzione per aggiungere la sezione al DOM (usata durante l'analisi)
        function aggiungiSezioneStrategica(strategia, scenario) {
            console.log('üìù Aggiungo sezione strategica al report');
            
            // Trova il contenitore risultati (ID corretto: viewRisultati)
            const risultatiDiv = document.getElementById('viewRisultati');
            if (!risultatiDiv) {
                console.error('‚ùå Div viewRisultati non trovato');
                return;
            }
            
            console.log('‚úÖ Trovato div viewRisultati');
            
            // Genera HTML
            const html = renderAnalisiStrategica(strategia, scenario);
            
            // Inserisci PRIMA della sezione Zanichelli
            // Cerca tutti gli h3 e trova quello che contiene "Manuali Zanichelli" o "Valutazione Compatibilit√†"
            const allH3 = risultatiDiv.querySelectorAll('h3');
            let sezioneZanichelli = null;
            
            for (let h3 of allH3) {
                if (h3.textContent.includes('Manuali Zanichelli')) {
                    sezioneZanichelli = h3;
                    break;
                }
            }
            
            if (sezioneZanichelli && sezioneZanichelli.parentElement) {
                console.log('‚úÖ Trovata sezione Zanichelli, inserisco PRIMA');
                sezioneZanichelli.parentElement.insertAdjacentHTML('beforebegin', html);
            } else {
                // Se non trova la sezione Zanichelli, inserisci alla fine di risultatiView
                console.log('‚ö†Ô∏è Sezione Zanichelli non trovata, inserisco alla fine');
                risultatiDiv.insertAdjacentHTML('beforeend', html);
            }
            
            console.log('‚úÖ Sezione strategica aggiunta al DOM');
        }
        
        // ============================================
        // FINE FASE 5.5
        // ============================================

        function mostraRisultati(prog) {
            console.log('üñºÔ∏è mostraRisultati chiamata con prog:', {
                hasAnalisiStrategica: !!prog.analisi_strategica,
                analisiStrategicaScenario: prog.analisi_strategica?.scenario
            });
            
            const html = `
                <div class="space-y-6">
                    <!-- Disclaimer Situazioni Extra-Didattiche -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-yellow-800">
                                    ‚ö†Ô∏è Nota Importante per il Promotore
                                </h3>
                                <div class="mt-2 text-sm text-yellow-700">
                                    <p class="mb-2">Questa analisi si basa su criteri didattici e scientifici. Le raccomandazioni potrebbero richiedere un approccio diverso se esistono situazioni extra-didattiche:</p>
                                    <ul class="list-disc list-inside space-y-1 ml-2">
                                        <li><strong>Docente autore/coautore/traduttore del manuale</strong> ‚Üí Probabilit√† di cambio molto scarse</li>
                                        <li><strong>Autori del manuale colleghi di Dipartimento/Ateneo</strong> ‚Üí Probabilit√† di cambio molto basse</li>
                                        <li><strong>Collaborazioni scientifiche attive tra docente e autori</strong> ‚Üí Probabilit√† di cambio basse</li>
                                    </ul>
                                    <p class="mt-2 text-xs italic">In questi casi, valuta attentamente l'opportunit√† di proporre un cambio manuale prima di contattare il docente.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Header -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-start justify-between">
                            <div>
                                <h2 class="text-2xl font-bold">${prog.denominazione_corso}</h2>
                                <div class="mt-2 space-y-1 text-sm text-gray-600">
                                    <p><strong>Universit√†:</strong> ${prog.universita}</p>
                                    <p><strong>Corso di Laurea:</strong> ${prog.corso_laurea_nome} (${prog.contesto})</p>
                                    ${prog.docente ? `<p><strong>Docente:</strong> ${prog.docente}</p>` : ''}
                                    ${prog.cfu ? `<p><strong>CFU:</strong> ${prog.cfu}</p>` : ''}
                                    ${prog.ore ? `<p><strong>Ore:</strong> ${prog.ore}</p>` : ''}
                                    <p><strong>Manuale Adottato:</strong> ${prog.manuale_adottato}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-indigo-600">
                                    ${getCoperturaProgrammaLabel(prog.punteggi.totale, 270)}
                                </div>
                                <p class="text-sm font-medium mt-1 ${getPunteggioColor(prog.punteggi.totale, 270)}">
                                    ${getPunteggioLabel(prog.punteggi.totale, 270)}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Banner Scenario Zanichelli -->
                    ${prog.analisi_strategica?.scenario ? `
                    <div class="${prog.analisi_strategica.scenario === 'zanichelli_principale' ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400' : prog.analisi_strategica.scenario === 'opportunita_conversione' ? 'bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-400' : 'bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-400'} rounded-lg p-4 shadow">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${prog.analisi_strategica.scenario === 'zanichelli_principale' ? '‚úÖ' : prog.analisi_strategica.scenario === 'opportunita_conversione' ? 'üéØ' : 'üîç'}</span>
                            <div>
                                <p class="font-bold text-lg ${prog.analisi_strategica.scenario === 'zanichelli_principale' ? 'text-green-900' : prog.analisi_strategica.scenario === 'opportunita_conversione' ? 'text-blue-900' : 'text-orange-900'}">
                                    ${prog.analisi_strategica.scenario === 'zanichelli_principale' ? 'Zanichelli e gia il manuale principale' : prog.analisi_strategica.scenario === 'opportunita_conversione' ? 'Opportunita di conversione a Zanichelli' : 'Nessun Zanichelli in bibliografia'}
                                </p>
                                <p class="text-sm ${prog.analisi_strategica.scenario === 'zanichelli_principale' ? 'text-green-700' : prog.analisi_strategica.scenario === 'opportunita_conversione' ? 'text-blue-700' : 'text-orange-700'}">
                                    ${prog.analisi_strategica.scenario === 'zanichelli_principale' ? 'Strategia: conferma adozione, difesa da competitor, eventuale upgrade' : prog.analisi_strategica.scenario === 'opportunita_conversione' ? 'Zanichelli e gia tra i testi alternativi ‚Äî proporre come principale' : 'Strategia: penetrazione ‚Äî proporre inserimento Zanichelli in bibliografia'}
                                </p>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Executive Summary -->
                    ${prog.executive_summary ? `
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-400 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl mr-3">üìã</span>
                            <h3 class="text-xl font-bold text-yellow-900">Executive Summary</h3>
                            <span class="ml-auto text-xs text-yellow-700 font-medium bg-yellow-200 px-2 py-1 rounded">‚è±Ô∏è Lettura: 30 secondi</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <!-- Colonna 1 -->
                            <div>
                                <p class="mb-3">
                                    <span class="font-semibold text-yellow-900">üë§ Docente:</span>
                                    <span class="text-gray-800"> ${prog.executive_summary.docente_in_breve}</span>
                                </p>
                                <p class="mb-3">
                                    <span class="font-semibold text-yellow-900">üìö Situazione:</span>
                                    <span class="text-gray-800"> ${prog.executive_summary.situazione_attuale}</span>
                                </p>
                                <p class="mb-3">
                                    <span class="font-semibold text-yellow-900">üí° Opportunit√†:</span>
                                    <span class="text-gray-800"> ${prog.executive_summary.opportunita}</span>
                                </p>
                            </div>
                            
                            <!-- Colonna 2 -->
                            <div>
                                <p class="mb-3">
                                    <span class="font-semibold text-yellow-900">‚úÖ Raccomandato:</span>
                                    <span class="text-gray-800"> ${prog.executive_summary.zanichelli_raccomandato}</span>
                                </p>
                                <p class="mb-3">
                                    <span class="font-semibold text-yellow-900">üéØ Approccio:</span>
                                    <span class="text-gray-800"> ${prog.executive_summary.approccio_colloquio}</span>
                                </p>
                                <p class="mb-0">
                                    <span class="font-semibold text-red-700">‚ö†Ô∏è Attenzione:</span>
                                    <span class="text-gray-800 italic"> ${prog.executive_summary.attenzione}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Sezione 0: Analisi Preliminare (Fase 0) -->
                    ${prog.analisi_preliminare ? `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">
                        <h3 class="text-xl font-bold mb-4 flex items-center text-indigo-900">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">0</span>
                            Analisi Preliminare del Programma
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Quadro Generale -->
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="text-lg font-semibold text-indigo-800 mb-3 flex items-center">
                                    üìä Quadro Generale
                                </h4>
                                
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-1">Tipologia Corso</p>
                                        <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.quadro_generale.tipologia}</p>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-2">Distribuzione Tematica</p>
                                        <div class="space-y-2">
                                            ${prog.analisi_preliminare.quadro_generale.distribuzione_tematica.map(area => `
                                                <div class="flex items-center justify-between">
                                                    <span class="text-sm text-gray-700">${area.area}</span>
                                                    <div class="flex items-center space-x-2">
                                                        <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                            <div class="h-full bg-indigo-500" style="width: ${area.percentuale}%"></div>
                                                        </div>
                                                        <span class="text-sm font-medium text-indigo-600">${area.percentuale}%</span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-1">Livello di Complessit√†</p>
                                        <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full ${
                                            prog.analisi_preliminare.quadro_generale.livello_complessita === 'avanzato' ? 'bg-red-100 text-red-800' :
                                            prog.analisi_preliminare.quadro_generale.livello_complessita === 'intermedio' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                        }">
                                            ${prog.analisi_preliminare.quadro_generale.livello_complessita.toUpperCase()}
                                        </span>
                                    </div>
                                    
                                    ${prog.analisi_preliminare.quadro_generale.note ? `
                                        <div class="mt-3 pt-3 border-t">
                                            <p class="text-xs text-gray-600">${prog.analisi_preliminare.quadro_generale.note}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Profilo Pedagogico -->
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="text-lg font-semibold text-indigo-800 mb-3 flex items-center">
                                    üë§ Profilo Pedagogico del Docente
                                </h4>
                                
                                <div class="space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Approccio</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.approccio}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Livello</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.livello}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Stile</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.stile}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 mb-1">Orientamento</p>
                                            <p class="text-sm font-medium text-gray-900">${prog.analisi_preliminare.profilo_pedagogico.orientamento}</p>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <p class="text-xs font-medium text-gray-500 mb-2">Enfasi Particolari</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${prog.analisi_preliminare.profilo_pedagogico.enfasi.map(e => `
                                                <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-medium rounded-full">
                                                    ${e}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    ${prog.analisi_preliminare.profilo_pedagogico.note ? `
                                        <div class="mt-3 pt-3 border-t">
                                            <p class="text-xs text-gray-600">${prog.analisi_preliminare.profilo_pedagogico.note}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Allineamento con Classe di Laurea -->
                            ${prog.analisi_preliminare.allineamento_classe ? `
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="text-lg font-semibold text-indigo-800 mb-3 flex items-center">
                                    üéì Allineamento con ${prog.analisi_preliminare.allineamento_classe.classe || 'Classe di Laurea'}
                                </h4>
                                
                                ${prog.analisi_preliminare.allineamento_classe.allineamento_complessivo ? `
                                <div class="mb-4">
                                    <span class="px-3 py-1 rounded-full text-sm font-bold ${
                                        prog.analisi_preliminare.allineamento_classe.allineamento_complessivo.includes('Alto') ? 'bg-green-100 text-green-800' :
                                        prog.analisi_preliminare.allineamento_classe.allineamento_complessivo.includes('Medio-Alto') ? 'bg-lime-100 text-lime-800' :
                                        prog.analisi_preliminare.allineamento_classe.allineamento_complessivo.includes('Medio') ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">Allineamento: ${prog.analisi_preliminare.allineamento_classe.allineamento_complessivo}</span>
                                </div>
                                ` : ''}

                                ${prog.analisi_preliminare.allineamento_classe.valutazioni && prog.analisi_preliminare.allineamento_classe.valutazioni.length > 0 ? `
                                <div class="border border-gray-200 rounded-lg overflow-hidden">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="bg-gray-50 text-left">
                                                <th class="px-3 py-2 font-medium text-gray-600">Priorit√†</th>
                                                <th class="px-3 py-2 font-medium text-gray-600 text-center">Soddisfatta</th>
                                                <th class="px-3 py-2 font-medium text-gray-600">Evidenza</th>
                                                <th class="px-3 py-2 font-medium text-gray-600">Valutazione</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            ${prog.analisi_preliminare.allineamento_classe.valutazioni.map(v => {
                                                const soddColor = v.soddisfatta === 'si' ? 'text-green-600' : 
                                                    v.soddisfatta === 'parzialmente' ? 'text-yellow-600' : 'text-red-600';
                                                const soddIcon = v.soddisfatta === 'si' ? '‚úÖ' : 
                                                    v.soddisfatta === 'parzialmente' ? 'üü°' : '‚ùå';
                                                const valColor = v.valutazione?.includes('Perfetto') ? 'bg-green-100 text-green-800' :
                                                    v.valutazione?.includes('Buon') ? 'bg-lime-100 text-lime-800' :
                                                    v.valutazione?.includes('parziale') ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-red-100 text-red-800';
                                                return '<tr class="hover:bg-gray-50">' +
                                                    '<td class="px-3 py-2 text-gray-900 font-medium text-xs">' + (v.priorita || '') + '</td>' +
                                                    '<td class="px-3 py-2 text-center ' + soddColor + '">' + soddIcon + '</td>' +
                                                    '<td class="px-3 py-2 text-gray-600 text-xs">' + (v.evidenza || '') + '</td>' +
                                                    '<td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs font-medium ' + valColor + '">' + (v.valutazione || '') + '</span></td>' +
                                                '</tr>';
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}

                            <!-- Criteri Disciplinari (solo se presenti nel framework) -->
                            ${prog.analisi_preliminare.criteri_disciplinari && prog.analisi_preliminare.criteri_disciplinari.length > 0 ? `
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                                    üî¨ Criteri di Valutazione Disciplinari
                                </h4>
                                
                                <div class="border border-purple-200 rounded-lg overflow-hidden">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="bg-purple-50 text-left">
                                                <th class="px-3 py-2 font-medium text-purple-700">Criterio</th>
                                                <th class="px-3 py-2 font-medium text-purple-700">Posizione Docente</th>
                                                <th class="px-3 py-2 font-medium text-purple-700">Evidenze</th>
                                                <th class="px-3 py-2 font-medium text-purple-700 text-center">Confidenza</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-purple-100">
                                            ${prog.analisi_preliminare.criteri_disciplinari.map(c => {
                                                const confColor = c.confidenza === 'alta' ? 'bg-green-100 text-green-800' :
                                                    c.confidenza === 'media' ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-red-100 text-red-800';
                                                return '<tr class="hover:bg-purple-50/30">' +
                                                    '<td class="px-3 py-2 text-gray-900 font-medium text-xs">' + (c.criterio?.replace(/_/g, ' ') || '') + '</td>' +
                                                    '<td class="px-3 py-2 text-gray-700 text-xs">' + (c.posizione_docente || '') + '</td>' +
                                                    '<td class="px-3 py-2 text-gray-600 text-xs">' + (c.evidenze || '') + '</td>' +
                                                    '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ' + confColor + '">' + (c.confidenza || '') + '</span></td>' +
                                                '</tr>';
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${prog.motivazioni_scelta ? `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4 text-blue-800 flex items-center gap-2">
                            <span>üéØ</span>
                            <span>Logica della Scelta Editoriale</span>
                        </h2>
                        
                        <!-- PARTE 1: Scelta Manuale Principale -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-3 text-gray-800">üìö Perch√© Questo Manuale Principale?</h3>
                            
                            <!-- Motivazioni -->
                            <div class="space-y-3 mb-4">
                                ${prog.motivazioni_scelta.scelta_manuale_principale.motivazioni.map((m, idx) => `
                                    <div class="flex items-start gap-3 bg-gray-50 rounded-lg p-3">
                                        <span class="flex-shrink-0 w-6 h-6 rounded-full text-sm font-bold flex items-center justify-center ${
                                            m.peso === 'alto' ? 'bg-green-500 text-white' : 
                                            m.peso === 'medio' ? 'bg-yellow-400 text-gray-800' : 
                                            'bg-gray-400 text-white'
                                        }">${idx + 1}</span>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <p class="text-sm font-semibold text-gray-900">${m.fattore}</p>
                                                <span class="px-2 py-0.5 text-xs font-medium rounded-full ${
                                                    m.peso === 'alto' ? 'bg-green-100 text-green-700' : 
                                                    m.peso === 'medio' ? 'bg-yellow-100 text-yellow-700' : 
                                                    'bg-gray-100 text-gray-600'
                                                }">Peso: ${m.peso}</span>
                                            </div>
                                            <p class="text-sm text-gray-600">${m.evidenza}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Natura Scelta + Priorit√† (2 colonne) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gradient-to-br ${
                                    prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.tipo === 'convinta' ? 'from-green-50 to-green-100 border-green-300' :
                                    prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.tipo === 'ereditata' ? 'from-yellow-50 to-yellow-100 border-yellow-300' :
                                    'from-orange-50 to-orange-100 border-orange-300'
                                } border-2 rounded-lg p-4">
                                    <h4 class="text-sm font-semibold mb-2 flex items-center gap-2">
                                        <span class="text-lg">${
                                            prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.tipo === 'convinta' ? '‚úì' :
                                            prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.tipo === 'ereditata' ? 'üîÑ' :
                                            '‚öñÔ∏è'
                                        }</span>
                                        <span>Natura della Scelta</span>
                                    </h4>
                                    <p class="text-sm font-bold ${
                                        prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.tipo === 'convinta' ? 'text-green-800' :
                                        prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.tipo === 'ereditata' ? 'text-yellow-800' :
                                        'text-orange-800'
                                    } mb-2">${prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.tipo.toUpperCase()}</p>
                                    <p class="text-xs text-gray-600 mb-2">${prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.spiegazione}</p>
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${
                                        prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.confidenza === 'alta' ? 'bg-gray-800 text-white' :
                                        prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.confidenza === 'media' ? 'bg-gray-500 text-white' :
                                        'bg-gray-300 text-gray-700'
                                    }">Confidenza: ${prog.motivazioni_scelta.scelta_manuale_principale.natura_scelta.confidenza}</span>
                                </div>
                                
                                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                                    <h4 class="text-sm font-semibold mb-2 text-blue-800">üéØ Priorit√† del Docente</h4>
                                    <ol class="space-y-2">
                                        ${prog.motivazioni_scelta.scelta_manuale_principale.priorita_docente.map((p, idx) => `
                                            <li class="flex items-start gap-2">
                                                <span class="flex-shrink-0 w-5 h-5 rounded-full bg-blue-600 text-white text-xs font-bold flex items-center justify-center">${idx+1}</span>
                                                <span class="text-sm text-gray-800">${p}</span>
                                            </li>
                                        `).join('')}
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PARTE 2: Relazione Testi Bibliografia (solo se alternativi presenti) -->
                        ${prog.motivazioni_scelta.relazione_testi_bibliografia.testi_alternativi_presenti ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-3 text-gray-800">üîó Relazione tra i Testi in Bibliografia</h3>
                            
                            <!-- Analisi Combinazione -->
                            <div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-4">
                                <p class="text-sm text-gray-800">${prog.motivazioni_scelta.relazione_testi_bibliografia.analisi_combinazione}</p>
                            </div>
                            
                            <!-- Dettaglio Alternativi -->
                            <div class="space-y-3 mb-4">
                                ${prog.motivazioni_scelta.relazione_testi_bibliografia.dettaglio_alternativi.map((alt, idx) => `
                                    <div class="bg-gray-50 rounded-lg p-4 border-l-4 ${
                                        alt.ruolo === 'approfondimento' ? 'border-blue-500' :
                                        alt.ruolo === 'semplificazione' ? 'border-green-500' :
                                        alt.ruolo === 'esercizi' ? 'border-yellow-500' :
                                        alt.ruolo === 'modulo_specifico' ? 'border-red-500' :
                                        alt.ruolo === 'alternativa_studenti' ? 'border-purple-500' :
                                        'border-gray-400'
                                    }">
                                        <div class="flex items-start justify-between mb-2">
                                            <div class="flex-1">
                                                <p class="text-sm font-semibold text-gray-900">${alt.titolo}</p>
                                                ${alt.autore ? `<p class="text-xs text-gray-500 mt-0.5">${alt.autore}</p>` : ''}
                                            </div>
                                            <span class="px-2 py-1 text-xs font-medium rounded-full whitespace-nowrap ${
                                                alt.ruolo === 'approfondimento' ? 'bg-blue-100 text-blue-700' :
                                                alt.ruolo === 'semplificazione' ? 'bg-green-100 text-green-700' :
                                                alt.ruolo === 'esercizi' ? 'bg-yellow-100 text-yellow-700' :
                                                alt.ruolo === 'modulo_specifico' ? 'bg-red-100 text-red-700' :
                                                alt.ruolo === 'alternativa_studenti' ? 'bg-purple-100 text-purple-700' :
                                                'bg-gray-100 text-gray-700'
                                            }">${alt.ruolo.replace(/_/g, ' ')}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${alt.cosa_rivela}</p>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Cosa Verificare con il Docente -->
                            ${prog.motivazioni_scelta.relazione_testi_bibliografia.domanda_chiave ? `
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-400 rounded-lg p-4">
                                <h4 class="text-sm font-bold text-blue-900 mb-2 flex items-center gap-2">
                                    <span>üí°</span>
                                    <span>Cosa Verificare con il Docente</span>
                                </h4>
                                <p class="text-sm text-gray-800">${prog.motivazioni_scelta.relazione_testi_bibliografia.domanda_chiave}</p>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- PARTE 3: Profilo Decisionale -->
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-gray-800">üí° Profilo Decisionale del Docente</h3>
                            
                            <!-- Cosa Cerca + Cosa Evita (2 colonne) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-green-50 border-l-4 border-green-500 p-4">
                                    <h4 class="text-sm font-semibold text-green-900 mb-2">‚úÖ Cosa Cerca</h4>
                                    <ul class="space-y-1">
                                        ${prog.motivazioni_scelta.profilo_decisionale.cosa_cerca.map(c => `
                                            <li class="text-sm text-gray-700 flex items-start gap-2">
                                                <span class="text-green-600 font-bold">‚Ä¢</span>
                                                <span>${c}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                
                                <div class="bg-red-50 border-l-4 border-red-500 p-4">
                                    <h4 class="text-sm font-semibold text-red-900 mb-2">‚ùå Cosa Evita</h4>
                                    <ul class="space-y-1">
                                        ${prog.motivazioni_scelta.profilo_decisionale.cosa_evita.map(e => `
                                            <li class="text-sm text-gray-700 flex items-start gap-2">
                                                <span class="text-red-600 font-bold">√ó</span>
                                                <span>${e}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Info Strategiche (griglia 3 colonne) -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="bg-gradient-to-br ${
                                    prog.motivazioni_scelta.profilo_decisionale.sensibilita_prezzo === 'alta' ? 'from-red-100 to-red-200' :
                                    prog.motivazioni_scelta.profilo_decisionale.sensibilita_prezzo === 'media' ? 'from-yellow-100 to-yellow-200' :
                                    'from-green-100 to-green-200'
                                } rounded-lg p-3 text-center">
                                    <p class="text-xs text-gray-600 mb-1">üí∞ Sensibilit√† Prezzo</p>
                                    <p class="text-sm font-bold ${
                                        prog.motivazioni_scelta.profilo_decisionale.sensibilita_prezzo === 'alta' ? 'text-red-800' :
                                        prog.motivazioni_scelta.profilo_decisionale.sensibilita_prezzo === 'media' ? 'text-yellow-800' :
                                        'text-green-800'
                                    }">${prog.motivazioni_scelta.profilo_decisionale.sensibilita_prezzo.toUpperCase()}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br ${
                                    prog.motivazioni_scelta.profilo_decisionale.familiarita_zanichelli === 'alta' ? 'from-blue-100 to-blue-200' :
                                    prog.motivazioni_scelta.profilo_decisionale.familiarita_zanichelli === 'media' ? 'from-indigo-100 to-indigo-200' :
                                    prog.motivazioni_scelta.profilo_decisionale.familiarita_zanichelli === 'bassa' ? 'from-gray-100 to-gray-200' :
                                    'from-gray-50 to-gray-100'
                                } rounded-lg p-3 text-center">
                                    <p class="text-xs text-gray-600 mb-1">üìò Familiarit√† Zanichelli</p>
                                    <p class="text-sm font-bold ${
                                        prog.motivazioni_scelta.profilo_decisionale.familiarita_zanichelli === 'alta' ? 'text-blue-800' :
                                        prog.motivazioni_scelta.profilo_decisionale.familiarita_zanichelli === 'media' ? 'text-indigo-800' :
                                        'text-gray-800'
                                    }">${prog.motivazioni_scelta.profilo_decisionale.familiarita_zanichelli.toUpperCase()}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br ${
                                    prog.motivazioni_scelta.profilo_decisionale.apertura_cambio_principale === 'alta' ? 'from-green-100 to-green-200' :
                                    prog.motivazioni_scelta.profilo_decisionale.apertura_cambio_principale === 'media' ? 'from-yellow-100 to-yellow-200' :
                                    'from-red-100 to-red-200'
                                } rounded-lg p-3 text-center">
                                    <p class="text-xs text-gray-600 mb-1">üîÑ Apertura Cambio Principale</p>
                                    <p class="text-sm font-bold ${
                                        prog.motivazioni_scelta.profilo_decisionale.apertura_cambio_principale === 'alta' ? 'text-green-800' :
                                        prog.motivazioni_scelta.profilo_decisionale.apertura_cambio_principale === 'media' ? 'text-yellow-800' :
                                        'text-red-800'
                                    }">${prog.motivazioni_scelta.profilo_decisionale.apertura_cambio_principale.toUpperCase()}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br ${
                                    prog.motivazioni_scelta.profilo_decisionale.apertura_integrazione_alternativo === 'alta' ? 'from-green-100 to-green-200' :
                                    prog.motivazioni_scelta.profilo_decisionale.apertura_integrazione_alternativo === 'media' ? 'from-yellow-100 to-yellow-200' :
                                    'from-red-100 to-red-200'
                                } rounded-lg p-3 text-center md:col-span-3">
                                    <p class="text-xs text-gray-600 mb-1">‚ûï Apertura Integrazione Alternativo</p>
                                    <p class="text-sm font-bold ${
                                        prog.motivazioni_scelta.profilo_decisionale.apertura_integrazione_alternativo === 'alta' ? 'text-green-800' :
                                        prog.motivazioni_scelta.profilo_decisionale.apertura_integrazione_alternativo === 'media' ? 'text-yellow-800' :
                                        'text-red-800'
                                    }">${prog.motivazioni_scelta.profilo_decisionale.apertura_integrazione_alternativo.toUpperCase()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${prog.analisi_preliminare && prog.analisi_preliminare.profilo_docente_insights ? `
                    <div class="bg-orange-50 border-2 border-orange-300 rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4 text-orange-900 flex items-center">
                            <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Insights Profilo Docente (Analisi Avanzata)
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="font-semibold text-orange-800 mb-1">Tipo Docente:</p>
                                <p class="text-gray-700">${prog.analisi_preliminare.profilo_docente_insights.tipo_docente}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-orange-800 mb-1">Sensibilit√† Chiave:</p>
                                <p class="text-gray-700">${prog.analisi_preliminare.profilo_docente_insights.sensibilita_chiave}</p>
                            </div>
                            <div class="md:col-span-2">
                                <p class="font-semibold text-orange-800 mb-1">Approccio Consigliato:</p>
                                <p class="text-gray-700">${prog.analisi_preliminare.profilo_docente_insights.approccio_consigliato}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-orange-800 mb-2">Leve Potenziali:</p>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">
                                    ${prog.analisi_preliminare.profilo_docente_insights.leve_potenziali.map(l => `<li class="text-xs">${l}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <p class="font-semibold text-orange-800 mb-2">Possibili Resistenze:</p>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">
                                    ${prog.analisi_preliminare.profilo_docente_insights.possibili_resistenze.map(r => `<li class="text-xs">${r}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="md:col-span-2">
                                <p class="font-semibold text-orange-800 mb-2">Argomenti Rilevanti:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${prog.analisi_preliminare.profilo_docente_insights.argomenti_rilevanti.map(a => `
                                        <span class="px-2 py-1 bg-orange-200 text-orange-900 text-xs rounded">${a}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Sezione 1: Analisi Programma -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">1</span>
                            Analisi Dettagliata Programma
                        </h3>
                        
                        <!-- Punteggi -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            ${['obiettivi', 'contenuti', 'metodologia', 'allineamento', 'risultati'].map(dim => {
                                const max = dim === 'contenuti' ? 130 : dim === 'obiettivi' || dim === 'metodologia' ? 40 : 30;
                                const label = {obiettivi: 'Obiettivi Formativi', contenuti: 'Contenuti Programmatici', 
                                              metodologia: 'Metodologia Didattica', allineamento: 'Allineamento Curriculum', 
                                              risultati: 'Risultati Attesi'}[dim];
                                return `
                                    <div class="border rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-600 mb-2">${label}</h4>
                                        <div class="mb-2">
                                            <span class="text-lg font-bold ${getPunteggioColor(prog.punteggi[dim], max)}">
                                                ${getPunteggioLabel(prog.punteggi[dim], max)}
                                            </span>
                                        </div>
                                        ${prog.valutazione[dim]?.giudizio ? `<p class="text-sm font-semibold ${getPunteggioColor(prog.punteggi[dim], max)} mb-1">${prog.valutazione[dim].giudizio}</p>` : ''}
                                        ${prog.valutazione[dim]?.note ? `<p class="text-xs text-gray-600">${prog.valutazione[dim].note}</p>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${prog.valutazione.sintesi ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Sintesi dell'Analisi</h4>
                                <p class="text-sm text-gray-700">${prog.valutazione.sintesi}</p>
                            </div>
                        ` : ''}

                        ${prog.valutazione.analisi_criteri ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-yellow-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                    Analisi Criteri Specifici
                                </h4>
                                <div class="space-y-2">
                                    ${Object.entries(prog.valutazione.analisi_criteri).map(([key, value]) => `
                                        <div class="flex">
                                            <span class="text-xs font-medium text-yellow-800 w-40 flex-shrink-0">${key.replace(/_/g, ' ').toUpperCase()}:</span>
                                            <span class="text-xs text-yellow-900">${value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${prog.valutazione.insights_adozione ? `
                            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-green-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Insights Adozione (Analisi Avanzata)
                                </h4>
                                <div class="space-y-3 text-xs">
                                    ${prog.valutazione.insights_adozione.punti_forza_programma?.length ? `
                                        <div>
                                            <p class="font-semibold text-green-800 mb-1">Punti Forza Programma:</p>
                                            <ul class="list-disc list-inside text-green-900 space-y-1">
                                                ${prog.valutazione.insights_adozione.punti_forza_programma.map(p => `<li>${p}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${prog.valutazione.insights_adozione.aspetti_migliorabili?.length ? `
                                        <div>
                                            <p class="font-semibold text-green-800 mb-1">Aspetti Migliorabili:</p>
                                            <ul class="list-disc list-inside text-green-900 space-y-1">
                                                ${prog.valutazione.insights_adozione.aspetti_migliorabili.map(a => `<li>${a}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${prog.valutazione.insights_adozione.opportunita_manuale ? `
                                        <div class="bg-white rounded p-3">
                                            <p class="font-semibold text-green-800 mb-1">Opportunit√† Manuale:</p>
                                            <p class="text-green-900">${prog.valutazione.insights_adozione.opportunita_manuale}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${prog.valutazione.analisi_criteri_approfondita ? `
                            <div class="bg-blue-50 border border-blue-300 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-blue-900 mb-3">Analisi Criteri Approfondita (Avanzata)</h4>
                                <div class="space-y-3 text-xs">
                                    <div class="bg-white rounded p-3">
                                        <p class="font-semibold text-blue-800 mb-1">Implicazioni Didattiche:</p>
                                        <p class="text-blue-900">${prog.valutazione.analisi_criteri_approfondita.implicazioni_didattiche}</p>
                                    </div>
                                    <div class="bg-white rounded p-3">
                                        <p class="font-semibold text-blue-800 mb-1">Compatibilit√† Manuale Ideale:</p>
                                        <p class="text-blue-900">${prog.valutazione.analisi_criteri_approfondita.compatibilita_manuale_ideale}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Sezione 2: Gap Analysis Manuale Adottato -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">2</span>
                            Analisi Manuale Adottato: ${prog.manuale_adottato}
                        </h3>
                        


                        ${prog.gap_manuale.note ? `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-blue-900">${prog.gap_manuale.note}</p>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${prog.gap_manuale.coperti?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Argomenti Coperti
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.coperti.map(arg => 
                                            `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${prog.gap_manuale.gap?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Gap (Non Coperti)
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.gap.map(arg => 
                                            `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${prog.gap_manuale.eccedenti?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Argomenti Eccedenti
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.eccedenti.map(arg => 
                                            `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${prog.gap_manuale.copertura_moduli && prog.gap_manuale.copertura_moduli.length > 0 ? `
                            <div class="mt-6 border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                    <h4 class="text-sm font-semibold text-gray-900 flex items-center">
                                        <svg class="h-5 w-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7"></path>
                                        </svg>
                                        Copertura Modulo per Modulo
                                    </h4>
                                </div>
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-50 text-left">
                                            <th class="px-4 py-2 font-medium text-gray-600 w-1/4">Modulo Framework</th>
                                            <th class="px-4 py-2 font-medium text-gray-600 w-1/3">Capitoli Manuale</th>
                                            <th class="px-4 py-2 font-medium text-gray-600 w-1/8 text-center">Copertura</th>
                                            <th class="px-4 py-2 font-medium text-gray-600 w-1/4">Nota</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        ${prog.gap_manuale.copertura_moduli.map(mod => {
                                            const badgeColor = mod.copertura === 'OTTIMA' ? 'bg-green-100 text-green-800' :
                                                mod.copertura === 'BUONA' ? 'bg-lime-100 text-lime-800' :
                                                mod.copertura === 'PARZIALE' ? 'bg-orange-100 text-orange-800' :
                                                'bg-red-100 text-red-800';
                                            return '<tr class="hover:bg-gray-50">' +
                                                '<td class="px-4 py-2 text-gray-900 font-medium">' + (mod.modulo_framework || '') + '</td>' +
                                                '<td class="px-4 py-2 text-gray-700">' + (mod.capitoli_manuale || '‚Äî') + '</td>' +
                                                '<td class="px-4 py-2 text-center">' +
                                                    '<span class="px-2 py-1 rounded-full text-xs font-bold ' + badgeColor + '">' + (mod.copertura || '') + '</span>' +
                                                '</td>' +
                                                '<td class="px-4 py-2 text-gray-600 text-xs">' + (mod.nota || '') + '</td>' +
                                            '</tr>';
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${prog.gap_manuale.compatibilita_criteri ? `
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-purple-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    Compatibilit√† Criteri Specifici (Programma vs Manuale)
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${Object.entries(prog.gap_manuale.compatibilita_criteri).filter(([k]) => k !== 'note_compatibilita').map(([key, value]) => `
                                        <div class="bg-white rounded p-3">
                                            <div class="text-xs font-medium text-purple-700 mb-1">${key.replace(/_/g, ' ').toUpperCase()}</div>
                                            <div class="text-xs text-gray-800">${value}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${prog.gap_manuale.compatibilita_criteri.note_compatibilita ? `
                                    <div class="mt-3 text-xs text-purple-900 bg-white rounded p-3">
                                        <strong>Analisi Dettagliata:</strong> ${prog.gap_manuale.compatibilita_criteri.note_compatibilita}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${prog.gap_manuale.analisi_impatto_adozione ? `
                            <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 mt-4">
                                <h4 class="text-sm font-semibold text-red-900 mb-3 flex items-center">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    Analisi Impatto Adozione (Analisi Avanzata)
                                </h4>
                                <div class="space-y-3 text-xs">
                                    ${prog.gap_manuale.analisi_impatto_adozione.gap_critici_insegnamento?.length ? `
                                        <div>
                                            <p class="font-semibold text-red-800 mb-2">Gap Critici per Insegnamento:</p>
                                            ${prog.gap_manuale.analisi_impatto_adozione.gap_critici_insegnamento.map(g => `
                                                <div class="bg-white rounded p-3 mb-2">
                                                    <p class="font-medium text-red-900 mb-1">Gap: ${g.gap}</p>
                                                    <p class="text-gray-700 mb-1"><strong>Impatto Docente:</strong> ${g.possibile_impatto_docente}</p>
                                                    <p class="text-gray-700"><strong>Impatto Studenti:</strong> ${g.possibile_impatto_studenti}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    ${prog.gap_manuale.analisi_impatto_adozione.sintesi_criticita ? `
                                        <div class="bg-white rounded p-3">
                                            <p class="font-semibold text-red-800 mb-1">Sintesi Criticit√†:</p>
                                            <p class="text-red-900">${prog.gap_manuale.analisi_impatto_adozione.sintesi_criticita}</p>
                                        </div>
                                    ` : ''}
                                    ${prog.gap_manuale.analisi_impatto_adozione.benefici_potenziali_cambio ? `
                                        <div class="bg-green-100 rounded p-3">
                                            <p class="font-semibold text-green-800 mb-1">Benefici Potenziali Cambio Manuale:</p>
                                            <p class="text-green-900">${prog.gap_manuale.analisi_impatto_adozione.benefici_potenziali_cambio}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Sezione 2b: Confronto Manuali Alternativi -->
                    ${prog.gap_alternativi && prog.gap_alternativi.length > 0 ? `
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">2b</span>
                                Confronto Manuali Alternativi
                            </h3>
                            
                            <p class="text-sm text-gray-600 mb-4">Valutazione rapida dei manuali alternativi selezionati</p>
                            
                            <div class="space-y-6">
                                ${prog.gap_alternativi.map(alt => `
                                    <div class="border-2 rounded-lg p-6 hover:shadow-lg transition">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-lg font-bold text-gray-900">${alt.manuale}</h4>
                                            <span class="px-3 py-1 rounded-full text-sm font-bold ${getCompatibilitaBadgeColor(alt.compatibilita)}">${getCompatibilitaLabel(alt.compatibilita || 0)}</span>
                                        </div>
                                        

                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            ${alt.punti_forza && alt.punti_forza.length > 0 ? `
                                                <div class="bg-green-50 rounded-lg p-3">
                                                    <h5 class="text-sm font-semibold text-green-900 mb-2 flex items-center">
                                                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                        Punti di Forza
                                                    </h5>
                                                    <ul class="space-y-1">
                                                        ${alt.punti_forza.map(f => `<li class="text-xs text-green-800">‚Ä¢ ${f}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            
                                            ${alt.punti_debolezza && alt.punti_debolezza.length > 0 ? `
                                                <div class="bg-orange-50 rounded-lg p-3">
                                                    <h5 class="text-sm font-semibold text-orange-900 mb-2 flex items-center">
                                                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                        </svg>
                                                        Punti di Debolezza
                                                    </h5>
                                                    <ul class="space-y-1">
                                                        ${alt.punti_debolezza.map(d => `<li class="text-xs text-orange-800">‚Ä¢ ${d}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        ${alt.gap && alt.gap.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-sm font-semibold text-red-900 mb-2">Gap (Argomenti Non Coperti)</h5>
                                                <div class="flex flex-wrap gap-1">
                                                    ${alt.gap.map(g => `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">${g}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        ${alt.note ? `
                                            <div class="bg-gray-50 rounded-lg p-3 mt-3">
                                                <p class="text-sm text-gray-700">${alt.note}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Sezione 3.5: RIMOSSA - contenuti consolidati in Sez 5 (Confronto Strutturato) e Strategia Adozione -->

                    <!-- Sezione 5: Raccomandazione Zanichelli con Confronto (SE PRESENTE) -->
                    ${prog.raccomandazione_zanichelli ? `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-emerald-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">5</span>
                            Raccomandazione Zanichelli ‚Äî Confronto Strutturato
                        </h3>
                        
                        <!-- Manuale Raccomandato -->
                        ${prog.raccomandazione_zanichelli.zanichelli_raccomandato ? `
                        <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-lg font-bold text-emerald-900">‚≠ê ${prog.raccomandazione_zanichelli.zanichelli_raccomandato.titolo}</p>
                                    <p class="text-sm text-emerald-700">${prog.raccomandazione_zanichelli.zanichelli_raccomandato.autore || ''}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-emerald-600">Corrispondenza</p>
                                    <p class="text-lg font-bold text-emerald-800">${getCompatibilitaLabel(prog.raccomandazione_zanichelli.zanichelli_raccomandato.compatibilita || 0)}</p>
                                </div>
                            </div>
                            ${prog.raccomandazione_zanichelli.zanichelli_raccomandato.motivazione_in_una_frase ? `
                            <p class="text-sm text-emerald-800 mt-2 italic">"${prog.raccomandazione_zanichelli.zanichelli_raccomandato.motivazione_in_una_frase}"</p>
                            ` : ''}
                        </div>
                        ` : ''}

                        <!-- Confronto per Criterio -->
                        ${prog.raccomandazione_zanichelli.confronto_per_criterio && prog.raccomandazione_zanichelli.confronto_per_criterio.length > 0 ? `
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">üìä Confronto Criterio per Criterio</h4>
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-50 text-left">
                                            <th class="px-3 py-2 font-medium text-gray-600">Criterio</th>
                                            <th class="px-3 py-2 font-medium text-gray-600">Manuale Adottato</th>
                                            <th class="px-3 py-2 font-medium text-gray-600">Zanichelli</th>
                                            <th class="px-3 py-2 font-medium text-gray-600 text-center">Vantaggio</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        ${prog.raccomandazione_zanichelli.confronto_per_criterio.map(c => {
                                            const vantaggioIcon = c.vantaggio === 'zanichelli' ? 'üü¢ ‚Üí' :
                                                c.vantaggio === 'adottato' ? 'üî¥ ‚Üê' : 'üü° =';
                                            const vantaggioColor = c.vantaggio === 'zanichelli' ? 'text-green-700 bg-green-50' :
                                                c.vantaggio === 'adottato' ? 'text-red-700 bg-red-50' : 'text-yellow-700 bg-yellow-50';
                                            return '<tr class="hover:bg-gray-50">' +
                                                '<td class="px-3 py-2 text-gray-900 font-medium text-xs">' + (c.criterio || '') + '</td>' +
                                                '<td class="px-3 py-2 text-gray-600 text-xs">' + (c.manuale_adottato || '') + '</td>' +
                                                '<td class="px-3 py-2 text-gray-600 text-xs">' + (c.zanichelli || '') + '</td>' +
                                                '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ' + vantaggioColor + '">' + vantaggioIcon + '</span></td>' +
                                            '</tr>';
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Gap Risolti e NON Risolti -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            ${prog.raccomandazione_zanichelli.gap_risolti_da_zanichelli && prog.raccomandazione_zanichelli.gap_risolti_da_zanichelli.length > 0 ? `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-green-900 mb-3">‚úÖ Gap Risolti da Zanichelli</h4>
                                <div class="space-y-2">
                                    ${prog.raccomandazione_zanichelli.gap_risolti_da_zanichelli.map(g => `
                                        <div class="bg-white rounded p-2">
                                            <p class="text-xs font-bold text-green-800">${g.gap}</p>
                                            <p class="text-xs text-green-700 mt-1">${g.come_risolve}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}

                            ${prog.raccomandazione_zanichelli.gap_NON_risolti && prog.raccomandazione_zanichelli.gap_NON_risolti.length > 0 ? `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">‚ö†Ô∏è Gap NON Risolti (da sapere prima del colloquio)</h4>
                                <div class="space-y-1">
                                    ${prog.raccomandazione_zanichelli.gap_NON_risolti.map(g => `
                                        <p class="text-xs text-gray-600 flex items-start">
                                            <span class="text-gray-400 mr-2">‚Ä¢</span>${g}
                                        </p>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- Alternative Zanichelli -->
                        ${prog.raccomandazione_zanichelli.alternative_zanichelli && prog.raccomandazione_zanichelli.alternative_zanichelli.length > 0 ? `
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">üìö Alternative Zanichelli</h4>
                            <div class="space-y-3">
                                ${prog.raccomandazione_zanichelli.alternative_zanichelli.map(alt => `
                                    <div class="border rounded-lg p-3 hover:bg-gray-50 transition">
                                        <div class="flex items-center justify-between mb-1">
                                            <p class="text-sm font-medium text-gray-900">${alt.autore ? alt.autore + ' - ' : ''}${alt.titolo}</p>
                                            <span class="text-xs px-2 py-0.5 rounded-full ${getCompatibilitaBadgeColor(alt.compatibilita || 0)}">${getCompatibilitaLabel(alt.compatibilita || 0)}</span>
                                        </div>
                                        ${alt.quando_preferirlo ? `<p class="text-xs text-gray-600"><strong>Quando preferirlo:</strong> ${alt.quando_preferirlo}</p>` : ''}
                                        ${alt.differenza_dal_raccomandato ? `<p class="text-xs text-gray-500 mt-1"><strong>Differenza:</strong> ${alt.differenza_dal_raccomandato}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    <!-- Sezione 4: Valutazione Compatibilit√† Manuali Consigliati -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">4</span>
                            Valutazione Compatibilit√† Manuali Consigliati
                        </h3>
                        
                        ${prog.zanichelli && prog.zanichelli.nota ? `
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <p class="text-yellow-700">${prog.zanichelli.nota}</p>
                            </div>
                        ` : ''}
                        
                        ${prog.zanichelli && prog.zanichelli.selection_note ? `
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                                <div class="flex items-start">
                                    <svg class="h-5 w-5 text-blue-600 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm text-blue-900 whitespace-pre-line">${prog.zanichelli.selection_note}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${prog.zanichelli && prog.zanichelli.manuali && prog.zanichelli.manuali.length > 0 ? `
                            ${prog.zanichelli.manuali.map((man, idx) => `
                                <div class="${man.raccomandazione === 'RACCOMANDATO' ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 border border-gray-300'} rounded-lg p-6 mb-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <span class="${man.raccomandazione === 'RACCOMANDATO' ? 'bg-green-600' : 'bg-gray-600'} text-white px-3 py-1 rounded-full text-sm font-bold mr-3">
                                                ${man.raccomandazione === 'RACCOMANDATO' ? '‚≠ê RACCOMANDATO' : 'üìö ALTERNATIVA'}
                                            </span>
                                            <h4 class="text-lg font-bold text-gray-900">${man.autore} - ${man.nome}</h4>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-600">Corrispondenza</p>
                                            <p class="text-lg font-bold ${man.compatibilita >= 80 ? 'text-green-600' : man.compatibilita >= 60 ? 'text-yellow-600' : 'text-red-600'}">${getCompatibilitaLabel(man.compatibilita || 0)}</p>
                                        </div>
                                    </div>
                                    
                                    ${man.punti_forza && man.punti_forza.length > 0 ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-green-700 mb-2">‚úÖ Punti di Forza:</h5>
                                            <ul class="list-disc list-inside text-sm space-y-1">
                                                ${man.punti_forza.map(pf => `<li>${pf}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.gap && man.gap.length > 0 ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-red-700 mb-2">‚ö†Ô∏è Gap:</h5>
                                            <ul class="list-disc list-inside text-sm space-y-1">
                                                ${man.gap.map(g => `<li>${g}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.quando_preferirlo ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-blue-700 mb-2">üí° Quando Preferirlo:</h5>
                                            <p class="text-sm text-gray-700">${man.quando_preferirlo}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.confronto_bibliografia ? `
                                        <div class="mb-3">
                                            <h5 class="font-semibold text-indigo-700 mb-2">üìä Confronto con Bibliografia Adottata:</h5>
                                            <p class="text-sm text-gray-700">${man.confronto_bibliografia}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${man.compatibilita_criteri ? `
                                        <div class="bg-purple-100 border border-purple-300 rounded p-3">
                                            <h5 class="font-semibold text-purple-800 mb-2">üîç Compatibilit√† Criteri Specifici:</h5>
                                            <p class="text-xs text-purple-900">${man.compatibilita_criteri}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                            
                            ${prog.zanichelli.sintesi ? `
                                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mt-4">
                                    <h5 class="font-semibold text-blue-900 mb-2">üìù Sintesi Generale:</h5>
                                    <p class="text-sm text-blue-800">${prog.zanichelli.sintesi}</p>
                                </div>
                            ` : ''}
                        ` : ''}
                        
                        ${prog.zanichelli && prog.zanichelli.errore ? `
                            <div class="bg-red-50 border-l-4 border-red-400 p-4">
                                <p class="text-red-700">‚ö†Ô∏è Errore nella valutazione: ${prog.zanichelli.errore}</p>
                            </div>
                        ` : ''}

                        <!-- Analisi Strategica Zanichelli (Fase 5.5) -->
                        ${prog.analisi_strategica?.strategia ? `
                            ${renderAnalisiStrategica(prog.analisi_strategica.strategia, prog.analisi_strategica.scenario)}
                        ` : ''}

                        ${prog.zanichelli && prog.zanichelli.strategia_adozione ? `
                            <div class="bg-indigo-50 border-2 border-indigo-300 rounded-lg p-6 mt-4">
                                <h4 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center">
                                    <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    Guida al Colloquio con il Docente
                                </h4>
                                <div class="space-y-4 text-sm">

                                    <!-- Pitch di Apertura (dal dato strategico se disponibile) -->
                                    ${prog.analisi_strategica?.strategia?.pitch ? `
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                                            <p class="font-semibold text-blue-900 mb-3">üí¨ Pitch di Apertura</p>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                ${prog.analisi_strategica.strategia.pitch.primo_contatto ? `
                                                <div class="bg-white rounded p-3 border border-blue-200">
                                                    <p class="text-xs font-semibold text-blue-800 mb-1">üìß Primo Contatto</p>
                                                    <p class="text-xs text-gray-700 italic">"${prog.analisi_strategica.strategia.pitch.primo_contatto}"</p>
                                                </div>
                                                ` : ''}
                                                ${prog.analisi_strategica.strategia.pitch.docente_conosciuto ? `
                                                <div class="bg-white rounded p-3 border border-blue-200">
                                                    <p class="text-xs font-semibold text-blue-800 mb-1">ü§ù Docente Conosciuto</p>
                                                    <p class="text-xs text-gray-700 italic">"${prog.analisi_strategica.strategia.pitch.docente_conosciuto}"</p>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : (prog.analisi_strategica?.strategia?.pitch_primo_contatto?.apertura ? `
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                                            <p class="font-semibold text-blue-900 mb-3">üí¨ Pitch di Apertura</p>
                                            <div class="bg-white rounded p-3 border border-blue-200">
                                                <p class="text-xs text-gray-700 italic">"${prog.analisi_strategica.strategia.pitch_primo_contatto.apertura}"</p>
                                            </div>
                                        </div>
                                    ` : (prog.analisi_strategica?.strategia?.pitch_conversione?.pitch_breve_primo_contatto ? `
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                                            <p class="font-semibold text-blue-900 mb-3">üí¨ Pitch di Apertura</p>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <div class="bg-white rounded p-3 border border-blue-200">
                                                    <p class="text-xs font-semibold text-blue-800 mb-1">üìß Primo Contatto</p>
                                                    <p class="text-xs text-gray-700 italic">"${prog.analisi_strategica.strategia.pitch_conversione.pitch_breve_primo_contatto}"</p>
                                                </div>
                                                ${prog.analisi_strategica.strategia.pitch_conversione.pitch_breve_docente_conosciuto ? `
                                                <div class="bg-white rounded p-3 border border-blue-200">
                                                    <p class="text-xs font-semibold text-blue-800 mb-1">ü§ù Docente Conosciuto</p>
                                                    <p class="text-xs text-gray-700 italic">"${prog.analisi_strategica.strategia.pitch_conversione.pitch_breve_docente_conosciuto}"</p>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''))}

                                    <!-- Obiezioni e Risposte -->
                                    ${prog.zanichelli.strategia_adozione.manuale_primario.possibili_obiezioni?.length ? `
                                        <div class="bg-white rounded-lg p-4">
                                            <p class="font-medium text-indigo-800 mb-2">‚ö†Ô∏è Possibili Obiezioni e Risposte:</p>
                                            ${prog.zanichelli.strategia_adozione.manuale_primario.possibili_obiezioni.map(o => `
                                                <div class="bg-gray-50 rounded p-3 mb-2 text-xs">
                                                    <p class="font-medium text-red-700 mb-1">‚ùì ${o.obiezione}</p>
                                                    <p class="text-green-700">üí¨ ${o.risposta}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}

                                    <!-- Note per il Colloquio -->
                                    ${prog.zanichelli.strategia_adozione.note_colloquio ? `
                                        <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                                            <p class="font-medium text-yellow-900 mb-2">üí° Note per il Colloquio:</p>
                                            <p class="text-yellow-900 text-xs">${prog.zanichelli.strategia_adozione.note_colloquio}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex space-x-4 mb-4">
                        <button onclick="showView('upload'); resetForm();" class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Nuova Analisi
                        </button>
                        <button onclick="exportResults()" class="px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Esporta Risultati
                        </button>
                    </div>

                </div>
            `;

            document.getElementById('viewRisultati').innerHTML = html;
            showView('risultati');
        }

        function resetForm() {
            document.getElementById('fileInput').value = '';
            document.getElementById('testoInput').value = '';
            document.getElementById('contestoSelect').value = '';
            document.getElementById('manualeSelect').value = '';
            document.getElementById('cfuInput').value = '';
            document.getElementById('oreInput').value = '';
            document.getElementById('fileNameDisplay').textContent = 'Clicca per selezionare un file';
            fileContent = null;
        }

        function exportResults() {
            if (!currentProgramma) return;
            const dataStr = JSON.stringify(currentProgramma, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analisi_${currentProgramma.id}.json`;
            link.click();
        }

        // Storico
        function saveToStorico(prog) {
            let storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            storico.unshift(prog);
            if (storico.length > 50) storico = storico.slice(0, 50);
            localStorage.setItem('storico_analisi', JSON.stringify(storico));
            loadStorico();
        }

        function deleteFromStorico(index) {
            if (!confirm('Sei sicuro di voler eliminare questa analisi?')) {
                return;
            }
            let storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            storico.splice(index, 1);
            localStorage.setItem('storico_analisi', JSON.stringify(storico));
            loadStorico();
        }

        function loadStorico() {
            const storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            const container = document.getElementById('storicoContent');
            
            if (storico.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Nessun programma analizzato</p>';
                return;
            }

            container.innerHTML = storico.map((prog, index) => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 cursor-pointer" onclick='visualizzaProgramma(${JSON.stringify(prog).replace(/'/g, "&apos;")})'>
                            <div class="flex items-center space-x-2 mb-1">
                                <h3 class="font-medium text-gray-900">${prog.denominazione_corso}</h3>
                                <span class="px-2 py-0.5 text-xs font-medium rounded ${prog.tipo_analisi === 'avanzata' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                                    ${prog.tipo_analisi === 'avanzata' ? 'üî¨ Avanzata' : '‚ö° Base'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">${prog.universita} - ${prog.contesto}</p>
                            <p class="text-xs text-gray-500 mt-1">Manuale: ${prog.manuale_adottato} | ${new Date(prog.created_at).toLocaleDateString('it-IT')}</p>
                        </div>
                        <div class="flex items-center space-x-3 ml-4">
                            <div class="text-right cursor-pointer" onclick='visualizzaProgramma(${JSON.stringify(prog).replace(/'/g, "&apos;")})'>  
                                <div class="text-sm font-bold text-indigo-600">
                                    ${getCoperturaProgrammaLabel(prog.punteggi.totale, 270)}
                                </div>
                                <p class="text-xs font-medium ${getPunteggioColor(prog.punteggi.totale, 270)}">
                                    ${getPunteggioLabel(prog.punteggi.totale, 270)}
                                </p>
                            </div>
                            <button onclick="event.stopPropagation(); esportaPDF(${index});" class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition" title="Esporta PDF">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteFromStorico(${index});" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Elimina analisi">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function esportaPDF(index) {
            const storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            const prog = storico[index];
            
            if (!prog) {
                alert('Analisi non trovata');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let y = 20;
            const lineHeight = 7;
            const pageHeight = 280;
            const margin = 20;
            const maxWidth = 170;
            
            // Funzione per aggiungere testo con wrap e gestione pagine
            function addText(text, fontSize = 10, isBold = false) {
                doc.setFontSize(fontSize);
                doc.setFont('helvetica', isBold ? 'bold' : 'normal');
                const lines = doc.splitTextToSize(text, maxWidth);
                
                lines.forEach(line => {
                    if (y > pageHeight) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, margin, y);
                    y += lineHeight;
                });
            }
            
            function addSpace(space = 5) {
                y += space;
            }
            
            // Intestazione
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`Analisi Programma ${prog.framework_name || prog.denominazione_corso}`, margin, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${prog.universita} | ${prog.corso_laurea_nome || prog.contesto}`, margin, y);
            y += 6;
            doc.text(`Docente: ${prog.docente || 'N/D'} | CFU: ${prog.cfu || 'N/D'}`, margin, y);
            y += 6;
            doc.text(`Tipo Analisi: ${prog.tipo_analisi === 'avanzata' ? 'Avanzata' : 'Base'}`, margin, y);
            y += 10;
            
            // Linea separatore
            doc.setDrawColor(79, 70, 229);
            doc.setLineWidth(0.5);
            doc.line(margin, y, 190, y);
            y += 10;
            
            // Sintesi
            if (prog.valutazione?.sintesi) {
                addText('SINTESI', 12, true);
                addSpace(3);
                addText(prog.valutazione.sintesi);
                addSpace(8);
            }
            
            // Valutazione Programma
            addText('VALUTAZIONE PROGRAMMA', 12, true);
            addSpace(3);
            addText(`Valutazione Complessiva: ${getPunteggioLabel(prog.punteggi.totale, 270)} ‚Äî ${getCoperturaProgrammaLabel(prog.punteggi.totale, 270)}`);
            addText(`Obiettivi Formativi: ${getPunteggioLabel(prog.punteggi.obiettivi, 40)}`);
            addText(`Contenuti Programmatici: ${getPunteggioLabel(prog.punteggi.contenuti, 130)}`);
            addText(`Metodologia Didattica: ${getPunteggioLabel(prog.punteggi.metodologia, 40)}`);
            addText(`Allineamento Curriculum: ${getPunteggioLabel(prog.punteggi.allineamento, 30)}`);
            addText(`Risultati Attesi: ${getPunteggioLabel(prog.punteggi.risultati, 30)}`);
            addSpace(8);
            
            // Manuale Adottato
            addText('MANUALE ADOTTATO: ' + prog.manuale_adottato, 12, true);
            addSpace(3);
            
            if (prog.gap_manuale?.note) {
                addText(prog.gap_manuale.note);
                addSpace(5);
            }
            
            if (prog.gap_manuale?.gap?.length > 0) {
                addText('Gap (Argomenti Non Coperti):', 10, true);
                prog.gap_manuale.gap.forEach(gap => {
                    addText('‚Ä¢ ' + gap);
                });
                addSpace(5);
            }
            
            if (prog.gap_manuale?.punti_debolezza?.length > 0) {
                addText('Punti di Debolezza:', 10, true);
                prog.gap_manuale.punti_debolezza.forEach(deb => {
                    addText('‚Ä¢ ' + deb);
                });
                addSpace(8);
            }
            
            // Raccomandazione Zanichelli
            if (prog.zanichelli?.raccomandato) {
                addText('RACCOMANDAZIONE ZANICHELLI', 12, true);
                addSpace(3);
                addText(`Manuale Raccomandato: ${prog.zanichelli.raccomandato.titolo}`, 11, true);
                addText(`Corrispondenza: ${getCompatibilitaLabel(prog.zanichelli.raccomandato.compatibilita || prog.zanichelli.raccomandato.punteggio || 0)}`);
                addText(`Prezzo: ${prog.zanichelli.raccomandato.prezzo}`);
                addSpace(5);
                
                if (prog.zanichelli.raccomandato.confronto_bibliografia) {
                    addText('Confronto con Bibliografia Adottata:', 10, true);
                    addText(prog.zanichelli.raccomandato.confronto_bibliografia);
                    addSpace(5);
                }
                
                if (prog.zanichelli.raccomandato.punti_forza?.length > 0) {
                    addText('Punti di Forza:', 10, true);
                    prog.zanichelli.raccomandato.punti_forza.forEach(forza => {
                        addText('‚Ä¢ ' + forza);
                    });
                    addSpace(5);
                }
                
                if (prog.zanichelli.raccomandato.quando_preferirlo) {
                    addText('Quando Raccomandare:', 10, true);
                    addText(prog.zanichelli.raccomandato.quando_preferirlo);
                }
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} - Zanichelli Editore - Pagina ${i}/${pageCount}`, margin, 290);
            }
            
            // Salva PDF
            const filename = `Analisi_${prog.universita.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        function visualizzaProgramma(prog) {
            currentProgramma = prog;
            mostraRisultati(prog);
        }

        function toggleFAQ() {
            const content = document.getElementById('faqContent');
            const chevron = document.getElementById('faqChevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // ============================================
        // FASE C - FUNZIONI PREPARA COLLOQUIO
        // ============================================

        // ============================================
        // VALUTAZIONE ASSOLUTA MANUALI
        // ============================================
        
        // Global variables for evaluation
        let evalAbs_selectedMacroarea = null;
        let evalAbs_selectedMateria = null;
        let evalAbs_selectedManuale = null;
        let evalAbs_selectedFramework = null;
        let evalAbs_currentReportData = null;

        // STEP 1: Initialize dropdown on tab load
        function evalAbs_initTab() {
            console.log('üîÑ Inizializzo tab Valutazione Assoluta');
            
            // Wait for FRAMEWORK_CATALOG to be loaded
            if (!FRAMEWORK_CATALOG || !FRAMEWORK_CATALOG.by_subject) {
                console.error('‚ùå FRAMEWORK_CATALOG non ancora caricato!');
                setTimeout(evalAbs_initTab, 500); // Retry after 500ms
                return;
            }
            
            evalAbs_loadMacroareeDropdown();
            evalAbs_loadSavedEvaluations();
        }

        // Load Macroaree (STEP 1)
        function evalAbs_loadMacroareeDropdown() {
            const select = document.getElementById('evalAbsMacroarea');
            if (!select) return;
            
            // Get unique macroaree from FRAMEWORK_CATALOG.by_subject
            const macroaree = Object.keys(FRAMEWORK_CATALOG.by_subject || {});
            
            console.log('üìö Macroaree trovate:', macroaree);
            
            select.innerHTML = '<option value="">Seleziona macroarea...</option>';
            macroaree.forEach(macro => {
                const opt = document.createElement('option');
                opt.value = macro;
                opt.textContent = macro;
                select.appendChild(opt);
            });
        }

        // STEP 1 ‚Üí STEP 2: On Macroarea change
        function evalAbs_onMacroareaChange() {
            const select = document.getElementById('evalAbsMacroarea');
            const macroarea = select.value;
            
            evalAbs_selectedMacroarea = macroarea;
            
            if (!macroarea) {
                // Hide all subsequent steps
                document.getElementById('evalAbsMateriaContainer').classList.add('hidden');
                document.getElementById('evalAbsManualeContainer').classList.add('hidden');
                document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
                document.getElementById('evalAbsButtonContainer').classList.add('hidden');
                return;
            }
            
            console.log('‚úÖ Macroarea selezionata:', macroarea);
            
            // Get frameworks for this macroarea
            const frameworkIds = FRAMEWORK_CATALOG.by_subject[macroarea] || [];
            
            // Get unique materias from frameworks
            const materias = new Set();
            const frameworks = FRAMEWORK_CATALOG.frameworks || [];
            
            frameworkIds.forEach(fwId => {
                const fw = frameworks.find(f => f.id === fwId);
                if (fw && fw.name) {
                    materias.add(fw.name);
                }
            });
            
            const materiasArray = Array.from(materias);
            
            console.log('üìñ Materie trovate per', macroarea, ':', materiasArray);
            
            // If only 1 materia, skip STEP 2 and go directly to manuali
            if (materiasArray.length === 1) {
                evalAbs_selectedMateria = materiasArray[0];
                document.getElementById('evalAbsMateriaContainer').classList.add('hidden');
                evalAbs_loadManualiDropdown();
            } else {
                // Show STEP 2: Materia dropdown
                evalAbs_loadMateriaDropdown(materiasArray);
                document.getElementById('evalAbsMateriaContainer').classList.remove('hidden');
            }
            
            // Hide subsequent steps
            document.getElementById('evalAbsManualeContainer').classList.add('hidden');
            document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
            document.getElementById('evalAbsButtonContainer').classList.add('hidden');
        }

        // Load Materia dropdown (STEP 2)
        function evalAbs_loadMateriaDropdown(materias) {
            const select = document.getElementById('evalAbsMateria');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona materia...</option>';
            materias.forEach(mat => {
                const opt = document.createElement('option');
                opt.value = mat;
                opt.textContent = mat;
                select.appendChild(opt);
            });
        }

        // STEP 2 ‚Üí STEP 3: On Materia change
        function evalAbs_onMateriaChange() {
            const select = document.getElementById('evalAbsMateria');
            evalAbs_selectedMateria = select.value;
            
            if (!evalAbs_selectedMateria) {
                document.getElementById('evalAbsManualeContainer').classList.add('hidden');
                document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
                document.getElementById('evalAbsButtonContainer').classList.add('hidden');
                return;
            }
            
            console.log('‚úÖ Materia selezionata:', evalAbs_selectedMateria);
            evalAbs_loadManualiDropdown();
        }

        // Load Manuali dropdown (STEP 3)
        function evalAbs_loadManualiDropdown() {
            const select = document.getElementById('evalAbsManuale');
            if (!select) return;
            
            // Mapping: Framework Name ‚Üí Manual Subject
            const frameworkToManualSubject = {
                // Matematica
                'Analisi Matematica 1': 'Matematica',
                'Analisi Matematica 2': 'Matematica',
                'Istituzioni di Matematiche / Matematica Generale': 'Matematica',
                
                // Fisica
                'Fisica Generale 1 (Meccanica e Termodinamica)': 'Fisica',
                'Fisica Generale 2 (Elettromagnetismo e Ottica)': 'Fisica',
                'Fisica Generale (Area Bio-Geo-Chimica)': 'Fisica',
                'Fisica (Semestre Filtro)': 'Fisica',
                
                // Chimica
                'Chimica Generale con Elementi di Chimica Inorganica': 'Chimica Generale',
                'Chimica Organica': 'Chimica Organica',
                'Chimica e Propedeutica Biochimica (Semestre Filtro)': 'Chimica Generale',
                
                // Biologia
                'Biologia (Semestre Filtro)': 'Biologia',
                'Biochimica Generale': 'Biochimica',
                'Biologia Molecolare della Cellula': 'Biologia',
                'Biologia Molecolare del Gene': 'Biologia',
                'Microbiologia Generale e Clinica': 'Microbiologia',
                'Genetica Generale': 'Biologia',
                
                // Istologia
                'Istologia ed Embriologia Umana': 'Istologia',
                
                // Economia
                'Economia Politica (Micro & Macro)': 'Economia',
                'Macroeconomia': 'Economia',
                'Microeconomia Generale / Microeconomia Avanzata': 'Economia',
                'Microeconomia': 'Economia'
            };
            
            // Determine filter mode
            let manualSubjectFilter = null;
            
            if (evalAbs_selectedMateria) {
                // User selected a specific materia ‚Üí use exact mapping
                manualSubjectFilter = frameworkToManualSubject[evalAbs_selectedMateria];
                console.log('üîç Filtro per materia specifica:', evalAbs_selectedMateria, '‚Üí', manualSubjectFilter);
            } else {
                // User selected only macroarea ‚Üí use all subjects for that macroarea
                const macroareaToSubjects = {
                    'Matematica': ['Matematica'],
                    'Fisica': ['Fisica'],
                    'Chimica': ['Chimica Generale', 'Chimica Organica'],
                    'Biologia': ['Biochimica', 'Biologia', 'Microbiologia'],
                    'Economia': ['Economia'],
                    'Medicina e Chirurgia': ['Biologia', 'Chimica Generale', 'Fisica'],
                    'Istologia': ['Istologia']
                };
                
                const allowedSubjects = macroareaToSubjects[evalAbs_selectedMacroarea] || [];
                console.log('üîç Filtro per macroarea:', evalAbs_selectedMacroarea, '‚Üí', allowedSubjects);
                
                // Use multiple subjects for filtering
                manualSubjectFilter = allowedSubjects;
            }
            
            // Filter manuali
            const allManuali = getManualsAsObject();
            let filteredManuali = [];
            let usedFallback = false;
            
            for (const id in allManuali) {
                const man = allManuali[id];
                const manSubject = man.subject || '';
                
                // Check match
                let matches = false;
                
                if (Array.isArray(manualSubjectFilter)) {
                    // Multiple subjects (macroarea mode)
                    matches = manualSubjectFilter.includes(manSubject);
                } else if (manualSubjectFilter) {
                    // Single subject (specific materia mode)
                    matches = manSubject === manualSubjectFilter;
                }
                
                if (matches) {
                    filteredManuali.push(man);
                }
            }
            
            // FALLBACK: If no manuals found with specific subject, try generic subject
            if (filteredManuali.length === 0 && evalAbs_selectedMateria && !Array.isArray(manualSubjectFilter)) {
                console.warn('‚ö†Ô∏è Nessun manuale specifico per:', manualSubjectFilter);
                console.log('üîÑ Provo con subject generico della macroarea:', evalAbs_selectedMacroarea);
                
                // Try generic subject for macroarea
                const fallbackMapping = {
                    'Matematica': 'Matematica',
                    'Fisica': 'Fisica',
                    'Chimica': 'Chimica Generale',
                    'Biologia': 'Biologia',
                    'Economia': 'Economia',
                    'Medicina e Chirurgia': 'Biologia',
                    'Istologia': 'Istologia'
                };
                
                const fallbackSubject = fallbackMapping[evalAbs_selectedMacroarea];
                
                if (fallbackSubject) {
                    for (const id in allManuali) {
                        const man = allManuali[id];
                        if (man.subject === fallbackSubject) {
                            filteredManuali.push(man);
                        }
                    }
                    
                    if (filteredManuali.length > 0) {
                        usedFallback = true;
                        console.log(`‚úÖ Trovati ${filteredManuali.length} manuali generici (${fallbackSubject})`);
                    }
                }
            }
            
            console.log('üìö Manuali trovati:', filteredManuali.length, usedFallback ? '(fallback a generici)' : '');
            
            select.innerHTML = '<option value="">Seleziona manuale...</option>';
            
            if (filteredManuali.length === 0) {
                select.innerHTML += '<option value="" disabled>Nessun manuale disponibile per questa materia</option>';
            } else if (usedFallback) {
                // Add warning message
                select.innerHTML += `<option value="" disabled style="color: #F59E0B; font-weight: bold;">‚ö†Ô∏è Nessun manuale specifico per ${evalAbs_selectedMateria}</option>`;
                select.innerHTML += `<option value="" disabled style="color: #6B7280;">Mostro manuali generici di ${evalAbs_selectedMacroarea}:</option>`;
            }
            
            // Sort by title
            filteredManuali.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            
            filteredManuali.forEach(man => {
                const opt = document.createElement('option');
                opt.value = man.id;
                opt.textContent = `${man.title} (${man.author || 'N/A'})`;
                select.appendChild(opt);
            });
            
            // Show manuale container
            document.getElementById('evalAbsManualeContainer').classList.remove('hidden');
            
            // Hide subsequent steps
            document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
            document.getElementById('evalAbsButtonContainer').classList.add('hidden');
        }

        // STEP 3 ‚Üí STEP 4: On Manuale change
        function evalAbs_onManualeChange() {
            const select = document.getElementById('evalAbsManuale');
            evalAbs_selectedManuale = select.value;
            
            if (!evalAbs_selectedManuale) {
                document.getElementById('evalAbsFrameworkContainer').classList.add('hidden');
                document.getElementById('evalAbsButtonContainer').classList.add('hidden');
                return;
            }
            
            console.log('‚úÖ Manuale selezionato:', evalAbs_selectedManuale);
            evalAbs_loadFrameworkDropdown();
        }

        // Load Framework dropdown (STEP 4) - auto-selected
        function evalAbs_loadFrameworkDropdown() {
            const select = document.getElementById('evalAbsFramework');
            if (!select) return;
            
            // Get frameworks for selected macroarea
            const frameworkIds = FRAMEWORK_CATALOG.by_subject[evalAbs_selectedMacroarea] || [];
            const frameworks = FRAMEWORK_CATALOG.frameworks || [];
            
            const filteredFrameworks = frameworks.filter(fw => frameworkIds.includes(fw.id));
            
            console.log('üéØ Framework disponibili:', filteredFrameworks.length);
            
            select.innerHTML = '<option value="">Seleziona framework...</option>';
            
            filteredFrameworks.forEach(fw => {
                const opt = document.createElement('option');
                opt.value = fw.id;
                opt.textContent = fw.name || fw.id;
                select.appendChild(opt);
            });
            
            // Auto-select first framework if only 1
            if (filteredFrameworks.length === 1) {
                select.value = filteredFrameworks[0].id;
                evalAbs_selectedFramework = filteredFrameworks[0].id;
            }
            
            // Show framework container and button
            document.getElementById('evalAbsFrameworkContainer').classList.remove('hidden');
            document.getElementById('evalAbsButtonContainer').classList.remove('hidden');
        }

        // Start Evaluation (STEP 5)
        async function evalAbs_startEvaluation() {
            // Get selected framework
            const frameworkSelect = document.getElementById('evalAbsFramework');
            evalAbs_selectedFramework = frameworkSelect.value;
            
            if (!evalAbs_selectedFramework) {
                alert('‚ö†Ô∏è Seleziona un framework prima di avviare la valutazione');
                return;
            }
            
            console.log('üöÄ Avvio valutazione:', {
                macroarea: evalAbs_selectedMacroarea,
                materia: evalAbs_selectedMateria,
                manuale: evalAbs_selectedManuale,
                framework: evalAbs_selectedFramework
            });
            
            // Show loading
            document.getElementById('evalAbsLoading').classList.remove('hidden');
            document.getElementById('evalAbsResult').classList.add('hidden');
            
            try {
                // Load manual data
                const manuale = await evalAbs_loadManualeData(evalAbs_selectedManuale);
                
                // Load framework data
                const framework = await evalAbs_loadFrameworkData(evalAbs_selectedFramework);
                
                // Build prompt
                const prompt = evalAbs_buildPrompt(manuale, framework);
                
                console.log('üìù Prompt pronto, lunghezza:', prompt.length);
                
                // Call LLM
                const reportHTML = await evalAbs_callLLM(prompt);
                
                console.log('‚úÖ Report generato, lunghezza:', reportHTML.length);
                
                // Store report data
                evalAbs_currentReportData = {
                    manual_id: evalAbs_selectedManuale,
                    manual_title: manuale.title,
                    manual_author: manuale.author,
                    framework_id: evalAbs_selectedFramework,
                    framework_name: framework.name,
                    evaluation_date: new Date().toISOString(),
                    report_html: reportHTML
                };
                
                // Show report
                evalAbs_showReport(reportHTML);
                
            } catch (error) {
                console.error('‚ùå Errore valutazione:', error);
                alert('‚ùå Errore durante la valutazione: ' + error.message);
            } finally {
                document.getElementById('evalAbsLoading').classList.add('hidden');
            }
        }

        // Load Manual Data
        async function evalAbs_loadManualeData(manualeId) {
            console.log('üìñ Carico dati manuale:', manualeId);
            
            // First check in custom/modified
            const customManuals = JSON.parse(localStorage.getItem('custom_manuals') || '{}');
            const modifiedManuals = JSON.parse(localStorage.getItem('modified_manuals') || '{}');
            
            if (modifiedManuals[manualeId]) {
                console.log('‚úÖ Manuale trovato in modified_manuals');
                return modifiedManuals[manualeId];
            }
            
            if (customManuals[manualeId]) {
                console.log('‚úÖ Manuale trovato in custom_manuals');
                return customManuals[manualeId];
            }
            
            // Load from original catalog
            const allManuali = getManualsAsObject();
            const manual = allManuali[manualeId];
            
            if (!manual || !manual.filepath) {
                throw new Error('Manuale non trovato: ' + manualeId);
            }
            
            console.log('üì• Carico JSON da:', manual.filepath);
            const response = await fetch(manual.filepath);
            
            if (!response.ok) {
                throw new Error('Errore caricamento manuale: ' + response.statusText);
            }
            
            return await response.json();
        }

        // Load Framework Data
        async function evalAbs_loadFrameworkData(frameworkId) {
            console.log('üéØ Carico dati framework:', frameworkId);
            
            // Get framework from catalog
            const frameworks = FRAMEWORK_CATALOG.frameworks || [];
            const framework = frameworks.find(f => f.id === frameworkId);
            
            if (!framework) {
                throw new Error('Framework non trovato: ' + frameworkId);
            }
            
            // If content is already loaded, return it
            if (framework.content) {
                console.log('‚úÖ Framework content gi√† caricato');
                return framework;
            }
            
            // Load from file
            if (!framework.filepath) {
                throw new Error('Framework filepath non trovato per: ' + frameworkId);
            }
            
            console.log('üì• Carico JSON da:', framework.filepath);
            const response = await fetch(framework.filepath);
            
            if (!response.ok) {
                throw new Error('Errore caricamento framework: ' + response.statusText);
            }
            
            const data = await response.json();
            framework.content = data.content || data;
            
            return framework;
        }

        // Build Prompt for LLM
        function evalAbs_buildPrompt(manuale, framework) {
            // Build Table of Contents (TOC) from manual chapters
            let toc = '';
            if (manuale.chapters && Array.isArray(manuale.chapters)) {
                toc = manuale.chapters.map((ch, idx) => `${idx + 1}. ${ch.title || ch}`).join('\n');
            }
            
            // Build Framework Syllabus
            let syllabus = '';
            if (framework.content && framework.content.syllabus_modules) {
                syllabus = framework.content.syllabus_modules.map((mod, idx) => 
                    `Modulo ${idx + 1}: ${mod.title || mod.name || mod}\n${mod.description || ''}`
                ).join('\n\n');
            }
            
            // Build Program Profiles
            let profiles = '';
            if (framework.content && framework.content.program_profiles) {
                profiles = framework.content.program_profiles.map((prof, idx) => 
                    `Profilo ${idx + 1}: ${prof.name || prof.title || prof}\nTarget: ${prof.target_degrees ? prof.target_degrees.join(', ') : 'N/A'}`
                ).join('\n\n');
            }
            
            const prompt = `# VALUTAZIONE ASSOLUTA MANUALE ZANICHELLI

## Contesto
Sei un promotore editoriale Zanichelli esperto. Devi valutare il manuale "${manuale.title}" di ${manuale.author || 'N/A'} (${manuale.publisher || 'Zanichelli'}) rispetto al framework di riferimento "${framework.name}".

## Dati Manuale
**Titolo**: ${manuale.title}
**Autore**: ${manuale.author || 'N/A'}
**Editore**: ${manuale.publisher || 'Zanichelli'}
**Prezzo**: ${manuale.price || 'N/A'} ‚Ç¨
**Pagine**: ${manuale.pages || 'N/A'}
**Edizione**: ${manuale.edition || 'N/A'}

### Indice Completo (Capitoli)
\`\`\`
${toc || 'Indice non disponibile'}
\`\`\`

## Framework di Riferimento: ${framework.name}

### Syllabus Moduli
\`\`\`
${syllabus || 'Syllabus non disponibile'}
\`\`\`

### Profili di Programma
\`\`\`
${profiles || 'Profili non disponibili'}
\`\`\`

---

## COMPITO
Fornisci un report dettagliato di valutazione del manuale. Struttura il report in HTML (usa tag <h3>, <p>, <ul>, <li>, <strong>) con le seguenti sezioni:

### 1. üìö Struttura dell'Opera
Descrivi l'organizzazione dei contenuti, la sequenza dei capitoli, e la copertura degli argomenti rispetto al framework.

### 2. ‚úçÔ∏è Chiarezza Espositiva e Stile
Valuta il linguaggio, la chiarezza delle spiegazioni, e l'approccio didattico.

### 3. üìñ Apparato Didattico
Analizza esempi, esercizi, figure, tabelle, materiali supplementari.

### 4. üéØ Supporto allo Studio
Valuta strumenti come riassunti, mappe concettuali, test di autovalutazione, risorse online.

### 5. üéì Pubblico Ideale e Livello
Indica per quale tipologia di studenti √® pi√π adatto il manuale (es. classi di laurea, livello di difficolt√†).

### 6. üèÜ Confronto con Framework
In base al framework "${framework.name}", indica quale pubblico √® pi√π adatto motivando la scelta (confronta con i profili di programma).

### 7. ‚úÖ Punti di Forza
Elenca i principali punti di forza del manuale (contenutistici, didattici, elementi distintivi).

### 8. ‚ö†Ô∏è Debolezze e Criticit√†
Indica eventuali ostacoli all'adozione, necessit√† di aggiornamento, problemi di usabilit√†, lacune tematiche.

---

**IMPORTANTE**: Restituisci SOLO il contenuto HTML del report (senza tag <html>, <head>, <body>). Usa tag semantici e ben formattati.`;

            return prompt;
        }

        // Call LLM API (uses existing callLLM function with OpenAI/Perplexity support)
        async function evalAbs_callLLM(prompt) {
            console.log('ü§ñ Chiamo LLM tramite callLLM()...');
            
            // Use the existing callLLM function that supports both OpenAI and Perplexity
            // with retry logic and proper error handling
            const temperature = 0.2; // Low temperature for consistent, factual evaluation
            const maxRetries = 5; // Increased from 3 to 5 for better reliability
            
            // Custom wrapper to show progress
            const progressEl = document.getElementById('evalAbsLoadingProgress');
            
            try {
                // Show initial progress
                if (progressEl) progressEl.textContent = 'üîÑ Tentativo 1/5...';
                
                // Call with custom retry handling to update progress
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        if (progressEl && attempt > 1) {
                            progressEl.textContent = `üîÑ Tentativo ${attempt}/${maxRetries}...`;
                        }
                        
                        console.log(`Tentativo ${attempt}/${maxRetries} per chiamata LLM...`);
                        
                        const provider = localStorage.getItem('ai_provider') || 'openai';
                        let response;
                        
                        if (provider === 'openai') {
                            response = await callOpenAI(prompt, temperature);
                        } else {
                            response = await callPerplexity(prompt, temperature);
                        }
                        
                        // Verify response is not empty
                        if (!response || response.trim().length === 0) {
                            throw new Error('Risposta vuota da LLM');
                        }
                        
                        console.log(`‚úÖ Risposta ricevuta (${response.length} caratteri)`);
                        if (progressEl) progressEl.textContent = '‚úÖ Report generato con successo!';
                        
                        return response;
                        
                    } catch (error) {
                        console.error(`Tentativo ${attempt} fallito:`, error.message);
                        
                        if (attempt === maxRetries) {
                            // Last attempt failed, throw error
                            throw new Error(`Chiamata LLM fallita dopo ${maxRetries} tentativi: ${error.message}`);
                        }
                        
                        // Wait before retrying (exponential backoff)
                        const waitTime = Math.pow(2, attempt) * 1000; // 2s, 4s, 8s, 16s, 32s
                        console.log(`Attendo ${waitTime/1000}s prima di riprovare...`);
                        
                        if (progressEl) {
                            progressEl.textContent = `‚è≥ Tentativo ${attempt} fallito, attendo ${waitTime/1000}s prima di riprovare...`;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Errore chiamata LLM:', error);
                if (progressEl) progressEl.textContent = '‚ùå Errore: ' + error.message;
                throw new Error(`Errore generazione report: ${error.message}`);
            }
        }

        // Show Report
        function evalAbs_showReport(reportHTML) {
            const container = document.getElementById('evalAbsReportContent');
            container.innerHTML = reportHTML;
            
            document.getElementById('evalAbsResult').classList.remove('hidden');
            
            // Scroll to report
            document.getElementById('evalAbsResult').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Report
        function evalAbs_closeReport() {
            document.getElementById('evalAbsResult').classList.add('hidden');
            evalAbs_currentReportData = null;
        }

        // Save Report to localStorage
        function evalAbs_saveReport() {
            if (!evalAbs_currentReportData) {
                alert('‚ùå Nessun report da salvare');
                return;
            }
            
            // Generate unique ID
            const id = `${evalAbs_currentReportData.manual_id}_${evalAbs_currentReportData.framework_id}`;
            
            // Load existing evaluations
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            
            // Check if already exists
            if (evaluations[id]) {
                if (!confirm('‚ö†Ô∏è Esiste gi√† una valutazione per questo manuale/framework. Sovrascrivere?')) {
                    return;
                }
            }
            
            // Save
            evalAbs_currentReportData.id = id;
            evalAbs_currentReportData.last_edited = new Date().toISOString();
            evaluations[id] = evalAbs_currentReportData;
            
            localStorage.setItem('manual_evaluations_absolute', JSON.stringify(evaluations));
            
            console.log('üíæ Valutazione salvata:', id);
            alert('‚úÖ Valutazione salvata con successo!');
            
            // Refresh saved list
            evalAbs_loadSavedEvaluations();
        }

        // Download Report as HTML
        function evalAbs_downloadHTML() {
            if (!evalAbs_currentReportData) {
                alert('‚ùå Nessun report da scaricare');
                return;
            }
            
            const filename = `valutazione_${evalAbs_currentReportData.manual_id}_${new Date().toISOString().split('T')[0]}.html`;
            
            const htmlContent = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valutazione: ${evalAbs_currentReportData.manual_title}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: #4F46E5; }
        h1 { border-bottom: 3px solid #4F46E5; padding-bottom: 10px; }
        .meta { background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .meta p { margin: 5px 0; }
        ul { margin-left: 20px; }
        strong { color: #1F2937; }
    </style>
</head>
<body>
    <h1>üìä Valutazione Assoluta Manuale Zanichelli</h1>
    
    <div class="meta">
        <p><strong>Manuale:</strong> ${evalAbs_currentReportData.manual_title}</p>
        <p><strong>Autore:</strong> ${evalAbs_currentReportData.manual_author}</p>
        <p><strong>Framework:</strong> ${evalAbs_currentReportData.framework_name}</p>
        <p><strong>Data Valutazione:</strong> ${new Date(evalAbs_currentReportData.evaluation_date).toLocaleDateString('it-IT')}</p>
    </div>
    
    ${evalAbs_currentReportData.report_html}
    
    <hr style="margin: 40px 0;">
    <p style="text-align: center; color: #6B7280; font-size: 0.9em;">
        Report generato da Matrix Analisi Programmi - Zanichelli
    </p>
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('üì• Report scaricato:', filename);
        }

        // Load Saved Evaluations
        function evalAbs_loadSavedEvaluations() {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            const container = document.getElementById('evalAbsSavedListContent');
            
            if (Object.keys(evaluations).length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Nessuna valutazione salvata</p>';
                return;
            }
            
            const evaluationsArray = Object.values(evaluations);
            evaluationsArray.sort((a, b) => new Date(b.evaluation_date) - new Date(a.evaluation_date));
            
            let html = '';
            evaluationsArray.forEach(ev => {
                const date = new Date(ev.evaluation_date).toLocaleDateString('it-IT');
                html += `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900">${ev.manual_title}</h4>
                                <p class="text-sm text-gray-600">Autore: ${ev.manual_author || 'N/A'}</p>
                                <p class="text-sm text-gray-500">Framework: ${ev.framework_name} | Data: ${date}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="evalAbs_viewSaved('${ev.id}')" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">
                                    üëÅÔ∏è Visualizza
                                </button>
                                <button onclick="evalAbs_downloadSaved('${ev.id}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                    üì• HTML
                                </button>
                                <button onclick="evalAbs_deleteSaved('${ev.id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // View Saved Evaluation
        function evalAbs_viewSaved(id) {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            const ev = evaluations[id];
            
            if (!ev) {
                alert('‚ùå Valutazione non trovata');
                return;
            }
            
            evalAbs_currentReportData = ev;
            evalAbs_showReport(ev.report_html);
        }

        // Download Saved Evaluation
        function evalAbs_downloadSaved(id) {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            const ev = evaluations[id];
            
            if (!ev) {
                alert('‚ùå Valutazione non trovata');
                return;
            }
            
            evalAbs_currentReportData = ev;
            evalAbs_downloadHTML();
        }

        // Delete Saved Evaluation
        function evalAbs_deleteSaved(id) {
            if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questa valutazione?')) {
                return;
            }
            
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            delete evaluations[id];
            localStorage.setItem('manual_evaluations_absolute', JSON.stringify(evaluations));
            
            console.log('üóëÔ∏è Valutazione eliminata:', id);
            alert('‚úÖ Valutazione eliminata');
            
            evalAbs_loadSavedEvaluations();
        }

        // Export All Evaluations
        function evalAbs_exportAll() {
            const evaluations = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
            
            if (Object.keys(evaluations).length === 0) {
                alert('‚ö†Ô∏è Nessuna valutazione da esportare');
                return;
            }
            
            const exportData = {
                export_date: new Date().toISOString(),
                total_evaluations: Object.keys(evaluations).length,
                evaluations: evaluations
            };
            
            const filename = `valutazioni_assolute_${new Date().toISOString().split('T')[0]}.json`;
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('üì§ Export completato:', filename);
            alert(`‚úÖ Export completato: ${Object.keys(evaluations).length} valutazioni`);
        }

        // Import Evaluations
        function evalAbs_importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.evaluations || typeof data.evaluations !== 'object') {
                        throw new Error('Formato JSON non valido');
                    }
                    
                    // Merge with existing
                    const existing = JSON.parse(localStorage.getItem('manual_evaluations_absolute') || '{}');
                    const merged = { ...existing, ...data.evaluations };
                    
                    localStorage.setItem('manual_evaluations_absolute', JSON.stringify(merged));
                    
                    console.log('üì• Import completato:', Object.keys(data.evaluations).length);
                    alert(`‚úÖ Import completato: ${Object.keys(data.evaluations).length} valutazioni importate`);
                    
                    evalAbs_loadSavedEvaluations();
                    
                } catch (error) {
                    console.error('‚ùå Errore import:', error);
                    alert('‚ùå Errore durante l\'import: ' + error.message);
                }
            };
            
            input.click();
        }

        // ============================================
        // END VALUTAZIONE ASSOLUTA MANUALI
        // ============================================

    </script>
    
    <!-- MODAL: Aggiungi/Modifica Manuale -->
    <div id="manualeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h3 id="manualeModalTitle" class="text-xl font-bold">‚ûï Nuovo Manuale</h3>
                <button onclick="closeManualeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- STEP 1: Identificativi -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-3">üìù STEP 1: Identificativi</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ID Manuale *</label>
                            <input type="text" id="manualeId" placeholder="es: brown_intro" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                pattern="[a-zA-Z0-9_]+" title="Solo lettere, numeri e underscore">
                            <p class="text-xs text-gray-500 mt-1">Solo lettere, numeri e underscore. Deve essere univoco.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Macroarea *</label>
                                <select id="manualeMacroarea" onchange="updateMaterieAutocomplete()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona macroarea...</option>
                                    <option value="Biologia">Biologia</option>
                                    <option value="Chimica">Chimica</option>
                                    <option value="Fisica">Fisica</option>
                                    <option value="Matematica">Matematica</option>
                                    <option value="Economia">Economia</option>
                                    <option value="Istologia">Istologia</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Categoria principale (es: Biologia, Chimica)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Materia *</label>
                                <input type="text" id="manualeMateria" list="materieDatalist" placeholder="es: Biologia Vegetale"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    oninput="filterMaterieDatalist()">
                                <datalist id="materieDatalist">
                                    <!-- Popolato dinamicamente da JavaScript -->
                                </datalist>
                                <p class="text-xs text-gray-500 mt-1">Disciplina specifica (campo libero con suggerimenti)</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                            <select id="manualeTipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona tipo...</option>
                                <option value="zanichelli">Zanichelli</option>
                                <option value="competitor">Competitor</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 2: Carica JSON -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 mb-3">üìÅ STEP 2: Carica File JSON</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                File JSON del Manuale *
                            </label>
                            <div class="flex items-center justify-center w-full">
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clicca per caricare</span> o trascina qui</p>
                                        <p class="text-xs text-gray-500">File JSON (MAX 10MB)</p>
                                    </div>
                                    <input id="manualeJsonFile" type="file" accept=".json" class="hidden" onchange="handleJsonUpload(event)">
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Il file JSON deve contenere la struttura completa del manuale con capitoli e sezioni.
                            </p>
                        </div>
                        
                        <div id="jsonFileInfo" class="hidden p-3 bg-white border border-gray-300 rounded-lg">
                            <p class="text-sm font-medium text-gray-700">File caricato:</p>
                            <p id="jsonFileName" class="text-sm text-gray-600"></p>
                            <p id="jsonFileSize" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 3: Preview Dati -->
                <div id="previewSection" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="font-semibold text-purple-900 mb-3">üëÅÔ∏è STEP 3: Preview Dati</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Titolo:</span>
                            <span id="previewTitle" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Autore:</span>
                            <span id="previewAuthor" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Editore:</span>
                            <span id="previewPublisher" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Capitoli:</span>
                            <span id="previewChapters" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Pagine:</span>
                            <span id="previewPages" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Prezzo:</span>
                            <span id="previewPrice" class="font-medium text-gray-900"></span>
                        </div>
                    </div>
                </div>
                
                <!-- EDITOR JSON (solo in modifica) -->
                <div id="jsonEditorSection" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-900 mb-3">üìù Editor JSON</h4>
                    <textarea id="jsonEditor" class="w-full h-96 p-3 border border-gray-300 rounded-lg font-mono text-xs"
                        placeholder="Contenuto JSON del manuale..."></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                        Modifica il JSON direttamente. Assicurati che la sintassi sia valida prima di salvare.
                    </p>
                </div>
                
                <!-- Errori validazione -->
                <div id="validationErrors" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                    <h4 class="font-semibold text-red-900 mb-2">‚ö†Ô∏è Errori di Validazione</h4>
                    <ul id="errorList" class="list-disc list-inside text-sm text-red-700 space-y-1">
                    </ul>
                </div>
            </div>
            
            <!-- Footer con azioni -->
            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button onclick="closeManualeModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    ‚ùå Annulla
                </button>
                <button onclick="saveManualeData()" id="btnSaveManuale" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    üíæ Salva Manuale
                </button>
            </div>
        </div>
    </div>
    <!-- END MODAL -->
    
    <!-- MODAL: Conferma Eliminazione -->
    <div id="deleteManualeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Conferma Eliminazione</h3>
                <p class="text-sm text-gray-500 mb-1">Stai per eliminare il manuale:</p>
                <p id="deleteManualeName" class="text-sm font-semibold text-gray-900 mb-4"></p>
                <p class="text-xs text-red-600 mb-6">Questa azione non pu√≤ essere annullata.</p>
                
                <div class="flex justify-center gap-3">
                    <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                        Annulla
                    </button>
                    <button onclick="confirmDeleteManuale()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                        üóëÔ∏è Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- END MODAL -->

    <!-- MODAL: Aggiungi/Modifica Framework -->
    <div id="frameworkModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h3 id="frameworkModalTitle" class="text-xl font-bold">‚ûï Nuovo Framework</h3>
                <button onclick="closeFrameworkModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- STEP 1: Identificativi -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-3">üìù STEP 1: Identificativi</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ID Framework *</label>
                            <input type="text" id="frameworkId" placeholder="es: chimica_organica_framework" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                pattern="[a-zA-Z0-9_]+" title="Solo lettere, numeri e underscore">
                            <p class="text-xs text-gray-500 mt-1">Solo lettere, numeri e underscore. Deve essere univoco.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome Framework *</label>
                                <input type="text" id="frameworkName" placeholder="es: Chimica Organica"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Materia *</label>
                                <select id="frameworkSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleziona materia...</option>
                                    <option value="Matematica">Matematica</option>
                                    <option value="Fisica">Fisica</option>
                                    <option value="Chimica">Chimica</option>
                                    <option value="Chimica Generale">Chimica Generale</option>
                                    <option value="Chimica Organica">Chimica Organica</option>
                                    <option value="Biologia">Biologia</option>
                                    <option value="Economia">Economia</option>
                                    <option value="Medicina e Chirurgia">Medicina e Chirurgia</option>
                                    <option value="Istologia">Istologia</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 2: Carica JSON -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 mb-3">üìÅ STEP 2: Carica File JSON</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                File JSON del Framework *
                            </label>
                            <div class="flex items-center justify-center w-full">
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clicca per caricare</span> o trascina qui</p>
                                        <p class="text-xs text-gray-500">File JSON (MAX 10MB)</p>
                                    </div>
                                    <input id="frameworkJsonFile" type="file" accept=".json" class="hidden" onchange="handleFrameworkJsonUpload(event)">
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Il file JSON deve contenere: syllabus_modules, program_profiles, target_degrees.
                            </p>
                        </div>
                        
                        <div id="frameworkJsonFileInfo" class="hidden p-3 bg-white border border-gray-300 rounded-lg">
                            <p class="text-sm font-medium text-gray-700">File caricato:</p>
                            <p id="frameworkJsonFileName" class="text-sm text-gray-600"></p>
                            <p id="frameworkJsonFileSize" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                </div>
                
                <!-- STEP 3: Preview Dati -->
                <div id="frameworkPreviewSection" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="font-semibold text-purple-900 mb-3">üëÅÔ∏è STEP 3: Preview Dati</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Nome:</span>
                            <span id="frameworkPreviewName" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Materia:</span>
                            <span id="frameworkPreviewSubject" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Moduli Programma:</span>
                            <span id="frameworkPreviewModules" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Profili Studente:</span>
                            <span id="frameworkPreviewProfiles" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Corsi di Laurea:</span>
                            <span id="frameworkPreviewDegrees" class="font-medium text-gray-900"></span>
                        </div>
                    </div>
                </div>
                
                <!-- EDITOR JSON (solo in modifica) -->
                <div id="frameworkJsonEditorSection" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-900 mb-3">üìù Editor JSON</h4>
                    <textarea id="frameworkJsonEditor" class="w-full h-96 p-3 border border-gray-300 rounded-lg font-mono text-xs"
                        placeholder="Contenuto JSON del framework..."></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                        Modifica il JSON direttamente. Assicurati che la sintassi sia valida prima di salvare.
                    </p>
                </div>
                
                <!-- Errori validazione -->
                <div id="frameworkValidationErrors" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                    <h4 class="font-semibold text-red-900 mb-2">‚ö†Ô∏è Errori di Validazione</h4>
                    <ul id="frameworkErrorList" class="list-disc list-inside text-sm text-red-700 space-y-1">
                    </ul>
                </div>
            </div>
            
            <!-- Footer con azioni -->
            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button onclick="closeFrameworkModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    ‚ùå Annulla
                </button>
                <button onclick="saveFrameworkData()" id="btnSaveFramework" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    üíæ Salva Framework
                </button>
            </div>
        </div>
    </div>
    <!-- END MODAL -->

    <!-- MODAL: Conferma Eliminazione Framework -->
    <div id="deleteFrameworkModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Conferma Eliminazione</h3>
                <p class="text-sm text-gray-500 mb-1">Stai per eliminare il framework:</p>
                <p id="deleteFrameworkName" class="text-sm font-semibold text-gray-900 mb-4"></p>
                <p class="text-xs text-red-600 mb-6">Questa azione non pu√≤ essere annullata.</p>
                
                <div class="flex justify-center gap-3">
                    <button onclick="closeDeleteFrameworkModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                        Annulla
                    </button>
                    <button onclick="confirmDeleteFramework()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                        üóëÔ∏è Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- END MODAL -->

</body>
</html>
